<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Config v2.10.7 â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 640px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 20px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .card h2 { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 14px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }
  input:focus { outline: none; border-color: #f97316; }
  .btn { padding: 11px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-orange { background: #f97316; color: #fff; width: 100%; font-size: 16px; padding: 14px; }
  .btn-gray   { background: #e2e8f0; color: #1e293b; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .status { padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-top: 8px; }
  .status.ok  { background: #dcfce7; color: #16a34a; }
  .status.err { background: #fee2e2; color: #dc2626; }
  /* Entregadores removido v2.5.0 â€” gerenciar em UsuÃ¡rios */
  .version-badge { font-size: 10px; color: #94a3b8; text-align: right; padding: 4px 0 10px; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <div class="version-badge">v2.10.7 â€” config</div>
  <h1>âš™ï¸ ConfiguraÃ§Ãµes v2.10.7</h1>

  <!-- API Key (admin only) -->
  <div class="card" id="apiKeySection">
    <h2>ğŸ”‘ Chave de Acesso (APP_API_KEY)</h2>
    <label>Chave configurada no Cloudflare Worker</label>
    <input type="password" id="apiKeyInput" placeholder="Cole a APP_API_KEY aqui">
    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="saveKey()">Salvar Chave</button>
      <button class="btn btn-green" onclick="testHealth()">ğŸ” Testar ConexÃ£o</button>
    </div>
    <div id="health-status"></div>
  </div>

  <!-- Bling OAuth -->
  <div class="card">
    <h2>ğŸ”— AutorizaÃ§Ã£o Bling</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">Conecte sua conta Bling para sincronizar contatos e pedidos. VocÃª precisa ter o APP configurado no Bling com a URL de callback apontando para <code>https://api.moskogas.com.br/bling/oauth/callback</code></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank" class="btn btn-green" style="display:inline-block;text-decoration:none">ğŸš€ Autorizar no Bling</a>
      <button class="btn btn-gray" onclick="testBling()">ğŸ“¡ Testar Token Bling</button>
    </div>
    <div id="bling-status"></div>
  </div>

  <!-- Entregadores: gerenciar em UsuÃ¡rios (app_users) -->

  <!-- Teste IzChat -->
  <div class="card">
    <h2>ğŸ“± Teste IzChat WhatsApp</h2>
    <label>NÃºmero para teste (ex: 5567999990000)</label>
    <input id="testTo" placeholder="5567999990000">
    <button class="btn btn-green" onclick="testIzChat()">ğŸ“² Enviar Mensagem Teste</button>
    <div id="izchat-status"></div>
  </div>

  <!-- Config Foto Comprovante -->
  <div class="card">
    <h2>ğŸ“¸ Foto Comprovante (Entregador)</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:14px">Ajuste a compressÃ£o da foto tirada pelo entregador ao marcar entrega. Fotos sÃ£o sempre de recibos/texto.</p>

    <label>Formato de imagem</label>
    <select id="fotoFormato" style="margin-bottom:12px">
      <option value="webp">ğŸ“„ WebP â€” Melhor para texto (recomendado)</option>
      <option value="jpeg">ğŸ“· JPEG â€” Compatibilidade mÃ¡xima</option>
      <option value="png">ğŸ–¼ï¸ PNG â€” Sem perda (arquivo grande)</option>
    </select>

    <label>DimensÃ£o mÃ¡xima (px): <strong id="maxDimVal">1200</strong></label>
    <input type="range" id="fotoMaxDim" min="400" max="1600" step="100" value="1200" oninput="document.getElementById('maxDimVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>400px</span><span>800</span><span>1200</span><span>1600px</span></div>

    <label>Qualidade (%): <strong id="qualityVal">85</strong> <span id="qualityHint" style="font-size:11px;color:#94a3b8">(ignorado para PNG)</span></label>
    <input type="range" id="fotoQuality" min="20" max="95" step="5" value="85" oninput="document.getElementById('qualityVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>20%</span><span>55%</span><span>85%</span><span>95%</span></div>

    <label>DesaturaÃ§Ã£o (%): <strong id="desatVal">50</strong></label>
    <input type="range" id="fotoDesat" min="0" max="100" step="10" value="50" oninput="document.getElementById('desatVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>0% (cor)</span><span>50%</span><span>100% (P&B)</span></div>

    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
      <label style="display:inline;cursor:pointer;margin:0"><input type="checkbox" id="fotoContraste" checked style="width:auto;margin-right:6px">Auto-contraste</label>
      <label style="display:inline;cursor:pointer;margin:0"><input type="checkbox" id="fotoSharpen" checked style="width:auto;margin-right:6px">Nitidez (sharpen) â€” melhora legibilidade de texto</label>
    </div>

    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="salvarFotoConfig()" style="flex:1">ğŸ’¾ Salvar</button>
      <button class="btn btn-gray" onclick="resetFotoConfig()">ğŸ”„ PadrÃ£o</button>
    </div>
    <div id="foto-config-status"></div>
  </div>

  <!-- PermissÃµes Atendente (admin only) -->
  <div class="card" id="permissoesSection">
    <h2>ğŸ” PermissÃµes do Atendente</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:14px">Defina o que atendentes podem fazer. Admin sempre tem acesso total.</p>

    <div style="display:flex;flex-direction:column;gap:10px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permReabrirEntregue" checked style="width:auto;margin:0"> Reabrir pedido <strong>entregue</strong>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permReabrirCancelado" style="width:auto;margin:0"> Reabrir pedido <strong>cancelado</strong>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permCancelar" checked style="width:auto;margin:0"> Cancelar pedido
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permEditarEntregue" style="width:auto;margin:0"> Editar pedido <strong>entregue</strong>
      </label>
    </div>

    <div style="background:#fef3c7;border-radius:8px;padding:10px 12px;font-size:12px;color:#92400e;margin-top:12px">
      âš ï¸ Quando atendente reabrir/cancelar, admin recebe alerta WhatsApp automÃ¡tico.
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-orange" onclick="salvarPermissoes()" style="flex:1">ğŸ’¾ Salvar PermissÃµes</button>
    </div>
    <div id="perm-status"></div>
  </div>

  <!-- WhatsApp Safety Layer (admin only) -->
  <div class="card" id="safetySection">
    <h2>ğŸ›¡ï¸ WhatsApp Safety Layer</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">ProteÃ§Ã£o anti-ban do WhatsApp. Desative restriÃ§Ãµes apenas para testes.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ws-habilitado" style="width:18px;height:18px" checked>
        <span style="font-size:13px;font-weight:600">Safety Layer ativo</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="ws-horario" style="width:18px;height:18px" checked>
        <span style="font-size:13px;font-weight:600">Respeitar horÃ¡rio comercial</span>
      </label>
      <label style="font-size:13px">
        ğŸ• InÃ­cio (CG/MS)
        <select id="ws-hora-ini" style="margin-top:4px">
          <option value="6">06:00</option><option value="7">07:00</option>
          <option value="8" selected>08:00</option><option value="9">09:00</option>
        </select>
      </label>
      <label style="font-size:13px">
        ğŸ• Fim (CG/MS)
        <select id="ws-hora-fim" style="margin-top:4px">
          <option value="17">17:00</option><option value="18" selected>18:00</option>
          <option value="19">19:00</option><option value="20">20:00</option>
          <option value="21">21:00</option><option value="22">22:00</option>
        </select>
      </label>
      <label style="font-size:13px">
        âš¡ Rate limit (msg/min)
        <input type="number" id="ws-max-min" min="1" max="50" value="25" style="width:80px;margin-top:4px">
      </label>
      <label style="font-size:13px">
        â±ï¸ Intervalo mÃ­nimo (seg)
        <input type="number" id="ws-intervalo" min="1" max="60" value="4" style="width:80px;margin-top:4px">
      </label>
      <label style="font-size:13px">
        ğŸ”„ Circuit breaker (min)
        <input type="number" id="ws-breaker" min="5" max="120" value="30" style="width:80px;margin-top:4px">
      </label>
      <label style="font-size:13px">
        ğŸš« Cooldown mesmo nÂº (h)
        <input type="number" id="ws-cooldown" min="1" max="48" value="12" style="width:80px;margin-top:4px">
      </label>
    </div>
    <div id="ws-status-info" style="margin-top:10px;font-size:12px;color:#94a3b8"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-orange" onclick="salvarSafetyConfig()" style="flex:1">ğŸ’¾ Salvar Safety Config</button>
    </div>
  </div>

  <!-- Lembretes PIX (admin only) -->
  <div class="card" id="lembreteSection">
    <h2>ğŸ“± Lembretes PIX (WhatsApp)</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">ConfiguraÃ§Ã£o de lembretes automÃ¡ticos para PIX Aberto pendentes.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="lemb-ativo" style="width:18px;height:18px">
        <span style="font-size:13px;font-weight:600">Lembretes ativos</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="lemb-cron" style="width:18px;height:18px">
        <span style="font-size:13px;font-weight:600">Envio automÃ¡tico (cron)</span>
      </label>
      <label style="font-size:13px">
        â±ï¸ Intervalo entre lembretes (horas)
        <input type="number" id="lemb-intervalo" min="0" max="168" value="24" style="width:80px;margin-top:4px" title="0 = sem intervalo (para testes)"> <span style="font-size:11px;color:#94a3b8">0 = sem intervalo</span>
      </label>
      <label style="font-size:13px">
        ğŸ”¢ MÃ¡ximo de lembretes por pedido
        <input type="number" id="lemb-max" min="0" max="10" value="3" style="width:80px;margin-top:4px" title="0 = sem limite (para testes)"> <span style="font-size:11px;color:#94a3b8">0 = sem limite</span>
      </label>
      <label style="font-size:13px">
        ğŸ• Hora do envio automÃ¡tico (horÃ¡rio local CG/MS)
        <select id="lemb-hora" style="margin-top:4px">
          <option value="12">08:00</option>
          <option value="13">09:00</option>
          <option value="14">10:00</option>
          <option value="15">11:00</option>
          <option value="16">12:00</option>
          <option value="17">13:00</option>
          <option value="18">14:00</option>
        </select>
        <span style="font-size:10px;color:#94a3b8">GMT-4 (Campo Grande/MS)</span>
      </label>
      <label style="font-size:13px">
        â³ Intervalo entre envios (segundos)
        <input type="number" id="lemb-delay" min="10" max="300" value="60" style="width:80px;margin-top:4px">
        <span style="font-size:10px;color:#94a3b8">Recomendado: 60s (anti-ban)</span>
      </label>
    </div>
    <label style="font-size:13px;display:block;margin-top:12px">
      ğŸ”‘ Chave PIX (aparece na mensagem)
      <input type="text" id="lemb-chave-pix" placeholder="Ex: 12.977.901/0001-17 ou (67) 99924-1437" style="width:100%;margin-top:4px;font-size:14px;border:2px solid #e2e8f0;border-radius:8px;padding:10px">
    </label>
    <label style="font-size:13px;display:block;margin-top:12px">
      ğŸ’¬ Mensagem do lembrete
      <span style="font-size:10px;color:#94a3b8;display:block;margin:4px 0">VariÃ¡veis: {nome}, {itens}, {valor}, {ontem}, {chave_pix} â€” SaudaÃ§Ã£o varia automaticamente</span>
      <textarea id="lemb-mensagem" rows="8" style="width:100%;font-size:13px;border:2px solid #e2e8f0;border-radius:8px;padding:10px;margin-top:4px;resize:vertical"></textarea>
    </label>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-orange" onclick="salvarLembreteConfig()" style="flex:1">ğŸ’¾ Salvar Config Lembretes</button>
      <button class="btn" onclick="resetLembreteTemplate()" style="background:#e2e8f0;color:#64748b">ğŸ”„ Restaurar PadrÃ£o</button>
    </div>
    <div id="lemb-status"></div>
  </div>

  <!-- QR Code AvaliaÃ§Ã£o Google -->
  <div class="card">
    <h2>â­ QR Code â€” AvaliaÃ§Ã£o Google</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">ApÃ³s cada entrega, o entregador vÃª um QR Code para o cliente avaliar no Google. Configure a URL da sua pÃ¡gina de avaliaÃ§Ã£o.</p>
    <label style="font-size:13px;font-weight:600;display:block;margin-bottom:4px">ğŸ”— URL Google Reviews</label>
    <input type="url" id="review-url" placeholder="https://g.page/r/CeXXXX/review" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:13px">
    <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
      <button class="btn btn-orange" onclick="salvarReviewUrl()" style="flex:0 0 auto">ğŸ’¾ Salvar</button>
      <span id="review-stats" style="font-size:12px;color:#94a3b8"></span>
    </div>
    <div id="review-preview" style="margin-top:10px;text-align:center;display:none">
      <img id="review-qr-preview" style="width:150px;height:150px;border-radius:8px;border:2px solid #f97316">
    </div>
  </div>

  <!-- RelatÃ³rio DiÃ¡rio por Email -->
  <div class="card" id="relatorioSection">
    <h2>ğŸ“§ RelatÃ³rio DiÃ¡rio por E-mail</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">Envia resumo dos pedidos do dia anterior por e-mail (HTML + CSV anexo) automaticamente via cron.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="rel-ativo" style="width:18px;height:18px">
        <span style="font-size:13px;font-weight:600">Envio automÃ¡tico ativo</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="rel-csv" style="width:18px;height:18px" checked>
        <span style="font-size:13px;font-weight:600">Incluir CSV em anexo</span>
      </label>
      <label style="font-size:13px">
        ğŸ• Hora do envio (horÃ¡rio CG/MS)
        <select id="rel-hora" style="margin-top:4px">
          <option value="4">00:00</option>
          <option value="5">01:00</option>
          <option value="6">02:00</option>
          <option value="7">03:00</option>
          <option value="8">04:00</option>
          <option value="9">05:00</option>
          <option value="10">06:00</option>
          <option value="11">07:00</option>
          <option value="12">08:00</option>
        </select>
        <span style="font-size:10px;color:#94a3b8">GMT-4 (Campo Grande/MS)</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="rel-cancelados" style="width:18px;height:18px" checked>
        <span style="font-size:13px;font-weight:600">Incluir cancelados</span>
      </label>
    </div>
    <label style="font-size:13px;display:block;margin-top:12px">
      ğŸ“¬ E-mails de destino <span style="font-size:10px;color:#94a3b8">(um por linha)</span>
      <textarea id="rel-destinos" rows="3" placeholder="moskogas@gmail.com&#10;luismosko@gmail.com" style="width:100%;font-size:13px;border:2px solid #e2e8f0;border-radius:8px;padding:10px;margin-top:4px;resize:vertical"></textarea>
    </label>
    <label style="font-size:13px;display:block;margin-top:12px">
      ğŸ”‘ API Key do Resend <span style="font-size:10px;color:#94a3b8">(re_xxx... â€” necessÃ¡ria para envio)</span>
      <input type="password" id="rel-resend-key" placeholder="re_aBMY..." style="width:100%;margin-top:4px;font-size:14px;border:2px solid #e2e8f0;border-radius:8px;padding:10px">
      <span style="font-size:10px;color:#94a3b8">Deixe em branco para manter a chave atual</span>
    </label>
    <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap">
      <button class="btn btn-orange" onclick="salvarRelatorioConfig()" style="flex:1">ğŸ’¾ Salvar Config</button>
      <button class="btn" onclick="enviarRelatorioTeste()" style="background:#3b82f6;color:#fff;flex:1">ğŸ“§ Enviar Teste (Ontem)</button>
      <button class="btn" onclick="window.open(API_BASE+'/api/relatorio/preview-email?date='+new Date(Date.now()-86400000).toISOString().slice(0,10)+'&api_key='+encodeURIComponent(localStorage.getItem('mg_api_key')||''),'_blank')" style="background:#e2e8f0;color:#64748b" title="Abre preview no navegador">ğŸ‘ï¸ Preview</button>
    </div>
    <div id="rel-status" style="margin-top:8px"></div>
  </div>

  <!-- Produtos MoskoGÃ¡s -->
  <div class="card" id="productsSection">
    <h2>ğŸ“¦ Produtos MoskoGÃ¡s</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">Cadastre produtos com preÃ§o sugerido. Marque â­ para aparecer como atalho rÃ¡pido na tela de pedido.</p>

    <!-- Importar do Bling -->
    <div style="position:relative;margin-bottom:12px">
      <input id="prodBlingSearch" placeholder="ğŸ” Importar produto do Bling..." oninput="searchBlingProduct(this.value)" autocomplete="off" style="margin-bottom:0">
      <div id="prodBlingSuggestions" style="display:none;position:absolute;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1)"></div>
    </div>

    <!-- Lista de produtos -->
    <div id="appProductsList" style="min-height:40px">
      <div style="color:#94a3b8;text-align:center;padding:16px;font-size:13px">â³ Carregando produtos...</div>
    </div>

    <!-- Adicionar manual -->
    <div style="margin-top:10px;border-top:1px solid #e2e8f0;padding-top:10px">
      <button onclick="showAddProductModal()" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:6px 14px;font-size:12px;cursor:pointer;font-weight:600;color:#334155">â• Cadastrar Produto Manual</button>
    </div>
  </div>

  <!-- Modal Editar Produto -->
  <div id="productModal" style="display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center">
    <div style="background:#fff;border-radius:12px;padding:20px;width:90%;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 id="productModalTitle" style="margin:0;font-size:16px">Editar Produto</h3>
        <button onclick="closeProductModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#94a3b8">âœ•</button>
      </div>
      <input id="pm_id" type="hidden">
      <input id="pm_bling_id" type="hidden">
      <div style="margin-bottom:8px"><label style="font-size:12px;font-weight:600;color:#64748b">Nome</label><input id="pm_name" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"></div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div style="flex:1"><label style="font-size:12px;font-weight:600;color:#64748b">CÃ³digo</label><input id="pm_code" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"></div>
        <div style="flex:1"><label style="font-size:12px;font-weight:600;color:#64748b">PreÃ§o Sugerido (R$)</label><input id="pm_price" type="text" inputmode="decimal" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px;font-weight:700"></div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input id="pm_favorite" type="checkbox"> â­ Favorito (atalho no pedido)</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input id="pm_ativo" type="checkbox" checked> Ativo</label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button onclick="closeProductModal()" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:8px 16px;font-size:13px;cursor:pointer">Cancelar</button>
        <button onclick="saveProduct()" style="background:#f97316;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer">ğŸ’¾ Salvar</button>
      </div>
    </div>
  </div>

  <!-- Autocomplete de Ruas -->
  <div class="card">
    <h2>ğŸ—ºï¸ Autocomplete de EndereÃ§o</h2>

    <div id="streetsStatus" style="font-size:13px;color:#64748b;margin-bottom:12px">â³ Verificando banco local...</div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;font-size:13px;color:#1e40af;margin-bottom:14px">
      âœ… <strong>Nominatim ao vivo ativado</strong> â€” autocomplete jÃ¡ funciona sem importar nada!<br>
      <span style="font-size:12px;color:#3b82f6">O Worker busca ruas via OpenStreetMap em tempo real. O banco local (import) Ã© opcional e torna a busca mais rÃ¡pida.</span>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="streetTestInput" placeholder="Teste: digite 'Rio Branco' ou 'Afonso Pena'" style="flex:1;margin-bottom:0">
      <button onclick="testStreetSearch()" class="btn btn-green" style="white-space:nowrap;padding:10px 16px">ğŸ” Testar</button>
    </div>
    <div id="streetTestResult" style="font-size:13px;min-height:20px"></div>

    <details style="margin-top:16px">
      <summary style="cursor:pointer;font-size:13px;color:#64748b;font-weight:600;user-select:none">âš™ï¸ Import local (opcional â€” busca instantÃ¢nea)</summary>
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9">
        <p style="font-size:12px;color:#94a3b8;margin-bottom:10px">Importa todas as ruas de Campo Grande para o banco D1. Pode demorar 2â€“3 minutos.</p>
        <button onclick="importStreets()" id="btnImportStreets"
          style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;font-weight:700;cursor:pointer">
          â¬‡ï¸ Importar Ruas de CG
        </button>
        <div id="streetsProgress" style="display:none;margin-top:12px">
          <div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden">
            <div id="streetsBar" style="background:#6366f1;height:100%;width:0%;transition:width 0.5s"></div>
          </div>
          <div id="streetsMsg" style="font-size:12px;color:#64748b;margin-top:6px">Aguardando...</div>
        </div>
      </div>
    </details>
  </div>

</div><!-- /container -->

<script src="shared.js"></script>
<script>
checkAuth(['admin', 'atendente']);
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;

// Esconder seÃ§Ãµes admin-only para atendente
const _cfgUser = getCurrentUser();
if (_cfgUser && _cfgUser.role !== 'admin') {
  const apiSec = document.getElementById('apiKeySection');
  if (apiSec) apiSec.style.display = 'none';
  const permSec = document.getElementById('permissoesSection');
  if (permSec) permSec.style.display = 'none';
}

document.getElementById('apiKeyInput').value = localStorage.getItem('mg_api_key') || '';

function saveKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('mg_api_key', k);
  toast('âœ… Chave salva!');
}

async function testHealth() {
  const el = document.getElementById('health-status');
  el.innerHTML = '<div class="status">â³ Testando...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/health');
    const d = await r.json();
    el.innerHTML = `<div class="status ok">âœ… API ok â€” DB: ${d.hasDB ? 'âœ…' : 'âŒ'} | Bucket: ${d.hasBucket ? 'âœ…' : 'âŒ'}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testBling() {
  const el = document.getElementById('bling-status');
  el.innerHTML = '<div class="status">â³ Testando token Bling...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/bling/ping');
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Bling conectado!</div>'
      : `<div class="status err">âŒ Erro ${d.status} â€” <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank">Re-autorizar</a></div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testIzChat() {
  const to = document.getElementById('testTo').value.trim();
  const el = document.getElementById('izchat-status');
  if (!to) { toast('Informe o nÃºmero', 'error'); return; }
  el.innerHTML = '<div class="status">â³ Enviando...</div>';
  try {
    const r = await fetch(`https://api.moskogas.com.br/izchat/teste?to=${to}`);
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Mensagem enviada!</div>'
      : `<div class="status err">âŒ ${JSON.stringify(d)}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

// [REMOVIDO v2.5.0] loadDrivers/addDriver/toggleDriver â€” entregadores via UsuÃ¡rios (app_users)

// â”€â”€ Banco de Ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkStreetsCount() {
  try {
    const r = await api('/api/streets/count');
    const el = document.getElementById('streetsStatus');
    if (el) el.textContent = r.count > 0
      ? `âœ… ${r.count.toLocaleString('pt-BR')} ruas cadastradas`
      : 'âš ï¸ Nenhuma rua importada ainda â€” autocomplete de endereÃ§o nÃ£o funcionarÃ¡';
    if (r.count === 0) {
      const btn = document.getElementById('btnImportStreets');
      if (btn) btn.style.animation = 'pulse 2s infinite';
    }
    return r.count || 0;
  } catch(e) { return 0; }
}

// â”€â”€ Import letra por letra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LETRAS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
let _importRunning = false;

async function importStreets() {
  if (_importRunning) return;
  _importRunning = true;

  const btn  = document.getElementById('btnImportStreets');
  const prog = document.getElementById('streetsProgress');
  const bar  = document.getElementById('streetsBar');
  const msg  = document.getElementById('streetsMsg');

  btn.disabled = true;
  btn.textContent = 'â³ Importando...';
  prog.style.display = 'block';
  bar.style.background = '#6366f1';
  bar.style.width = '2%';
  msg.textContent = 'ğŸš€ Iniciando import letra por letra...';

  let totalRuas = 0;
  const erros = [];

  for (let i = 0; i < LETRAS.length; i++) {
    const letra = LETRAS[i];
    const pct = Math.round(((i) / LETRAS.length) * 95) + 2;
    bar.style.width = pct + '%';
    msg.textContent = `ğŸ“¥ Buscando letra ${letra}... (${i+1}/${LETRAS.length}) â€” ${totalRuas.toLocaleString('pt-BR')} ruas salvas`;

    let ok = false;
    let tentativas = 0;
    while (!ok && tentativas < 3) {
      tentativas++;
      try {
        const r = await api('/api/streets/import-letter', {
          method: 'POST',
          body: JSON.stringify({ letter: letra, first: (i === 0 && tentativas === 1) })
        });
        if (r.ok) {
          totalRuas = r.total || totalRuas;
          ok = true;
        } else {
          throw new Error(r.error || 'Erro desconhecido');
        }
      } catch(e) {
        if (tentativas < 3) {
          msg.textContent = `âš ï¸ Letra ${letra}: ${e.message} â€” tentativa ${tentativas+1}/3...`;
          await new Promise(res => setTimeout(res, 3000));
        } else {
          erros.push(letra);
        }
      }
    }
  }

  // Finalizado
  _importRunning = false;
  bar.style.width = '100%';

  const statusEl = document.getElementById('streetsStatus');
  if (erros.length === 0) {
    bar.style.background = '#16a34a';
    msg.textContent = `âœ… ${totalRuas.toLocaleString('pt-BR')} ruas importadas com sucesso!`;
    statusEl.textContent = `âœ… ${totalRuas.toLocaleString('pt-BR')} ruas cadastradas`;
    btn.textContent = 'âœ… Importado!';
    setTimeout(() => { btn.disabled = false; btn.textContent = 'â¬‡ï¸ Reimportar'; }, 4000);
  } else {
    bar.style.background = '#f97316';
    msg.textContent = `âš ï¸ ${totalRuas.toLocaleString('pt-BR')} ruas salvas. Letras com erro: ${erros.join(', ')} â€” clique para tentar novamente`;
    statusEl.textContent = `âš ï¸ ${totalRuas.toLocaleString('pt-BR')} ruas (incompleto)`;
    btn.disabled = false;
    btn.textContent = 'ğŸ”„ Tentar letras com erro';
  }
}

// â”€â”€ Teste de busca de ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testStreetSearch() {
  const q = document.getElementById('streetTestInput').value.trim();
  const el = document.getElementById('streetTestResult');
  if (!q) { el.innerHTML = '<span style="color:#dc2626">Digite uma rua para testar</span>'; return; }
  el.innerHTML = '<span style="color:#94a3b8">ğŸ” Buscando...</span>';
  try {
    const results = await api(`/api/streets/search?q=${encodeURIComponent(q)}`);
    if (!results || !results.length) {
      el.innerHTML = `<span style="color:#f97316">âš ï¸ Nenhuma rua encontrada para "${q}"</span>`;
    } else {
      el.innerHTML = `<span style="color:#16a34a">âœ… ${results.length} rua(s) encontrada(s):</span><br>` +
        results.slice(0,5).map(r => `<span style="color:#334155;margin-left:8px">â€¢ ${r.name}${r.bairro ? ' â€” ' + r.bairro : ''}</span>`).join('<br>');
    }
  } catch(e) {
    el.innerHTML = `<span style="color:#dc2626">âŒ ${e.message}</span>`;
  }
}

// â”€â”€ PermissÃµes Atendente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregarPermissoes() {
  try {
    const data = await api('/api/config?key=permissoes');
    if (data?.value) {
      const p = data.value;
      if (p.atendente_reabrir_entregue !== undefined) document.getElementById('permReabrirEntregue').checked = p.atendente_reabrir_entregue;
      if (p.atendente_reabrir_cancelado !== undefined) document.getElementById('permReabrirCancelado').checked = p.atendente_reabrir_cancelado;
      if (p.atendente_cancelar !== undefined) document.getElementById('permCancelar').checked = p.atendente_cancelar;
      if (p.atendente_editar_entregue !== undefined) document.getElementById('permEditarEntregue').checked = p.atendente_editar_entregue;
    }
  } catch(_) {}
}

async function salvarPermissoes() {
  const perms = {
    atendente_reabrir_entregue: document.getElementById('permReabrirEntregue').checked,
    atendente_reabrir_cancelado: document.getElementById('permReabrirCancelado').checked,
    atendente_cancelar: document.getElementById('permCancelar').checked,
    atendente_editar_entregue: document.getElementById('permEditarEntregue').checked,
  };
  const el = document.getElementById('perm-status');
  showLoading('Salvando permissÃµes...');
  try {
    await api('/api/config', { method: 'POST', body: JSON.stringify({ key: 'permissoes', value: perms }) });
    el.innerHTML = '<div class="status ok">âœ… PermissÃµes salvas!</div>';
    setTimeout(() => el.innerHTML = '', 3000);
  } catch(e) {
    el.innerHTML = '<div class="status err">âŒ ' + e.message + '</div>';
  } finally { hideLoading(); }
}

// â”€â”€ Foto Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregarFotoConfig() {
  try {
    const data = await api('/api/config?key=foto_config');
    if (data?.value) {
      const c = data.value;
      if (c.formato) { document.getElementById('fotoFormato').value = c.formato; }
      if (c.maxDim) { document.getElementById('fotoMaxDim').value = c.maxDim; document.getElementById('maxDimVal').textContent = c.maxDim; }
      if (c.quality) { document.getElementById('fotoQuality').value = c.quality; document.getElementById('qualityVal').textContent = c.quality; }
      if (c.desaturacao !== undefined) { document.getElementById('fotoDesat').value = c.desaturacao; document.getElementById('desatVal').textContent = c.desaturacao; }
      if (c.contraste !== undefined) { document.getElementById('fotoContraste').checked = c.contraste; }
      if (c.sharpen !== undefined) { document.getElementById('fotoSharpen').checked = c.sharpen; }
    }
  } catch(_) {}
}

async function salvarFotoConfig() {
  const config = {
    formato: document.getElementById('fotoFormato').value,
    maxDim: parseInt(document.getElementById('fotoMaxDim').value),
    quality: parseInt(document.getElementById('fotoQuality').value),
    desaturacao: parseInt(document.getElementById('fotoDesat').value),
    contraste: document.getElementById('fotoContraste').checked,
    sharpen: document.getElementById('fotoSharpen').checked,
  };
  const el = document.getElementById('foto-config-status');
  showLoading('Salvando configuraÃ§Ã£o de foto...');
  try {
    await api('/api/config', { method: 'POST', body: JSON.stringify({ key: 'foto_config', value: config }) });
    el.innerHTML = '<div class="status ok">âœ… ConfiguraÃ§Ã£o salva! Entregadores usarÃ£o na prÃ³xima foto.</div>';
    setTimeout(() => el.innerHTML = '', 3000);
  } catch(e) {
    el.innerHTML = '<div class="status err">âŒ ' + e.message + '</div>';
  } finally { hideLoading(); }
}

function resetFotoConfig() {
  document.getElementById('fotoFormato').value = 'webp';
  document.getElementById('fotoMaxDim').value = 1200; document.getElementById('maxDimVal').textContent = '1200';
  document.getElementById('fotoQuality').value = 85; document.getElementById('qualityVal').textContent = '85';
  document.getElementById('fotoDesat').value = 50; document.getElementById('desatVal').textContent = '50';
  document.getElementById('fotoContraste').checked = true;
  document.getElementById('fotoSharpen').checked = true;
}

// â”€â”€ Produtos Favoritos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ PRODUTOS MOSKOGAS (preÃ§os sugeridos + favoritos) â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _appProducts = [];
let _blingSearchTimer;
let _blingSearchResults = [];

async function loadAppProducts() {
  try {
    _appProducts = await api('/api/app-products');
    renderAppProducts();
  } catch(e) {
    document.getElementById('appProductsList').innerHTML = `<div style="color:#dc2626;font-size:13px;padding:12px">âŒ ${e.message}</div>`;
  }
}

function renderAppProducts() {
  const el = document.getElementById('appProductsList');
  if (!_appProducts.length) {
    el.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:16px;font-size:13px">Nenhum produto cadastrado. Importe do Bling ou cadastre manualmente.</div>';
    return;
  }
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:28px 36px 1fr auto auto auto auto;gap:0;font-size:12px;font-weight:700;color:#64748b;padding:6px 10px;border-bottom:2px solid #e2e8f0">
      <span></span><span></span><span>Produto</span><span style="text-align:center;width:50px">CÃ³digo</span><span style="text-align:right;width:80px">PreÃ§o</span><span style="text-align:center;width:40px">â­</span><span style="width:60px"></span>
    </div>
  ` + _appProducts.map((p, idx) => {
    const iconSrc = p.icon_url ? (API_BASE + p.icon_url + '?t=' + Date.now()) : '';
    return `
    <div draggable="true" data-prod-idx="${idx}" data-prod-id="${p.id}"
      ondragstart="prodDragStart(event)" ondragover="prodDragOver(event)" ondrop="prodDrop(event)" ondragend="prodDragEnd(event)"
      style="display:grid;grid-template-columns:28px 36px 1fr auto auto auto auto;gap:0;align-items:center;padding:6px 10px;border-bottom:1px solid #f1f5f9;cursor:grab;transition:background 0.15s;${!p.ativo?'opacity:0.4':''}"
      onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''">
      <span style="color:#cbd5e1;font-size:16px;cursor:grab" title="Arrastar para reordenar">â˜°</span>
      <span style="width:32px;height:32px;border-radius:6px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#f1f5f9;cursor:pointer"
        onclick="uploadProductIcon(${p.id})" title="${iconSrc ? 'Trocar Ã­cone' : 'Adicionar Ã­cone'}">
        ${iconSrc
          ? `<img src="${iconSrc}" style="width:32px;height:32px;object-fit:cover;border-radius:6px">`
          : '<span style="font-size:14px;color:#cbd5e1">ğŸ“·</span>'}
      </span>
      <span style="font-size:13px;font-weight:600;padding-left:4px">${p.name}</span>
      <span style="font-size:11px;color:#94a3b8;text-align:center;width:50px">${p.code||'-'}</span>
      <span style="font-size:13px;font-weight:800;color:#f97316;text-align:right;width:80px">R$ ${parseFloat(p.price||0).toFixed(2)}</span>
      <span style="text-align:center;width:40px">${p.is_favorite?'â­':''}</span>
      <span style="display:flex;gap:4px;width:60px">
        <button onmousedown="event.preventDefault();event.stopPropagation();editProduct(${p.id})" style="background:#e0f2fe;color:#0369a1;border:none;border-radius:4px;padding:3px 6px;font-size:11px;cursor:pointer" title="Editar">âœï¸</button>
        <button onmousedown="event.preventDefault();event.stopPropagation();deleteProduct(${p.id})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:3px 6px;font-size:11px;cursor:pointer" title="Excluir">ğŸ—‘ï¸</button>
      </span>
    </div>`;
  }).join('');
}

// â”€â”€ Drag & Drop reorder â”€â”€
let _dragProdIdx = null;
function prodDragStart(e) {
  _dragProdIdx = parseInt(e.currentTarget.dataset.prodIdx);
  e.currentTarget.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}
function prodDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
  const row = e.currentTarget;
  const rect = row.getBoundingClientRect();
  const mid = rect.top + rect.height / 2;
  row.style.borderTop = e.clientY < mid ? '3px solid #f97316' : '';
  row.style.borderBottom = e.clientY >= mid ? '3px solid #f97316' : '';
}
function prodDragEnd(e) {
  e.currentTarget.style.opacity = '1';
  document.querySelectorAll('[data-prod-idx]').forEach(el => {
    el.style.borderTop = '';
    el.style.borderBottom = '';
  });
}
async function prodDrop(e) {
  e.preventDefault();
  const targetIdx = parseInt(e.currentTarget.dataset.prodIdx);
  if (_dragProdIdx === null || _dragProdIdx === targetIdx) return;
  const item = _appProducts.splice(_dragProdIdx, 1)[0];
  const rect = e.currentTarget.getBoundingClientRect();
  const insertIdx = e.clientY < rect.top + rect.height / 2 ? targetIdx : targetIdx + 1;
  const finalIdx = _dragProdIdx < targetIdx ? insertIdx - 1 : insertIdx;
  _appProducts.splice(finalIdx, 0, item);
  _dragProdIdx = null;
  renderAppProducts();
  try {
    const order = _appProducts.map(p => ({ id: p.id }));
    await api('/api/app-products/reorder', { method: 'POST', body: JSON.stringify({ order }) });
    toast('âœ… Ordem salva!', 'success');
  } catch(err) { toast('âŒ Erro ao salvar ordem: ' + err.message, 'error'); }
}

// â”€â”€ Icon upload â”€â”€
function uploadProductIcon(prodId) {
  const inp = document.createElement('input');
  inp.type = 'file';
  inp.accept = 'image/*';
  inp.onchange = async () => {
    const file = inp.files[0];
    if (!file) return;
    if (file.size > 2 * 1024 * 1024) { toast('âš ï¸ MÃ¡ximo 2MB', 'warning'); return; }
    showLoading('Enviando Ã­cone...');
    try {
      const fd = new FormData();
      fd.append('icon', file);
      const token = getSessionToken();
      const res = await fetch(API_BASE + `/api/app-products/${prodId}/icon`, {
        method: 'POST', headers: { 'Authorization': `Bearer ${token}` }, body: fd
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Erro upload');
      const p = _appProducts.find(x => x.id === prodId);
      if (p) p.icon_url = data.icon_url;
      renderAppProducts();
      toast('ğŸ–¼ï¸ Ãcone salvo!', 'success');
    } catch(err) { toast('âŒ ' + err.message, 'error'); }
    finally { hideLoading(); }
  };
  inp.click();
}

function searchBlingProduct(q) {
  clearTimeout(_blingSearchTimer);
  const box = document.getElementById('prodBlingSuggestions');
  if (q.length < 2) { box.style.display = 'none'; return; }
  box.style.display = 'block';
  box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">ğŸ” Buscando no Bling...</div>';
  _blingSearchTimer = setTimeout(async () => {
    try {
      const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`);
      if (!list || !list.length) {
        box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">Nenhum produto encontrado</div>';
        _blingSearchResults = [];
        return;
      }
      _blingSearchResults = list;
      const existIds = new Set(_appProducts.map(p => String(p.bling_id)));
      box.innerHTML = list.map((p, i) => {
        const exists = existIds.has(String(p.id));
        return `<div onmousedown="${exists ? '' : `event.preventDefault();importBlingProduct(${i})`}"
          style="padding:10px 14px;cursor:${exists ? 'default' : 'pointer'};display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;${exists ? 'opacity:0.5' : ''};background:#fff;"
          ${!exists ? 'onmouseover="this.style.background=\'#fff7ed\'" onmouseout="this.style.background=\'#fff\'"' : ''}>
          <span><strong>${p.name||'Produto'}</strong> ${p.code ? `<small style="color:#94a3b8">(${p.code})</small>` : ''}</span>
          <span style="font-weight:700;color:${exists ? '#94a3b8' : '#f97316'};font-size:13px">${exists ? 'âœ… JÃ¡ cadastrado' : 'R$ ' + parseFloat(p.price||0).toFixed(2) + ' â•'}</span>
        </div>`;
      }).join('');
    } catch(e) {
      box.innerHTML = `<div style="padding:10px 14px;color:#dc2626;font-size:12px">âŒ ${e.message}</div>`;
      _blingSearchResults = [];
    }
  }, 350);
}

async function importBlingProduct(idx) {
  const p = _blingSearchResults[idx];
  if (!p) return;
  try {
    await api('/api/app-products/import-bling', {
      method: 'POST',
      body: JSON.stringify({ bling_id: String(p.id), name: p.name, code: p.code || '', price: p.price || 0, is_favorite: false })
    });
    document.getElementById('prodBlingSearch').value = '';
    document.getElementById('prodBlingSuggestions').style.display = 'none';
    _appProducts.push({ id: Date.now(), bling_id: String(p.id), name: p.name, code: p.code||'', price: p.price||0, is_favorite: 0, ativo: 1 });
    renderAppProducts();
    toast('ğŸ“¦ Produto importado!', 'success');
    setTimeout(() => loadAppProducts(), 500);
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

function showAddProductModal() {
  document.getElementById('pm_id').value = '';
  document.getElementById('pm_bling_id').value = '';
  document.getElementById('pm_name').value = '';
  document.getElementById('pm_code').value = '';
  document.getElementById('pm_price').value = '';
  document.getElementById('pm_favorite').checked = false;
  document.getElementById('pm_ativo').checked = true;
  document.getElementById('productModalTitle').textContent = 'Novo Produto';
  document.getElementById('productModal').style.display = 'flex';
}

function editProduct(id) {
  const p = _appProducts.find(x => x.id === id);
  if (!p) return;
  document.getElementById('pm_id').value = p.id;
  document.getElementById('pm_bling_id').value = p.bling_id || '';
  document.getElementById('pm_name').value = p.name;
  document.getElementById('pm_code').value = p.code || '';
  document.getElementById('pm_price').value = parseFloat(p.price||0).toFixed(2);
  document.getElementById('pm_favorite').checked = !!p.is_favorite;
  document.getElementById('pm_ativo').checked = p.ativo !== 0;
  document.getElementById('productModalTitle').textContent = 'Editar Produto';
  document.getElementById('productModal').style.display = 'flex';
}

function closeProductModal() {
  document.getElementById('productModal').style.display = 'none';
}

function _parsePrice(val) {
  if (typeof val !== 'string') val = String(val || '0');
  val = val.trim().replace(/\s/g, '');
  if (val.includes(',')) val = val.replace('.', '').replace(',', '.');
  return parseFloat(val) || 0;
}

async function saveProduct() {
  const id = document.getElementById('pm_id').value;
  const data = {
    bling_id: document.getElementById('pm_bling_id').value || null,
    name: document.getElementById('pm_name').value.trim(),
    code: document.getElementById('pm_code').value.trim(),
    price: _parsePrice(document.getElementById('pm_price').value),
    is_favorite: document.getElementById('pm_favorite').checked ? 1 : 0,
    ativo: document.getElementById('pm_ativo').checked ? 1 : 0
  };
  if (!data.name) { toast('âŒ Nome obrigatÃ³rio', 'error'); return; }
  if (id) data.id = parseInt(id);
  showLoading('Salvando produto...');
  try {
    await api('/api/app-products', { method: 'POST', body: JSON.stringify(data) });
    closeProductModal();
    toast('ğŸ’¾ Produto salvo!', 'success');
    await loadAppProducts();
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
  finally { hideLoading(); }
}

async function deleteProduct(id) {
  if (!confirm('Excluir este produto?')) return;
  showLoading('Excluindo produto...');
  try {
    await api(`/api/app-products/${id}`, { method: 'DELETE' });
    _appProducts = _appProducts.filter(p => p.id !== id);
    renderAppProducts();
    toast('ğŸ—‘ï¸ Produto excluÃ­do', 'warning');
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
  finally { hideLoading(); }
}

document.addEventListener('click', e => {
  if (!e.target.closest('#prodBlingSearch') && !e.target.closest('#prodBlingSuggestions'))
    document.getElementById('prodBlingSuggestions').style.display = 'none';
});

// Esconder seÃ§Ã£o produtos para nÃ£o-admin
if (_cfgUser && _cfgUser.role !== 'admin') {
  const ps = document.getElementById('productsSection');
  if (ps) ps.style.display = 'none';
}

// â”€â”€ WhatsApp Safety Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function carregarSafetyConfig() {
  try {
    const config = await api('/api/whatsapp/safety-config');
    document.getElementById('ws-habilitado').checked = config.habilitado !== false;
    document.getElementById('ws-horario').checked = config.respeitar_horario !== false;
    document.getElementById('ws-hora-ini').value = config.horario_inicio_brt || 8;
    document.getElementById('ws-hora-fim').value = config.horario_fim_brt || 18;
    document.getElementById('ws-max-min').value = config.max_por_minuto || 25;
    document.getElementById('ws-intervalo').value = config.intervalo_min_segundos || 4;
    document.getElementById('ws-breaker').value = config.circuit_breaker_minutos || 30;
    document.getElementById('ws-cooldown').value = config.cooldown_mesmo_numero_horas || 12;
    // Stats
    try {
      const stats = await api('/api/whatsapp/stats');
      const hoje = stats.hoje || {};
      document.getElementById('ws-status-info').innerHTML =
        `ğŸ“Š Hoje: ${hoje.total || 0} enviados, ${hoje.bloqueios || 0} bloqueios` +
        (stats.circuit_breaker ? ' | <span style="color:#dc2626;font-weight:700">âš ï¸ CIRCUIT BREAKER ATIVO</span>' : ' | âœ… Operacional');
    } catch(_) {}
  } catch(e) {
    const sec = document.getElementById('safetySection');
    if (sec) sec.style.display = 'none';
  }
}

async function salvarSafetyConfig() {
  const config = {
    habilitado: document.getElementById('ws-habilitado').checked,
    respeitar_horario: document.getElementById('ws-horario').checked,
    horario_inicio_brt: parseInt(document.getElementById('ws-hora-ini').value) || 8,
    horario_fim_brt: parseInt(document.getElementById('ws-hora-fim').value) || 18,
    max_por_minuto: parseInt(document.getElementById('ws-max-min').value) || 25,
    intervalo_min_segundos: parseInt(document.getElementById('ws-intervalo').value) || 4,
    circuit_breaker_minutos: parseInt(document.getElementById('ws-breaker').value) || 30,
    cooldown_mesmo_numero_horas: parseInt(document.getElementById('ws-cooldown').value) || 12,
  };
  showLoading('Salvando Safety Config...');
  try {
    const d = await api('/api/whatsapp/safety-config', { method: 'POST', body: JSON.stringify(config) });
    if (d.ok) toast('âœ… Safety config salva!');
    else toast('âŒ ' + (d.error || 'Erro'), 'error');
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ Lembretes PIX Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const LEMBRETE_PADRAO = `OlÃ¡ {nome}. ğŸ˜ƒ Tudo bem?

Seu pedido de GÃ¡s foi entregue {ontem}, mas ainda nÃ£o conseguimos conciliar o pagamento via PIX.

Pode nos enviar o comprovante por gentileza?

ğŸ’° Valor: R$ {valor}
ğŸ“± Chave PIX: {chave_pix}

Caso jÃ¡ tenha sido pago por favor desconsidere essa mensagem.

â€” MoskoGÃ¡s ğŸ”¥`;

function resetLembreteTemplate() {
  document.getElementById('lemb-mensagem').value = LEMBRETE_PADRAO;
  toast('ğŸ”„ Modelo padrÃ£o restaurado');
}

async function carregarLembreteConfig() {
  try {
    const config = await api('/api/lembretes/config');
    document.getElementById('lemb-ativo').checked = config.ativo !== false;
    document.getElementById('lemb-cron').checked = config.cron_ativo !== false;
    document.getElementById('lemb-intervalo').value = config.intervalo_horas || 24;
    document.getElementById('lemb-max').value = config.max_lembretes || 3;
    document.getElementById('lemb-hora').value = config.cron_hora_utc || 12;
    document.getElementById('lemb-delay').value = config.delay_segundos || 60;
    document.getElementById('lemb-chave-pix').value = config.chave_pix || '';
    document.getElementById('lemb-mensagem').value = config.mensagem || LEMBRETE_PADRAO;
  } catch(e) {
    const sec = document.getElementById('lembreteSection');
    if (sec) sec.style.display = 'none';
  }
}

async function salvarLembreteConfig() {
  const config = {
    ativo: document.getElementById('lemb-ativo').checked,
    cron_ativo: document.getElementById('lemb-cron').checked,
    intervalo_horas: parseInt(document.getElementById('lemb-intervalo').value) ?? 24,
    max_lembretes: parseInt(document.getElementById('lemb-max').value) ?? 3,
    cron_hora_utc: parseInt(document.getElementById('lemb-hora').value) || 12,
    delay_segundos: parseInt(document.getElementById('lemb-delay').value) || 60,
    chave_pix: document.getElementById('lemb-chave-pix').value.trim(),
    mensagem: document.getElementById('lemb-mensagem').value.trim()
  };
  if (!config.mensagem) { toast('âš ï¸ Mensagem nÃ£o pode estar vazia', 'error'); return; }
  showLoading('Salvando configuraÃ§Ã£o...');
  try {
    const d = await api('/api/lembretes/config', { method: 'POST', body: JSON.stringify(config) });
    if (d.ok) toast('âœ… Config lembretes salva!');
    else toast('âŒ ' + (d.error || 'Erro'), 'error');
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ RelatÃ³rio DiÃ¡rio Email Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function carregarRelatorioConfig() {
  try {
    const config = await api('/api/relatorio/email-config');
    document.getElementById('rel-ativo').checked = config.ativo === true;
    document.getElementById('rel-csv').checked = config.incluir_csv !== false;
    document.getElementById('rel-cancelados').checked = config.incluir_cancelados !== false;
    document.getElementById('rel-hora').value = config.hora_utc || 6;
    document.getElementById('rel-destinos').value = (config.destinos || []).join('\n');
  } catch(e) {
    const sec = document.getElementById('relatorioSection');
    if (sec) sec.style.display = 'none';
  }
}

async function salvarRelatorioConfig() {
  const destinos = document.getElementById('rel-destinos').value
    .split('\n').map(e => e.trim()).filter(e => e.includes('@'));
  if (!destinos.length) { toast('âš ï¸ Informe ao menos um e-mail', 'error'); return; }
  const config = {
    ativo: document.getElementById('rel-ativo').checked,
    incluir_csv: document.getElementById('rel-csv').checked,
    incluir_cancelados: document.getElementById('rel-cancelados').checked,
    hora_utc: parseInt(document.getElementById('rel-hora').value) || 6,
    destinos,
  };
  const resendKey = document.getElementById('rel-resend-key').value.trim();
  if (resendKey) config.resend_api_key = resendKey;
  showLoading('Salvando configuraÃ§Ã£o...');
  try {
    const d = await api('/api/relatorio/email-config', { method: 'POST', body: JSON.stringify(config) });
    if (d.ok) {
      toast('âœ… Config relatÃ³rio salva!');
      document.getElementById('rel-resend-key').value = '';
    }
    else toast('âŒ ' + (d.error || 'Erro'), 'error');
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function enviarRelatorioTeste() {
  const yesterday = new Date(Date.now() - 86400000).toISOString().slice(0, 10);
  if (!confirm(`Enviar relatÃ³rio de ${yesterday} por e-mail agora?`)) return;
  showLoading('Enviando relatÃ³rio...');
  try {
    const d = await api('/api/relatorio/enviar-email', { method: 'POST', body: JSON.stringify({ date: yesterday }) });
    if (d.ok) {
      if (d.total === 0) toast(`â„¹ï¸ Sem pedidos em ${yesterday}`, 'error');
      else toast(`âœ… Enviado! ${d.total} pedidos â€” ${d.destinos?.join(', ')}`);
    }
    else toast('âŒ ' + (d.error || 'Erro ao enviar'), 'error');
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ QR Review Config â”€â”€
async function carregarReviewConfig() {
  try {
    const data = await api('/api/config?key=google_review_url');
    const url = data?.value || '';
    document.getElementById('review-url').value = url;
    if (url) {
      const preview = document.getElementById('review-preview');
      preview.style.display = 'block';
      document.getElementById('review-qr-preview').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
    }
    // Stats
    try {
      const stats = await api('/api/qr-review/stats');
      if (stats.total) {
        document.getElementById('review-stats').textContent = `ğŸ“Š ${stats.total} QRs mostrados â€” ${stats.by_driver?.map(d => d.driver + ': ' + d.total).join(', ')}`;
      }
    } catch(_) {}
  } catch(_) {}
}

async function salvarReviewUrl() {
  const url = document.getElementById('review-url').value.trim();
  showLoading('Salvando...');
  try {
    await api('/api/config', { method: 'POST', body: JSON.stringify({ key: 'google_review_url', value: url }) });
    toast('âœ… URL de avaliaÃ§Ã£o salva!');
    if (url) {
      const preview = document.getElementById('review-preview');
      preview.style.display = 'block';
      document.getElementById('review-qr-preview').src = 'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(url);
    } else {
      document.getElementById('review-preview').style.display = 'none';
    }
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

checkStreetsCount();
carregarFotoConfig();
carregarPermissoes();
loadAppProducts();
carregarSafetyConfig();
carregarLembreteConfig();
carregarRelatorioConfig();
carregarReviewConfig();
</script>
</body>
</html>
