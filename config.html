<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Config â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 640px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 20px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .card h2 { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 14px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }
  input:focus { outline: none; border-color: #f97316; }
  .btn { padding: 11px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-orange { background: #f97316; color: #fff; width: 100%; font-size: 16px; padding: 14px; }
  .btn-gray   { background: #e2e8f0; color: #1e293b; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .status { padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-top: 8px; }
  .status.ok  { background: #dcfce7; color: #16a34a; }
  .status.err { background: #fee2e2; color: #dc2626; }
  table.drivers-tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
  table.drivers-tbl td, table.drivers-tbl th { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
  table.drivers-tbl th { background: #f1f5f9; font-weight: 700; font-size: 11px; text-transform: uppercase; color: #64748b; }
  .version-badge { font-size: 10px; color: #94a3b8; text-align: right; padding: 4px 0 10px; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <div class="version-badge">v2.1.0 â€” config</div>
  <h1>âš™ï¸ ConfiguraÃ§Ãµes</h1>

  <!-- API Key -->
  <div class="card">
    <h2>ğŸ”‘ Chave de Acesso (APP_API_KEY)</h2>
    <label>Chave configurada no Cloudflare Worker</label>
    <input type="password" id="apiKeyInput" placeholder="Cole a APP_API_KEY aqui">
    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="saveKey()">Salvar Chave</button>
      <button class="btn btn-green" onclick="testHealth()">ğŸ” Testar ConexÃ£o</button>
    </div>
    <div id="health-status"></div>
  </div>

  <!-- Bling OAuth -->
  <div class="card">
    <h2>ğŸ”— AutorizaÃ§Ã£o Bling</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">Conecte sua conta Bling para sincronizar contatos e pedidos. VocÃª precisa ter o APP configurado no Bling com a URL de callback apontando para <code>https://api.moskogas.com.br/bling/oauth/callback</code></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank" class="btn btn-green" style="display:inline-block;text-decoration:none">ğŸš€ Autorizar no Bling</a>
      <button class="btn btn-gray" onclick="testBling()">ğŸ“¡ Testar Token Bling</button>
    </div>
    <div id="bling-status"></div>
  </div>

  <!-- Entregadores -->
  <div class="card">
    <h2>ğŸšš Entregadores</h2>
    <div id="drivers-list" style="margin-bottom:14px"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <div>
        <label>Nome</label>
        <input id="dName" placeholder="Nome do entregador">
      </div>
      <div>
        <label>Telefone (5567999...)</label>
        <input id="dPhone" placeholder="5567999990001">
      </div>
    </div>
    <button class="btn btn-orange" onclick="addDriver()">â• Adicionar Entregador</button>
  </div>

  <!-- Teste IzChat -->
  <div class="card">
    <h2>ğŸ“± Teste IzChat WhatsApp</h2>
    <label>NÃºmero para teste (ex: 5567999990000)</label>
    <input id="testTo" placeholder="5567999990000">
    <button class="btn btn-green" onclick="testIzChat()">ğŸ“² Enviar Mensagem Teste</button>
    <div id="izchat-status"></div>
  </div>

  <!-- Autocomplete de Ruas -->
  <div class="card">
    <h2>ğŸ—ºï¸ Autocomplete de EndereÃ§o</h2>

    <div id="streetsStatus" style="font-size:13px;color:#64748b;margin-bottom:12px">â³ Verificando banco local...</div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;font-size:13px;color:#1e40af;margin-bottom:14px">
      âœ… <strong>Nominatim ao vivo ativado</strong> â€” autocomplete jÃ¡ funciona sem importar nada!<br>
      <span style="font-size:12px;color:#3b82f6">O Worker busca ruas via OpenStreetMap em tempo real. O banco local (import) Ã© opcional e torna a busca mais rÃ¡pida.</span>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="streetTestInput" placeholder="Teste: digite 'Rio Branco' ou 'Afonso Pena'" style="flex:1;margin-bottom:0">
      <button onclick="testStreetSearch()" class="btn btn-green" style="white-space:nowrap;padding:10px 16px">ğŸ” Testar</button>
    </div>
    <div id="streetTestResult" style="font-size:13px;min-height:20px"></div>

    <details style="margin-top:16px">
      <summary style="cursor:pointer;font-size:13px;color:#64748b;font-weight:600;user-select:none">âš™ï¸ Import local (opcional â€” busca instantÃ¢nea)</summary>
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9">
        <p style="font-size:12px;color:#94a3b8;margin-bottom:10px">Importa todas as ruas de Campo Grande para o banco D1. Pode demorar 2â€“3 minutos.</p>
        <button onclick="importStreets()" id="btnImportStreets"
          style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;font-weight:700;cursor:pointer">
          â¬‡ï¸ Importar Ruas de CG
        </button>
        <div id="streetsProgress" style="display:none;margin-top:12px">
          <div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden">
            <div id="streetsBar" style="background:#6366f1;height:100%;width:0%;transition:width 0.5s"></div>
          </div>
          <div id="streetsMsg" style="font-size:12px;color:#64748b;margin-top:6px">Aguardando...</div>
        </div>
      </div>
    </details>
  </div>

</div><!-- /container -->

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;

document.getElementById('apiKeyInput').value = localStorage.getItem('mg_api_key') || '';

function saveKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('mg_api_key', k);
  toast('âœ… Chave salva!');
}

async function testHealth() {
  const el = document.getElementById('health-status');
  el.innerHTML = '<div class="status">â³ Testando...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/health');
    const d = await r.json();
    el.innerHTML = `<div class="status ok">âœ… API ok â€” DB: ${d.hasDB ? 'âœ…' : 'âŒ'} | Bucket: ${d.hasBucket ? 'âœ…' : 'âŒ'}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testBling() {
  const el = document.getElementById('bling-status');
  el.innerHTML = '<div class="status">â³ Testando token Bling...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/bling/ping');
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Bling conectado!</div>'
      : `<div class="status err">âŒ Erro ${d.status} â€” <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank">Re-autorizar</a></div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testIzChat() {
  const to = document.getElementById('testTo').value.trim();
  const el = document.getElementById('izchat-status');
  if (!to) { toast('Informe o nÃºmero', 'error'); return; }
  el.innerHTML = '<div class="status">â³ Enviando...</div>';
  try {
    const r = await fetch(`https://api.moskogas.com.br/izchat/teste?to=${to}`);
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Mensagem enviada!</div>'
      : `<div class="status err">âŒ ${JSON.stringify(d)}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function loadDrivers() {
  if (!apiKey()) {
    document.getElementById('drivers-list').innerHTML = '<p style="color:#94a3b8;font-size:13px">Salve a chave de acesso primeiro.</p>';
    return;
  }
  const drivers = await api('/api/drivers').catch(() => []);
  const el = document.getElementById('drivers-list');
  if (!drivers.length) {
    el.innerHTML = '<p style="color:#94a3b8;font-size:13px">Nenhum entregador cadastrado.</p>';
    return;
  }
  el.innerHTML = `<table class="drivers-tbl">
    <thead><tr><th>Nome</th><th>Telefone</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
    ${drivers.map(d => `
      <tr>
        <td><strong>${d.name}</strong></td>
        <td>${d.phone_e164}</td>
        <td>${d.active ? 'âœ…' : 'âŒ'}</td>
        <td><button class="btn btn-gray" style="padding:4px 8px;font-size:12px" onclick="toggleDriver(${d.id}, ${d.active})">
          ${d.active ? 'Desativar' : 'Ativar'}
        </button></td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

async function addDriver() {
  const name  = document.getElementById('dName').value.trim();
  const phone = document.getElementById('dPhone').value.trim().replace(/\D/g, '');
  if (!name || !phone) { toast('Nome e telefone obrigatÃ³rios', 'error'); return; }
  try {
    await api('/api/drivers', { method: 'POST', body: JSON.stringify({ name, phone_e164: phone }) });
    toast('âœ… Entregador adicionado!');
    document.getElementById('dName').value = '';
    document.getElementById('dPhone').value = '';
    loadDrivers();
  } catch(e) { toast(e.message, 'error'); }
}

async function toggleDriver(id, active) {
  try {
    await api(`/api/drivers/${id}`, { method: 'PATCH', body: JSON.stringify({ active: !active }) });
    loadDrivers();
  } catch(e) { toast(e.message, 'error'); }
}

// â”€â”€ Banco de Ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkStreetsCount() {
  try {
    const r = await api('/api/streets/count');
    const el = document.getElementById('streetsStatus');
    if (el) el.textContent = r.count > 0
      ? `âœ… ${r.count.toLocaleString('pt-BR')} ruas cadastradas`
      : 'âš ï¸ Nenhuma rua importada ainda â€” autocomplete de endereÃ§o nÃ£o funcionarÃ¡';
    if (r.count === 0) {
      const btn = document.getElementById('btnImportStreets');
      if (btn) btn.style.animation = 'pulse 2s infinite';
    }
    return r.count || 0;
  } catch(e) { return 0; }
}

let _importPolling = null;

async function importStreets() {
  const btn    = document.getElementById('btnImportStreets');
  const prog   = document.getElementById('streetsProgress');
  const bar    = document.getElementById('streetsBar');
  const msg    = document.getElementById('streetsMsg');
  const status = document.getElementById('streetsStatus');

  btn.disabled = true;
  btn.textContent = 'â³ Importando...';
  btn.style.animation = 'none';
  prog.style.display = 'block';
  status.textContent = '';
  bar.style.background = '#6366f1';
  bar.style.width = '5%';
  msg.textContent = 'ğŸš€ Iniciando import em background...';

  try {
    // âœ… Worker responde imediatamente e processa em background (sem timeout)
    const r = await api('/api/streets/import', { method: 'POST' });

    if (r.error) throw new Error(r.error);

    // Se retornou resultado direto (import rÃ¡pido / jÃ¡ pronto)
    if (r.total) {
      bar.style.width = '100%';
      msg.textContent = `âœ… ${r.total.toLocaleString('pt-BR')} ruas importadas!`;
      status.textContent = `âœ… ${r.total.toLocaleString('pt-BR')} ruas cadastradas`;
      btn.disabled = false;
      btn.textContent = 'âœ… Importado!';
      setTimeout(() => { btn.textContent = 'â¬‡ï¸ Importar / Atualizar Ruas'; }, 5000);
      return;
    }

    // Import em background: polling a cada 3 segundos
    msg.textContent = 'â³ Processando via OpenStreetMap... aguarde ~60s';
    bar.style.width = '15%';

    let prevCount = 0;
    let stableRounds = 0;
    let elapsed = 0;
    const MAX_WAIT = 150; // 150s timeout

    if (_importPolling) clearInterval(_importPolling);
    _importPolling = setInterval(async () => {
      elapsed += 3;
      const count = await checkStreetsCount();

      if (count > 0) {
        // Progresso animado baseado no tempo (esperamos ~7000 ruas)
        const pct = Math.min(15 + Math.round((count / 7000) * 80), 95);
        bar.style.width = pct + '%';
        msg.textContent = `â³ ${count.toLocaleString('pt-BR')} ruas salvas... aguardando finalizar`;

        if (count === prevCount) {
          stableRounds++;
          if (stableRounds >= 2) {
            // Contagem estÃ¡vel = import finalizado
            clearInterval(_importPolling);
            _importPolling = null;
            bar.style.width = '100%';
            msg.textContent = `âœ… ${count.toLocaleString('pt-BR')} ruas importadas com sucesso!`;
            status.textContent = `âœ… ${count.toLocaleString('pt-BR')} ruas cadastradas`;
            btn.disabled = false;
            btn.textContent = 'âœ… Importado!';
            setTimeout(() => { btn.textContent = 'â¬‡ï¸ Importar / Atualizar Ruas'; }, 5000);
          }
        } else {
          stableRounds = 0;
        }
        prevCount = count;
      } else {
        // Ainda buscando do Overpass
        const pct = Math.min(5 + elapsed, 50);
        bar.style.width = pct + '%';
        msg.textContent = `ğŸŒ Buscando ruas via OpenStreetMap... (${elapsed}s)`;
      }

      if (elapsed >= MAX_WAIT) {
        clearInterval(_importPolling);
        _importPolling = null;
        if (count > 0) {
          bar.style.width = '100%';
          msg.textContent = `âœ… ${count.toLocaleString('pt-BR')} ruas importadas (timeout atingido)`;
          status.textContent = `âœ… ${count.toLocaleString('pt-BR')} ruas cadastradas`;
          btn.textContent = 'âœ… Importado!';
        } else {
          bar.style.background = '#dc2626';
          bar.style.width = '100%';
          msg.textContent = 'âŒ Timeout â€” OpenStreetMap nÃ£o respondeu. Tente novamente.';
          btn.textContent = 'â¬‡ï¸ Tentar novamente';
        }
        btn.disabled = false;
      }
    }, 3000);

  } catch(e) {
    bar.style.width = '100%';
    bar.style.background = '#dc2626';
    msg.textContent = 'âŒ ' + e.message;
    status.textContent = '';
    btn.disabled = false;
    btn.textContent = 'â¬‡ï¸ Tentar novamente';
  }
}

// â”€â”€ Teste de busca de ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testStreetSearch() {
  const q = document.getElementById('streetTestInput').value.trim();
  const el = document.getElementById('streetTestResult');
  if (!q) { el.innerHTML = '<span style="color:#dc2626">Digite uma rua para testar</span>'; return; }
  el.innerHTML = '<span style="color:#94a3b8">ğŸ” Buscando...</span>';
  try {
    const results = await api(`/api/streets/search?q=${encodeURIComponent(q)}`);
    if (!results || !results.length) {
      el.innerHTML = `<span style="color:#f97316">âš ï¸ Nenhuma rua encontrada para "${q}"</span>`;
    } else {
      el.innerHTML = `<span style="color:#16a34a">âœ… ${results.length} rua(s) encontrada(s):</span><br>` +
        results.slice(0,5).map(r => `<span style="color:#334155;margin-left:8px">â€¢ ${r.name}${r.bairro ? ' â€” ' + r.bairro : ''}</span>`).join('<br>');
    }
  } catch(e) {
    el.innerHTML = `<span style="color:#dc2626">âŒ ${e.message}</span>`;
  }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadDrivers();
checkStreetsCount();
</script>
</body>
</html>
