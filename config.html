<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Config ‚Äî MoskoG√°s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 640px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 20px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .card h2 { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 14px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }
  input:focus { outline: none; border-color: #f97316; }
  .btn { padding: 11px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-orange { background: #f97316; color: #fff; width: 100%; font-size: 16px; padding: 14px; }
  .btn-gray   { background: #e2e8f0; color: #1e293b; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .status { padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-top: 8px; }
  .status.ok  { background: #dcfce7; color: #16a34a; }
  .status.err { background: #fee2e2; color: #dc2626; }
  .driver-row { display: flex; gap: 8px; align-items: center; padding: 8px 12px; background: #f8fafc; border-radius: 8px; margin-bottom: 6px; font-size: 14px; }
  .driver-row span { flex: 1; }
  .driver-row small { color: #64748b; font-size: 12px; }
  table.drivers-tbl { width: 100%; border-collapse: collapse; font-size: 13px; }
  table.drivers-tbl td, table.drivers-tbl th { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; }
  table.drivers-tbl th { background: #f1f5f9; font-weight: 700; font-size: 11px; text-transform: uppercase; color: #64748b; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <h1>‚öôÔ∏è Configura√ß√µes</h1>

  <!-- API Key -->
  <div class="card">
    <h2>üîë Chave de Acesso (APP_API_KEY)</h2>
    <label>Chave configurada no Cloudflare Worker</label>
    <input type="password" id="apiKeyInput" placeholder="Cole a APP_API_KEY aqui">
    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="saveKey()">Salvar Chave</button>
      <button class="btn btn-green" onclick="testHealth()">üîç Testar Conex√£o</button>
    </div>
    <div id="health-status"></div>
  </div>

  <!-- Bling OAuth -->
  <div class="card">
    <h2>üîó Autoriza√ß√£o Bling</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">Conecte sua conta Bling para sincronizar contatos e pedidos. Voc√™ precisa ter o APP configurado no Bling com a URL de callback apontando para <code>https://api.moskogas.com.br/bling/oauth/callback</code></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank" class="btn btn-green" style="display:inline-block;text-decoration:none">üöÄ Autorizar no Bling</a>
      <button class="btn btn-gray" onclick="testBling()">üì° Testar Token Bling</button>
    </div>
    <div id="bling-status"></div>
  </div>

  <!-- Entregadores -->
  <div class="card">
    <h2>üöö Entregadores</h2>
    <div id="drivers-list" style="margin-bottom:14px"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
      <div>
        <label>Nome</label>
        <input id="dName" placeholder="Nome do entregador">
      </div>
      <div>
        <label>Telefone (5567999...)</label>
        <input id="dPhone" placeholder="5567999990001">
      </div>
    </div>
    <button class="btn btn-orange" onclick="addDriver()">‚ûï Adicionar Entregador</button>
  </div>

  <!-- Teste IzChat -->
  <div class="card">
    <h2>üì± Teste IzChat WhatsApp</h2>
    <label>N√∫mero para teste (ex: 5567999990000)</label>
    <input id="testTo" placeholder="5567999990000">
    <button class="btn btn-green" onclick="testIzChat()">üì≤ Enviar Mensagem Teste</button>
    <div id="izchat-status"></div>
  </div>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;

// Carregar chave salva
document.getElementById('apiKeyInput').value = localStorage.getItem('mg_api_key') || '';

function saveKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('mg_api_key', k);
  toast('‚úÖ Chave salva!');
}

async function testHealth() {
  const el = document.getElementById('health-status');
  el.innerHTML = '<div class="status">‚è≥ Testando...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/health');
    const d = await r.json();
    el.innerHTML = `<div class="status ok">‚úÖ API ok ‚Äî DB: ${d.hasDB ? '‚úÖ' : '‚ùå'} | Bucket: ${d.hasBucket ? '‚úÖ' : '‚ùå'}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">‚ùå ${e.message}</div>`;
  }
}

async function testBling() {
  const el = document.getElementById('bling-status');
  el.innerHTML = '<div class="status">‚è≥ Testando token Bling...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/bling/ping');
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">‚úÖ Bling conectado!</div>'
      : `<div class="status err">‚ùå Erro ${d.status} ‚Äî <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank">Re-autorizar</a></div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">‚ùå ${e.message}</div>`;
  }
}

async function testIzChat() {
  const to = document.getElementById('testTo').value.trim();
  const el = document.getElementById('izchat-status');
  if (!to) { toast('Informe o n√∫mero', 'error'); return; }
  el.innerHTML = '<div class="status">‚è≥ Enviando...</div>';
  try {
    const r = await fetch(`https://api.moskogas.com.br/izchat/teste?to=${to}`);
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">‚úÖ Mensagem enviada!</div>'
      : `<div class="status err">‚ùå ${JSON.stringify(d)}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">‚ùå ${e.message}</div>`;
  }
}

async function loadDrivers() {
  if (!apiKey()) { document.getElementById('drivers-list').innerHTML = '<p style="color:#94a3b8;font-size:13px">Salve a chave de acesso primeiro.</p>'; return; }
  const drivers = await api('/api/drivers').catch(() => []);
  const el = document.getElementById('drivers-list');
  if (!drivers.length) {
    el.innerHTML = '<p style="color:#94a3b8;font-size:13px">Nenhum entregador cadastrado.</p>';
    return;
  }
  el.innerHTML = `<table class="drivers-tbl">
    <thead><tr><th>Nome</th><th>Telefone</th><th>Ativo</th><th></th></tr></thead>
    <tbody>
    ${drivers.map(d => `
      <tr>
        <td><strong>${d.name}</strong></td>
        <td>${d.phone_e164}</td>
        <td>${d.active ? '‚úÖ' : '‚ùå'}</td>
        <td><button class="btn btn-gray" style="padding:4px 8px;font-size:12px" onclick="toggleDriver(${d.id}, ${d.active})">
          ${d.active ? 'Desativar' : 'Ativar'}
        </button></td>
      </tr>`).join('')}
    </tbody>
  </table>`;
}

async function addDriver() {
  const name  = document.getElementById('dName').value.trim();
  const phone = document.getElementById('dPhone').value.trim().replace(/\D/g, '');
  if (!name || !phone) { toast('Nome e telefone obrigat√≥rios', 'error'); return; }
  try {
    await api('/api/drivers', { method: 'POST', body: JSON.stringify({ name, phone_e164: phone }) });
    toast('‚úÖ Entregador adicionado!');
    document.getElementById('dName').value = '';
    document.getElementById('dPhone').value = '';
    loadDrivers();
  } catch(e) { toast(e.message, 'error'); }
}

async function toggleDriver(id, active) {
  try {
    await api(`/api/drivers/${id}`, { method: 'PATCH', body: JSON.stringify({ active: !active }) });
    loadDrivers();
  } catch(e) { toast(e.message, 'error'); }
}

loadDrivers();
checkStreetsCount();

async function checkStreetsCount() {
  try {
    const r = await api('/api/streets/count');
    const el = document.getElementById('streetsStatus');
    if (el) el.textContent = r.count > 0
      ? `‚úÖ ${r.count.toLocaleString('pt-BR')} ruas cadastradas`
      : '‚ö†Ô∏è Nenhuma rua importada ainda ‚Äî autocomplete de endere√ßo n√£o funcionar√°';
    if (r.count === 0) {
      const btn = document.getElementById('btnImportStreets');
      if (btn) btn.style.animation = 'pulse 2s infinite';
    }
  } catch(e) {}
}

async function importStreets() {
  const btn    = document.getElementById('btnImportStreets');
  const prog   = document.getElementById('streetsProgress');
  const bar    = document.getElementById('streetsBar');
  const msg    = document.getElementById('streetsMsg');
  const status = document.getElementById('streetsStatus');

  btn.disabled = true;
  btn.textContent = '‚è≥ Importando...';
  prog.style.display = 'block';
  status.textContent = '';
  bar.style.background = '#6366f1';

  function setProgress(pct, txt) {
    bar.style.width = pct + '%';
    msg.textContent = txt;
  }

  try {
    setProgress(10, 'üåê Buscando ruas via OpenStreetMap (Worker)...');

    // Worker faz o fetch do Overpass (sem CORS) e salva direto no D1
    const r = await api('/api/streets/import', { method: 'POST' });

    if (r.error) throw new Error(r.error);

    setProgress(100, `‚úÖ ${r.total?.toLocaleString('pt-BR')} ruas importadas com sucesso!`);
    status.textContent = `‚úÖ ${r.total?.toLocaleString('pt-BR')} ruas cadastradas`;
    btn.textContent = '‚úÖ Importado!';
    setTimeout(() => { btn.disabled = false; btn.textContent = '‚¨áÔ∏è Importar / Atualizar Ruas'; }, 5000);

  } catch(e) {
    bar.style.width = '100%';
    bar.style.background = '#dc2626';
    msg.textContent = '‚ùå ' + e.message;
    status.textContent = '';
    btn.disabled = false;
    btn.textContent = '‚¨áÔ∏è Tentar novamente';
  }
}
</script>

  <!-- Ruas de Campo Grande -->
  <div class="card">
    <h2>üó∫Ô∏è Banco de Ruas ‚Äî Campo Grande/MS</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">
      Importa todas as ruas de Campo Grande via OpenStreetMap. Precisa fazer <strong>apenas uma vez</strong> (ou quando quiser atualizar).
      Leva ~30 segundos. Depois o autocomplete de endere√ßo funciona com qualquer palavra ‚Äî "rio", "mato", "av", etc.
    </p>
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <button onclick="importStreets()" id="btnImportStreets"
        style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;font-weight:700;cursor:pointer">
        ‚¨áÔ∏è Importar / Atualizar Ruas
      </button>
      <div id="streetsStatus" style="font-size:13px;color:#64748b"></div>
    </div>
    <div id="streetsProgress" style="display:none;margin-top:12px">
      <div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden">
        <div id="streetsBar" style="background:#6366f1;height:100%;width:0%;transition:width 0.5s"></div>
      </div>
      <div id="streetsMsg" style="font-size:12px;color:#64748b;margin-top:6px">Conectando ao OpenStreetMap...</div>
    </div>
  </div>

</body>
</html>
