<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Config v2.9.1 â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 640px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 20px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .card h2 { font-size: 15px; font-weight: 700; color: #1e293b; margin-bottom: 14px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }
  input:focus { outline: none; border-color: #f97316; }
  .btn { padding: 11px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-orange { background: #f97316; color: #fff; width: 100%; font-size: 16px; padding: 14px; }
  .btn-gray   { background: #e2e8f0; color: #1e293b; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .status { padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-top: 8px; }
  .status.ok  { background: #dcfce7; color: #16a34a; }
  .status.err { background: #fee2e2; color: #dc2626; }
  /* Entregadores removido v2.5.0 â€” gerenciar em UsuÃ¡rios */
  .version-badge { font-size: 10px; color: #94a3b8; text-align: right; padding: 4px 0 10px; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.6} }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <div class="version-badge">v2.9.1 â€” config</div>
  <h1>âš™ï¸ ConfiguraÃ§Ãµes v2.9.1</h1>

  <!-- API Key (admin only) -->
  <div class="card" id="apiKeySection">
    <h2>ğŸ”‘ Chave de Acesso (APP_API_KEY)</h2>
    <label>Chave configurada no Cloudflare Worker</label>
    <input type="password" id="apiKeyInput" placeholder="Cole a APP_API_KEY aqui">
    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="saveKey()">Salvar Chave</button>
      <button class="btn btn-green" onclick="testHealth()">ğŸ” Testar ConexÃ£o</button>
    </div>
    <div id="health-status"></div>
  </div>

  <!-- Bling OAuth -->
  <div class="card">
    <h2>ğŸ”— AutorizaÃ§Ã£o Bling</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:12px">Conecte sua conta Bling para sincronizar contatos e pedidos. VocÃª precisa ter o APP configurado no Bling com a URL de callback apontando para <code>https://api.moskogas.com.br/bling/oauth/callback</code></p>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank" class="btn btn-green" style="display:inline-block;text-decoration:none">ğŸš€ Autorizar no Bling</a>
      <button class="btn btn-gray" onclick="testBling()">ğŸ“¡ Testar Token Bling</button>
    </div>
    <div id="bling-status"></div>
  </div>

  <!-- Entregadores: gerenciar em UsuÃ¡rios (app_users) -->

  <!-- Teste IzChat -->
  <div class="card">
    <h2>ğŸ“± Teste IzChat WhatsApp</h2>
    <label>NÃºmero para teste (ex: 5567999990000)</label>
    <input id="testTo" placeholder="5567999990000">
    <button class="btn btn-green" onclick="testIzChat()">ğŸ“² Enviar Mensagem Teste</button>
    <div id="izchat-status"></div>
  </div>

  <!-- Config Foto Comprovante -->
  <div class="card">
    <h2>ğŸ“¸ Foto Comprovante (Entregador)</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:14px">Ajuste a compressÃ£o da foto tirada pelo entregador ao marcar entrega. Fotos sÃ£o sempre de recibos/texto.</p>

    <label>Formato de imagem</label>
    <select id="fotoFormato" style="margin-bottom:12px">
      <option value="webp">ğŸ“„ WebP â€” Melhor para texto (recomendado)</option>
      <option value="jpeg">ğŸ“· JPEG â€” Compatibilidade mÃ¡xima</option>
      <option value="png">ğŸ–¼ï¸ PNG â€” Sem perda (arquivo grande)</option>
    </select>

    <label>DimensÃ£o mÃ¡xima (px): <strong id="maxDimVal">1200</strong></label>
    <input type="range" id="fotoMaxDim" min="400" max="1600" step="100" value="1200" oninput="document.getElementById('maxDimVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>400px</span><span>800</span><span>1200</span><span>1600px</span></div>

    <label>Qualidade (%): <strong id="qualityVal">85</strong> <span id="qualityHint" style="font-size:11px;color:#94a3b8">(ignorado para PNG)</span></label>
    <input type="range" id="fotoQuality" min="20" max="95" step="5" value="85" oninput="document.getElementById('qualityVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>20%</span><span>55%</span><span>85%</span><span>95%</span></div>

    <label>DesaturaÃ§Ã£o (%): <strong id="desatVal">50</strong></label>
    <input type="range" id="fotoDesat" min="0" max="100" step="10" value="50" oninput="document.getElementById('desatVal').textContent=this.value" style="padding:0;border:none">
    <div style="display:flex;justify-content:space-between;font-size:11px;color:#94a3b8;margin:-8px 0 12px"><span>0% (cor)</span><span>50%</span><span>100% (P&B)</span></div>

    <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:12px">
      <label style="display:inline;cursor:pointer;margin:0"><input type="checkbox" id="fotoContraste" checked style="width:auto;margin-right:6px">Auto-contraste</label>
      <label style="display:inline;cursor:pointer;margin:0"><input type="checkbox" id="fotoSharpen" checked style="width:auto;margin-right:6px">Nitidez (sharpen) â€” melhora legibilidade de texto</label>
    </div>

    <div style="display:flex;gap:8px">
      <button class="btn btn-orange" onclick="salvarFotoConfig()" style="flex:1">ğŸ’¾ Salvar</button>
      <button class="btn btn-gray" onclick="resetFotoConfig()">ğŸ”„ PadrÃ£o</button>
    </div>
    <div id="foto-config-status"></div>
  </div>

  <!-- PermissÃµes Atendente (admin only) -->
  <div class="card" id="permissoesSection">
    <h2>ğŸ” PermissÃµes do Atendente</h2>
    <p style="font-size:13px;color:#64748b;margin-bottom:14px">Defina o que atendentes podem fazer. Admin sempre tem acesso total.</p>

    <div style="display:flex;flex-direction:column;gap:10px">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permReabrirEntregue" checked style="width:auto;margin:0"> Reabrir pedido <strong>entregue</strong>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permReabrirCancelado" style="width:auto;margin:0"> Reabrir pedido <strong>cancelado</strong>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permCancelar" checked style="width:auto;margin:0"> Cancelar pedido
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin:0;text-transform:none;font-size:14px;font-weight:500;color:#334155">
        <input type="checkbox" id="permEditarEntregue" style="width:auto;margin:0"> Editar pedido <strong>entregue</strong>
      </label>
    </div>

    <div style="background:#fef3c7;border-radius:8px;padding:10px 12px;font-size:12px;color:#92400e;margin-top:12px">
      âš ï¸ Quando atendente reabrir/cancelar, admin recebe alerta WhatsApp automÃ¡tico.
    </div>

    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-orange" onclick="salvarPermissoes()" style="flex:1">ğŸ’¾ Salvar PermissÃµes</button>
    </div>
    <div id="perm-status"></div>
  </div>

  <!-- Lembretes PIX (admin only) -->
  <div class="card" id="lembreteSection">
    <h2>ğŸ“± Lembretes PIX (WhatsApp)</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">ConfiguraÃ§Ã£o de lembretes automÃ¡ticos para PIX a receber pendentes.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="lemb-ativo" style="width:18px;height:18px">
        <span style="font-size:13px;font-weight:600">Lembretes ativos</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px">
        <input type="checkbox" id="lemb-cron" style="width:18px;height:18px">
        <span style="font-size:13px;font-weight:600">Envio automÃ¡tico (cron)</span>
      </label>
      <label style="font-size:13px">
        â±ï¸ Intervalo entre lembretes (horas)
        <input type="number" id="lemb-intervalo" min="1" max="168" value="24" style="width:80px;margin-top:4px">
      </label>
      <label style="font-size:13px">
        ğŸ”¢ MÃ¡ximo de lembretes por pedido
        <input type="number" id="lemb-max" min="1" max="10" value="3" style="width:80px;margin-top:4px">
      </label>
      <label style="font-size:13px">
        ğŸ• Hora do envio automÃ¡tico (UTC)
        <select id="lemb-hora" style="margin-top:4px">
          <option value="10">10:00 UTC (07:00 BRT)</option>
          <option value="11">11:00 UTC (08:00 BRT)</option>
          <option value="12">12:00 UTC (09:00 BRT)</option>
          <option value="13">13:00 UTC (10:00 BRT)</option>
          <option value="14" selected>14:00 UTC (11:00 BRT)</option>
          <option value="15">15:00 UTC (12:00 BRT)</option>
          <option value="16">16:00 UTC (13:00 BRT)</option>
          <option value="17">17:00 UTC (14:00 BRT)</option>
          <option value="18">18:00 UTC (15:00 BRT)</option>
        </select>
      </label>
    </div>
    <label style="font-size:13px;display:block;margin-top:12px">
      ğŸ’¬ Mensagem do lembrete
      <span style="font-size:10px;color:#94a3b8;display:block;margin:4px 0">VariÃ¡veis: {nome}, {id}, {itens}, {valor}, {data_entrega}</span>
      <textarea id="lemb-mensagem" rows="6" style="width:100%;font-size:13px;border:2px solid #e2e8f0;border-radius:8px;padding:10px;margin-top:4px;resize:vertical"></textarea>
    </label>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-orange" onclick="salvarLembreteConfig()" style="flex:1">ğŸ’¾ Salvar Config Lembretes</button>
    </div>
    <div id="lemb-status"></div>
  </div>

  <!-- Produtos MoskoGÃ¡s -->
  <div class="card" id="productsSection">
    <h2>ğŸ“¦ Produtos MoskoGÃ¡s</h2>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:12px">Cadastre produtos com preÃ§o sugerido. Marque â­ para aparecer como atalho rÃ¡pido na tela de pedido.</p>

    <!-- Importar do Bling -->
    <div style="position:relative;margin-bottom:12px">
      <input id="prodBlingSearch" placeholder="ğŸ” Importar produto do Bling..." oninput="searchBlingProduct(this.value)" autocomplete="off" style="margin-bottom:0">
      <div id="prodBlingSuggestions" style="display:none;position:absolute;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:200px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,0.1)"></div>
    </div>

    <!-- Lista de produtos -->
    <div id="appProductsList" style="min-height:40px">
      <div style="color:#94a3b8;text-align:center;padding:16px;font-size:13px">â³ Carregando produtos...</div>
    </div>

    <!-- Adicionar manual -->
    <div style="margin-top:10px;border-top:1px solid #e2e8f0;padding-top:10px">
      <button onclick="showAddProductModal()" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:6px 14px;font-size:12px;cursor:pointer;font-weight:600;color:#334155">â• Cadastrar Produto Manual</button>
    </div>
  </div>

  <!-- Modal Editar Produto -->
  <div id="productModal" style="display:none;position:fixed;inset:0;z-index:999;background:rgba(0,0,0,0.5);display:none;justify-content:center;align-items:center">
    <div style="background:#fff;border-radius:12px;padding:20px;width:90%;max-width:400px;box-shadow:0 8px 24px rgba(0,0,0,0.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <h3 id="productModalTitle" style="margin:0;font-size:16px">Editar Produto</h3>
        <button onclick="closeProductModal()" style="background:none;border:none;font-size:20px;cursor:pointer;color:#94a3b8">âœ•</button>
      </div>
      <input id="pm_id" type="hidden">
      <input id="pm_bling_id" type="hidden">
      <div style="margin-bottom:8px"><label style="font-size:12px;font-weight:600;color:#64748b">Nome</label><input id="pm_name" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"></div>
      <div style="display:flex;gap:8px;margin-bottom:8px">
        <div style="flex:1"><label style="font-size:12px;font-weight:600;color:#64748b">CÃ³digo</label><input id="pm_code" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px"></div>
        <div style="flex:1"><label style="font-size:12px;font-weight:600;color:#64748b">PreÃ§o Sugerido (R$)</label><input id="pm_price" type="text" inputmode="decimal" style="width:100%;padding:8px;border:1px solid #e2e8f0;border-radius:6px;font-size:14px;font-weight:700"></div>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:12px">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input id="pm_favorite" type="checkbox"> â­ Favorito (atalho no pedido)</label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;cursor:pointer"><input id="pm_ativo" type="checkbox" checked> Ativo</label>
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button onclick="closeProductModal()" style="background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:8px 16px;font-size:13px;cursor:pointer">Cancelar</button>
        <button onclick="saveProduct()" style="background:#f97316;color:#fff;border:none;border-radius:6px;padding:8px 16px;font-size:13px;font-weight:700;cursor:pointer">ğŸ’¾ Salvar</button>
      </div>
    </div>
  </div>

  <!-- Autocomplete de Ruas -->
  <div class="card">
    <h2>ğŸ—ºï¸ Autocomplete de EndereÃ§o</h2>

    <div id="streetsStatus" style="font-size:13px;color:#64748b;margin-bottom:12px">â³ Verificando banco local...</div>

    <div style="background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;padding:12px;font-size:13px;color:#1e40af;margin-bottom:14px">
      âœ… <strong>Nominatim ao vivo ativado</strong> â€” autocomplete jÃ¡ funciona sem importar nada!<br>
      <span style="font-size:12px;color:#3b82f6">O Worker busca ruas via OpenStreetMap em tempo real. O banco local (import) Ã© opcional e torna a busca mais rÃ¡pida.</span>
    </div>

    <div style="display:flex;gap:8px;margin-bottom:10px">
      <input id="streetTestInput" placeholder="Teste: digite 'Rio Branco' ou 'Afonso Pena'" style="flex:1;margin-bottom:0">
      <button onclick="testStreetSearch()" class="btn btn-green" style="white-space:nowrap;padding:10px 16px">ğŸ” Testar</button>
    </div>
    <div id="streetTestResult" style="font-size:13px;min-height:20px"></div>

    <details style="margin-top:16px">
      <summary style="cursor:pointer;font-size:13px;color:#64748b;font-weight:600;user-select:none">âš™ï¸ Import local (opcional â€” busca instantÃ¢nea)</summary>
      <div style="margin-top:10px;padding-top:10px;border-top:1px solid #f1f5f9">
        <p style="font-size:12px;color:#94a3b8;margin-bottom:10px">Importa todas as ruas de Campo Grande para o banco D1. Pode demorar 2â€“3 minutos.</p>
        <button onclick="importStreets()" id="btnImportStreets"
          style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-size:14px;font-weight:700;cursor:pointer">
          â¬‡ï¸ Importar Ruas de CG
        </button>
        <div id="streetsProgress" style="display:none;margin-top:12px">
          <div style="background:#e2e8f0;border-radius:99px;height:8px;overflow:hidden">
            <div id="streetsBar" style="background:#6366f1;height:100%;width:0%;transition:width 0.5s"></div>
          </div>
          <div id="streetsMsg" style="font-size:12px;color:#64748b;margin-top:6px">Aguardando...</div>
        </div>
      </div>
    </details>
  </div>

</div><!-- /container -->

<script src="shared.js"></script>
<script>
checkAuth(['admin', 'atendente']);
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;

// Esconder seÃ§Ãµes admin-only para atendente
const _cfgUser = getCurrentUser();
if (_cfgUser && _cfgUser.role !== 'admin') {
  const apiSec = document.getElementById('apiKeySection');
  if (apiSec) apiSec.style.display = 'none';
  const permSec = document.getElementById('permissoesSection');
  if (permSec) permSec.style.display = 'none';
}

document.getElementById('apiKeyInput').value = localStorage.getItem('mg_api_key') || '';

function saveKey() {
  const k = document.getElementById('apiKeyInput').value.trim();
  localStorage.setItem('mg_api_key', k);
  toast('âœ… Chave salva!');
}

async function testHealth() {
  const el = document.getElementById('health-status');
  el.innerHTML = '<div class="status">â³ Testando...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/health');
    const d = await r.json();
    el.innerHTML = `<div class="status ok">âœ… API ok â€” DB: ${d.hasDB ? 'âœ…' : 'âŒ'} | Bucket: ${d.hasBucket ? 'âœ…' : 'âŒ'}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testBling() {
  const el = document.getElementById('bling-status');
  el.innerHTML = '<div class="status">â³ Testando token Bling...</div>';
  try {
    const r = await fetch('https://api.moskogas.com.br/bling/ping');
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Bling conectado!</div>'
      : `<div class="status err">âŒ Erro ${d.status} â€” <a href="https://api.moskogas.com.br/bling/oauth/start" target="_blank">Re-autorizar</a></div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

async function testIzChat() {
  const to = document.getElementById('testTo').value.trim();
  const el = document.getElementById('izchat-status');
  if (!to) { toast('Informe o nÃºmero', 'error'); return; }
  el.innerHTML = '<div class="status">â³ Enviando...</div>';
  try {
    const r = await fetch(`https://api.moskogas.com.br/izchat/teste?to=${to}`);
    const d = await r.json();
    el.innerHTML = d.ok
      ? '<div class="status ok">âœ… Mensagem enviada!</div>'
      : `<div class="status err">âŒ ${JSON.stringify(d)}</div>`;
  } catch(e) {
    el.innerHTML = `<div class="status err">âŒ ${e.message}</div>`;
  }
}

// [REMOVIDO v2.5.0] loadDrivers/addDriver/toggleDriver â€” entregadores via UsuÃ¡rios (app_users)

// â”€â”€ Banco de Ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function checkStreetsCount() {
  try {
    const r = await api('/api/streets/count');
    const el = document.getElementById('streetsStatus');
    if (el) el.textContent = r.count > 0
      ? `âœ… ${r.count.toLocaleString('pt-BR')} ruas cadastradas`
      : 'âš ï¸ Nenhuma rua importada ainda â€” autocomplete de endereÃ§o nÃ£o funcionarÃ¡';
    if (r.count === 0) {
      const btn = document.getElementById('btnImportStreets');
      if (btn) btn.style.animation = 'pulse 2s infinite';
    }
    return r.count || 0;
  } catch(e) { return 0; }
}

// â”€â”€ Import letra por letra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LETRAS = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'.split('');
let _importRunning = false;

async function importStreets() {
  if (_importRunning) return;
  _importRunning = true;

  const btn  = document.getElementById('btnImportStreets');
  const prog = document.getElementById('streetsProgress');
  const bar  = document.getElementById('streetsBar');
  const msg  = document.getElementById('streetsMsg');

  btn.disabled = true;
  btn.textContent = 'â³ Importando...';
  prog.style.display = 'block';
  bar.style.background = '#6366f1';
  bar.style.width = '2%';
  msg.textContent = 'ğŸš€ Iniciando import letra por letra...';

  let totalRuas = 0;
  const erros = [];

  for (let i = 0; i < LETRAS.length; i++) {
    const letra = LETRAS[i];
    const pct = Math.round(((i) / LETRAS.length) * 95) + 2;
    bar.style.width = pct + '%';
    msg.textContent = `ğŸ“¥ Buscando letra ${letra}... (${i+1}/${LETRAS.length}) â€” ${totalRuas.toLocaleString('pt-BR')} ruas salvas`;

    let ok = false;
    let tentativas = 0;
    while (!ok && tentativas < 3) {
      tentativas++;
      try {
        const r = await api('/api/streets/import-letter', {
          method: 'POST',
          body: JSON.stringify({ letter: letra, first: (i === 0 && tentativas === 1) })
        });
        if (r.ok) {
          totalRuas = r.total || totalRuas;
          ok = true;
        } else {
          throw new Error(r.error || 'Erro desconhecido');
        }
      } catch(e) {
        if (tentativas < 3) {
          msg.textContent = `âš ï¸ Letra ${letra}: ${e.message} â€” tentativa ${tentativas+1}/3...`;
          await new Promise(res => setTimeout(res, 3000));
        } else {
          erros.push(letra);
        }
      }
    }
  }

  // Finalizado
  _importRunning = false;
  bar.style.width = '100%';

  const statusEl = document.getElementById('streetsStatus');
  if (erros.length === 0) {
    bar.style.background = '#16a34a';
    msg.textContent = `âœ… ${totalRuas.toLocaleString('pt-BR')} ruas importadas com sucesso!`;
    statusEl.textContent = `âœ… ${totalRuas.toLocaleString('pt-BR')} ruas cadastradas`;
    btn.textContent = 'âœ… Importado!';
    setTimeout(() => { btn.disabled = false; btn.textContent = 'â¬‡ï¸ Reimportar'; }, 4000);
  } else {
    bar.style.background = '#f97316';
    msg.textContent = `âš ï¸ ${totalRuas.toLocaleString('pt-BR')} ruas salvas. Letras com erro: ${erros.join(', ')} â€” clique para tentar novamente`;
    statusEl.textContent = `âš ï¸ ${totalRuas.toLocaleString('pt-BR')} ruas (incompleto)`;
    btn.disabled = false;
    btn.textContent = 'ğŸ”„ Tentar letras com erro';
  }
}

// â”€â”€ Teste de busca de ruas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function testStreetSearch() {
  const q = document.getElementById('streetTestInput').value.trim();
  const el = document.getElementById('streetTestResult');
  if (!q) { el.innerHTML = '<span style="color:#dc2626">Digite uma rua para testar</span>'; return; }
  el.innerHTML = '<span style="color:#94a3b8">ğŸ” Buscando...</span>';
  try {
    const results = await api(`/api/streets/search?q=${encodeURIComponent(q)}`);
    if (!results || !results.length) {
      el.innerHTML = `<span style="color:#f97316">âš ï¸ Nenhuma rua encontrada para "${q}"</span>`;
    } else {
      el.innerHTML = `<span style="color:#16a34a">âœ… ${results.length} rua(s) encontrada(s):</span><br>` +
        results.slice(0,5).map(r => `<span style="color:#334155;margin-left:8px">â€¢ ${r.name}${r.bairro ? ' â€” ' + r.bairro : ''}</span>`).join('<br>');
    }
  } catch(e) {
    el.innerHTML = `<span style="color:#dc2626">âŒ ${e.message}</span>`;
  }
}

// â”€â”€ PermissÃµes Atendente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregarPermissoes() {
  try {
    const data = await api('/api/config?key=permissoes');
    if (data?.value) {
      const p = data.value;
      if (p.atendente_reabrir_entregue !== undefined) document.getElementById('permReabrirEntregue').checked = p.atendente_reabrir_entregue;
      if (p.atendente_reabrir_cancelado !== undefined) document.getElementById('permReabrirCancelado').checked = p.atendente_reabrir_cancelado;
      if (p.atendente_cancelar !== undefined) document.getElementById('permCancelar').checked = p.atendente_cancelar;
      if (p.atendente_editar_entregue !== undefined) document.getElementById('permEditarEntregue').checked = p.atendente_editar_entregue;
    }
  } catch(_) {}
}

async function salvarPermissoes() {
  const perms = {
    atendente_reabrir_entregue: document.getElementById('permReabrirEntregue').checked,
    atendente_reabrir_cancelado: document.getElementById('permReabrirCancelado').checked,
    atendente_cancelar: document.getElementById('permCancelar').checked,
    atendente_editar_entregue: document.getElementById('permEditarEntregue').checked,
  };
  const el = document.getElementById('perm-status');
  showLoading('Salvando permissÃµes...');
  try {
    await api('/api/config', { method: 'POST', body: JSON.stringify({ key: 'permissoes', value: perms }) });
    el.innerHTML = '<div class="status ok">âœ… PermissÃµes salvas!</div>';
    setTimeout(() => el.innerHTML = '', 3000);
  } catch(e) {
    el.innerHTML = '<div class="status err">âŒ ' + e.message + '</div>';
  } finally { hideLoading(); }
}

// â”€â”€ Foto Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function carregarFotoConfig() {
  try {
    const data = await api('/api/config?key=foto_config');
    if (data?.value) {
      const c = data.value;
      if (c.formato) { document.getElementById('fotoFormato').value = c.formato; }
      if (c.maxDim) { document.getElementById('fotoMaxDim').value = c.maxDim; document.getElementById('maxDimVal').textContent = c.maxDim; }
      if (c.quality) { document.getElementById('fotoQuality').value = c.quality; document.getElementById('qualityVal').textContent = c.quality; }
      if (c.desaturacao !== undefined) { document.getElementById('fotoDesat').value = c.desaturacao; document.getElementById('desatVal').textContent = c.desaturacao; }
      if (c.contraste !== undefined) { document.getElementById('fotoContraste').checked = c.contraste; }
      if (c.sharpen !== undefined) { document.getElementById('fotoSharpen').checked = c.sharpen; }
    }
  } catch(_) {}
}

async function salvarFotoConfig() {
  const config = {
    formato: document.getElementById('fotoFormato').value,
    maxDim: parseInt(document.getElementById('fotoMaxDim').value),
    quality: parseInt(document.getElementById('fotoQuality').value),
    desaturacao: parseInt(document.getElementById('fotoDesat').value),
    contraste: document.getElementById('fotoContraste').checked,
    sharpen: document.getElementById('fotoSharpen').checked,
  };
  const el = document.getElementById('foto-config-status');
  showLoading('Salvando configuraÃ§Ã£o de foto...');
  try {
    await api('/api/config', { method: 'POST', body: JSON.stringify({ key: 'foto_config', value: config }) });
    el.innerHTML = '<div class="status ok">âœ… ConfiguraÃ§Ã£o salva! Entregadores usarÃ£o na prÃ³xima foto.</div>';
    setTimeout(() => el.innerHTML = '', 3000);
  } catch(e) {
    el.innerHTML = '<div class="status err">âŒ ' + e.message + '</div>';
  } finally { hideLoading(); }
}

function resetFotoConfig() {
  document.getElementById('fotoFormato').value = 'webp';
  document.getElementById('fotoMaxDim').value = 1200; document.getElementById('maxDimVal').textContent = '1200';
  document.getElementById('fotoQuality').value = 85; document.getElementById('qualityVal').textContent = '85';
  document.getElementById('fotoDesat').value = 50; document.getElementById('desatVal').textContent = '50';
  document.getElementById('fotoContraste').checked = true;
  document.getElementById('fotoSharpen').checked = true;
}

// â”€â”€ Produtos Favoritos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ PRODUTOS MOSKOGAS (preÃ§os sugeridos + favoritos) â”€â”€â”€â”€â”€â”€â”€â”€â”€
let _appProducts = [];
let _blingSearchTimer;
let _blingSearchResults = [];

async function loadAppProducts() {
  try {
    _appProducts = await api('/api/app-products');
    renderAppProducts();
  } catch(e) {
    document.getElementById('appProductsList').innerHTML = `<div style="color:#dc2626;font-size:13px;padding:12px">âŒ ${e.message}</div>`;
  }
}

function renderAppProducts() {
  const el = document.getElementById('appProductsList');
  if (!_appProducts.length) {
    el.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:16px;font-size:13px">Nenhum produto cadastrado. Importe do Bling ou cadastre manualmente.</div>';
    return;
  }
  el.innerHTML = `
    <div style="display:grid;grid-template-columns:1fr auto auto auto auto;gap:0;font-size:12px;font-weight:700;color:#64748b;padding:6px 10px;border-bottom:2px solid #e2e8f0">
      <span>Produto</span><span style="text-align:center;width:50px">CÃ³digo</span><span style="text-align:right;width:80px">PreÃ§o</span><span style="text-align:center;width:40px">â­</span><span style="width:60px"></span>
    </div>
  ` + _appProducts.map(p => `
    <div style="display:grid;grid-template-columns:1fr auto auto auto auto;gap:0;align-items:center;padding:8px 10px;border-bottom:1px solid #f1f5f9;${!p.ativo?'opacity:0.4':''}">
      <span style="font-size:13px;font-weight:600">${p.name}</span>
      <span style="font-size:11px;color:#94a3b8;text-align:center;width:50px">${p.code||'-'}</span>
      <span style="font-size:13px;font-weight:800;color:#f97316;text-align:right;width:80px">R$ ${parseFloat(p.price||0).toFixed(2)}</span>
      <span style="text-align:center;width:40px">${p.is_favorite?'â­':''}</span>
      <span style="display:flex;gap:4px;width:60px">
        <button onmousedown="event.preventDefault();editProduct(${p.id})" style="background:#e0f2fe;color:#0369a1;border:none;border-radius:4px;padding:3px 6px;font-size:11px;cursor:pointer" title="Editar">âœï¸</button>
        <button onmousedown="event.preventDefault();deleteProduct(${p.id})" style="background:#fee2e2;color:#dc2626;border:none;border-radius:4px;padding:3px 6px;font-size:11px;cursor:pointer" title="Excluir">ğŸ—‘ï¸</button>
      </span>
    </div>
  `).join('');
}

function searchBlingProduct(q) {
  clearTimeout(_blingSearchTimer);
  const box = document.getElementById('prodBlingSuggestions');
  if (q.length < 2) { box.style.display = 'none'; return; }
  box.style.display = 'block';
  box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">ğŸ” Buscando no Bling...</div>';
  _blingSearchTimer = setTimeout(async () => {
    try {
      const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`);
      if (!list || !list.length) {
        box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">Nenhum produto encontrado</div>';
        _blingSearchResults = [];
        return;
      }
      _blingSearchResults = list;
      const existIds = new Set(_appProducts.map(p => String(p.bling_id)));
      box.innerHTML = list.map((p, i) => {
        const exists = existIds.has(String(p.id));
        return `<div onmousedown="${exists ? '' : `event.preventDefault();importBlingProduct(${i})`}"
          style="padding:10px 14px;cursor:${exists ? 'default' : 'pointer'};display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #f1f5f9;${exists ? 'opacity:0.5' : ''};background:#fff;"
          ${!exists ? 'onmouseover="this.style.background=\'#fff7ed\'" onmouseout="this.style.background=\'#fff\'"' : ''}>
          <span><strong>${p.name||'Produto'}</strong> ${p.code ? `<small style="color:#94a3b8">(${p.code})</small>` : ''}</span>
          <span style="font-weight:700;color:${exists ? '#94a3b8' : '#f97316'};font-size:13px">${exists ? 'âœ… JÃ¡ cadastrado' : 'R$ ' + parseFloat(p.price||0).toFixed(2) + ' â•'}</span>
        </div>`;
      }).join('');
    } catch(e) {
      box.innerHTML = `<div style="padding:10px 14px;color:#dc2626;font-size:12px">âŒ ${e.message}</div>`;
      _blingSearchResults = [];
    }
  }, 350);
}

async function importBlingProduct(idx) {
  const p = _blingSearchResults[idx];
  if (!p) return;
  try {
    await api('/api/app-products/import-bling', {
      method: 'POST',
      body: JSON.stringify({ bling_id: String(p.id), name: p.name, code: p.code || '', price: p.price || 0, is_favorite: false })
    });
    document.getElementById('prodBlingSearch').value = '';
    document.getElementById('prodBlingSuggestions').style.display = 'none';
    _appProducts.push({ id: Date.now(), bling_id: String(p.id), name: p.name, code: p.code||'', price: p.price||0, is_favorite: 0, ativo: 1 });
    renderAppProducts();
    toast('ğŸ“¦ Produto importado!', 'success');
    setTimeout(() => loadAppProducts(), 500);
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
}

function showAddProductModal() {
  document.getElementById('pm_id').value = '';
  document.getElementById('pm_bling_id').value = '';
  document.getElementById('pm_name').value = '';
  document.getElementById('pm_code').value = '';
  document.getElementById('pm_price').value = '';
  document.getElementById('pm_favorite').checked = false;
  document.getElementById('pm_ativo').checked = true;
  document.getElementById('productModalTitle').textContent = 'Novo Produto';
  document.getElementById('productModal').style.display = 'flex';
}

function editProduct(id) {
  const p = _appProducts.find(x => x.id === id);
  if (!p) return;
  document.getElementById('pm_id').value = p.id;
  document.getElementById('pm_bling_id').value = p.bling_id || '';
  document.getElementById('pm_name').value = p.name;
  document.getElementById('pm_code').value = p.code || '';
  document.getElementById('pm_price').value = parseFloat(p.price||0).toFixed(2);
  document.getElementById('pm_favorite').checked = !!p.is_favorite;
  document.getElementById('pm_ativo').checked = p.ativo !== 0;
  document.getElementById('productModalTitle').textContent = 'Editar Produto';
  document.getElementById('productModal').style.display = 'flex';
}

function closeProductModal() {
  document.getElementById('productModal').style.display = 'none';
}

function _parsePrice(val) {
  if (typeof val !== 'string') val = String(val || '0');
  val = val.trim().replace(/\s/g, '');
  if (val.includes(',')) val = val.replace('.', '').replace(',', '.');
  return parseFloat(val) || 0;
}

async function saveProduct() {
  const id = document.getElementById('pm_id').value;
  const data = {
    bling_id: document.getElementById('pm_bling_id').value || null,
    name: document.getElementById('pm_name').value.trim(),
    code: document.getElementById('pm_code').value.trim(),
    price: _parsePrice(document.getElementById('pm_price').value),
    is_favorite: document.getElementById('pm_favorite').checked ? 1 : 0,
    ativo: document.getElementById('pm_ativo').checked ? 1 : 0
  };
  if (!data.name) { toast('âŒ Nome obrigatÃ³rio', 'error'); return; }
  if (id) data.id = parseInt(id);
  showLoading('Salvando produto...');
  try {
    await api('/api/app-products', { method: 'POST', body: JSON.stringify(data) });
    closeProductModal();
    toast('ğŸ’¾ Produto salvo!', 'success');
    await loadAppProducts();
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
  finally { hideLoading(); }
}

async function deleteProduct(id) {
  if (!confirm('Excluir este produto?')) return;
  showLoading('Excluindo produto...');
  try {
    await api(`/api/app-products/${id}`, { method: 'DELETE' });
    _appProducts = _appProducts.filter(p => p.id !== id);
    renderAppProducts();
    toast('ğŸ—‘ï¸ Produto excluÃ­do', 'warning');
  } catch(e) { toast('âŒ ' + e.message, 'error'); }
  finally { hideLoading(); }
}

document.addEventListener('click', e => {
  if (!e.target.closest('#prodBlingSearch') && !e.target.closest('#prodBlingSuggestions'))
    document.getElementById('prodBlingSuggestions').style.display = 'none';
});

// Esconder seÃ§Ã£o produtos para nÃ£o-admin
if (_cfgUser && _cfgUser.role !== 'admin') {
  const ps = document.getElementById('productsSection');
  if (ps) ps.style.display = 'none';
}

// â”€â”€ Lembretes PIX Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function carregarLembreteConfig() {
  try {
    const config = await api('/api/lembretes/config');
    document.getElementById('lemb-ativo').checked = config.ativo !== false;
    document.getElementById('lemb-cron').checked = config.cron_ativo !== false;
    document.getElementById('lemb-intervalo').value = config.intervalo_horas || 24;
    document.getElementById('lemb-max').value = config.max_lembretes || 3;
    document.getElementById('lemb-hora').value = config.cron_hora_utc || 14;
    document.getElementById('lemb-mensagem').value = config.mensagem || '';
  } catch(e) {
    // Admin-only â€” pode falhar se nÃ£o-admin
    const sec = document.getElementById('lembreteSection');
    if (sec) sec.style.display = 'none';
  }
}

async function salvarLembreteConfig() {
  const config = {
    ativo: document.getElementById('lemb-ativo').checked,
    cron_ativo: document.getElementById('lemb-cron').checked,
    intervalo_horas: parseInt(document.getElementById('lemb-intervalo').value) || 24,
    max_lembretes: parseInt(document.getElementById('lemb-max').value) || 3,
    cron_hora_utc: parseInt(document.getElementById('lemb-hora').value) || 14,
    mensagem: document.getElementById('lemb-mensagem').value.trim()
  };
  if (!config.mensagem) { toast('âš ï¸ Mensagem nÃ£o pode estar vazia', 'error'); return; }
  showLoading('Salvando configuraÃ§Ã£o...');
  try {
    const d = await api('/api/lembretes/config', { method: 'POST', body: JSON.stringify(config) });
    if (d.ok) toast('âœ… Config lembretes salva!');
    else toast('âŒ ' + (d.error || 'Erro'), 'error');
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
checkStreetsCount();
carregarFotoConfig();
carregarPermissoes();
loadAppProducts();
carregarLembreteConfig();
</script>
</body>
</html>
