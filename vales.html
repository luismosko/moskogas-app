<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Controle de Vale G√°s v1.1.0 ‚Äî MoskoG√°s</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: system-ui, sans-serif; background: #f1f5f9; }
        .toolbar { background:#fff; padding:12px 16px; display:flex; gap:8px; flex-wrap:wrap; align-items:center; border-bottom:2px solid #e2e8f0; position:sticky; top:0; z-index:50; box-shadow:0 2px 8px rgba(0,0,0,.08); }
        .btn { padding:8px 14px; border:none; border-radius:8px; cursor:pointer; font-weight:700; font-size:13px; }
        .btn-orange { background:#f97316; color:#fff; }
        .btn-blue   { background:#2563eb; color:#fff; }
        .btn-green  { background:#16a34a; color:#fff; }
        .btn-gray   { background:#94a3b8; color:#fff; }
        .btn-red    { background:#dc2626; color:#fff; }
        .btn:hover  { opacity:.85; }
        table { width:100%; border-collapse:collapse; background:#fff; }
        th { background:#475569; color:#fff; padding:8px 10px; text-align:left; font-size:12px; font-weight:700; white-space:nowrap; position:sticky; top:58px; z-index:40; }
        td { padding:8px 10px; border-bottom:1px solid #f1f5f9; font-size:13px; vertical-align:middle; }
        tr:hover td { background:#f0f4ff; }
        tbody tr { cursor:pointer; transition:background .1s; }
        .badge { display:inline-block; padding:2px 8px; border-radius:12px; font-size:11px; font-weight:700; color:#fff; }
        /* Modal */
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,.6); z-index:200; align-items:center; justify-content:center; }
        .modal-overlay.open { display:flex; }
        .modal { background:#fff; border-radius:14px; padding:24px; width:min(560px,95vw); max-height:90vh; overflow-y:auto; }
        .modal label { display:block; font-size:11px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase; letter-spacing:.5px; }
        .modal select, .modal input[type=text], .modal input[type=number] { width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; margin-bottom:12px; }
        .modal select:focus, .modal input:focus { outline:none; border-color:#f97316; }
        .modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
        /* Autocomplete */
        .search-wrap { position:relative; margin-bottom:12px; }
        .search-wrap input { margin-bottom:0; }
        #suggestions { position:absolute; top:100%; left:0; right:0; background:#fff; border:2px solid #f97316; border-top:none; border-radius:0 0 8px 8px; z-index:300; max-height:220px; overflow-y:auto; display:none; box-shadow:0 4px 12px rgba(0,0,0,.12); }
        .sug-item { padding:10px 12px; cursor:pointer; border-bottom:1px solid #f1f5f9; font-size:14px; }
        .sug-item:hover { background:#fff7ed; }
        .sug-item strong { color:#1e293b; display:block; }
        .sug-item small { color:#64748b; font-size:11px; }
        /* Itens */
        .itens-wrap { background:#f8fafc; border:2px solid #e2e8f0; border-radius:10px; padding:12px; margin-bottom:12px; }
        .itens-wrap h3 { font-size:12px; font-weight:700; color:#64748b; text-transform:uppercase; margin-bottom:10px; }
        .add-item-row { display:flex; gap:8px; align-items:flex-end; margin-bottom:10px; }
        .add-item-row > div { flex:1; }
        .add-item-row label { margin-bottom:3px; }
        .add-item-row select, .add-item-row input { margin-bottom:0; }
        .add-item-row .btn { flex-shrink:0; height:42px; }
        .item-list { display:flex; flex-direction:column; gap:6px; }
        .item-row { display:flex; align-items:center; justify-content:space-between; background:#fff; padding:8px 12px; border-radius:8px; border:1px solid #e2e8f0; font-size:14px; }
        .item-qtd { background:#f97316; color:#fff; border-radius:20px; padding:2px 10px; font-size:12px; font-weight:700; }
        .item-name { font-weight:700; color:#1e293b; margin-left:10px; }
        .rm-btn { background:none; border:none; color:#dc2626; cursor:pointer; font-size:20px; line-height:1; padding:0 4px; }
        .rm-btn:hover { color:#991b1b; }
        .empty-items { color:#94a3b8; font-size:13px; text-align:center; padding:12px 0; }
        .total-bar { background:#1e293b; color:#fff; padding:10px 14px; border-radius:8px; font-size:15px; font-weight:700; margin-bottom:12px; display:flex; justify-content:space-between; }
        .total-bar span { color:#f97316; }
        /* View modal */
        .summary-bar { background:#1e293b; color:#fff; padding:12px 16px; font-size:14px; display:flex; gap:20px; flex-wrap:wrap; border-radius:8px; margin-bottom:16px; }
        .summary-bar strong { color:#f97316; }
        .vales-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(120px,1fr)); gap:6px; }
        .vale-card { padding:8px; border-radius:8px; border:2px solid #e2e8f0; text-align:center; }
        .vale-card.pendente  { background:#f0fdf4; border-color:#bbf7d0; color:#166534; }
        .vale-card.resgatado { background:#fef2f2; border-color:#fecaca; color:#991b1b; }
        .v-num { font-size:14px; font-weight:800; }
        .v-sub { font-size:10px; color:#475569; margin-top:2px; }
        .baixa-btn { margin-top:4px; cursor:pointer; background:#fff; border:1px solid #16a34a; color:#16a34a; border-radius:4px; font-size:10px; width:100%; padding:3px 0; }
    </style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="toolbar">
    <button class="btn btn-blue" onclick="openNewModal()"><span style="font-size:16px">+</span> Nova Emiss√£o de Vale G√°s</button>
    <span style="font-size:11px;color:#94a3b8;font-weight:bold;">v1.1.0</span>
    <button class="btn btn-orange" onclick="load()" title="Recarregar">üîÑ Atualizar</button>
    <span style="font-size:12px;color:#64748b;margin-left:4px" id="count-badge"></span>
    <div style="margin-left:auto; display:flex; gap:8px;">
        <input type="number" id="baixaValeId" placeholder="ID do Vale para Baixar" style="width:180px; padding:8px 12px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px;" onkeydown="if(event.key==='Enter') darBaixa(this.value)">
        <button class="btn btn-red" onclick="darBaixa(document.getElementById('baixaValeId').value)">üéØ Dar Baixa R√°pida</button>
    </div>
</div>

<table>
    <thead>
        <tr>
            <th>#</th><th>Data/Hora</th><th>Cliente</th><th>Produtos</th>
            <th>Pgto</th><th>Resgates</th><th>NF / Empenho</th><th>A√ß√µes</th>
        </tr>
    </thead>
    <tbody id="tbody"></tbody>
</table>

<!-- MODAL NOVA NOTA -->
<div class="modal-overlay" id="modal-nova">
    <div class="modal">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h2 style="font-size:18px;color:#1e293b">üé´ Emitir Nova Nota de Vale G√°s</h2>
            <button onclick="closeNovaModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8" title="Fechar">&times;</button>
        </div>

        <label>üîç Cliente / Empresa / Raz√£o Social *</label>
        <div class="search-wrap">
            <input type="text" id="searchName" placeholder="Digite o nome para buscar..." autocomplete="off" oninput="buscaCliente()">
            <input type="hidden" id="n-cliente">
            <div id="suggestions"></div>
        </div>

        <div style="display:flex;gap:12px">
            <div style="flex:1"><label>N¬∫ Nota Fiscal (Opc.)</label><input type="text" id="n-nf" placeholder="Ex: 54321"></div>
            <div style="flex:1"><label>N¬∫ Empenho (Opc.)</label><input type="text" id="n-empenho" placeholder="Ex: 2025NE00012"></div>
        </div>

        <div class="itens-wrap">
            <h3>üì¶ Produtos / Itens</h3>
            <div class="add-item-row">
                <div>
                    <label>Produto</label>
                    <select id="add-produto">
                        <option value="P13">üî¥ P13 ‚Äî Botij√£o 13kg</option>
                        <option value="P20">üü† P20 ‚Äî Botij√£o 20kg</option>
                        <option value="P45">üü° P45 ‚Äî Botij√£o 45kg</option>
                        <option value="√Ågua 20L">üíß √Ågua Mineral 20L</option>
                    </select>
                </div>
                <div style="flex:0 0 90px"><label>Quantidade</label><input type="number" id="add-qtd" value="10" min="1" max="500"></div>
                <button class="btn btn-orange" onclick="addItem()" style="padding:0 14px">+ Adicionar</button>
            </div>
            <div class="item-list" id="item-list">
                <div class="empty-items">Nenhum produto adicionado ainda.</div>
            </div>
        </div>

        <label>Forma de Pagamento *</label>
        <select id="n-pgto">
            <option value="dinheiro">üíµ Dinheiro</option>
            <option value="pix_vista">‚ö° PIX √† vista</option>
            <option value="pix_receber">‚è≥ PIX a receber</option>
            <option value="debito">üí≥ Cart√£o de D√©bito</option>
            <option value="credito">üí≥ Cart√£o de Cr√©dito</option>
            <option value="mensalista">üìÖ Mensalista (Boleto/Fiado)</option>
        </select>

        <div class="total-bar">
            <span style="color:#fff">Total de Vales:</span>
            <span id="n-total-vales">0 vales</span>
        </div>

        <div class="modal-footer">
            <button class="btn btn-gray" onclick="closeNovaModal()">Cancelar</button>
            <button class="btn btn-green" onclick="salvarNota()" id="n-btn-save">‚úÖ Confirmar Emiss√£o</button>
        </div>
    </div>
</div>

<!-- MODAL DETALHES -->
<div class="modal-overlay" id="modal-view">
    <div class="modal" style="width:min(700px,95vw);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h2 style="margin:0;font-size:18px;color:#1e293b" id="det-title">Nota #</h2>
            <button onclick="closeViewModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8" title="Fechar">&times;</button>
        </div>
        <div class="summary-bar">
            <span id="det-cli"></span>
            <span id="det-qty"></span>
            <span id="det-resgatados"></span>
        </div>
        <h3 style="font-size:14px;margin-bottom:10px;color:#475569">üé´ Vales Emitidos</h3>
        <div class="vales-grid" id="det-vales-list"></div>
        <div class="modal-footer" style="margin-top:20px;">
            <button class="btn btn-gray" onclick="closeViewModal()">Fechar</button>
            <button class="btn btn-blue" onclick="imprimirAtual()">üñ®Ô∏è Imprimir A4</button>
        </div>
    </div>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
window.addEventListener('DOMContentLoaded', () => {
    if (typeof requireAdminOrAtendente === 'function') requireAdminOrAtendente();
});

let notasData = [], currentViewId = null, searchTimer = null, itens = [];

async function load() {
    showLoading('Carregando notas...');
    try {
        const res = await api('/api/vales/notas');
        notasData = res.notas || [];
        renderTable();
        document.getElementById('count-badge').textContent = notasData.length + ' notas recentes';
    } catch (e) { toast('Erro ao carregar: ' + e.message, 'error'); }
    finally { hideLoading(); }
}

function renderTable() {
    const tbody = document.getElementById('tbody');
    if (!notasData.length) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#94a3b8">Nenhuma emiss√£o encontrada.</td></tr>';
        return;
    }
    const PL = { dinheiro:'üíµ Dinheiro', pix_vista:'‚ö° PIX Vista', pix_receber:'‚è≥ PIX Rec.', debito:'üí≥ D√©bito', credito:'üí≥ Cr√©dito', mensalista:'üìÖ Mensalista' };
    tbody.innerHTML = notasData.map(n => {
        const d = new Date(n.created_at * 1000).toLocaleString('pt-BR', { timeZone: 'America/Campo_Grande' });
        const pco = n.resgatados === n.total_vales && n.total_vales > 0 ? '#16a34a' : (n.resgatados > 0 ? '#f59e0b' : '#64748b');
        const badge = '<span class="badge" style="background:' + pco + '">' + n.resgatados + ' / ' + n.total_vales + ' resgatados</span>';
        let itensHtml = '';
        try {
            const its = JSON.parse(n.itens_json || '[]');
            itensHtml = its.map(it => '<span style="font-size:11px;background:#f1f5f9;padding:1px 6px;border-radius:8px;margin-right:3px">' + it.produto + ': ' + it.quantidade + '</span>').join('');
        } catch(_) { itensHtml = '<span style="font-size:12px;color:#64748b">' + n.quantidade + ' vales</span>'; }
        const docs = [];
        if (n.nota_fiscal) docs.push('<strong>NF:</strong> ' + n.nota_fiscal);
        if (n.empenho) docs.push('<strong>Emp:</strong> ' + n.empenho);
        return '<tr onclick="viewNota(' + n.id + ')">' +
            '<td><strong style="color:#2563eb">#' + n.id + '</strong></td>' +
            '<td style="font-size:12px">' + d + '</td>' +
            '<td><strong>' + n.cliente_nome + '</strong></td>' +
            '<td>' + itensHtml + '</td>' +
            '<td>' + (PL[n.forma_pagamento] || n.forma_pagamento) + '</td>' +
            '<td>' + badge + '</td>' +
            '<td style="font-size:11px;color:#475569">' + (docs.join('<br>') || '‚Äî') + '</td>' +
            '<td><button class="btn btn-blue" onclick="event.stopPropagation(); window.open(\'print-vales.html?id=' + n.id + '\', \'_blank\')" style="padding:4px 8px;font-size:11px">üñ®Ô∏è Imprimir</button></td>' +
            '</tr>';
    }).join('');
}

function openNewModal() {
    itens = [];
    ['n-cliente','n-nf','n-empenho'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('searchName').value = '';
    document.getElementById('add-qtd').value = '10';
    document.getElementById('add-produto').value = 'P13';
    document.getElementById('n-pgto').value = 'dinheiro';
    document.getElementById('suggestions').style.display = 'none';
    renderItens();
    document.getElementById('modal-nova').classList.add('open');
    setTimeout(() => document.getElementById('searchName').focus(), 100);
}

function closeNovaModal() { document.getElementById('modal-nova').classList.remove('open'); }

function buscaCliente() {
    const name = document.getElementById('searchName').value.trim();
    document.getElementById('n-cliente').value = name;
    clearTimeout(searchTimer);
    if (name.length < 2) { document.getElementById('suggestions').style.display = 'none'; return; }
    searchTimer = setTimeout(async () => {
        try {
            const res = await api('/api/customer/search-multi?' + new URLSearchParams({ name }));
            const box = document.getElementById('suggestions');
            if (!res.length) { box.style.display = 'none'; return; }
            box.innerHTML = res.map((c, i) => {
                const bling = c.bling_contact_id ? '<span style="background:#16a34a;color:#fff;font-size:9px;font-weight:700;padding:1px 5px;border-radius:6px;margin-left:6px">B</span>' : '';
                return '<div class="sug-item" onclick="selecionaCliente(' + i + ')"><strong>' + (c.name || c.customer_name) + bling + '</strong><small>' + (c.address_line || '') + (c.bairro ? ' ‚Äî ' + c.bairro : '') + '</small></div>';
            }).join('');
            box._data = res;
            box.style.display = 'block';
        } catch(e) { console.error(e); }
    }, 280);
}

function selecionaCliente(i) {
    const c = document.getElementById('suggestions')._data[i];
    const nome = c.name || c.customer_name || '';
    document.getElementById('n-cliente').value = nome;
    document.getElementById('searchName').value = nome;
    document.getElementById('suggestions').style.display = 'none';
}

document.addEventListener('click', e => {
    if (!e.target.closest('.search-wrap')) {
        const s = document.getElementById('suggestions');
        if (s) s.style.display = 'none';
    }
});

function addItem() {
    const produto = document.getElementById('add-produto').value;
    const qtd = parseInt(document.getElementById('add-qtd').value) || 0;
    if (qtd < 1) return toast('Quantidade deve ser maior que zero', 'error');
    const existing = itens.find(it => it.produto === produto);
    if (existing) { existing.quantidade += qtd; } else { itens.push({ produto, quantidade: qtd }); }
    renderItens();
    document.getElementById('add-qtd').value = '10';
}

function removeItem(idx) { itens.splice(idx, 1); renderItens(); }

function renderItens() {
    const list = document.getElementById('item-list');
    const total = itens.reduce((s, it) => s + it.quantidade, 0);
    document.getElementById('n-total-vales').textContent = total + ' vales';
    if (!itens.length) { list.innerHTML = '<div class="empty-items">Nenhum produto adicionado ainda.</div>'; return; }
    const icons = { P13:'üî¥', P20:'üü†', P45:'üü°', '√Ågua 20L':'üíß' };
    list.innerHTML = itens.map((it, i) =>
        '<div class="item-row"><div style="display:flex;align-items:center"><span class="item-qtd">' + it.quantidade + 'x</span>' +
        '<span class="item-name">' + (icons[it.produto] || 'üì¶') + ' ' + it.produto + '</span></div>' +
        '<button class="rm-btn" onclick="removeItem(' + i + ')" title="Remover">&times;</button></div>'
    ).join('');
}

async function salvarNota() {
    const cli = document.getElementById('n-cliente').value.trim() || document.getElementById('searchName').value.trim();
    if (!cli) return toast('Insira o nome do cliente', 'error');
    if (!itens.length) return toast('Adicione pelo menos um produto', 'error');
    const btn = document.getElementById('n-btn-save');
    btn.disabled = true; btn.textContent = 'Aguarde...';
    try {
        const res = await api('/api/vales/notas', { method: 'POST', body: JSON.stringify({
            cliente_nome: cli, itens,
            forma_pagamento: document.getElementById('n-pgto').value,
            nota_fiscal: document.getElementById('n-nf').value.trim(),
            empenho: document.getElementById('n-empenho').value.trim()
        })});
        toast('‚úÖ Nota #' + res.nota_id + ' emitida com sucesso!');
        closeNovaModal(); load();
        setTimeout(() => window.open('print-vales.html?id=' + res.nota_id, '_blank'), 500);
    } catch(e) { toast(e.message, 'error'); }
    finally { btn.disabled = false; btn.textContent = '‚úÖ Confirmar Emiss√£o'; }
}

async function viewNota(id) {
    currentViewId = id;
    showLoading('Buscando detalhes...');
    try {
        const res = await api('/api/vales/notas/' + id);
        document.getElementById('det-title').textContent = 'Nota de Vale G√°s #' + res.nota.id;
        document.getElementById('det-cli').innerHTML = 'üè¢ <strong>' + res.nota.cliente_nome + '</strong>';
        document.getElementById('det-qty').innerHTML = 'üé´ Emitidos: <strong>' + res.nota.quantidade + '</strong>';
        let regs = 0;
        const grid = res.vales.map(v => {
            if (v.status === 'resgatado') regs++;
            const cl = v.status === 'resgatado' ? 'resgatado' : 'pendente';
            const sub = v.status === 'resgatado'
                ? '<div class="v-sub">Resgatado ' + new Date(v.resgatado_em * 1000).toLocaleDateString('pt-BR', { timeZone: 'America/Campo_Grande' }) + '</div>'
                : '<button class="baixa-btn" onclick="darBaixa(' + v.id + ')">‚úÖ Dar Baixa</button>';
            return '<div class="vale-card ' + cl + '"><div class="v-num">' + (v.status==='resgatado'?'‚ùå':'üé´') + ' ' + v.numero + '</div><div class="v-sub">ID: ' + v.id + '</div>' + sub + '</div>';
        }).join('');
        document.getElementById('det-resgatados').innerHTML = 'üîÑ Resgatados: <strong>' + regs + ' / ' + res.vales.length + '</strong>';
        document.getElementById('det-vales-list').innerHTML = grid;
        document.getElementById('modal-view').classList.add('open');
    } catch(e) { toast(e.message, 'error'); }
    finally { hideLoading(); }
}

function closeViewModal() { document.getElementById('modal-view').classList.remove('open'); currentViewId = null; }
function imprimirAtual() { if (currentViewId) window.open('print-vales.html?id=' + currentViewId, '_blank'); }

async function darBaixa(valeId) {
    if (!valeId) return;
    if (!confirm('Confirma a BAIXA do Vale ID ' + valeId + '?\n\nEsta a√ß√£o n√£o poder√° ser desfeita.')) return;
    showLoading('Baixando vale...');
    try {
        await api('/api/vales/' + valeId + '/baixa', { method: 'PATCH' });
        toast('‚úÖ Vale baixado com sucesso!');
        await load();
        if (currentViewId) await viewNota(currentViewId);
        document.getElementById('baixaValeId').value = '';
    } catch(e) { toast(e.message, 'error'); }
    finally { hideLoading(); }
}

load();
</script>
</body>
</html>
