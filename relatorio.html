<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Relat√≥rio Entregador ‚Äî MoskoG√°s v1.2.6</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; }

  .toolbar { background: #fff; padding: 14px 16px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar select, .toolbar input { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar select:focus, .toolbar input:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn-blue { background: #2563eb; color: #fff; }
  .btn:hover { opacity: 0.85; }

  /* ‚îÄ‚îÄ RELAT√ìRIO ‚îÄ‚îÄ */
  .report { max-width: 800px; margin: 16px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

  .report-header { text-align: center; margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1.5px solid #94a3b8; }
  .report-header h1 { font-size: 13px; color: #334155; white-space: nowrap; }

  .report table { width: 100%; border-collapse: collapse; }
  .report th { background: #f1f5f9; color: #334155; padding: 4px 5px; text-align: left; font-size: 12px; font-weight: 700; border: 1px solid #cbd5e1; white-space: nowrap; }
  .report td { padding: 3px 5px; border: 1px solid #e2e8f0; font-size: 12px; vertical-align: top; }
  .report .order-first td { border-top: 1.5px solid #94a3b8; }
  .report .subtotal-row td { font-weight: 900; font-size: 11px; background: #f1f5f9; border-top: 2px solid #94a3b8; color: #1e293b; }
  .report .grand-total td { font-weight: 900; font-size: 13px; background: #e2e8f0; color: #1e293b; }

  .report .pgto-summary { margin-top: 12px; display: flex; gap: 16px; align-items: flex-start; flex-wrap: wrap; }
  .report .pgto-summary table { width: auto; border-collapse: collapse; }
  .report .pgto-summary th { background: #f1f5f9; color: #334155; font-size: 10px; padding: 4px 10px; border: 1px solid #cbd5e1; }
  .report .pgto-summary td { font-size: 10px; padding: 3px 10px; border: 1px solid #e2e8f0; }
  .report .pgto-summary .pgto-total td { font-weight: 900; background: #f1f5f9; }
  .report .pgto-summary .dinheiro-row td { font-weight: 800; background: #fef9c3; }

  .report .dinheiro-conf { border: 1.5px solid #94a3b8; padding: 6px 10px; font-size: 11px; display: flex; align-items: center; gap: 8px; margin-top: 4px; }
  .report .dinheiro-conf .line { border-bottom: 1px solid #334155; flex: 1; min-width: 80px; height: 18px; }

  .empty-report { text-align: center; padding: 60px; color: #94a3b8; font-size: 16px; }

  /* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
  @media print {
    body { background: #fff; }
    .toolbar, #nav-placeholder { display: none !important; }
    .report { margin: 0; padding: 6px; box-shadow: none; border-radius: 0; max-width: 100%; }
    .report-header h1 { font-size: 13px; }
    .report th, .report td { font-size: 9px; padding: 2px 4px; }
    .report .pgto-summary th, .report .pgto-summary td { font-size: 9px; padding: 2px 8px; }
    @page { margin: 8mm; size: A4 portrait; }
  }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<!-- TOOLBAR -->
<div class="toolbar">
  <span style="font-size:15px;font-weight:700;color:#1e293b">üìã Relat√≥rio do Entregador v1.2.6</span>
  <input type="date" id="fDate" style="width:155px">
  <select id="fDriver" style="min-width:160px">
    <option value="">Todos entregadores</option>
  </select>
  <button class="btn btn-orange" onclick="gerarRelatorio()" title="Gerar relat√≥rio">üìä Gerar</button>
  <button class="btn btn-blue" onclick="window.print()" title="Imprimir relat√≥rio">üñ®Ô∏è Imprimir</button>
  <span title="Vers√£o" style="background:#6366f1;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:.5px">v1.2.6</span>
</div>

<!-- RELAT√ìRIO -->
<div class="report" id="report">
  <div class="empty-report" id="empty-msg">
    Selecione a data e o entregador, depois clique em <strong>üìä Gerar</strong>
  </div>
  <div id="report-content" style="display:none"></div>
</div>

<script src="shared.js"></script>
<script>
// v1.2.6
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let drivers = [];

async function init() {
  drivers = await api('/api/drivers').catch(() => []);
  const sel = document.getElementById('fDriver');
  sel.innerHTML = '<option value="">Todos entregadores</option>';
  drivers.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = d.name;
    sel.appendChild(opt);
  });
  document.getElementById('fDate').value = new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
}

function truncAddr(addr, maxLen) {
  if (!addr) return '‚Äî';
  // Separa n√∫mero do final (ex: "Avenida Afonso Pena, 3297" ‚Üí rua="Avenida Afonso Pena", num="3297")
  const m = addr.match(/^(.+?)[,\s]+(\d{1,6}\s*\w?)$/);
  if (m) {
    const rua = m[1], num = m[2];
    const space = maxLen - num.length - 4; // 4 = "... "
    if (rua.length > space && space > 5) return rua.slice(0, space).trim() + '... ' + num;
    return addr.length > maxLen ? addr.slice(0, maxLen - 3) + '...' : addr;
  }
  return addr.length > maxLen ? addr.slice(0, maxLen - 3) + '...' : addr;
}

function truncText(txt, maxLen) {
  if (!txt) return '‚Äî';
  return txt.length > maxLen ? txt.slice(0, maxLen - 3).trim() + '...' : txt;
}

async function gerarRelatorio() {
  const date = document.getElementById('fDate').value;
  const driverId = document.getElementById('fDriver').value;
  const driverName = driverId ? document.getElementById('fDriver').selectedOptions[0].textContent : 'TODOS';

  if (!date) { toast('Selecione uma data', 'error'); return; }

  showLoading('Gerando relat√≥rio...');
  let rows = [];
  try {
    let url = `/api/orders/list?date_from=${date}&date_to=${date}`;
    if (driverId) url += `&driver_id=${driverId}`;
    rows = await api(url);
    if (!Array.isArray(rows)) rows = [];
  } catch(e) { toast('Erro: ' + e.message, 'error'); hideLoading(); return; }

  rows = rows.filter(r => {
    if (!r.created_at) return true;
    const d = new Date(r.created_at * 1000).toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
    return d === date;
  });

  rows = rows.filter(r => r.status !== 'cancelado');
  rows.sort((a, b) => a.id - b.id);

  if (!rows.length) {
    document.getElementById('empty-msg').style.display = 'block';
    document.getElementById('empty-msg').textContent = '‚ö†Ô∏è Nenhum pedido encontrado para este filtro.';
    document.getElementById('report-content').style.display = 'none';
    return;
  }

  document.getElementById('empty-msg').style.display = 'none';
  document.getElementById('report-content').style.display = 'block';

  const dateFmt = new Date(date + 'T12:00:00').toLocaleDateString('pt-BR');

  // Header compacto: tudo numa √∫nica linha
  let html = `
    <div class="report-header">
      <h1>MOSKO G√ÅS ‚Äî ${dateFmt} ‚Äî ${driverName.toUpperCase()} ‚Äî ${rows.length} pedidos</h1>
    </div>
  `;

  // Tabela ‚Äî sem Bairro, sem R$
  html += `<table>
    <thead><tr>
      <th style="width:24px">#</th>
      <th>Cliente</th>
      <th>Pgto</th>
      <th>Fone</th>
      <th>Endere√ßo</th>
      <th>Produto</th>
      <th style="text-align:center">Qt</th>
      <th style="text-align:right">Unit.</th>
      <th style="text-align:right">Sub-total</th>
    </tr></thead>
    <tbody>`;

  const pgtoLabels = {
    dinheiro: 'DIN', pix_vista: 'PIX‚úì', pix_receber: 'PIX‚è≥',
    debito: 'D√âB', credito: 'CR√âD',
    mensalista: 'MENSAL', boleto: 'BOLETO', nfe: 'NFE'
  };

  const pgtoTotals = {};
  const prodTotals = {};
  let grandTotal = 0;

  rows.forEach(o => {
    let items = [];
    try { items = JSON.parse(o.items_json || '[]'); } catch(e) {}
    if (!items.length) items = [{ name: '(sem itens)', qty: 1, price: 0 }];

    const pgtoKey = o.tipo_pagamento || 'dinheiro';
    const pgtoLabel = pgtoLabels[pgtoKey] || pgtoKey.toUpperCase();
    const orderTotal = parseFloat(o.total_value) || 0;
    grandTotal += orderTotal;

    if (!pgtoTotals[pgtoKey]) pgtoTotals[pgtoKey] = { label: pgtoLabel, total: 0, count: 0 };
    pgtoTotals[pgtoKey].total += orderTotal;
    pgtoTotals[pgtoKey].count++;

    // Acumular totais de produtos
    items.forEach(it => {
      const nome = (it.name || '').trim();
      const qty = parseInt(it.qty) || 1;
      if (!nome || nome === '(sem itens)') return;
      if (!prodTotals[nome]) prodTotals[nome] = 0;
      prodTotals[nome] += qty;
    });

    const phone = o.phone_digits ? formatPhone(o.phone_digits) : '‚Äî';
    const endFull = (o.address_line || '') + (o.complemento ? ', ' + o.complemento : '');
    const endTrunc = truncAddr(endFull, 50);

    items.forEach((it, i) => {
      const isFirst = i === 0;
      const qty   = parseInt(it.qty) || 1;
      const price = parseFloat(it.price) || 0;
      const sub   = qty * price;

      html += `<tr class="${isFirst ? 'order-first' : ''}">
        ${isFirst ? `<td rowspan="${items.length}" style="font-weight:700;vertical-align:middle;text-align:center">${o.id}</td>` : ''}
        ${isFirst ? `<td rowspan="${items.length}" style="font-weight:600;vertical-align:middle;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${truncText(o.customer_name, 25) || '‚Äî'}</td>` : ''}
        ${isFirst ? `<td rowspan="${items.length}" style="font-size:9px;vertical-align:middle;white-space:nowrap">${pgtoLabel}</td>` : ''}
        ${isFirst ? `<td rowspan="${items.length}" style="font-size:9px;vertical-align:middle;white-space:nowrap">${phone}</td>` : ''}
        ${isFirst ? `<td rowspan="${items.length}" style="vertical-align:middle;white-space:nowrap;font-size:9px" title="${(o.address_line||'') + (o.complemento ? ', '+o.complemento : '')}">${endTrunc}</td>` : ''}
        <td style="white-space:nowrap;font-size:9px" title="${it.name || ''}">${truncText(it.name, 35)}</td>
        <td style="text-align:center;font-weight:700;white-space:nowrap">${qty}</td>
        <td style="text-align:right;white-space:nowrap">${price.toFixed(2)}</td>
        <td style="text-align:right;font-weight:700;white-space:nowrap">${sub.toFixed(2)}</td>
      </tr>`;
    });

    html += `<tr class="subtotal-row">
      <td colspan="8" style="text-align:right;font-size:9px;color:#64748b">Subtotal #${o.id}</td>
      <td style="text-align:right;font-size:10px;white-space:nowrap">${orderTotal.toFixed(2)}</td>
    </tr>`;
  });

  html += `<tr class="grand-total">
    <td colspan="8" style="text-align:right;padding:6px 8px">TOTAL GERAL</td>
    <td style="text-align:right;padding:6px 8px;white-space:nowrap">R$ ${grandTotal.toFixed(2)}</td>
  </tr>`;

  html += `</tbody></table>`;

  // ‚îÄ‚îÄ Resumo compacto por forma de pagamento + confer√™ncia dinheiro ‚îÄ‚îÄ
  const pgtoFullLabels = {
    dinheiro: 'üíµ Dinheiro', pix_vista: '‚ö° PIX pago', pix_receber: '‚è≥ PIX a receber',
    debito: 'üí≥ D√©bito', credito: 'üí≥ Cr√©dito', mensalista: 'üìÖ Mensalista', boleto: 'üßæ Boleto', nfe: 'üìÑ NFe'
  };
  const pgtoOrder = ['dinheiro','pix_vista','pix_receber','debito','credito','mensalista','boleto','nfe'];
  const sortedPgto = Object.entries(pgtoTotals).sort((a, b) => {
    const ia = pgtoOrder.indexOf(a[0]); const ib = pgtoOrder.indexOf(b[0]);
    return (ia === -1 ? 99 : ia) - (ib === -1 ? 99 : ib);
  });

  html += `<div class="pgto-summary">
    <table>
      <thead><tr>
        <th>Pagamento</th>
        <th style="text-align:center">Qtd</th>
        <th style="text-align:right">Total</th>
      </tr></thead>
      <tbody>`;

  sortedPgto.forEach(([key, data]) => {
    const isDinheiro = key === 'dinheiro';
    html += `<tr class="${isDinheiro ? 'dinheiro-row' : ''}">
      <td>${pgtoFullLabels[key] || key}</td>
      <td style="text-align:center;font-weight:700">${data.count}</td>
      <td style="text-align:right;font-weight:700">R$ ${data.total.toFixed(2)}</td>
    </tr>`;
  });

  html += `<tr class="pgto-total">
      <td style="font-weight:900">TOTAL</td>
      <td style="text-align:center;font-weight:900">${rows.length}</td>
      <td style="text-align:right;font-weight:900">R$ ${grandTotal.toFixed(2)}</td>
    </tr>`;
  html += `</tbody></table>`;

  // ‚îÄ‚îÄ Tabela de totais de produtos ‚îÄ‚îÄ
  const sortedProd = Object.entries(prodTotals).sort((a, b) => b[1] - a[1]);
  const totalItens = sortedProd.reduce((s, [,q]) => s + q, 0);
  html += `<table>
    <thead><tr>
      <th>Produto</th>
      <th style="text-align:center">Qtd</th>
    </tr></thead>
    <tbody>`;
  sortedProd.forEach(([nome, qty]) => {
    html += `<tr><td style="white-space:nowrap">${nome}</td><td style="text-align:center;font-weight:700">${qty}</td></tr>`;
  });
  html += `<tr class="pgto-total">
      <td style="font-weight:900">TOTAL</td>
      <td style="text-align:center;font-weight:900">${totalItens}</td>
    </tr>
    </tbody></table>`;

  // Confer√™ncia dinheiro ‚Äî s√≥ uma linha simples
  const dinheiroTotal = pgtoTotals['dinheiro'] ? pgtoTotals['dinheiro'].total : 0;
  if (dinheiroTotal > 0) {
    html += `<div class="dinheiro-conf">
      <span>üíµ Dinheiro esperado: <strong>R$ ${dinheiroTotal.toFixed(2)}</strong></span>
      <span>| Conferido: R$</span><div class="line"></div>
    </div>`;
  }

  html += `</div>`;

  document.getElementById('report-content').innerHTML = html;
  hideLoading();
}

function formatPhone(p) {
  if (!p) return '‚Äî';
  const d = p.replace(/\D/g, '');
  if (d.length === 11) return `(${d.slice(0,2)}) ${d.slice(2,7)}-${d.slice(7)}`;
  if (d.length === 10) return `(${d.slice(0,2)}) ${d.slice(2,6)}-${d.slice(6)}`;
  return p;
}

init();
</script>
</body>
</html>
