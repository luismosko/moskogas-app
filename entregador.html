<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Entregador v2.1.0 â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; min-height: 100vh; -webkit-tap-highlight-color: transparent; }

  /* â”€â”€ Toolbar â”€â”€ */
  .toolbar { background: #0f172a; padding: 10px 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 50; }
  .toolbar h1 { color: #fff; font-size: 16px; font-weight: 800; margin-right: auto; }
  .toolbar h1 small { font-weight: 400; color: #94a3b8; font-size: 11px; }
  .toolbar select { padding: 8px 10px; border: none; border-radius: 8px; font-size: 13px; background: #334155; color: #fff; }
  .toolbar select option { background: #1e293b; }
  .btn { padding: 9px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-refresh { background: #f97316; color: #fff; }
  .auto-lbl { color: #94a3b8; font-size: 11px; display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .auto-lbl input { accent-color: #f97316; width: 16px; height: 16px; }

  /* â”€â”€ Tabs â”€â”€ */
  .tab-bar { display: flex; background: #1e293b; border-bottom: 2px solid #334155; }
  .tab-btn { flex: 1; padding: 12px 8px; text-align: center; font-size: 14px; font-weight: 700; color: #94a3b8; background: transparent; border: none; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn.active { color: #fff; border-bottom-color: #f97316; background: #334155; }
  .tab-btn .tab-count { display: inline-block; background: #475569; color: #fff; border-radius: 12px; padding: 1px 8px; font-size: 11px; margin-left: 4px; }
  .tab-btn.active .tab-count { background: #f97316; }

  /* â”€â”€ Summary â”€â”€ */
  .summary-bar { background: #1e293b; color: #fff; padding: 8px 12px; display: flex; gap: 14px; flex-wrap: wrap; font-size: 12px; }
  .summary-bar strong { color: #f97316; }

  /* â”€â”€ Container â”€â”€ */
  .container { padding: 10px; max-width: 600px; margin: 0 auto; }

  /* â”€â”€ Card â”€â”€ */
  .card { background: #fff; border-radius: 16px; margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
  .card-header { padding: 14px 14px 8px; display: flex; justify-content: space-between; align-items: flex-start; }
  .card-header-left { flex: 1; }
  .card-id { font-size: 11px; color: #94a3b8; font-weight: 700; }
  .card-client { font-size: 16px; font-weight: 800; color: #1e293b; margin-top: 2px; }
  .hour-chip { background: #e2e8f0; color: #475569; border-radius: 6px; padding: 2px 7px; font-size: 10px; font-weight: 700; }

  .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }
  .badge-novo   { background: #fee2e2; color: #dc2626; }
  .badge-enc    { background: #fef3c7; color: #d97706; }
  .badge-wa     { background: #dcfce7; color: #16a34a; }
  .badge-entregue { background: #dbeafe; color: #2563eb; }
  .badge-cancel { background: #f1f5f9; color: #6b7280; }

  .card-body { padding: 0 14px; }
  .card-addr { background: #f8fafc; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; font-size: 13px; color: #374151; line-height: 1.6; }
  .card-addr .ref { color: #7c3aed; font-size: 12px; font-weight: 600; }
  .notes-box { background: #faf5ff; border-left: 3px solid #7c3aed; padding: 8px 12px; border-radius: 0 8px 8px 0; font-size: 12px; color: #7c3aed; margin-bottom: 8px; }
  .card-items { font-size: 14px; font-weight: 700; color: #1e293b; padding: 0 0 6px; }
  .card-total-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
  .card-total { font-size: 20px; font-weight: 900; color: #16a34a; }
  .pgto-badge { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 8px; background: #f1f5f9; color: #475569; }

  /* â”€â”€ Quick action buttons â”€â”€ */
  .card-quick { display: flex; gap: 6px; padding: 8px 0; flex-wrap: wrap; }
  .btn-maps  { background: #dcfce7; color: #16a34a; border: 2px solid #86efac; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }
  .btn-phone { background: #dbeafe; color: #2563eb; border: 2px solid #93c5fd; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }
  .btn-whats { background: #d1fae5; color: #059669; border: 2px solid #6ee7b7; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }

  /* â”€â”€ Delivery section â”€â”€ */
  .delivery-section { border-top: 2px dashed #e2e8f0; margin-top: 6px; padding: 14px; background: #f8fafc; }
  .delivery-section h3 { font-size: 13px; color: #475569; font-weight: 700; margin-bottom: 10px; }
  .delivery-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
  .delivery-row label { font-size: 12px; font-weight: 700; color: #475569; min-width: 70px; }
  .delivery-row select, .delivery-row textarea { flex: 1; padding: 8px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-family: inherit; }
  .delivery-row textarea { resize: vertical; min-height: 50px; }
  .delivery-row select:focus, .delivery-row textarea:focus { border-color: #3b82f6; outline: none; }

  /* â”€â”€ Photo capture â”€â”€ */
  .photo-area { margin-bottom: 12px; }
  .photo-btn { width: 100%; padding: 14px; border: 3px dashed #94a3b8; border-radius: 12px; background: #fff; cursor: pointer; text-align: center; font-size: 14px; font-weight: 700; color: #64748b; transition: all 0.2s; }
  .photo-btn:active { transform: scale(0.98); background: #f1f5f9; }
  .photo-btn.has-photo { border-color: #16a34a; border-style: solid; background: #f0fdf4; color: #16a34a; }
  .photo-btn .icon { font-size: 28px; display: block; margin-bottom: 4px; }
  .photo-preview { margin-top: 8px; position: relative; display: none; }
  .photo-preview img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid #16a34a; }
  .photo-preview .remove { position: absolute; top: 6px; right: 6px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 14px; font-weight: 900; cursor: pointer; }
  .photo-size { text-align: center; font-size: 11px; color: #64748b; margin-top: 4px; }
  .photo-input { display: none !important; }

  /* â”€â”€ Deliver button â”€â”€ */
  .btn-deliver { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-deliver.ready { background: #2563eb; color: #fff; }
  .btn-deliver.ready:active { transform: scale(0.97); background: #1d4ed8; }
  .btn-deliver.disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }

  .empty { text-align: center; padding: 60px 20px; color: #94a3b8; font-size: 16px; }
  .version-badge { position: fixed; bottom: 6px; right: 8px; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 9px; font-weight: 700; z-index: 99; }

  /* â”€â”€ Totais (aba entregues) â”€â”€ */
  .totals-card { background: #fff; border-radius: 16px; margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
  .totals-header { background: #1e293b; color: #fff; padding: 12px 14px; font-size: 14px; font-weight: 800; }
  .totals-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  .totals-row:last-child { border-bottom: none; }
  .totals-row .pgto-icon { font-size: 16px; }
  .totals-row .pgto-name { font-weight: 600; color: #374151; }
  .totals-row .pgto-count { color: #64748b; font-size: 12px; }
  .totals-row .pgto-val { font-weight: 800; color: #16a34a; }
  .totals-grand { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #f0fdf4; font-size: 18px; font-weight: 900; color: #16a34a; border-top: 2px solid #16a34a; }

  /* â”€â”€ Entregue mini card â”€â”€ */
  .mini-card { background: #fff; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); padding: 12px 14px; }
  .mini-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .mini-id { font-size: 11px; color: #94a3b8; font-weight: 700; }
  .mini-client { font-size: 14px; font-weight: 700; color: #1e293b; }
  .mini-items { font-size: 12px; color: #64748b; margin-top: 2px; }
  .mini-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
  .mini-pgto { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; background: #f1f5f9; color: #475569; }
  .mini-val { font-size: 16px; font-weight: 900; color: #16a34a; }

  @media (max-width: 600px) {
    .toolbar h1 { font-size: 14px; }
    .card-client { font-size: 15px; }
  }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="toolbar">
  <h1>ğŸšš Entregas <small>v2.1.0</small></h1>
  <select id="fDriver" onchange="load()">
    <option value="">Todos</option>
  </select>
  <button class="btn btn-refresh" onclick="load()" title="Atualizar">ğŸ”„</button>
  <label class="auto-lbl"><input type="checkbox" id="autoRefresh" onchange="toggleAuto()"> 30s</label>
</div>

<div class="tab-bar">
  <button class="tab-btn active" id="tab-pendentes" onclick="switchTab('pendentes')">ğŸ“¦ Pendentes <span class="tab-count" id="count-pendentes">0</span></button>
  <button class="tab-btn" id="tab-entregues" onclick="switchTab('entregues')">âœ… Entregues <span class="tab-count" id="count-entregues">0</span></button>
</div>

<div class="summary-bar" id="summary-bar"></div>

<div class="container">
  <div id="list"></div>
</div>

<div class="version-badge">v2.1.0 â€” entregador</div>

<script src="shared.js"></script>
<script>
// v2.1.0
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

const TIPO_LABELS = {
  dinheiro: 'ğŸ’µ Dinheiro', pix_vista: 'âš¡ PIX Ã  vista', pix_receber: 'â³ PIX a receber',
  mensalista: 'ğŸ“… Mensalista', boleto: 'ğŸ§¾ Boleto/Ã“rgÃ£o', debito: 'ğŸ’³ DÃ©bito', credito: 'ğŸ’³ CrÃ©dito'
};
const TIPO_ICONS = {
  dinheiro: 'ğŸ’µ', pix_vista: 'âš¡', pix_receber: 'â³',
  mensalista: 'ğŸ“…', boleto: 'ğŸ§¾', debito: 'ğŸ’³', credito: 'ğŸ’³'
};

const photoStore = {};
let autoTimer;
let allOrders = [];
let currentTab = 'pendentes';

async function init() {
  const drivers = await api('/api/drivers').catch(() => []);
  const sel = document.getElementById('fDriver');
  drivers.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = d.name;
    sel.appendChild(opt);
  });

  const user = getCurrentUser();
  if (user && user.role === 'entregador') {
    const match = drivers.find(d => d.id == user.id);
    if (match) sel.value = match.id;
  }

  load();
}

async function load() {
  const driverId = document.getElementById('fDriver').value;
  const todayStr = today();

  let url = `/api/orders/list?date=${todayStr}`;
  if (driverId) url += `&driver_id=${driverId}`;
  url += '&status=encaminhado,whatsapp_enviado,entregue';

  allOrders = await api(url).catch(() => []);
  updateCounts();
  renderCurrentTab();
}

function updateCounts() {
  const pendentes = allOrders.filter(r => ['encaminhado','whatsapp_enviado','novo'].includes(r.status));
  const entregues = allOrders.filter(r => r.status === 'entregue');
  document.getElementById('count-pendentes').textContent = pendentes.length;
  document.getElementById('count-entregues').textContent = entregues.length;
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-pendentes').className = 'tab-btn' + (tab === 'pendentes' ? ' active' : '');
  document.getElementById('tab-entregues').className = 'tab-btn' + (tab === 'entregues' ? ' active' : '');
  renderCurrentTab();
}

function renderCurrentTab() {
  if (currentTab === 'pendentes') {
    const rows = allOrders.filter(r => ['encaminhado','whatsapp_enviado','novo'].includes(r.status));
    renderSummaryPendentes(rows);
    renderPendentes(rows);
  } else {
    const rows = allOrders.filter(r => r.status === 'entregue');
    renderSummaryEntregues(rows);
    renderEntregues(rows);
  }
}

function renderSummaryPendentes(rows) {
  const totalVal = rows.reduce((s,r) => s + (r.total_value||0), 0);
  document.getElementById('summary-bar').innerHTML = `
    <span>ğŸ“¦ <strong>${rows.length}</strong> pendentes</span>
    <span>ğŸ’° <strong>R$ ${totalVal.toFixed(2)}</strong></span>
    <span style="margin-left:auto;color:#64748b">ğŸ“… Hoje</span>
  `;
}

function renderSummaryEntregues(rows) {
  const totalVal = rows.reduce((s,r) => s + (r.total_value||0), 0);
  document.getElementById('summary-bar').innerHTML = `
    <span>âœ… <strong>${rows.length}</strong> entregues</span>
    <span>ğŸ’° <strong>R$ ${totalVal.toFixed(2)}</strong></span>
    <span style="margin-left:auto;color:#64748b">ğŸ“… Hoje</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ABA PENDENTES (cards completos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPendentes(rows) {
  const el = document.getElementById('list');
  if (!rows.length) {
    el.innerHTML = '<div class="empty">ğŸ‰ Nenhuma entrega pendente!</div>';
    return;
  }

  el.innerHTML = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${parseInt(i.qty)}Ã— ${i.name}`).join(' Â· ') || 'â€”';
    const hora = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const addr = `${o.address_line}${o.bairro ? ', ' + o.bairro : ''}, Campo Grande/MS`;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const phoneClean = (o.phone_digits||'').replace(/\D/g,'');
    const pgtoLabel = TIPO_LABELS[o.tipo_pagamento] || o.tipo_pagamento || 'â€”';
    const hasPhoto = photoStore[o.id];

    const badgeMap = {
      novo:             '<span class="badge badge-novo">NOVO</span>',
      encaminhado:      '<span class="badge badge-enc">ENCAMINHADO</span>',
      whatsapp_enviado: '<span class="badge badge-wa">WHATS ENVIADO</span>',
    };

    return `
    <div class="card" id="card-${o.id}">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-id">#${o.id} <span class="hour-chip">${hora}</span>${o.driver_name_cache ? ' ğŸšš ' + o.driver_name_cache : ''}</div>
          <div class="card-client">${o.customer_name}</div>
        </div>
        ${badgeMap[o.status] || ''}
      </div>

      <div class="card-body">
        <div class="card-addr">
          ğŸ“ <strong>${o.address_line}</strong>${o.bairro ? ' â€” ' + o.bairro : ''}
          ${o.complemento ? '<br>ğŸ¢ ' + o.complemento : ''}
          ${o.referencia ? '<br><span class="ref">ğŸ“Œ ' + o.referencia + '</span>' : ''}
        </div>
        ${o.notes ? '<div class="notes-box">ğŸ“ ' + o.notes + '</div>' : ''}
        <div class="card-items">ğŸ“¦ ${itemsStr}</div>
        <div class="card-total-row">
          <span class="pgto-badge">${pgtoLabel}</span>
          <span class="card-total">R$ ${(o.total_value||0).toFixed(2)}</span>
        </div>
        <div class="card-quick">
          <a class="btn-maps" href="${mapsUrl}" target="_blank" title="Abrir no Google Maps">ğŸ—ºï¸ Mapa</a>
          ${phoneClean ? '<a class="btn-phone" href="tel:+55' + phoneClean + '" title="Ligar para cliente">ğŸ“ Ligar</a>' : ''}
          ${phoneClean ? '<a class="btn-whats" href="https://wa.me/55' + phoneClean + '" target="_blank" title="WhatsApp do cliente">ğŸ’¬ Zap</a>' : ''}
        </div>
      </div>

      <div class="delivery-section" id="delivery-${o.id}">
        <h3>ğŸ“‹ Finalizar Entrega</h3>

        <div class="delivery-row">
          <label>ğŸ’° Pgto:</label>
          <select id="pgto-${o.id}">
            ${Object.entries(TIPO_LABELS).map(([k,v]) => '<option value="' + k + '"' + (k===o.tipo_pagamento?' selected':'') + '>' + v + '</option>').join('')}
          </select>
        </div>

        <div class="delivery-row">
          <label>ğŸ“ Obs:</label>
          <textarea id="obs-${o.id}" placeholder="ObservaÃ§Ã£o da entrega (opcional)"></textarea>
        </div>

        <div class="photo-area">
          <input type="file" accept="image/*" capture="environment" class="photo-input" id="photo-input-${o.id}" onchange="onPhotoSelected(${o.id}, this)">
          <button class="photo-btn ${hasPhoto ? 'has-photo' : ''}" id="photo-btn-${o.id}" onclick="document.getElementById('photo-input-${o.id}').click()">
            <span class="icon">${hasPhoto ? 'âœ…' : 'ğŸ“¸'}</span>
            ${hasPhoto ? 'Foto capturada âœ“ (toque para trocar)' : 'Tirar foto do comprovante (obrigatÃ³rio)'}
          </button>
          <div class="photo-preview" id="photo-preview-${o.id}" ${hasPhoto ? 'style="display:block"' : ''}>
            ${hasPhoto ? '<img src="' + hasPhoto.dataUrl + '"><button class="remove" onclick="removePhoto(' + o.id + ')">âœ•</button><div class="photo-size">' + hasPhoto.sizeTxt + '</div>' : ''}
          </div>
        </div>

        <button class="btn-deliver ${hasPhoto ? 'ready' : 'disabled'}" id="deliver-btn-${o.id}" onclick="deliver(${o.id})" ${!hasPhoto ? 'disabled' : ''}>
          âœ… Marcar como Entregue
        </button>
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ABA ENTREGUES (mini cards + totais)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderEntregues(rows) {
  const el = document.getElementById('list');
  if (!rows.length) {
    el.innerHTML = '<div class="empty">ğŸ“­ Nenhuma entrega finalizada hoje</div>';
    return;
  }

  // Calcular totais por tipo de pagamento
  const totais = {};
  let grandTotal = 0;
  rows.forEach(o => {
    const tipo = o.tipo_pagamento || 'outros';
    if (!totais[tipo]) totais[tipo] = { count: 0, value: 0 };
    totais[tipo].count++;
    totais[tipo].value += (o.total_value || 0);
    grandTotal += (o.total_value || 0);
  });

  // Card de totais
  let totaisHtml = `
  <div class="totals-card">
    <div class="totals-header">ğŸ’° Resumo â€” ${rows.length} entregas</div>`;

  Object.entries(totais).sort((a,b) => b[1].value - a[1].value).forEach(([tipo, data]) => {
    const icon = TIPO_ICONS[tipo] || 'ğŸ’²';
    const name = TIPO_LABELS[tipo] || tipo;
    totaisHtml += `
    <div class="totals-row">
      <span>
        <span class="pgto-icon">${icon}</span>
        <span class="pgto-name">${name}</span>
        <span class="pgto-count">(${data.count}x)</span>
      </span>
      <span class="pgto-val">R$ ${data.value.toFixed(2)}</span>
    </div>`;
  });

  totaisHtml += `
    <div class="totals-grand">
      <span>TOTAL</span>
      <span>R$ ${grandTotal.toFixed(2)}</span>
    </div>
  </div>`;

  // Mini cards dos pedidos entregues
  const cardsHtml = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${parseInt(i.qty)}Ã— ${i.name}`).join(' Â· ') || 'â€”';
    const hora = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const deliveredTime = o.delivered_at ? formatTime(o.delivered_at) : '';

    const pgtoLabel = TIPO_LABELS[o.tipo_pagamento] || o.tipo_pagamento || 'â€”';

    return `
    <div class="mini-card">
      <div class="mini-top">
        <span class="mini-id">#${o.id} Â· ${hora}${deliveredTime ? ' â†’ âœ… ' + deliveredTime : ''}</span>
        ${o.foto_comprovante ? '<a href="' + API_BASE + '/api/comprovante/' + o.id + '" target="_blank" style="font-size:11px;color:#2563eb;font-weight:700;">ğŸ“· Foto</a>' : ''}
      </div>
      <div class="mini-client">${o.customer_name}</div>
      <div class="mini-items">${itemsStr}</div>
      ${o.observacao_entregador ? '<div style="font-size:11px;color:#7c3aed;margin-top:2px;">ğŸ“ ' + o.observacao_entregador + '</div>' : ''}
      <div class="mini-bottom">
        <span class="mini-pgto">${pgtoLabel}</span>
        <span class="mini-val">R$ ${(o.total_value||0).toFixed(2)}</span>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = totaisHtml + cardsHtml;
}

function formatTime(val) {
  if (!val) return '';
  const d = typeof val === 'number' ? new Date(val * 1000) : new Date(val);
  return d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit', timeZone:'America/Campo_Grande'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ FOTO (capture + compress)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function onPhotoSelected(orderId, input) {
  const file = input.files[0];
  if (!file) return;

  toast('â³ Processando foto...', 'info');

  try {
    const compressed = await compressImage(file, 1200, 0.7);
    const dataUrl = URL.createObjectURL(compressed.blob);
    const sizeTxt = (compressed.blob.size / 1024).toFixed(0) + ' KB';

    photoStore[orderId] = { blob: compressed.blob, dataUrl, sizeTxt };

    const btn = document.getElementById('photo-btn-' + orderId);
    btn.className = 'photo-btn has-photo';
    btn.innerHTML = '<span class="icon">âœ…</span>Foto capturada âœ“ (toque para trocar)';

    const preview = document.getElementById('photo-preview-' + orderId);
    preview.style.display = 'block';
    preview.innerHTML = '<img src="' + dataUrl + '"><button class="remove" onclick="removePhoto(' + orderId + ')">âœ•</button><div class="photo-size">' + sizeTxt + ' (' + compressed.width + 'Ã—' + compressed.height + 'px)</div>';

    const deliverBtn = document.getElementById('deliver-btn-' + orderId);
    deliverBtn.className = 'btn-deliver ready';
    deliverBtn.disabled = false;

    toast('ğŸ“¸ Foto pronta â€” ' + sizeTxt);
  } catch(e) {
    toast('Erro ao processar foto: ' + e.message, 'error');
  }

  input.value = '';
}

function compressImage(file, maxWidth, quality) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
    reader.onload = (e) => {
      const img = new Image();
      img.onerror = () => reject(new Error('Erro ao carregar imagem'));
      img.onload = () => {
        let w = img.width;
        let h = img.height;
        if (w > maxWidth) {
          h = Math.round(h * maxWidth / w);
          w = maxWidth;
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);
        canvas.toBlob(
          (blob) => {
            if (!blob) { reject(new Error('Falha na compressÃ£o')); return; }
            resolve({ blob, width: w, height: h });
          },
          'image/jpeg',
          quality
        );
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function removePhoto(orderId) {
  if (photoStore[orderId] && photoStore[orderId].dataUrl) {
    URL.revokeObjectURL(photoStore[orderId].dataUrl);
  }
  delete photoStore[orderId];

  const btn = document.getElementById('photo-btn-' + orderId);
  if (btn) {
    btn.className = 'photo-btn';
    btn.innerHTML = '<span class="icon">ğŸ“¸</span>Tirar foto do comprovante (obrigatÃ³rio)';
  }
  const preview = document.getElementById('photo-preview-' + orderId);
  if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
  const deliverBtn = document.getElementById('deliver-btn-' + orderId);
  if (deliverBtn) { deliverBtn.className = 'btn-deliver disabled'; deliverBtn.disabled = true; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ DELIVER (com loading overlay)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function deliver(orderId) {
  const photo = photoStore[orderId];
  if (!photo) {
    toast('ğŸ“¸ Tire a foto do comprovante antes!', 'error');
    return;
  }

  const tipoPg = document.getElementById('pgto-' + orderId);
  const obs = document.getElementById('obs-' + orderId);

  const btn = document.getElementById('deliver-btn-' + orderId);
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';
  showLoading('Finalizando entrega...');

  try {
    const formData = new FormData();
    formData.append('photo', photo.blob, 'comprovante_' + orderId + '.jpg');
    if (tipoPg && tipoPg.value) formData.append('tipo_pagamento', tipoPg.value);
    if (obs && obs.value.trim()) formData.append('observacao_entregador', obs.value.trim());

    const token = getSessionToken();
    const key = apiKey();
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    else if (key) headers['X-API-KEY'] = key;

    const resp = await fetch(API_BASE + '/api/order/' + orderId + '/mark-delivered', {
      method: 'POST',
      headers,
      body: formData,
    });

    if (!resp.ok) {
      const errData = await resp.json().catch(() => ({ error: resp.statusText }));
      throw new Error(errData.error || 'Erro ' + resp.status);
    }

    const result = await resp.json();
    removePhoto(orderId);
    hideLoading();

    let msg = 'âœ… Pedido #' + orderId + ' entregue!';
    if (result.bling_result && result.bling_result.action === 'created') {
      msg += ' Venda Bling nÂº ' + result.bling_result.bling_num + ' criada.';
    } else if (result.bling_result && result.bling_result.action === 'create_error') {
      msg += ' âš ï¸ Erro Bling: ' + result.bling_result.error;
    }
    toast(msg, result.bling_result && result.bling_result.action === 'create_error' ? 'warning' : 'success');

    load();
  } catch (e) {
    hideLoading();
    toast('âŒ ' + e.message, 'error');
    btn.disabled = false;
    btn.className = 'btn-deliver ready';
    btn.innerHTML = 'âœ… Marcar como Entregue';
  }
}

function toggleAuto() {
  clearInterval(autoTimer);
  if (document.getElementById('autoRefresh').checked) {
    autoTimer = setInterval(load, 30000);
    toast('Auto-refresh 30s ativado');
  }
}

init();
</script>
</body>
</html>
