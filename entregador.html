<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pedidos do Dia â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }
  select, input[type=date] { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
  .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-blue { background: #2563eb; color: #fff; }
  .btn-orange { background: #f97316; color: #fff; }
  .container { padding: 16px; max-width: 900px; margin: 0 auto; }
  .card { background: #fff; border-radius: 12px; padding: 16px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); border-left: 5px solid #e2e8f0; }
  .card.novo             { border-left-color: #dc2626; }
  .card.encaminhado      { border-left-color: #d97706; }
  .card.whatsapp_enviado { border-left-color: #16a34a; }
  .card.entregue         { border-left-color: #2563eb; }
  .card.cancelado        { border-left-color: #9ca3af; opacity: 0.6; }
  .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .card-title { font-size: 16px; font-weight: 800; color: #1e293b; }
  .card-body { font-size: 14px; color: #374151; line-height: 1.8; }
  .card-body .addr { font-size: 13px; color: #64748b; }
  .card-footer { display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap; }
  .btn-sm { padding: 8px 14px; font-size: 13px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; }
  .btn-maps { background: #f0fdf4; color: #16a34a; border: 2px solid #bbf7d0; }
  .btn-delivered { background: #2563eb; color: #fff; }
  .items-list { background: #f8fafc; border-radius: 6px; padding: 8px 12px; margin-top: 8px; font-size: 13px; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 16px; }
  .badge { display:inline-block;padding:3px 10px;border-radius:12px;font-size:12px;font-weight:700;color:#fff; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="toolbar">
  <input type="date" id="fDate" onchange="load()">
  <select id="fDriver" onchange="load()">
    <option value="">Todos entregadores</option>
  </select>
  <select id="fStatus" onchange="load()">
    <option value="">Todos status</option>
    <option value="encaminhado">ğŸŸ¡ Encaminhado</option>
    <option value="whatsapp_enviado">ğŸŸ¢ WhatsApp Enviado</option>
    <option value="entregue">ğŸ”µ Entregue</option>
  </select>
  <button class="btn btn-orange" onclick="load()">ğŸ”„</button>
  <span id="count-lbl" style="font-size:13px;color:#64748b"></span>
</div>

<div class="container">
  <div id="list"></div>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

document.getElementById('fDate').value = today();

async function init() {
  const drivers = await api('/api/drivers').catch(() => []);
  const sel = document.getElementById('fDriver');
  drivers.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = d.name;
    sel.appendChild(opt);
  });
  load();
}

async function load() {
  const date     = document.getElementById('fDate').value;
  const driverId = document.getElementById('fDriver').value;
  const status   = document.getElementById('fStatus').value;

  let url = '/api/orders/list?';
  if (date)     url += `&date=${date}`;
  if (driverId) url += `&driver_id=${driverId}`;
  if (status)   url += `&status=${status}`;

  const rows = await api(url).catch(() => []);
  document.getElementById('count-lbl').textContent = `${rows.length} pedidos`;
  render(rows);
}

function render(rows) {
  const el = document.getElementById('list');
  if (!rows.length) {
    el.innerHTML = '<div class="empty">ğŸ“­ Nenhum pedido encontrado</div>';
    return;
  }

  el.innerHTML = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${i.qty}Ã— ${i.name}`).join(' | ') || 'â€”';
    const hora = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const addr = `${o.address_line}${o.bairro ? ', ' + o.bairro : ''}, Campo Grande/MS`;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;

    const canDeliver = ['whatsapp_enviado','encaminhado'].includes(o.status);

    return `
    <div class="card ${o.status}">
      <div class="card-header">
        <span class="card-title">#${o.id} â€” ${o.customer_name}</span>
        ${statusBadge(o.status)}
      </div>
      <div class="card-body">
        <div>ğŸ“ ${o.phone_digits || 'â€”'}</div>
        <div class="addr">ğŸ“ ${o.address_line}${o.bairro ? ' â€” ' + o.bairro : ''}</div>
        ${o.referencia ? `<div class="addr">ğŸ“Œ Ref: ${o.referencia}</div>` : ''}
        ${o.driver_name_cache ? `<div class="addr">ğŸšš Entregador: <strong>${o.driver_name_cache}</strong></div>` : ''}
        <div class="items-list">ğŸ“¦ ${itemsStr}</div>
        ${o.notes ? `<div style="margin-top:6px;font-size:12px;color:#7c3aed">ğŸ“ ${o.notes}</div>` : ''}
      </div>
      <div class="card-footer">
        <a class="btn-sm btn-maps" href="${mapsUrl}" target="_blank">ğŸ—ºï¸ Abrir Mapa</a>
        ${canDeliver ? `<button class="btn-sm btn-delivered" onclick="deliver(${o.id})">âœ… Marcar Entregue</button>` : ''}
        ${o.total_value ? `<span style="font-weight:800;font-size:15px;color:#1e293b;margin-left:auto">ğŸ’° R$ ${o.total_value.toFixed(2)}</span>` : ''}
      </div>
    </div>`;
  }).join('');
}

async function deliver(id) {
  if (!confirm(`Marcar pedido #${id} como entregue?`)) return;
  try {
    await api(`/api/order/${id}/mark-delivered`, { method: 'POST' });
    toast('âœ… Entregue!');
    load();
  } catch(e) { toast(e.message, 'error'); }
}

init();
</script>
</body>
</html>
