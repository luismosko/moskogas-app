<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>Entregador v2.6.5 â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, -apple-system, sans-serif; background: #f1f5f9; min-height: 100vh; -webkit-tap-highlight-color: transparent; }

  /* â”€â”€ Toolbar â”€â”€ */
  .toolbar { background: #0f172a; padding: 10px 12px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; position: sticky; top: 0; z-index: 50; }
  .toolbar h1 { color: #fff; font-size: 16px; font-weight: 800; margin-right: auto; }
  .toolbar h1 small { font-weight: 400; color: #94a3b8; font-size: 11px; }
  .toolbar select { padding: 8px 10px; border: none; border-radius: 8px; font-size: 13px; background: #334155; color: #fff; }
  .toolbar select option { background: #1e293b; }
  .btn { padding: 9px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 14px; }
  .btn-refresh { background: #f97316; color: #fff; }
  .auto-lbl { color: #94a3b8; font-size: 11px; display: flex; align-items: center; gap: 4px; cursor: pointer; }
  .auto-lbl input { accent-color: #f97316; width: 16px; height: 16px; }

  /* â”€â”€ Tabs â”€â”€ */
  .tab-bar { display: flex; background: #1e293b; border-bottom: 2px solid #334155; }
  .tab-btn { flex: 1; padding: 12px 8px; text-align: center; font-size: 14px; font-weight: 700; color: #94a3b8; background: transparent; border: none; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
  .tab-btn.active { color: #fff; border-bottom-color: #f97316; background: #334155; }
  .tab-btn .tab-count { display: inline-block; background: #475569; color: #fff; border-radius: 12px; padding: 1px 8px; font-size: 11px; margin-left: 4px; }
  .tab-btn.active .tab-count { background: #f97316; }

  /* â”€â”€ Summary â”€â”€ */
  .summary-bar { background: #1e293b; color: #fff; padding: 8px 12px; display: flex; gap: 14px; flex-wrap: wrap; font-size: 12px; }
  .summary-bar strong { color: #f97316; }

  /* â”€â”€ Container â”€â”€ */
  .container { padding: 10px; max-width: 600px; margin: 0 auto; }

  /* â”€â”€ Card â”€â”€ */
  .card { background: #fff; border-radius: 16px; margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
  .card-header { padding: 14px 14px 8px; display: flex; justify-content: space-between; align-items: flex-start; }
  .card-header-left { flex: 1; }
  .card-id { font-size: 11px; color: #94a3b8; font-weight: 700; }
  .card-client { font-size: 16px; font-weight: 800; color: #1e293b; margin-top: 2px; }
  .hour-chip { background: #e2e8f0; color: #475569; border-radius: 6px; padding: 2px 7px; font-size: 10px; font-weight: 700; }

  .badge { display: inline-flex; align-items: center; padding: 4px 10px; border-radius: 99px; font-size: 10px; font-weight: 800; letter-spacing: 0.5px; }
  .badge-novo   { background: #fee2e2; color: #dc2626; }
  .badge-enc    { background: #fef3c7; color: #d97706; }
  .badge-wa     { background: #dcfce7; color: #16a34a; }
  .badge-entregue { background: #dbeafe; color: #2563eb; }
  .badge-cancel { background: #f1f5f9; color: #6b7280; }

  .card-body { padding: 0 14px; }
  .card-addr { background: #f8fafc; border-radius: 10px; padding: 10px 12px; margin-bottom: 8px; font-size: 13px; color: #374151; line-height: 1.6; }
  .card-addr .ref { color: #7c3aed; font-size: 12px; font-weight: 600; }
  .notes-box { background: #faf5ff; border-left: 3px solid #7c3aed; padding: 8px 12px; border-radius: 0 8px 8px 0; font-size: 12px; color: #7c3aed; margin-bottom: 8px; }
  .card-items { font-size: 14px; font-weight: 700; color: #1e293b; padding: 0 0 6px; }
  .card-total-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
  .card-total { font-size: 20px; font-weight: 900; color: #16a34a; }
  .pgto-badge { font-size: 12px; font-weight: 700; padding: 3px 10px; border-radius: 8px; background: #f1f5f9; color: #475569; }

  /* â”€â”€ Quick action buttons â”€â”€ */
  .card-quick { display: flex; gap: 6px; padding: 8px 0; flex-wrap: wrap; }
  .btn-maps  { background: #dcfce7; color: #16a34a; border: 2px solid #86efac; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }
  .btn-phone { background: #dbeafe; color: #2563eb; border: 2px solid #93c5fd; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }
  .btn-whats { background: #d1fae5; color: #059669; border: 2px solid #6ee7b7; padding: 8px 10px; border-radius: 10px; font-size: 12px; font-weight: 700; cursor: pointer; text-decoration: none; display: inline-flex; align-items: center; gap: 4px; flex: 1; justify-content: center; min-width: 0; }

  /* â”€â”€ Delivery section â”€â”€ */
  .delivery-section { border-top: 2px dashed #e2e8f0; margin-top: 6px; padding: 14px; background: #f8fafc; }
  .delivery-section h3 { font-size: 13px; color: #475569; font-weight: 700; margin-bottom: 10px; }
  .delivery-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }
  .delivery-row label { font-size: 12px; font-weight: 700; color: #475569; min-width: 70px; }
  .delivery-row select, .delivery-row textarea { flex: 1; padding: 8px 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; font-family: inherit; }
  .delivery-row textarea { resize: vertical; min-height: 50px; }
  .delivery-row select:focus, .delivery-row textarea:focus { border-color: #3b82f6; outline: none; }

  /* â”€â”€ Photo capture â”€â”€ */
  .photo-area { margin-bottom: 12px; }
  .photo-btn { width: 100%; padding: 14px; border: 3px dashed #94a3b8; border-radius: 12px; background: #fff; cursor: pointer; text-align: center; font-size: 14px; font-weight: 700; color: #64748b; transition: all 0.2s; }
  .photo-btn:active { transform: scale(0.98); background: #f1f5f9; }
  .photo-btn.has-photo { border-color: #16a34a; border-style: solid; background: #f0fdf4; color: #16a34a; }
  .photo-btn .icon { font-size: 28px; display: block; margin-bottom: 4px; }
  .photo-preview { margin-top: 8px; position: relative; display: none; }
  .photo-preview img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 10px; border: 2px solid #16a34a; }
  .photo-preview .remove { position: absolute; top: 6px; right: 6px; background: #dc2626; color: #fff; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 14px; font-weight: 900; cursor: pointer; }
  .photo-size { text-align: center; font-size: 11px; color: #64748b; margin-top: 4px; }
  .photo-input { display: none !important; }

  /* â”€â”€ Deliver button â”€â”€ */
  .btn-deliver { width: 100%; padding: 16px; border: none; border-radius: 12px; font-size: 16px; font-weight: 900; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
  .btn-deliver.ready { background: #2563eb; color: #fff; }
  .btn-deliver.ready:active { transform: scale(0.97); background: #1d4ed8; }
  .btn-deliver.disabled { background: #e2e8f0; color: #94a3b8; cursor: not-allowed; }

  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite; }

  .empty { text-align: center; padding: 60px 20px; color: #94a3b8; font-size: 16px; }
  .version-badge { position: fixed; bottom: 6px; right: 8px; background: rgba(0,0,0,0.5); color: #fff; padding: 2px 8px; border-radius: 8px; font-size: 9px; font-weight: 700; z-index: 99; }

  /* â”€â”€ Totais (aba entregues) â”€â”€ */
  .totals-card { background: #fff; border-radius: 16px; margin-bottom: 14px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); overflow: hidden; }
  .totals-header { background: #1e293b; color: #fff; padding: 12px 14px; font-size: 14px; font-weight: 800; }
  .totals-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  .totals-row:last-child { border-bottom: none; }
  .totals-row .pgto-icon { font-size: 16px; }
  .totals-row .pgto-name { font-weight: 600; color: #374151; }
  .totals-row .pgto-count { color: #64748b; font-size: 12px; }
  .totals-row .pgto-val { font-weight: 800; color: #16a34a; }
  .totals-grand { display: flex; justify-content: space-between; align-items: center; padding: 14px; background: #f0fdf4; font-size: 18px; font-weight: 900; color: #16a34a; border-top: 2px solid #16a34a; }

  /* â”€â”€ Entregue mini card â”€â”€ */
  .mini-card { background: #fff; border-radius: 12px; margin-bottom: 8px; box-shadow: 0 1px 6px rgba(0,0,0,0.06); padding: 12px 14px; }
  .mini-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
  .mini-id { font-size: 11px; color: #94a3b8; font-weight: 700; }
  .mini-client { font-size: 14px; font-weight: 700; color: #1e293b; }
  .mini-items { font-size: 12px; color: #64748b; margin-top: 2px; }
  .mini-bottom { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; }
  .mini-pgto { font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 6px; background: #f1f5f9; color: #475569; }
  .mini-val { font-size: 16px; font-weight: 900; color: #16a34a; }

  @media (max-width: 600px) {
    .toolbar h1 { font-size: 14px; }
    .card-client { font-size: 15px; }
  }

  /* â”€â”€ FAB â”€â”€ */
  .fab { position: fixed; bottom: 24px; right: 20px; z-index: 90; background: #16a34a; color: #fff; border: none; border-radius: 50px; padding: 14px 20px; font-size: 16px; font-weight: 800; box-shadow: 0 4px 20px rgba(0,0,0,0.25); cursor: pointer; display: flex; align-items: center; gap: 6px; }
  .fab:active { transform: scale(0.95); }

  /* â”€â”€ Modal Venda â”€â”€ */
  .venda-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 200; justify-content: center; align-items: flex-start; padding: 10px; overflow-y: auto; }
  .venda-overlay.active { display: flex; }
  .venda-modal { background: #fff; border-radius: 16px; width: 100%; max-width: 500px; margin: 20px auto; box-shadow: 0 8px 40px rgba(0,0,0,0.3); }
  .venda-header { background: #16a34a; color: #fff; padding: 14px 16px; border-radius: 16px 16px 0 0; display: flex; justify-content: space-between; align-items: center; }
  .venda-header h2 { font-size: 17px; margin: 0; }
  .venda-header .close-x { background: none; border: none; color: #fff; font-size: 22px; cursor: pointer; padding: 0 4px; }
  .venda-body { padding: 14px 16px; }
  .venda-body label { display: block; font-size: 13px; font-weight: 700; color: #374151; margin: 10px 0 4px; }
  .venda-body input, .venda-body select, .venda-body textarea { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 14px; }
  .venda-body input:focus, .venda-body select:focus { border-color: #16a34a; outline: none; }
  .prod-grid { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0; }
  .prod-btn { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 10px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 600; transition: all .15s; display: flex; align-items: center; gap: 4px; }
  .prod-btn.sel { border-color: #16a34a; background: #dcfce7; }
  .prod-btn:active { transform: scale(0.95); }
  .cart-list { margin: 8px 0; }
  .cart-item { display: flex; align-items: center; gap: 8px; padding: 8px; background: #f8fafc; border-radius: 8px; margin-bottom: 6px; }
  .cart-item .name { flex: 1; font-weight: 600; font-size: 13px; }
  .cart-item .qty-ctrl { display: flex; align-items: center; gap: 4px; }
  .cart-item .qty-btn { width: 28px; height: 28px; border: none; border-radius: 8px; font-size: 16px; font-weight: 900; cursor: pointer; }
  .cart-item .qty-btn.minus { background: #fee2e2; color: #dc2626; }
  .cart-item .qty-btn.plus { background: #dcfce7; color: #16a34a; }
  .cart-item .qty-val { font-size: 16px; font-weight: 800; min-width: 24px; text-align: center; }
  .cart-item .price { font-weight: 800; color: #16a34a; font-size: 14px; white-space: nowrap; }
  .venda-total { font-size: 20px; font-weight: 900; text-align: right; color: #16a34a; padding: 8px 0; border-top: 2px solid #e2e8f0; margin-top: 8px; }
  .venda-footer { padding: 12px 16px; border-top: 2px solid #f1f5f9; }
  .btn-venda-submit { width: 100%; padding: 14px; border: none; border-radius: 12px; font-size: 16px; font-weight: 800; cursor: pointer; }
  .btn-venda-submit.ready { background: #16a34a; color: #fff; }
  .btn-venda-submit.disabled { background: #e2e8f0; color: #94a3b8; }

  /* â”€â”€ QR Review Modal â”€â”€ */
  .qr-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 250; justify-content: center; align-items: center; padding: 20px; }
  .qr-overlay.active { display: flex; }
  .qr-modal { background: #fff; border-radius: 20px; width: 100%; max-width: 360px; text-align: center; overflow: hidden; animation: qrPop .3s ease; }
  @keyframes qrPop { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
  .qr-top { background: linear-gradient(135deg, #f59e0b, #f97316); padding: 18px 16px 12px; color: #fff; }
  .qr-top h2 { font-size: 20px; margin: 0 0 4px; }
  .qr-top p { font-size: 13px; margin: 0; opacity: 0.9; }
  .qr-body { padding: 20px; }
  .qr-body img { width: 220px; height: 220px; border-radius: 12px; border: 3px solid #f97316; }
  .qr-hint { font-size: 14px; color: #374151; margin: 14px 0 4px; font-weight: 600; }
  .qr-sub { font-size: 12px; color: #6b7280; margin: 0 0 16px; }
  .qr-actions { display: flex; gap: 10px; justify-content: center; padding: 0 16px 18px; }
  .qr-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-size: 14px; font-weight: 700; cursor: pointer; }
  .qr-btn-show { background: #f97316; color: #fff; }
  .qr-btn-skip { background: #f1f5f9; color: #64748b; }
  /* PIX QR Code Modal */
  .pix-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.6); z-index:9999; justify-content:center; align-items:center; }
  .pix-overlay.active { display:flex; }
  .pix-modal { background:#fff; border-radius:16px; padding:24px; max-width:380px; width:92%; text-align:center; position:relative; max-height:90vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,.3); }
  .pix-modal .close-btn { position:absolute; top:8px; right:12px; font-size:24px; background:none; border:none; cursor:pointer; color:#64748b; }
  .pix-valor { font-size:32px; font-weight:900; color:#0891b2; margin:8px 0 16px; }
  .pix-copiacola { background:#f0fdfa; border:2px solid #0891b2; border-radius:8px; padding:10px; font-size:11px; word-break:break-all; color:#334155; margin:8px 0 16px; max-height:100px; overflow-y:auto; }
  .pix-btn { display:block; width:100%; padding:12px; border:none; border-radius:10px; font-size:15px; font-weight:700; cursor:pointer; margin-top:8px; }
  .pix-btn-copy { background:#0891b2; color:#fff; }
  .pix-btn-whats { background:#25d366; color:#fff; }
  .pix-btn-close { background:#e2e8f0; color:#475569; }
  .btn-pix-card { background:linear-gradient(135deg,#0891b2,#06b6d4); color:#fff; border:none; border-radius:10px; padding:12px; font-size:15px; font-weight:700; width:100%; cursor:pointer; margin-top:8px; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="toolbar">
  <h1>ğŸšš Entregas <small>v2.6.5</small></h1>
  <select id="fDriver" onchange="load()">
    <option value="">Todos</option>
  </select>
  <button class="btn btn-refresh" onclick="load()" title="Atualizar">ğŸ”„</button>
  <label class="auto-lbl"><input type="checkbox" id="autoRefresh" onchange="toggleAuto()"> 30s</label>
</div>

<div class="tab-bar">
  <button class="tab-btn active" id="tab-pendentes" onclick="switchTab('pendentes')">ğŸ“¦ Pendentes <span class="tab-count" id="count-pendentes">0</span></button>
  <button class="tab-btn" id="tab-entregues" onclick="switchTab('entregues')">âœ… Entregues <span class="tab-count" id="count-entregues">0</span></button>
</div>

<div class="summary-bar" id="summary-bar"></div>

<div class="container">
  <div id="list"></div>
</div>

<div class="version-badge">v2.6.5 â€” entregador</div>

<!-- PIX QR Code Modal -->
<div class="pix-overlay" id="pixOverlay">
  <div class="pix-modal">
    <button class="close-btn" onclick="closePixModal()">âœ•</button>
    <h3 style="color:#0891b2;margin-bottom:12px">ğŸ’  PIX â€” QR Code</h3>
    <div id="pixBody"></div>
    <div id="pixActions"></div>
  </div>
</div>

<!-- FAB Nova Venda -->
<button class="fab" onclick="openVendaModal()" title="Registrar venda externa">â• Venda</button>

<!-- Modal Venda Externa -->
<div class="venda-overlay" id="vendaOverlay">
<div class="venda-modal">
  <div class="venda-header">
    <h2>ğŸ›’ Venda Externa</h2>
    <button class="close-x" onclick="closeVendaModal()">âœ•</button>
  </div>
  <div class="venda-body">
    <label>ğŸ‘¤ Cliente</label>
    <input id="ve-nome" placeholder="Nome do cliente">

    <label>ğŸ“ Telefone</label>
    <input id="ve-phone" placeholder="(67) 99999-9999" inputmode="tel">

    <label>ğŸ“ EndereÃ§o</label>
    <input id="ve-endereco" placeholder="Rua, nÃºmero (opcional)">

    <label>ğŸ˜ï¸ Bairro</label>
    <input id="ve-bairro" placeholder="Bairro (opcional)">

    <label>ğŸ“¦ Produtos</label>
    <div class="prod-grid" id="ve-prod-grid"></div>
    <div class="cart-list" id="ve-cart"></div>
    <div class="venda-total" id="ve-total" style="display:none">R$ 0.00</div>

    <label>ğŸ’° Pagamento</label>
    <select id="ve-pgto">
      <option value="dinheiro">ğŸ’µ Dinheiro</option>
      <option value="pix_vista">âœ… PIX Pago</option>
      <option value="pix_receber">â³ PIX a Receber</option>
      <option value="mensalista">ğŸ“… Mensalista</option>
      <option value="debito">ğŸ’³ DÃ©bito</option>
      <option value="credito">ğŸ’³ CrÃ©dito</option>
    </select>

    <label>ğŸ“ ObservaÃ§Ã£o</label>
    <textarea id="ve-obs" rows="2" placeholder="Opcional"></textarea>

    <label>ğŸ“¸ Foto do comprovante</label>
    <input type="file" accept="image/*" capture="environment" id="ve-photo-input" onchange="onVendaPhoto(this)" style="display:none">
    <button class="photo-btn" id="ve-photo-btn" onclick="document.getElementById('ve-photo-input').click()" style="width:100%;margin:4px 0">
      <span class="icon">ğŸ“¸</span> Tirar foto (obrigatÃ³rio)
    </button>
    <div class="photo-preview" id="ve-photo-preview"></div>
  </div>
  <div class="venda-footer">
    <button class="btn-venda-submit disabled" id="ve-submit" onclick="submitVendaExterna()" disabled>
      âœ… Registrar Venda
    </button>
  </div>
</div>
</div>

<!-- QR Review Modal -->
<div class="qr-overlay" id="qrOverlay">
<div class="qr-modal">
  <div class="qr-top">
    <h2>â­ Avalie-nos no Google!</h2>
    <p>Mostre o QR Code ao cliente</p>
  </div>
  <div class="qr-body">
    <img id="qrImg" src="" alt="QR Code">
    <div class="qr-hint">ğŸ“± PeÃ§a ao cliente para escanear</div>
    <div class="qr-sub">Sua avaliaÃ§Ã£o nos ajuda muito!</div>
  </div>
  <div class="qr-actions">
    <button class="qr-btn qr-btn-show" onclick="qrShown()">ğŸ‘ Mostrei ao cliente</button>
    <button class="qr-btn qr-btn-skip" onclick="closeQr()">Pular</button>
  </div>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="shared.js"></script>
<script>
// v2.6.5
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

const TIPO_LABELS = {
  dinheiro: 'ğŸ’µ Dinheiro', pix_vista: 'âœ… PIX Pago', pix_receber: 'â³ PIX a Receber',
  mensalista: 'ğŸ“… Mensalista', boleto: 'ğŸ§¾ Boleto/Ã“rgÃ£o', debito: 'ğŸ’³ DÃ©bito', credito: 'ğŸ’³ CrÃ©dito'
};
const TIPO_ICONS = {
  dinheiro: 'ğŸ’µ', pix_vista: 'âš¡', pix_receber: 'â³',
  mensalista: 'ğŸ“…', boleto: 'ğŸ§¾', debito: 'ğŸ’³', credito: 'ğŸ’³'
};

const photoStore = {};
let fotoConfig = { maxDim: 800, quality: 55, contraste: true, desaturacao: 50, formato: 'webp' };
let autoTimer;
let allOrders = [];
let currentTab = 'pendentes';

async function init() {
  // Carregar config de foto do backend
  try {
    const fc = await api('/api/pub/foto-config').catch(() => null);
    if (fc && fc.maxDim) fotoConfig = fc;
  } catch(_) {}

  // Carregar produtos para venda externa
  await loadVendaProducts();

  // Carregar URL de avaliaÃ§Ã£o Google
  await loadReviewConfig();

  const drivers = await api('/api/drivers').catch(() => []);
  const sel = document.getElementById('fDriver');
  drivers.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = d.name;
    sel.appendChild(opt);
  });

  const user = getCurrentUser();
  if (user && user.role === 'entregador') {
    const match = drivers.find(d => d.id == user.id);
    if (match) sel.value = match.id;
  }

  load();
}

async function load() {
  const driverId = document.getElementById('fDriver').value;
  const todayStr = today();

  let url = `/api/orders/list?date=${todayStr}`;
  if (driverId) url += `&driver_id=${driverId}`;
  url += '&status=encaminhado,whatsapp_enviado,entregue';

  allOrders = await api(url).catch(() => []);
  updateCounts();
  renderCurrentTab();
}

function updateCounts() {
  const pendentes = allOrders.filter(r => ['encaminhado','whatsapp_enviado','novo'].includes(r.status));
  const entregues = allOrders.filter(r => r.status === 'entregue');
  document.getElementById('count-pendentes').textContent = pendentes.length;
  document.getElementById('count-entregues').textContent = entregues.length;
}

function switchTab(tab) {
  currentTab = tab;
  document.getElementById('tab-pendentes').className = 'tab-btn' + (tab === 'pendentes' ? ' active' : '');
  document.getElementById('tab-entregues').className = 'tab-btn' + (tab === 'entregues' ? ' active' : '');
  renderCurrentTab();
}

function renderCurrentTab() {
  if (currentTab === 'pendentes') {
    const rows = allOrders.filter(r => ['encaminhado','whatsapp_enviado','novo'].includes(r.status));
    renderSummaryPendentes(rows);
    renderPendentes(rows);
  } else {
    const rows = allOrders.filter(r => r.status === 'entregue');
    renderSummaryEntregues(rows);
    renderEntregues(rows);
  }
}

function renderSummaryPendentes(rows) {
  const totalVal = rows.reduce((s,r) => s + (r.total_value||0), 0);
  document.getElementById('summary-bar').innerHTML = `
    <span>ğŸ“¦ <strong>${rows.length}</strong> pendentes</span>
    <span>ğŸ’° <strong>R$ ${totalVal.toFixed(2)}</strong></span>
    <span style="margin-left:auto;color:#64748b">ğŸ“… Hoje</span>
  `;
}

function renderSummaryEntregues(rows) {
  const totalVal = rows.reduce((s,r) => s + (r.total_value||0), 0);
  document.getElementById('summary-bar').innerHTML = `
    <span>âœ… <strong>${rows.length}</strong> entregues</span>
    <span>ğŸ’° <strong>R$ ${totalVal.toFixed(2)}</strong></span>
    <span style="margin-left:auto;color:#64748b">ğŸ“… Hoje</span>
  `;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ABA PENDENTES (cards completos)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPendentes(rows) {
  const el = document.getElementById('list');
  if (!rows.length) {
    el.innerHTML = '<div class="empty">ğŸ‰ Nenhuma entrega pendente!</div>';
    return;
  }

  el.innerHTML = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${parseInt(i.qty)}Ã— ${i.name}`).join(' Â· ') || 'â€”';
    const hora = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const addr = `${o.address_line}${o.bairro ? ', ' + o.bairro : ''}, Campo Grande/MS`;
    const mapsUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
    const phoneClean = (o.phone_digits||'').replace(/\D/g,'');
    const pgtoLabel = TIPO_LABELS[o.tipo_pagamento] || o.tipo_pagamento || 'â€”';
    const hasPhoto = photoStore[o.id];

    const badgeMap = {
      novo:             '<span class="badge badge-novo">NOVO</span>',
      encaminhado:      '<span class="badge badge-enc">ENCAMINHADO</span>',
      whatsapp_enviado: '<span class="badge badge-wa">WHATS ENVIADO</span>',
    };

    return `
    <div class="card" id="card-${o.id}">
      <div class="card-header">
        <div class="card-header-left">
          <div class="card-id">#${o.id} <span class="hour-chip">${hora}</span>${o.driver_name_cache ? ' ğŸšš ' + o.driver_name_cache : ''}</div>
          <div class="card-client">${o.customer_name} <span style="font-weight:400;font-size:13px;color:#64748b">â€” ${o.address_line || ''}</span></div>
        </div>
        ${badgeMap[o.status] || ''}
      </div>

      <div class="card-body">
        <div class="card-addr">
          ğŸ“ <strong>${o.address_line}</strong>${o.bairro ? ' â€” ' + o.bairro : ''}
          ${o.complemento ? '<br>ğŸ¢ ' + o.complemento : ''}
          ${o.referencia ? '<br><span class="ref">ğŸ“Œ ' + o.referencia + '</span>' : ''}
        </div>
        ${o.notes ? '<div class="notes-box">ğŸ“ ' + o.notes + '</div>' : ''}
        <div class="card-items">ğŸ“¦ ${itemsStr}</div>
        <div class="card-total-row">
          <span class="pgto-badge">${pgtoLabel}</span>
          <span class="card-total">R$ ${(o.total_value||0).toFixed(2)}</span>
        </div>
        <div class="card-quick">
          <a class="btn-maps" href="${mapsUrl}" target="_blank" title="Abrir no Google Maps">ğŸ—ºï¸ Mapa</a>
          ${phoneClean ? '<a class="btn-phone" href="tel:+55' + phoneClean + '" title="Ligar para cliente">ğŸ“ Ligar</a>' : ''}
          ${phoneClean ? '<a class="btn-whats" href="https://wa.me/55' + phoneClean + '" target="_blank" title="WhatsApp do cliente">ğŸ’¬ Zap</a>' : ''}
        </div>
      </div>

      <div class="delivery-section" id="delivery-${o.id}">
        <h3>ğŸ“‹ Finalizar Entrega</h3>

        <div class="delivery-row" style="flex-direction:column;align-items:flex-start;gap:4px">
          <label>ğŸ’° Pgto solicitado:</label>
          <div style="width:100%;padding:8px 12px;background:#f1f5f9;border-radius:8px;font-weight:700;color:#334155;font-size:13px">${pgtoLabel}</div>
        </div>

        <div class="delivery-row">
          <label>âœ… Pgto recebido: *</label>
          <select id="pgto-${o.id}" required>
            <option value="">â€” Selecione como recebeu â€”</option>
            ${Object.entries(TIPO_LABELS).map(([k,v]) => '<option value="' + k + '">' + v + '</option>').join('')}
          </select>
        </div>

        <div class="delivery-row">
          <label>ğŸ“ Obs:</label>
          <textarea id="obs-${o.id}" placeholder="ObservaÃ§Ã£o da entrega (opcional)"></textarea>
        </div>

        <div class="photo-area">
          <input type="file" accept="image/*" capture="environment" class="photo-input" id="photo-input-${o.id}" onchange="onPhotoSelected(${o.id}, this)">
          <button class="photo-btn ${hasPhoto ? 'has-photo' : ''}" id="photo-btn-${o.id}" onclick="document.getElementById('photo-input-${o.id}').click()">
            <span class="icon">${hasPhoto ? 'âœ…' : 'ğŸ“¸'}</span>
            ${hasPhoto ? 'Foto capturada âœ“ (toque para trocar)' : 'Tirar foto do comprovante (obrigatÃ³rio)'}
          </button>
          <div class="photo-preview" id="photo-preview-${o.id}" ${hasPhoto ? 'style="display:block"' : ''}>
            ${hasPhoto ? '<img src="' + hasPhoto.dataUrl + '"><button class="remove" onclick="removePhoto(' + o.id + ')">âœ•</button><div class="photo-size">' + hasPhoto.sizeTxt + '</div>' : ''}
          </div>
        </div>

        <button class="btn-deliver ${hasPhoto ? 'ready' : 'disabled'}" id="deliver-btn-${o.id}" onclick="deliver(${o.id})" ${!hasPhoto ? 'disabled' : ''}>
          âœ… Marcar como Entregue
        </button>
        ${o.tipo_pagamento === 'pix_receber' ? '<button class="btn-pix-card" onclick="abrirPixQr(' + o.id + ')">ğŸ’  PIX QR Code Mosko</button>' : ''}
      </div>
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ ABA ENTREGUES (mini cards + totais)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderEntregues(rows) {
  const el = document.getElementById('list');
  if (!rows.length) {
    el.innerHTML = '<div class="empty">ğŸ“­ Nenhuma entrega finalizada hoje</div>';
    return;
  }

  // Calcular totais por tipo de pagamento
  const totais = {};
  let grandTotal = 0;
  rows.forEach(o => {
    const tipo = o.tipo_pagamento || 'outros';
    if (!totais[tipo]) totais[tipo] = { count: 0, value: 0 };
    totais[tipo].count++;
    totais[tipo].value += (o.total_value || 0);
    grandTotal += (o.total_value || 0);
  });

  // Card de totais
  let totaisHtml = `
  <div class="totals-card">
    <div class="totals-header">ğŸ’° Resumo â€” ${rows.length} entregas</div>`;

  Object.entries(totais).sort((a,b) => b[1].value - a[1].value).forEach(([tipo, data]) => {
    const icon = TIPO_ICONS[tipo] || 'ğŸ’²';
    const name = TIPO_LABELS[tipo] || tipo;
    totaisHtml += `
    <div class="totals-row">
      <span>
        <span class="pgto-icon">${icon}</span>
        <span class="pgto-name">${name}</span>
        <span class="pgto-count">(${data.count}x)</span>
      </span>
      <span class="pgto-val">R$ ${data.value.toFixed(2)}</span>
    </div>`;
  });

  totaisHtml += `
    <div class="totals-grand">
      <span>TOTAL</span>
      <span>R$ ${grandTotal.toFixed(2)}</span>
    </div>
  </div>`;

  // Mini cards dos pedidos entregues
  const cardsHtml = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${parseInt(i.qty)}Ã— ${i.name}`).join(' Â· ') || 'â€”';
    const hora = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const deliveredTime = o.delivered_at ? formatTime(o.delivered_at) : '';

    const pgtoLabel = TIPO_LABELS[o.tipo_pagamento] || o.tipo_pagamento || 'â€”';

    return `
    <div class="mini-card">
      <div class="mini-top">
        <span class="mini-id">#${o.id} Â· ${hora}${deliveredTime ? ' â†’ âœ… ' + deliveredTime : ''}</span>
        ${o.foto_comprovante ? '<a href="' + API_BASE + '/api/comprovante/' + o.id + '" target="_blank" style="font-size:11px;color:#2563eb;font-weight:700;">ğŸ“· Foto</a>' : ''}
      </div>
      <div class="mini-client">${o.customer_name} <span style="font-weight:400;font-size:12px;color:#64748b">â€” ${o.address_line || ''}</span></div>
      <div class="mini-items">${itemsStr}</div>
      ${o.observacao_entregador ? '<div style="font-size:11px;color:#7c3aed;margin-top:2px;">ğŸ“ ' + o.observacao_entregador + '</div>' : ''}
      <div class="mini-bottom">
        <span class="mini-pgto">${pgtoLabel}</span>
        <span class="mini-val">R$ ${(o.total_value||0).toFixed(2)}</span>
      </div>
    </div>`;
  }).join('');

  el.innerHTML = totaisHtml + cardsHtml;
}

function formatTime(val) {
  if (!val) return '';
  const d = typeof val === 'number' ? new Date(val * 1000) : new Date(val);
  return d.toLocaleTimeString('pt-BR', {hour:'2-digit', minute:'2-digit', timeZone:'America/Campo_Grande'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ FOTO (capture + compress)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function onPhotoSelected(orderId, input) {
  const file = input.files[0];
  if (!file) return;

  toast('â³ Processando foto (scanner)...', 'info');

  try {
    const compressed = await compressImage(file, fotoConfig.maxDim, fotoConfig.quality / 100, fotoConfig.contraste, fotoConfig.desaturacao);
    const dataUrl = URL.createObjectURL(compressed.blob);
    const sizeTxt = (compressed.blob.size / 1024).toFixed(0) + ' KB';

    photoStore[orderId] = { blob: compressed.blob, dataUrl, sizeTxt };

    const btn = document.getElementById('photo-btn-' + orderId);
    btn.className = 'photo-btn has-photo';
    btn.innerHTML = '<span class="icon">âœ…</span>Foto tratada âœ“ (toque para trocar)';

    const preview = document.getElementById('photo-preview-' + orderId);
    preview.style.display = 'block';
    preview.innerHTML = '<img src="' + dataUrl + '"><button class="remove" onclick="removePhoto(' + orderId + ')">âœ•</button><div class="photo-size">' + sizeTxt + ' (' + compressed.width + 'Ã—' + compressed.height + 'px)</div>';

    const deliverBtn = document.getElementById('deliver-btn-' + orderId);
    deliverBtn.className = 'btn-deliver ready';
    deliverBtn.disabled = false;

    toast('ğŸ“¸ Foto tratada â€” ' + sizeTxt);
  } catch(e) {
    toast('Erro ao processar foto: ' + e.message, 'error');
  }

  input.value = '';
}

function compressImage(file, maxWidth, quality, contraste, desaturacao) {
  const formato = fotoConfig.formato || 'webp';
  const mimeType = formato === 'png' ? 'image/png' : formato === 'webp' ? 'image/webp' : 'image/jpeg';
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onerror = () => reject(new Error('Erro ao ler arquivo'));
    reader.onload = (e) => {
      const img = new Image();
      img.onerror = () => reject(new Error('Erro ao carregar imagem'));
      img.onload = () => {
        let w = img.width;
        let h = img.height;
        // Resize pela maior dimensÃ£o
        const maxDim = Math.max(w, h);
        if (maxDim > maxWidth) {
          const ratio = maxWidth / maxDim;
          w = Math.round(w * ratio);
          h = Math.round(h * ratio);
        }
        const canvas = document.createElement('canvas');
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, w, h);
        ctx.drawImage(img, 0, 0, w, h);

        // Tratamento condicional (config do admin)
        if (contraste || desaturacao > 0) {
          const imageData = ctx.getImageData(0, 0, w, h);
          const px = imageData.data;

          let cutLow = 0, cutRange = 255;
          if (contraste) {
            let minL = 255, maxL = 0;
            for (let i = 0; i < px.length; i += 4) {
              const lum = 0.299 * px[i] + 0.587 * px[i+1] + 0.114 * px[i+2];
              if (lum < minL) minL = lum;
              if (lum > maxL) maxL = lum;
            }
            cutLow = minL + (maxL - minL) * 0.02;
            const cutHigh = maxL - (maxL - minL) * 0.02;
            cutRange = (cutHigh - cutLow) || 1;
          }

          const satKeep = 1 - (desaturacao / 100);
          for (let i = 0; i < px.length; i += 4) {
            let r = contraste ? Math.min(255, Math.max(0, ((px[i]   - cutLow) / cutRange) * 255)) : px[i];
            let g = contraste ? Math.min(255, Math.max(0, ((px[i+1] - cutLow) / cutRange) * 255)) : px[i+1];
            let b = contraste ? Math.min(255, Math.max(0, ((px[i+2] - cutLow) / cutRange) * 255)) : px[i+2];
            if (desaturacao > 0) {
              const gray = 0.299 * r + 0.587 * g + 0.114 * b;
              r = gray + (r - gray) * satKeep;
              g = gray + (g - gray) * satKeep;
              b = gray + (b - gray) * satKeep;
            }
            px[i] = r; px[i+1] = g; px[i+2] = b;
          }
          ctx.putImageData(imageData, 0, 0);
        }

        // Sharpen (nitidez) â€” melhora legibilidade de texto
        if (fotoConfig.sharpen) {
          const imageData = ctx.getImageData(0, 0, w, h);
          const src = new Uint8ClampedArray(imageData.data);
          const dst = imageData.data;
          // Unsharp mask kernel: center=5, neighbors=-1
          const strength = 0.4;
          for (let y = 1; y < h - 1; y++) {
            for (let x = 1; x < w - 1; x++) {
              const i = (y * w + x) * 4;
              for (let c = 0; c < 3; c++) {
                const center = src[i + c] * 5;
                const neighbors = src[i - 4 + c] + src[i + 4 + c] + src[((y-1)*w+x)*4 + c] + src[((y+1)*w+x)*4 + c];
                const sharp = (center - neighbors);
                dst[i + c] = Math.min(255, Math.max(0, src[i + c] + sharp * strength));
              }
            }
          }
          ctx.putImageData(imageData, 0, 0);
        }

        // PNG ignora quality (Ã© lossless)
        const q = formato === 'png' ? undefined : quality;
        canvas.toBlob(
          (blob) => {
            if (!blob) { reject(new Error('Falha na compressÃ£o')); return; }
            resolve({ blob, width: w, height: h });
          },
          mimeType,
          q
        );
      };
      img.src = e.target.result;
    };
    reader.readAsDataURL(file);
  });
}

function removePhoto(orderId) {
  if (photoStore[orderId] && photoStore[orderId].dataUrl) {
    URL.revokeObjectURL(photoStore[orderId].dataUrl);
  }
  delete photoStore[orderId];

  const btn = document.getElementById('photo-btn-' + orderId);
  if (btn) {
    btn.className = 'photo-btn';
    btn.innerHTML = '<span class="icon">ğŸ“¸</span>Tirar foto do comprovante (obrigatÃ³rio)';
  }
  const preview = document.getElementById('photo-preview-' + orderId);
  if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; }
  const deliverBtn = document.getElementById('deliver-btn-' + orderId);
  if (deliverBtn) { deliverBtn.className = 'btn-deliver disabled'; deliverBtn.disabled = true; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ DELIVER (com loading overlay)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function deliver(orderId) {
  const photo = photoStore[orderId];
  if (!photo) {
    toast('ğŸ“¸ Tire a foto do comprovante antes!', 'error');
    return;
  }

  const tipoPg = document.getElementById('pgto-' + orderId);
  if (!tipoPg || !tipoPg.value) {
    toast('ğŸ’° Selecione a forma de pagamento recebida!', 'error');
    tipoPg && tipoPg.focus();
    return;
  }
  const tipoPg = document.getElementById('pgto-' + orderId);
  const obs = document.getElementById('obs-' + orderId);

  const btn = document.getElementById('deliver-btn-' + orderId);
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Enviando...';
  showLoading('Finalizando entrega...');

  try {
    const formData = new FormData();
    const ext = fotoConfig.formato === 'png' ? 'png' : fotoConfig.formato === 'webp' ? 'webp' : 'jpg';
    formData.append('photo', photo.blob, 'comprovante_' + orderId + '.' + ext);
    if (tipoPg && tipoPg.value) formData.append('tipo_pagamento', tipoPg.value);
    if (obs && obs.value.trim()) formData.append('observacao_entregador', obs.value.trim());

    const token = getSessionToken();
    const key = apiKey();
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    else if (key) headers['X-API-KEY'] = key;

    const resp = await fetch(API_BASE + '/api/order/' + orderId + '/mark-delivered', {
      method: 'POST',
      headers,
      body: formData,
    });

    if (!resp.ok) {
      const errData = await resp.json().catch(() => ({ error: resp.statusText }));
      throw new Error(errData.error || 'Erro ' + resp.status);
    }

    const result = await resp.json();
    removePhoto(orderId);
    hideLoading();

    let msg = 'âœ… Pedido #' + orderId + ' entregue!';
    if (result.bling_result && result.bling_result.action === 'created') {
      msg += ' Venda Bling nÂº ' + result.bling_result.bling_num + ' criada.';
    } else if (result.bling_result && result.bling_result.action === 'create_error') {
      msg += ' âš ï¸ Erro Bling: ' + result.bling_result.error;
    }
    toast(msg, result.bling_result && result.bling_result.action === 'create_error' ? 'warning' : 'success');

    // v2.6.5: Mostrar QR de avaliaÃ§Ã£o Google
    showQrReview(orderId);

    load();
  } catch (e) {
    hideLoading();
    toast('âŒ ' + e.message, 'error');
    btn.disabled = false;
    btn.className = 'btn-deliver ready';
    btn.innerHTML = 'âœ… Marcar como Entregue';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ QR CODE AVALIAÃ‡ÃƒO GOOGLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let reviewUrl = null;
let lastDeliveredOrderId = null;

async function loadReviewConfig() {
  try {
    const data = await api('/api/pub/review-config');
    reviewUrl = data?.url || null;
  } catch(_) { reviewUrl = null; }
}

function showQrReview(orderId) {
  if (!reviewUrl) return; // URL nÃ£o configurada â€” pular
  lastDeliveredOrderId = orderId;
  const qrSrc = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(reviewUrl);
  document.getElementById('qrImg').src = qrSrc;
  document.getElementById('qrOverlay').classList.add('active');
}

function closeQr() {
  document.getElementById('qrOverlay').classList.remove('active');
  lastDeliveredOrderId = null;
}

async function qrShown() {
  if (lastDeliveredOrderId) {
    try {
      await api('/api/order/' + lastDeliveredOrderId + '/qr-shown', { method: 'POST', body: '{}' });
    } catch(_) {}
  }
  toast('â­ Obrigado! AvaliaÃ§Ã£o registrada.');
  closeQr();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ VENDA EXTERNA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let vendaProducts = [];
let vendaCart = {};
let vendaPhoto = null;

async function loadVendaProducts() {
  try {
    const data = await api('/api/app-products');
    vendaProducts = (Array.isArray(data) ? data : data.products || []).filter(p => p.ativo !== 0);
    vendaProducts.sort((a, b) => (a.sort_order || 999) - (b.sort_order || 999));
  } catch(_) { vendaProducts = []; }
}

function openVendaModal() {
  vendaCart = {};
  vendaPhoto = null;
  document.getElementById('ve-nome').value = '';
  document.getElementById('ve-phone').value = '';
  document.getElementById('ve-endereco').value = '';
  document.getElementById('ve-bairro').value = '';
  document.getElementById('ve-pgto').value = 'dinheiro';
  document.getElementById('ve-obs').value = '';
  document.getElementById('ve-photo-preview').innerHTML = '';
  document.getElementById('ve-photo-preview').style.display = 'none';
  document.getElementById('ve-photo-btn').className = 'photo-btn';
  document.getElementById('ve-photo-btn').innerHTML = '<span class="icon">ğŸ“¸</span> Tirar foto (obrigatÃ³rio)';

  // Render product grid
  const grid = document.getElementById('ve-prod-grid');
  grid.innerHTML = vendaProducts.map(p =>
    `<button class="prod-btn" onclick="addToCart('${p.id}','${(p.name||'').replace(/'/g,"\\'")}',${parseFloat(p.price)||0})">
      ${p.name} <span style="color:#16a34a;font-size:11px">R$${(parseFloat(p.price)||0).toFixed(0)}</span>
    </button>`
  ).join('');

  renderVendaCart();
  document.getElementById('vendaOverlay').classList.add('active');
}

function closeVendaModal() {
  document.getElementById('vendaOverlay').classList.remove('active');
}

function addToCart(prodId, name, price) {
  if (!vendaCart[prodId]) vendaCart[prodId] = { name, price, qty: 0 };
  vendaCart[prodId].qty++;
  renderVendaCart();
}

function changeCartQty(prodId, delta) {
  if (!vendaCart[prodId]) return;
  vendaCart[prodId].qty += delta;
  if (vendaCart[prodId].qty <= 0) delete vendaCart[prodId];
  renderVendaCart();
}

function renderVendaCart() {
  const el = document.getElementById('ve-cart');
  const totalEl = document.getElementById('ve-total');
  const entries = Object.entries(vendaCart);

  if (!entries.length) {
    el.innerHTML = '<div style="color:#94a3b8;font-size:13px;padding:8px 0">Toque nos produtos acima para adicionar</div>';
    totalEl.style.display = 'none';
    updateVendaSubmit();
    return;
  }

  let total = 0;
  el.innerHTML = entries.map(([id, item]) => {
    const sub = item.qty * item.price;
    total += sub;
    return `<div class="cart-item">
      <span class="name">${item.name}</span>
      <div class="qty-ctrl">
        <button class="qty-btn minus" onclick="changeCartQty('${id}',-1)">âˆ’</button>
        <span class="qty-val">${item.qty}</span>
        <button class="qty-btn plus" onclick="changeCartQty('${id}',1)">+</button>
      </div>
      <span class="price">R$ ${sub.toFixed(2)}</span>
    </div>`;
  }).join('');

  totalEl.textContent = 'R$ ' + total.toFixed(2);
  totalEl.style.display = 'block';
  updateVendaSubmit();
}

async function onVendaPhoto(input) {
  const file = input.files[0];
  if (!file) return;
  toast('â³ Processando foto...', 'info');
  try {
    const compressed = await compressImage(file, fotoConfig.maxDim, fotoConfig.quality / 100, fotoConfig.contraste, fotoConfig.desaturacao);
    vendaPhoto = { blob: compressed.blob, dataUrl: URL.createObjectURL(compressed.blob), sizeTxt: (compressed.blob.size / 1024).toFixed(0) + ' KB' };
    const btn = document.getElementById('ve-photo-btn');
    btn.className = 'photo-btn has-photo';
    btn.innerHTML = '<span class="icon">âœ…</span> Foto capturada âœ“ (trocar)';
    const preview = document.getElementById('ve-photo-preview');
    preview.style.display = 'block';
    preview.innerHTML = '<img src="' + vendaPhoto.dataUrl + '" style="max-width:100%;border-radius:8px;margin-top:4px"><div class="photo-size">' + vendaPhoto.sizeTxt + '</div>';
    toast('ğŸ“¸ Foto pronta â€” ' + vendaPhoto.sizeTxt);
  } catch(e) { toast('Erro foto: ' + e.message, 'error'); }
  input.value = '';
  updateVendaSubmit();
}

function updateVendaSubmit() {
  const hasItems = Object.keys(vendaCart).length > 0;
  const hasPhoto = !!vendaPhoto;
  const btn = document.getElementById('ve-submit');
  if (hasItems && hasPhoto) {
    btn.disabled = false;
    btn.className = 'btn-venda-submit ready';
  } else {
    btn.disabled = true;
    btn.className = 'btn-venda-submit disabled';
  }
}

async function submitVendaExterna() {
  const entries = Object.entries(vendaCart);
  if (!entries.length) { toast('Adicione produtos', 'error'); return; }
  if (!vendaPhoto) { toast('Tire a foto do comprovante', 'error'); return; }

  const items = entries.map(([id, item]) => ({
    name: item.name, qty: item.qty, price: item.price,
    bling_id: id.match(/^\d+$/) ? parseInt(id) : null
  }));
  const totalValue = items.reduce((s, i) => s + i.qty * i.price, 0);

  showLoading('Registrando venda...');
  try {
    const formData = new FormData();
    formData.append('customer_name', document.getElementById('ve-nome').value.trim() || 'Cliente Avulso');
    formData.append('phone', document.getElementById('ve-phone').value.trim());
    formData.append('address_line', document.getElementById('ve-endereco').value.trim());
    formData.append('bairro', document.getElementById('ve-bairro').value.trim());
    formData.append('items_json', JSON.stringify(items));
    formData.append('total_value', totalValue);
    formData.append('tipo_pagamento', document.getElementById('ve-pgto').value);
    formData.append('observacao_entregador', document.getElementById('ve-obs').value.trim());
    const ext = fotoConfig.formato === 'png' ? 'png' : fotoConfig.formato === 'webp' ? 'webp' : 'jpg';
    formData.append('photo', vendaPhoto.blob, 'venda_externa.' + ext);

    const token = getSessionToken();
    const key = apiKey();
    const headers = {};
    if (token) headers['Authorization'] = 'Bearer ' + token;
    else if (key) headers['X-API-KEY'] = key;

    const resp = await fetch(API_BASE + '/api/order/venda-externa', { method: 'POST', headers, body: formData });
    if (!resp.ok) {
      const e = await resp.json().catch(() => ({ error: resp.statusText }));
      throw new Error(e.error || 'Erro ' + resp.status);
    }
    const result = await resp.json();
    hideLoading();
    closeVendaModal();

    let msg = 'âœ… Venda #' + result.id + ' registrada!';
    if (result.bling_result?.action === 'created') msg += ' Bling nÂº ' + result.bling_result.bling_num;
    else if (result.bling_result?.action === 'create_error') msg += ' âš ï¸ Bling: ' + result.bling_result.error;
    toast(msg, result.bling_result?.action === 'create_error' ? 'warning' : 'success');
    showQrReview(result.id);
    load();
  } catch(e) {
    hideLoading();
    toast('âŒ ' + e.message, 'error');
  }
}

function toggleAuto() {
  clearInterval(autoTimer);
  if (document.getElementById('autoRefresh').checked) {
    autoTimer = setInterval(load, 30000);
    toast('Auto-refresh 30s ativado');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ PIX QR CODE (entregador)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let currentPixOrderId = null;

function closePixModal() {
  document.getElementById('pixOverlay').classList.remove('active');
  currentPixOrderId = null;
}

async function abrirPixQr(orderId) {
  currentPixOrderId = orderId;
  const overlay = document.getElementById('pixOverlay');
  const body = document.getElementById('pixBody');
  const actions = document.getElementById('pixActions');
  overlay.classList.add('active');
  body.innerHTML = '<div style="padding:40px;text-align:center"><div class="spinner" style="width:36px;height:36px;border:4px solid #e2e8f0;border-top-color:#0891b2;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto"></div><p style="margin-top:12px;color:#64748b">Carregando QR Code...</p></div>';
  actions.innerHTML = '';

  try {
    const order = allOrders.find(o => o.id === orderId) || {};
    const check = await api('/api/pagamentos/' + orderId + '/qrcode');
    if (check.ok && check.paid) {
      body.innerHTML = '<div style="padding:30px;text-align:center"><p style="font-size:48px">âœ…</p><p style="font-weight:700;color:#16a34a;font-size:18px">PIX jÃ¡ confirmado!</p></div>';
      actions.innerHTML = '<button class="pix-btn pix-btn-close" onclick="closePixModal()">Fechar</button>';
      return;
    }
    if (check.ok && check.qrcode) { renderPixModal(orderId, order, check); return; }

    const data = await api('/api/pagamentos/' + orderId + '/gerar-pix', { method: 'POST' });
    if (data.ok && data.qrcode) { renderPixModal(orderId, order, data); }
    else {
      body.innerHTML = '<div style="padding:30px;text-align:center"><p style="font-size:40px">âš ï¸</p><p style="color:#dc2626;font-weight:600">' + (data.error || 'Erro ao gerar QR Code') + '</p></div>';
      actions.innerHTML = '<button class="pix-btn pix-btn-copy" onclick="abrirPixQr(' + orderId + ')">ğŸ”„ Tentar Novamente</button><button class="pix-btn pix-btn-close" onclick="closePixModal()">Fechar</button>';
    }
  } catch (e) {
    body.innerHTML = '<div style="padding:30px;text-align:center"><p style="font-size:40px">âŒ</p><p style="color:#dc2626;font-weight:600">' + e.message + '</p></div>';
    actions.innerHTML = '<button class="pix-btn pix-btn-close" onclick="closePixModal()">Fechar</button>';
  }
}

function renderPixModal(orderId, order, data) {
  const body = document.getElementById('pixBody');
  const actions = document.getElementById('pixActions');
  const valor = parseFloat(order.total_value || data.total_value || 0).toFixed(2);
  const nome = order.customer_name || data.customer_name || 'Cliente';
  const qrCode = data.qrcode || '';

  let qrImgHtml = '';
  try {
    const qr = qrcode(0, 'L');
    qr.addData(qrCode);
    qr.make();
    qrImgHtml = qr.createImgTag(6, 12);
  } catch(e) {
    qrImgHtml = '<img src="https://api.qrserver.com/v1/create-qr-code/?size=400x400&data=' + encodeURIComponent(qrCode) + '" alt="QR" style="width:240px;height:240px">';
  }

  body.innerHTML = `
    <p style="font-weight:600;color:#475569;margin:0 0 4px">${nome}</p>
    <div class="pix-valor">R$ ${valor}</div>
    <div style="display:inline-block;border:3px solid #0891b2;border-radius:12px;overflow:hidden;line-height:0">${qrImgHtml}</div>
    <p style="font-size:12px;color:#64748b;margin:8px 0 6px">PIX Copia e Cola:</p>
    <div class="pix-copiacola" id="pixCodeText">${qrCode}</div>
  `;
  actions.innerHTML = `
    <button class="pix-btn pix-btn-copy" onclick="copiarPixCode()">ğŸ“‹ Copiar CÃ³digo</button>
    <button class="pix-btn pix-btn-whats" onclick="enviarPixWhatsEntregador(${orderId})">ğŸ“² WhatsApp</button>
    <button class="pix-btn pix-btn-close" onclick="closePixModal()">Fechar</button>
  `;
}

function copiarPixCode() {
  const el = document.getElementById('pixCodeText');
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => toast('ğŸ“‹ CÃ³digo PIX copiado!')).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = el.textContent; document.body.appendChild(ta); ta.select();
    document.execCommand('copy'); document.body.removeChild(ta);
    toast('ğŸ“‹ CÃ³digo PIX copiado!');
  });
}

async function enviarPixWhatsEntregador(orderId) {
  if (!confirm('Enviar cÃ³digo PIX por WhatsApp para o cliente?')) return;
  showLoading('Enviando PIX WhatsApp...');
  try {
    const d = await api('/api/lembretes/enviar/' + orderId, { method: 'POST', body: JSON.stringify({ force: true }) });
    hideLoading();
    if (d.ok) toast('ğŸ“² PIX enviado por WhatsApp!');
    else toast('âŒ ' + (d.error || 'Falha'), 'error');
  } catch (e) { hideLoading(); toast(e.message, 'error'); }
}

init();

// â•â•â• PIX AUTO-CHECK (entregador) â•â•â•
let pixCheckRunning = false;
async function autoCheckPixEntregador(){
  if(pixCheckRunning) return;
  const pixPendentes = allOrders.filter(o => o.tipo_pagamento==='pix_receber' && o.status==='entregue');
  if(!pixPendentes.length) return;
  pixCheckRunning = true;
  for(const o of pixPendentes){
    try {
      const d = await api('/api/pix/check/'+o.id, {method:'POST'});
      if(d.action==='marked_paid'){
        toast('âœ… PIX #'+o.id+' confirmado!');
      }
    } catch(e) { /* silencioso */ }
  }
  pixCheckRunning = false;
}
setInterval(autoCheckPixEntregador, 20000);
</script>
</body>
</html>
