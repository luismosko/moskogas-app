<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Login ‚Äî MoskoApp v1.2.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; }
  .login-box { background: #fff; border-radius: 16px; padding: 40px 32px; width: 100%; max-width: 380px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
  .logo { text-align: center; margin-bottom: 24px; }
  .logo img { height: 48px; }
  .logo h1 { font-size: 22px; color: #1e293b; margin-top: 8px; }
  .logo p { font-size: 13px; color: #64748b; margin-top: 4px; }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input { width: 100%; padding: 12px 14px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; margin-bottom: 16px; transition: border-color 0.2s; }
  input:focus { outline: none; border-color: #f97316; }
  .btn-login { width: 100%; padding: 14px; background: #f97316; color: #fff; border: none; border-radius: 8px; font-size: 16px; font-weight: 700; cursor: pointer; transition: background 0.2s; }
  .btn-login:hover { background: #ea580c; }
  .btn-login:disabled { background: #94a3b8; cursor: not-allowed; }
  .error-msg { background: #fee2e2; color: #dc2626; padding: 10px 14px; border-radius: 8px; font-size: 13px; font-weight: 600; margin-bottom: 16px; display: none; }
  .version-badge { font-size: 10px; color: #94a3b8; text-align: center; margin-top: 16px; }
</style>
</head>
<body>

<div class="login-box">
  <div class="logo">
    <img src="https://moskogas.com.br/wp-content/uploads/2021/08/Logo-Moskogas-Ultragaz.png" alt="Mosko G√°s" onerror="this.style.display='none'">
    <h1>MoskoApp</h1>
    <p>Sistema de Gest√£o de Pedidos</p>
  </div>

  <div id="error-msg" class="error-msg"></div>

  <form id="login-form" onsubmit="doLogin(event)">
    <label>Usu√°rio</label>
    <input type="text" id="login" autocomplete="username" autocapitalize="off" required autofocus>

    <label>Senha</label>
    <input type="password" id="senha" autocomplete="current-password" required>

    <button type="submit" class="btn-login" id="btn-submit">üîê Entrar</button>
  </form>

  <div class="version-badge">v1.2.0 ‚Äî login</div>

  <!-- Bling Status -->
  <div id="bling-section" style="margin-top:16px;padding:14px;background:#f8fafc;border-radius:10px;border:2px solid #e2e8f0;display:none">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
      <div style="display:flex;align-items:center;gap:8px">
        <span id="bling-dot" style="width:10px;height:10px;border-radius:50%;background:#94a3b8;display:inline-block"></span>
        <span id="bling-label" style="font-size:13px;font-weight:600;color:#64748b">Verificando Bling...</span>
      </div>
      <button id="bling-btn" onclick="connectBling()" style="display:none;padding:6px 14px;background:#f97316;color:#fff;border:none;border-radius:6px;font-size:12px;font-weight:700;cursor:pointer">üîó Conectar</button>
    </div>
    <div id="bling-detail" style="font-size:11px;color:#94a3b8;margin-top:4px"></div>
  </div>
</div>

<script>
const API_BASE = 'https://api.moskogas.com.br';

// Se j√° tem sess√£o v√°lida, redireciona
(async () => {
  const token = localStorage.getItem('mg_session_token');
  if (!token) return;
  try {
    const resp = await fetch(API_BASE + '/api/auth/session', { headers: { 'Authorization': 'Bearer ' + token } });
    if (resp.ok) {
      const data = await resp.json();
      redirectByRole(data.user.role);
    } else {
      localStorage.removeItem('mg_session_token');
      localStorage.removeItem('mg_user');
    }
  } catch(e) {}
})();

async function doLogin(e) {
  e.preventDefault();
  const btn = document.getElementById('btn-submit');
  const errEl = document.getElementById('error-msg');
  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = '‚è≥ Entrando...';

  try {
    const login = document.getElementById('login').value.trim().toLowerCase();
    const senha = document.getElementById('senha').value;

    const resp = await fetch(API_BASE + '/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ login, senha }),
    });
    const data = await resp.json();

    if (!resp.ok || !data.ok) {
      if (resp.status === 429) {
        errEl.textContent = '‚è≥ Muitas tentativas. Aguarde 15 minutos e tente novamente.';
        errEl.style.display = 'block';
        btn.disabled = true;
        btn.textContent = 'üîí Bloqueado';
        setTimeout(() => { btn.disabled = false; btn.textContent = 'üîê Entrar'; }, 60000);
      } else {
        errEl.textContent = data.error || 'Usu√°rio ou senha inv√°lidos';
        errEl.style.display = 'block';
        btn.disabled = false;
        btn.textContent = 'üîê Entrar';
      }
      return;
    }

    // Salva sess√£o
    localStorage.setItem('mg_session_token', data.token);
    localStorage.setItem('mg_user', JSON.stringify(data.user));
    // Mant√©m API key para compatibilidade (se existir)
    // localStorage.setItem('mg_api_key', '...'); // removido ‚Äî agora usa sess√£o

    redirectByRole(data.user.role);
  } catch(e) {
    errEl.textContent = 'Erro de conex√£o: ' + e.message;
    errEl.style.display = 'block';
    btn.disabled = false;
    btn.textContent = 'üîê Entrar';
  }
}

function redirectByRole(role) {
  switch (role) {
    case 'entregador':
      window.location.href = 'entregador.html';
      break;
    case 'atendente':
      window.location.href = 'pedido.html';
      break;
    case 'admin':
    default:
      window.location.href = 'pedido.html';
      break;
  }
}

// ‚îÄ‚îÄ Bling Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkBlingStatus() {
  const section = document.getElementById('bling-section');
  const dot = document.getElementById('bling-dot');
  const label = document.getElementById('bling-label');
  const detail = document.getElementById('bling-detail');
  const btn = document.getElementById('bling-btn');
  section.style.display = 'block';

  try {
    const resp = await fetch(API_BASE + '/api/pub/bling-status');
    const data = await resp.json();

    if (data.ok) {
      dot.style.background = '#22c55e';
      label.style.color = '#16a34a';
      label.textContent = '‚úÖ Bling conectado';
      detail.textContent = `Token v√°lido ‚Äî ${data.token_minutes_left} min restantes`;
      btn.style.display = 'none';
      section.style.borderColor = '#bbf7d0';
      section.style.background = '#f0fdf4';
    } else {
      dot.style.background = '#dc2626';
      label.style.color = '#dc2626';
      label.textContent = '‚ùå Bling desconectado';
      detail.textContent = data.error || 'Token expirado ou n√£o configurado';
      btn.style.display = 'inline-block';
      section.style.borderColor = '#fecaca';
      section.style.background = '#fef2f2';
    }
  } catch(e) {
    dot.style.background = '#f59e0b';
    label.style.color = '#d97706';
    label.textContent = '‚ö†Ô∏è Sem conex√£o com API';
    detail.textContent = e.message;
    btn.style.display = 'none';
    section.style.borderColor = '#fde68a';
    section.style.background = '#fffbeb';
  }
}

function connectBling() {
  const w = 600, h = 700;
  const left = (screen.width - w) / 2;
  const top = (screen.height - h) / 2;
  window.open(
    API_BASE + '/bling/oauth/start',
    'bling_oauth',
    `width=${w},height=${h},left=${left},top=${top},scrollbars=yes`
  );
}

// Escuta callback do popup Bling
window.addEventListener('message', (e) => {
  if (e.data?.type === 'bling_connected') {
    checkBlingStatus();
  }
});

// Check Bling ao carregar
checkBlingStatus();
</script>
</body>
</html>
