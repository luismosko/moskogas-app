<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>GestÃ£o v2.9.3 â€” MoskoGÃ¡s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar input, .toolbar select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn-blue   { background: #2563eb; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .btn-gray   { background: #94a3b8; color: #fff; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn:hover { opacity: 0.85; }
  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #475569; color: #fff; padding: 8px 10px; text-align: left; font-size: 12px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: #f0f4ff; }
  tbody tr { cursor: pointer; transition: background .1s; }
  .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #fff; }
  select.driver-sel { border: 2px solid #e2e8f0; border-radius: 6px; padding: 4px 6px; font-size: 12px; max-width: 120px; }
  select.driver-sel:focus { outline: none; border-color: #f97316; }
  .action-btns { display: flex; gap: 4px; flex-wrap: nowrap; }
  .summary-bar { background: #475569; color: #fff; padding: 10px 16px; font-size: 13px; display: flex; gap: 16px; flex-wrap: wrap; }
  .summary-bar span strong { color: #fb923c; }

  /* Modal */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:#fff; border-radius:14px; padding:24px; width:min(560px,95vw); max-height:90vh; overflow-y:auto; }
  .modal h2 { font-size:18px; margin-bottom:16px; color:#1e293b; }
  .modal label { display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase; }
  .modal select, .modal textarea, .modal input { width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; margin-bottom:12px; }
  .modal select:focus, .modal textarea:focus { outline:none; border-color:#f97316; }
  .modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; flex-wrap:wrap; }
  .preview-msg { background:#f0fdf4; border:1px solid #bbf7d0; border-radius:8px; padding:12px; font-size:13px; white-space:pre-wrap; margin-bottom:12px; max-height:200px; overflow-y:auto; font-family:monospace; }
  .order-summary { background:#f8fafc; border-radius:8px; padding:12px; font-size:14px; margin-bottom:12px; line-height:1.8; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div style="display:flex;align-items:center;gap:4px">
    <input type="date" id="fDateFrom" onchange="load()" style="width:135px">
    <span style="color:#94a3b8;font-size:12px">atÃ©</span>
    <input type="date" id="fDateTo" onchange="load()" style="width:135px">
    <button id="btnHoje" class="btn" onclick="setDateFilter('hoje')" title="Filtrar pedidos de hoje" style="background:#f97316;color:#fff;padding:6px 10px;font-size:12px;white-space:nowrap">Hoje</button>
    <button id="btnOntem" class="btn" onclick="setDateFilter('ontem')" title="Filtrar pedidos de ontem" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px;white-space:nowrap">Ontem</button>
    <button class="btn" onclick="setDateFilter('limpar')" title="Limpar filtro de data" style="background:#e2e8f0;color:#64748b;padding:6px 8px;font-size:12px">âœ•</button>
  </div>
  <div style="position:relative">
    <button id="statusBtn" onclick="toggleStatusMenu()" style="background:#fff;border:2px solid #e2e8f0;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:13px;min-width:140px;text-align:left">
      <span id="statusLabel">Status â–¾</span>
    </button>
    <div id="statusMenu" style="display:none;position:absolute;top:42px;left:0;z-index:200;background:#fff;border:2px solid #f97316;border-radius:8px;padding:8px;min-width:200px;box-shadow:0 8px 24px rgba(0,0,0,.15)">
      <label style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;font-size:13px;border-radius:5px" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''"><input type="checkbox" value="novo" onchange="updateStatusFilter()" checked> ğŸ”´ Novo</label>
      <label style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;font-size:13px;border-radius:5px" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''"><input type="checkbox" value="encaminhado" onchange="updateStatusFilter()" checked> ğŸŸ¡ Encaminhado</label>
      <label style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;font-size:13px;border-radius:5px" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''"><input type="checkbox" value="whatsapp_enviado" onchange="updateStatusFilter()" checked> ğŸŸ¢ WhatsApp Enviado</label>
      <label style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;font-size:13px;border-radius:5px" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''"><input type="checkbox" value="entregue" onchange="updateStatusFilter()" checked> ğŸ”µ Entregue</label>
      <label style="display:flex;align-items:center;gap:8px;padding:5px 8px;cursor:pointer;font-size:13px;border-radius:5px" onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background=''"><input type="checkbox" value="cancelado" onchange="updateStatusFilter()"> âš« Cancelado</label>
    </div>
  </div>
  <div id="statusOverlay" onclick="closeStatusMenu()" style="display:none;position:fixed;inset:0;z-index:199"></div>
  <select id="fDriver" onchange="load()">
    <option value="">Todos entregadores</option>
  </select>
  <input type="text" id="fQ" placeholder="ğŸ” Busca..." oninput="load()" style="width:160px">
  <button class="btn btn-orange" onclick="load()" title="Recarregar pedidos">ğŸ”„ Atualizar</button>
  <span id="count-badge" style="font-size:12px;color:#64748b;margin-left:4px"></span>
  <span id="bling-indicator" title="Verificando Bling..." style="background:#94a3b8;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700;cursor:pointer" onclick="checkBlingStatus(true)">â³ Bling</span>
  <span title="VersÃ£o do sistema" style="background:#6366f1;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:.5px">v2.9.0</span>
  <label style="display:flex;align-items:center;gap:6px;font-size:13px;margin-left:auto;cursor:pointer;">
    <input type="checkbox" id="autoRefresh" onchange="toggleAuto()"> Auto (30s)
  </label>
</div>

<!-- SUMMARY -->
<div class="summary-bar" id="summary-bar"></div>

<!-- TABELA -->
<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Hora</th>
      <th>Cliente</th>
      <th>EndereÃ§o</th>
      <th>Itens</th>
      <th>Total</th>
      <th>Pgto</th>
      <th>Status</th>
      <th>Entregador</th>
      <th>AÃ§Ãµes</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<!-- RESUMO PRODUTOS -->
<div id="product-summary" style="margin:16px;background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;display:none">
  <div style="background:#475569;color:#fff;padding:10px 16px;font-size:14px;font-weight:700;display:flex;justify-content:space-between;align-items:center">
    <span>ğŸ“Š Resumo de Produtos</span>
    <span id="prod-summary-total" style="color:#fb923c;font-size:15px"></span>
  </div>
  <table style="width:100%;border-collapse:collapse">
    <thead>
      <tr style="background:#f8fafc">
        <th style="position:static;background:#f8fafc;color:#64748b;font-size:12px;padding:8px 12px;text-align:left">Produto</th>
        <th style="position:static;background:#f8fafc;color:#64748b;font-size:12px;padding:8px 12px;text-align:center;width:80px">Vendidos</th>
        <th style="position:static;background:#f8fafc;color:#64748b;font-size:12px;padding:8px 12px;text-align:right;width:120px">Total R$</th>
      </tr>
    </thead>
    <tbody id="prod-summary-body"></tbody>
  </table>
</div>

<!-- MODAL ENVIAR ENTREGADOR -->
<div class="modal-overlay" id="modal-wa">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="margin:0">ğŸ“± Enviar para Entregador</h2>
      <button onclick="closeModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8;padding:4px 8px;border-radius:6px" title="Fechar">&times;</button>
    </div>
    <div class="order-summary" id="modal-order-summary"></div>
    <label>Entregador *</label>
    <select id="modal-driver"></select>
    <label>ObservaÃ§Ã£o para o entregador</label>
    <textarea id="modal-obs" rows="3" placeholder="Ex: Troco para R$ 100, ligar antes de chegar..."></textarea>
    <div class="preview-msg" id="modal-preview" style="display:none"></div>
    <div class="modal-footer">
      <button class="btn btn-gray" onclick="closeModal()" title="Cancelar envio">Cancelar</button>
      <button class="btn" onclick="previewMsg()" title="Ver prÃ©via da mensagem" style="background:#6366f1;color:#fff">ğŸ‘ PrÃ©via</button>
      <button class="btn" onclick="copyMsg()" title="Copiar mensagem para colar no WhatsApp" style="background:#0ea5e9;color:#fff">ğŸ“‹ Copiar</button>
      <button class="btn btn-green" onclick="sendWa()" title="Enviar via IzChat WhatsApp">ğŸ“² Enviar</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="shared.js"></script>
<script>
// v2.9.0
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

// â”€â”€ Bling Status Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkBlingStatus(manual = false) {
  const ind = document.getElementById('bling-indicator');
  if (!ind) return;
  try {
    const r = await api('/api/bling/keep-alive');
    if (r.connected) {
      ind.style.background = '#16a34a';
      ind.textContent = 'ğŸŸ¢ Bling OK';
      ind.title = `Token vÃ¡lido (${r.minutesLeft}min) â€” clique para verificar`;
      hideBlingBanner();
    } else {
      ind.style.background = '#dc2626';
      ind.textContent = 'ğŸ”´ Bling OFF';
      ind.title = 'Reautorize em Config â†’ Conectar Bling';
      showBlingBanner();
    }
  } catch(e) {
    ind.style.background = '#dc2626';
    ind.textContent = 'ğŸ”´ Bling OFF';
    showBlingBanner();
  }
}

function showBlingBanner() {
  if (document.getElementById('bling-banner')) return;
  const b = document.createElement('div');
  b.id = 'bling-banner';
  b.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#dc2626;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.3)';
  b.innerHTML = '<span>âš ï¸ Bling desconectado â€” pedidos serÃ£o salvos mas SEM venda no Bling!</span>'
    + '<a href="config.html" style="background:#fff;color:#dc2626;padding:6px 16px;border-radius:8px;font-weight:700;text-decoration:none;margin-left:12px;white-space:nowrap">ğŸ”‘ Reconectar</a>';
  document.body.prepend(b);
  document.body.style.paddingTop = '52px';
}

function hideBlingBanner() {
  const b = document.getElementById('bling-banner');
  if (b) { b.remove(); document.body.style.paddingTop = ''; }
}

function checkBlingReauth(err) {
  const msg = (err?.message || String(err) || '').toLowerCase();
  if (msg.includes('reauth') || msg.includes('invalid_token') || msg.includes('bling 401') || msg.includes('bling_reauth') || msg.includes('token') && msg.includes('expir')) {
    const ind = document.getElementById('bling-indicator');
    if (ind) { ind.style.background = '#dc2626'; ind.textContent = 'ğŸ”´ Bling OFF'; }
    showBlingBanner();
    setTimeout(() => checkBlingStatus(true), 2000);
    return true;
  }
  return false;
}

checkBlingStatus(true);
setInterval(() => checkBlingStatus(false), 60000);
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) checkBlingStatus(true);
});

let drivers = [];
let currentOrder = null;
let autoTimer = null;

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  drivers = await api('/api/drivers').catch(() => []);
  const sel = document.getElementById('fDriver');
  sel.innerHTML = '<option value="">Todos entregadores</option>';
  drivers.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = d.name;
    sel.appendChild(opt);
  });
  setDateFilter('hoje');
}

// â”€â”€ Load orders â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let loadTimer;
async function load() {
  clearTimeout(loadTimer);
  loadTimer = setTimeout(_load, 150);
}

function todayCG() {
  return new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
}
function yesterdayCG() {
  const d = new Date(); d.setDate(d.getDate() - 1);
  return d.toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
}

function setDateFilter(mode) {
  const from = document.getElementById('fDateFrom');
  const to   = document.getElementById('fDateTo');
  const btnH = document.getElementById('btnHoje');
  const btnO = document.getElementById('btnOntem');
  if (mode === 'hoje') {
    const t = todayCG(); from.value = t; to.value = t;
    btnH.style.background = '#f97316'; btnO.style.background = '#64748b';
  } else if (mode === 'ontem') {
    const y = yesterdayCG(); from.value = y; to.value = y;
    btnO.style.background = '#f97316'; btnH.style.background = '#64748b';
  } else {
    from.value = ''; to.value = '';
    btnH.style.background = '#64748b'; btnO.style.background = '#64748b';
  }
  load();
}

let lastRows = [];
let activeStatuses = new Set(['novo','encaminhado','whatsapp_enviado','entregue']);

function toggleStatusMenu() {
  const m = document.getElementById('statusMenu');
  const ov = document.getElementById('statusOverlay');
  const isOpen = m.style.display !== 'none';
  m.style.display  = isOpen ? 'none' : 'block';
  ov.style.display = isOpen ? 'none' : 'block';
}
function closeStatusMenu() {
  document.getElementById('statusMenu').style.display  = 'none';
  document.getElementById('statusOverlay').style.display = 'none';
}

function updateStatusFilter() {
  const boxes = document.querySelectorAll('#statusMenu input[type=checkbox]');
  activeStatuses = new Set([...boxes].filter(b => b.checked).map(b => b.value));
  const count = activeStatuses.size;
  const lbl = count === 5 ? 'Todos status â–¾' : count === 0 ? 'Nenhum â–¾' : `${count} status â–¾`;
  document.getElementById('statusLabel').textContent = lbl;
  load();
}

const STATUS_ORDER = { novo: 0, encaminhado: 1, whatsapp_enviado: 2, entregue: 3, cancelado: 4 };

async function _load() {
  const dateFrom = document.getElementById('fDateFrom').value;
  const dateTo   = document.getElementById('fDateTo').value;
  const driverId = document.getElementById('fDriver').value;
  const q        = document.getElementById('fQ').value;

  let url = `/api/orders/list?`;
  if (dateFrom) url += `&date_from=${dateFrom}`;
  if (dateTo)   url += `&date_to=${dateTo}`;
  if (driverId) url += `&driver_id=${driverId}`;
  if (q)        url += `&q=${encodeURIComponent(q)}`;

  let rows = [];
  window._gestaoRows = [];
  try {
    rows = await api(url);
    if (!Array.isArray(rows)) { console.error('API retornou:', rows); rows = []; }
  } catch(e) {
    console.error('Erro ao carregar pedidos:', e);
    document.getElementById('tbody').innerHTML = '<tr><td colspan="10" style="text-align:center;padding:32px;color:#dc2626">Erro ao carregar: ' + e.message + '</td></tr>';
    return;
  }

  if (dateFrom || dateTo) {
    rows = rows.filter(r => {
      if (!r.created_at) return true;
      const d = new Date(r.created_at * 1000).toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
      if (dateFrom && d < dateFrom) return false;
      if (dateTo   && d > dateTo)   return false;
      return true;
    });
  }

  rows = rows.filter(r => activeStatuses.has(r.status));
  rows.sort((a, b) => {
    const sd = STATUS_ORDER[a.status] - STATUS_ORDER[b.status];
    if (sd !== 0) return sd;
    return b.created_at - a.created_at;
  });

  lastRows = rows;
  window._gestaoRows = rows;
  renderTable(rows);
  renderSummary(rows);
  document.getElementById('count-badge').textContent = `${rows.length} pedidos`;
}

function renderTable(rows) {
  const tbody = document.getElementById('tbody');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:32px;color:#94a3b8">Nenhum pedido encontrado</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(o => {
    const items = JSON.parse(o.items_json || '[]');
    const itemsStr = items.map(i => `${i.qty}x ${i.name}`).join(', ') || 'â€”';
    const total = o.total_value ? `R$ ${o.total_value.toFixed(2)}` : 'â€”';
    const hora  = o.created_at ? new Date(o.created_at * 1000).toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}) : 'â€”';
    const nomeExibir = (o.customer_name||'').length > 50 ? (o.customer_name||'').substring(0,50)+'â€¦' : (o.customer_name||'');

    const pgtoLabels = { dinheiro:'ğŸ’µ Din', pix_vista:'âš¡ PIX', pix_receber:'â³ PIX Aberto', debito:'ğŸ’³ DÃ©b', credito:'ğŸ’³ CrÃ©d', mensalista:'ğŸ“… Mensal', boleto:'ğŸ§¾ Boleto', nfe:'ğŸ“„ NFe' };
    const pgtoLabel = pgtoLabels[o.tipo_pagamento] || o.tipo_pagamento || 'â€”';
    const pagoFlag = o.pago ? 'âœ…' : '';

    const driverOpts = `<option value="">â€”</option>` +
      drivers.map(d => `<option value="${d.id}" ${o.driver_id == d.id ? 'selected' : ''}>${d.name}</option>`).join('');

    // WhatsApp SEMPRE disponÃ­vel (exceto cancelado)
    const canWa      = o.status !== 'cancelado';
    const canDeliver = ['novo','encaminhado','whatsapp_enviado'].includes(o.status);
    const canCancel  = o.status !== 'cancelado'; // agora permite cancelar entregue
    const canRevert  = ['entregue','cancelado'].includes(o.status);

    return `
    <tr id="row-${o.id}" style="cursor:pointer" onclick="openEditModal(${o.id})">
      <td><strong style="color:#6366f1">#${o.id}</strong></td>
      <td style="white-space:nowrap">${hora}</td>
      <td title="${o.customer_name||''}">
        <div style="font-weight:700;color:#1e293b;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${nomeExibir}</div>
        <div style="font-size:11px;color:#64748b">${o.phone_digits || ''}</div>
      </td>
      <td>
        <div style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${o.address_line||''}">${o.address_line||''}</div>
        <div style="font-size:11px;color:#64748b">${o.bairro || ''}</div>
      </td>
      <td style="max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${itemsStr}">${itemsStr}</td>
      <td style="font-weight:700;color:#1e293b;white-space:nowrap">${total}</td>
      <td style="white-space:nowrap;font-size:12px">${pgtoLabel} ${pagoFlag}</td>
      <td>${statusBadge(o.status)} ${o.bling_pedido_id ? '<span title="âœ… Venda Bling nÂº '+(o.bling_pedido_num||o.bling_pedido_id)+'" style="display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;background:#16a34a;color:#fff;font-size:9px;font-weight:800;vertical-align:middle;margin-left:2px;cursor:help;">B</span>' : ''}</td>
      <td onclick="event.stopPropagation()">
        <select class="driver-sel" onchange="selectDriver(${o.id}, this.value)">
          ${driverOpts}
        </select>
      </td>
      <td onclick="event.stopPropagation()">
        <div class="action-btns" style="gap:3px">
          ${o.tipo_pagamento==='pix_receber' && !o.pago ? `<button class="btn" style="font-size:11px;padding:4px 7px;background:#0891b2;color:#fff" title="Enviar PIX QR Code" onclick="abrirPixGestao(${o.id})">ğŸ’ </button>` : ''}
          ${canWa      ? `<button class="btn btn-green" style="font-size:11px;padding:4px 7px" title="Enviar/Reenviar WhatsApp" onclick="openModal(${o.id})">ğŸ“²</button>` : ''}
          ${canDeliver ? `<button class="btn btn-blue"  style="font-size:11px;padding:4px 7px" title="Marcar como entregue" onclick="markDelivered(${o.id})">âœ…</button>` : ''}
          <button class="btn btn-gray" style="font-size:11px;padding:4px 7px" title="Imprimir recibo" onclick="printOrder(${JSON.stringify(o).replace(/"/g,'&quot;')})">ğŸ–¨ï¸</button>
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderSummary(rows) {
  const counts = { novo: 0, encaminhado: 0, whatsapp_enviado: 0, entregue: 0, cancelado: 0 };
  let total = 0;
  rows.forEach(r => { counts[r.status]++; total += r.total_value || 0; });

  document.getElementById('summary-bar').innerHTML = `
    <span>ğŸ”´ Novos: <strong>${counts.novo}</strong></span>
    <span>ğŸŸ¡ Encaminhados: <strong>${counts.encaminhado}</strong></span>
    <span>ğŸŸ¢ WhatsApp: <strong>${counts.whatsapp_enviado}</strong></span>
    <span>ğŸ”µ Entregues: <strong>${counts.entregue}</strong></span>
    <span>âš« Cancelados: <strong>${counts.cancelado}</strong></span>
    <span style="margin-left:auto">ğŸ’° Total: <strong>R$ ${total.toFixed(2)}</strong></span>`;

  // â”€â”€ Resumo por produto (exclui cancelados) â”€â”€
  const prodMap = {};
  rows.filter(r => r.status !== 'cancelado').forEach(r => {
    let items = [];
    try { items = JSON.parse(r.items_json || '[]'); } catch(e) {}
    items.forEach(i => {
      const key = (i.name || 'Produto').trim();
      if (!prodMap[key]) prodMap[key] = { qty: 0, total: 0 };
      const q = parseInt(i.qty) || 1;
      const p = parseFloat(i.price) || 0;
      prodMap[key].qty   += q;
      prodMap[key].total += p * q;
    });
  });

  const prodSummary = document.getElementById('product-summary');
  const entries = Object.entries(prodMap).sort((a, b) => b[1].total - a[1].total);

  if (!entries.length) { prodSummary.style.display = 'none'; return; }
  prodSummary.style.display = 'block';

  let grandTotal = 0;
  document.getElementById('prod-summary-body').innerHTML = entries.map(([name, data]) => {
    grandTotal += data.total;
    return `<tr>
      <td style="padding:8px 12px;font-size:13px;font-weight:600;border-bottom:1px solid #f1f5f9">${name}</td>
      <td style="padding:8px 12px;font-size:14px;font-weight:700;text-align:center;border-bottom:1px solid #f1f5f9;color:#2563eb">${data.qty}</td>
      <td style="padding:8px 12px;font-size:14px;font-weight:700;text-align:right;border-bottom:1px solid #f1f5f9">R$ ${data.total.toFixed(2)}</td>
    </tr>`;
  }).join('') + `<tr style="background:#f8fafc">
    <td style="padding:10px 12px;font-size:13px;font-weight:800;color:#1e293b">TOTAL GERAL</td>
    <td style="padding:10px 12px;font-size:14px;font-weight:800;text-align:center;color:#1e293b">${entries.reduce((s, e) => s + e[1].qty, 0)}</td>
    <td style="padding:10px 12px;font-size:15px;font-weight:900;text-align:right;color:#f97316">R$ ${grandTotal.toFixed(2)}</td>
  </tr>`;
  document.getElementById('prod-summary-total').textContent = `Total Geral: R$ ${grandTotal.toFixed(2)}`;
}

// â”€â”€ AÃ§Ãµes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function selectDriver(orderId, driverId) {
  if (!driverId) return;
  showLoading('Selecionando entregador...');
  try {
    const result = await api(`/api/order/${orderId}/select-driver`, { method: 'POST', body: JSON.stringify({ driver_id: parseInt(driverId) }) });
    if (result.swap) {
      let msg = 'ğŸ”„ Entregador trocado!';
      if (result.whatsapp?.old?.sent) msg += `\nğŸ“± ${result.whatsapp.old.driver}: cancelamento enviado`;
      if (result.whatsapp?.new?.sent) msg += `\nğŸ“± ${result.whatsapp.new.driver}: entrega enviada`;
      toast(msg);
    } else {
      toast('âœ… Entregador selecionado!');
    }
    setTimeout(load, 500);
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

async function markDelivered(id) {
  if (!confirm(`Marcar pedido #${id} como ENTREGUE?`)) return;
  showLoading('Marcando como entregue...');
  try {
    await api(`/api/order/${id}/mark-delivered`, { method: 'POST', body: JSON.stringify({}) });
    toast('âœ… Pedido entregue!');
    load();
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ Modal Cancelar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openCancelModal(orderId, statusAtual) {
  const isEntregue = statusAtual === 'entregue';
  const titulo = isEntregue ? 'âš ï¸ Cancelar Pedido ENTREGUE' : 'âœ• Cancelar Pedido';
  const cor = isEntregue ? '#dc2626' : '#ef4444';
  const aviso = isEntregue
    ? '<div style="background:#fef2f2;border:2px solid #dc2626;border-radius:8px;padding:12px;margin-bottom:12px;font-size:13px;color:#991b1b"><strong>âš ï¸ ATENÃ‡ÃƒO:</strong> Este pedido jÃ¡ foi ENTREGUE. Cancelamento pÃ³s-entrega serÃ¡ registrado em auditoria e o administrador serÃ¡ notificado via WhatsApp.</div>'
    : '';

  const html = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center" id="cancelModal">
      <div style="background:#fff;border-radius:12px;padding:24px;max-width:440px;width:95%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
        <h3 style="margin:0 0 16px;color:${cor}">${titulo} #${orderId}</h3>
        ${aviso}
        <label style="font-weight:600;font-size:13px;color:#475569">Motivo do cancelamento *</label>
        <select id="cancelMotivoSelect" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;margin:6px 0 10px;font-size:14px" onchange="document.getElementById('cancelMotivoText').style.display = this.value==='outro' ? 'block' : 'none'">
          <option value="">â€” Selecione â€”</option>
          <option value="Cliente desistiu">Cliente desistiu</option>
          <option value="EndereÃ§o incorreto">EndereÃ§o incorreto</option>
          <option value="Pedido duplicado">Pedido duplicado</option>
          <option value="Erro de digitaÃ§Ã£o">Erro de digitaÃ§Ã£o</option>
          <option value="Produto indisponÃ­vel">Produto indisponÃ­vel</option>
          <option value="Erro operacional">Erro operacional</option>
          ${isEntregue ? '<option value="DevoluÃ§Ã£o">DevoluÃ§Ã£o</option><option value="CobranÃ§a indevida">CobranÃ§a indevida</option>' : ''}
          <option value="outro">Outro (especificar)</option>
        </select>
        <textarea id="cancelMotivoText" style="display:none;width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;resize:vertical;min-height:60px;box-sizing:border-box" placeholder="Descreva o motivo..."></textarea>
        <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end">
          <button onclick="document.getElementById('cancelModal').remove()" style="padding:10px 20px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-weight:600">âœ– Voltar</button>
          <button onclick="confirmCancel(${orderId})" style="padding:10px 20px;border:none;border-radius:8px;background:${cor};color:#fff;cursor:pointer;font-weight:600">âœ• Confirmar Cancelamento</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

async function confirmCancel(orderId) {
  const sel = document.getElementById('cancelMotivoSelect');
  const txt = document.getElementById('cancelMotivoText');
  let motivo = sel.value === 'outro' ? txt.value.trim() : sel.value;
  if (!motivo) { toast('Selecione o motivo do cancelamento', 'error'); return; }

  const modal = document.getElementById('cancelModal');
  const btn = modal.querySelector('button:last-child');
  btn.disabled = true; btn.textContent = 'â³ Cancelando...';
  showLoading('Cancelando pedido...');

  try {
    const res = await api(`/api/order/${orderId}/cancel`, {
      method: 'POST',
      body: JSON.stringify({ motivo })
    });
    hideLoading();
    if (res.cancelamento_pos_entrega) {
      toast(res.admin_notificado
        ? 'âš ï¸ Pedido cancelado (pÃ³s-entrega) â€” Admin notificado via WhatsApp'
        : 'âš ï¸ Pedido cancelado (pÃ³s-entrega) â€” Log registrado', 'warning');
    } else {
      toast('âœ• Pedido cancelado');
    }
    modal.remove();
    load();
  } catch(e) {
    hideLoading();
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'âœ• Confirmar Cancelamento';
  }
}

// â”€â”€ Modal Reabrir / Reverter Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openRevertModal(orderId, statusAtual) {
  const isCancel = statusAtual === 'cancelado';
  const titulo = isCancel ? 'â†©ï¸ Reabrir Pedido Cancelado' : 'â†©ï¸ Reverter Status do Pedido';
  const cor = '#f59e0b';

  // OpÃ§Ãµes de status destino baseadas no status atual
  const optsMap = {
    entregue: [
      { value: 'whatsapp_enviado', label: 'ğŸŸ¢ WhatsApp Enviado' },
      { value: 'encaminhado', label: 'ğŸŸ¡ Encaminhado' },
      { value: 'novo', label: 'ğŸ”´ Novo' },
    ],
    cancelado: [
      { value: 'novo', label: 'ğŸ”´ Novo' },
      { value: 'encaminhado', label: 'ğŸŸ¡ Encaminhado' },
    ],
  };
  const opts = optsMap[statusAtual] || [];
  const optionsHtml = opts.map(o => `<option value="${o.value}">${o.label}</option>`).join('');

  const html = `
    <div style="position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:9999;display:flex;align-items:center;justify-content:center" id="revertModal">
      <div style="background:#fff;border-radius:12px;padding:24px;max-width:440px;width:95%;box-shadow:0 20px 60px rgba(0,0,0,.3)">
        <h3 style="margin:0 0 16px;color:${cor}">${titulo} #${orderId}</h3>
        <div style="background:#fffbeb;border:2px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:12px;font-size:13px;color:#92400e">
          <strong>â„¹ï¸</strong> Status atual: <strong>${statusAtual.toUpperCase()}</strong>. Selecione o novo status e informe o motivo.
        </div>
        <label style="font-weight:600;font-size:13px;color:#475569">Novo status *</label>
        <select id="revertNovoStatus" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;margin:6px 0 10px;font-size:14px">
          ${optionsHtml}
        </select>
        <label style="font-weight:600;font-size:13px;color:#475569">Motivo *</label>
        <select id="revertMotivoSelect" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;margin:6px 0 10px;font-size:14px" onchange="document.getElementById('revertMotivoText').style.display = this.value==='outro' ? 'block' : 'none'">
          <option value="">â€” Selecione â€”</option>
          <option value="Erro humano ao marcar status">Erro humano ao marcar status</option>
          <option value="Entrega nÃ£o confirmada pelo cliente">Entrega nÃ£o confirmada pelo cliente</option>
          <option value="Pedido precisa ser refeito">Pedido precisa ser refeito</option>
          <option value="Cancelamento indevido">Cancelamento indevido</option>
          <option value="outro">Outro (especificar)</option>
        </select>
        <textarea id="revertMotivoText" style="display:none;width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;resize:vertical;min-height:60px;box-sizing:border-box" placeholder="Descreva o motivo..."></textarea>
        <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end">
          <button onclick="document.getElementById('revertModal').remove()" style="padding:10px 20px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-weight:600">âœ– Voltar</button>
          <button onclick="confirmRevert(${orderId})" style="padding:10px 20px;border:none;border-radius:8px;background:${cor};color:#fff;cursor:pointer;font-weight:600">â†©ï¸ Confirmar Reabertura</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', html);
}

async function confirmRevert(orderId) {
  const novoStatus = document.getElementById('revertNovoStatus').value;
  const sel = document.getElementById('revertMotivoSelect');
  const txt = document.getElementById('revertMotivoText');
  let motivo = sel.value === 'outro' ? txt.value.trim() : sel.value;
  if (!motivo) { toast('Selecione o motivo da reabertura', 'error'); return; }

  const modal = document.getElementById('revertModal');
  const btn = modal.querySelector('button:last-child');
  btn.disabled = true; btn.textContent = 'â³ Revertendo...';
  showLoading('Revertendo status...');

  try {
    const res = await api(`/api/order/${orderId}/revert-status`, {
      method: 'POST',
      body: JSON.stringify({ novo_status: novoStatus, motivo })
    });
    hideLoading();
    toast(`â†©ï¸ Status revertido: ${res.status_anterior} â†’ ${res.status_novo}`);
    modal.remove();
    load();
  } catch(e) {
    hideLoading();
    toast(e.message, 'error');
    btn.disabled = false; btn.textContent = 'â†©ï¸ Confirmar Reabertura';
  }
}

// â”€â”€ Modal WhatsApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildMsg(order, obs) {
  const items = JSON.parse(order.items_json || '[]');
  const itemsList = items.map(i => `  â€¢ ${i.name} x${i.qty}`).join('\n') || '  (sem itens)';
  const addr = `${order.address_line}${order.bairro ? ', ' + order.bairro : ''}, Campo Grande/MS`;
  const mapsLink = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;

  return `ğŸšš *NOVA ENTREGA* â€” Pedido #${order.id}

ğŸ‘¤ Cliente: ${order.customer_name}
ğŸ“ ${order.phone_digits || 'nÃ£o informado'}

ğŸ“ ${order.address_line}${order.bairro ? ' â€” ' + order.bairro : ''} â€” Campo Grande/MS${order.referencia ? '\nRef: ' + order.referencia : ''}

ğŸ“¦ Itens:
${itemsList}

ğŸ“ Obs: ${obs || 'â€”'}

ğŸ—ºï¸ ${mapsLink}`;
}

function openModal(orderId) {
  api(`/api/order/${orderId}`).then(order => {
    currentOrder = order;
    const items = JSON.parse(order.items_json || '[]');
    document.getElementById('modal-order-summary').innerHTML = `
      <strong>Pedido #${order.id}</strong> â€” ${order.customer_name}<br>
      ğŸ“ ${order.address_line}${order.bairro ? ', ' + order.bairro : ''}<br>
      ${order.referencia ? 'ğŸ“Œ Ref: ' + order.referencia + '<br>' : ''}
      ğŸ“¦ ${items.map(i => i.qty + 'x ' + i.name).join(' | ')}
    `;

    const dSel = document.getElementById('modal-driver');
    dSel.innerHTML = '<option value="">Selecione o entregador *</option>' +
      drivers.map(d => `<option value="${d.id}" ${order.driver_id == d.id ? 'selected' : ''}>${d.name}</option>`).join('');

    document.getElementById('modal-obs').value = '';
    document.getElementById('modal-preview').style.display = 'none';
    document.getElementById('modal-wa').classList.add('open');
  }).catch(() => {
    currentOrder = { id: orderId };
    document.getElementById('modal-wa').classList.add('open');
  });
}

function closeModal() {
  document.getElementById('modal-wa').classList.remove('open');
  currentOrder = null;
}

function previewMsg() {
  if (!currentOrder) return;
  const obs = document.getElementById('modal-obs').value;
  const msg = buildMsg(currentOrder, obs);
  document.getElementById('modal-preview').textContent = msg;
  document.getElementById('modal-preview').style.display = 'block';
}

function copyMsg() {
  if (!currentOrder) return;
  const obs = document.getElementById('modal-obs').value;
  const msg = buildMsg(currentOrder, obs);
  navigator.clipboard.writeText(msg).then(() => {
    toast('ğŸ“‹ Mensagem copiada!');
  }).catch(() => {
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = msg; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy');
    ta.remove();
    toast('ğŸ“‹ Mensagem copiada!');
  });
}

async function sendWa() {
  const driverId = document.getElementById('modal-driver').value;
  const obs      = document.getElementById('modal-obs').value;
  if (!driverId) { toast('Selecione um entregador!', 'error'); return; }

  showLoading('Enviando WhatsApp...');
  try {
    const res = await api(`/api/order/${currentOrder.id}/send-whatsapp`, {
      method: 'POST',
      body: JSON.stringify({ driver_id: parseInt(driverId), observation: obs }),
    });
    if (res.whatsapp_skipped) {
      toast('ğŸ“‹ Pedido encaminhado (sem WhatsApp)');
    } else {
      toast('âœ… WhatsApp enviado!');
    }
    closeModal();
    load();
  } catch(e) { toast(e.message, 'error'); }
  finally { hideLoading(); }
}

// â”€â”€ ImpressÃ£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function printOrder(order) {
  try {
    localStorage.setItem('mg_print_' + order.id, JSON.stringify(order));
    window.open(`print.html?id=${order.id}`, '_blank');
  } catch(e) {
    // fallback URL (pode ser truncado em pedidos grandes)
    window.open(`print.html?id=${order.id}`, '_blank');
  }
}

// â”€â”€ Auto refresh â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleAuto() {
  clearInterval(autoTimer);
  if (document.getElementById('autoRefresh').checked) {
    autoTimer = setInterval(load, 30000);
  }
}

// â”€â”€ Fechar modal clicando fora â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('modal-wa').addEventListener('click', function(e) {
  if (e.target === this) closeModal();
});


// â”€â”€ Editar Pedido â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let editOrderId = null;
let editItems = [];

function openEditModal(orderId) {
  const o = lastRows.find(r => r.id === orderId);
  if (!o) { toast('Pedido nÃ£o encontrado', 'error'); return; }

  editOrderId = orderId;
  editItems = JSON.parse(o.items_json || '[]').map(i => ({...i}));

  document.getElementById('edit-order-id').textContent = `#${orderId}`;
  document.getElementById('edit-name').value  = o.customer_name || '';
  document.getElementById('edit-phone').value = o.phone_digits || '';
  const _eal = o.address_line || '';
  const _enm = _eal.match(/,\s*(\d+\S*)$/);
  document.getElementById('edit-addr').value  = _enm ? _eal.slice(0, _enm.index) : _eal;
  const _enum = document.getElementById('edit-num');
  if (_enum) _enum.value = _enm ? _enm[1] : '';
  document.getElementById('edit-bairro').value = o.bairro || '';
  document.getElementById('edit-comp').value  = o.complemento || '';
  document.getElementById('edit-ref').value   = o.referencia || '';
  document.getElementById('edit-notes').value = o.notes || '';
  document.getElementById('edit-tipo-pgto').value = o.tipo_pagamento || 'dinheiro';
  
  // Popular dropdown entregador
  const editDriverSel = document.getElementById('edit-driver');
  editDriverSel.innerHTML = '<option value="">â€” Sem entregador â€”</option>' +
    drivers.map(d => `<option value="${d.id}" ${o.driver_id == d.id ? 'selected' : ''}>${d.name}</option>`).join('');
  
  document.getElementById('edit-prod-search').value = '';
  document.getElementById('edit-prod-suggestions').style.display = 'none';

  // Mostrar/esconder botÃµes de aÃ§Ã£o conforme status
  const canCancel = o.status !== 'cancelado';
  const canRevert = ['entregue','cancelado'].includes(o.status);
  const btnRevert = document.getElementById('edit-btn-revert');
  const btnCancel = document.getElementById('edit-btn-cancel');
  if (btnRevert) btnRevert.style.display = canRevert ? '' : 'none';
  if (btnCancel) btnCancel.style.display = canCancel ? '' : 'none';
  // Guardar status atual para os modais
  window._editOrderStatus = o.status;

  renderEditItems();
  document.getElementById('modal-edit').style.display = 'flex';
}

function closeEditModal() {
  document.getElementById('modal-edit').style.display = 'none';
}

function renderEditItems() {
  const list = document.getElementById('edit-items-list');
  if (!editItems.length) {
    list.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:8px">Nenhum item</div>';
    document.getElementById('edit-total').textContent = 'R$ 0,00';
    return;
  }
  let total = 0;
  list.innerHTML = editItems.map((it, i) => {
    total += (it.price||0) * (it.qty||1);
    return `<div style="display:flex;align-items:center;gap:6px;padding:6px 0;border-bottom:1px solid #f1f5f9">
      <span style="flex:1;font-size:13px">${it.name}</span>
      <button onclick="editQty(${i},-1)" style="background:#e2e8f0;border:none;border-radius:4px;width:26px;height:26px;cursor:pointer;font-size:14px">âˆ’</button>
      <span style="min-width:20px;text-align:center;font-weight:700">${it.qty}</span>
      <button onclick="editQty(${i},1)" style="background:#e2e8f0;border:none;border-radius:4px;width:26px;height:26px;cursor:pointer;font-size:14px">+</button>
      <span style="font-size:11px;color:#94a3b8">R$</span>
      <input type="number" step="0.01" value="${parseFloat(it.price||0).toFixed(2)}" style="width:65px;padding:4px;border:1px solid #e2e8f0;border-radius:6px;font-weight:700;text-align:right;font-size:13px" onchange="editPrice(${i},this.value)">
      <span style="min-width:70px;text-align:right;font-weight:700;font-size:13px">= R$ ${((it.price||0)*(it.qty||1)).toFixed(2)}</span>
      <button onclick="editRemove(${i})" style="background:#fee2e2;border:none;border-radius:4px;width:26px;height:26px;cursor:pointer;color:#ef4444">âœ•</button>
    </div>`;
  }).join('');
  document.getElementById('edit-total').textContent = `R$ ${total.toFixed(2)}`;
}

function editQty(i, d) {
  editItems[i].qty = (editItems[i].qty||1) + d;
  if (editItems[i].qty <= 0) editItems.splice(i, 1);
  renderEditItems();
}
function editPrice(i, v) { editItems[i].price = parseFloat(v)||0; renderEditItems(); }
function editRemove(i) { editItems.splice(i, 1); renderEditItems(); }

let editProdTimer;
async function searchEditProduct(q) {
  clearTimeout(editProdTimer);
  const box = document.getElementById('edit-prod-suggestions');
  if (q.length < 2) { box.style.display='none'; return; }
  editProdTimer = setTimeout(async () => {
    const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`).catch(() => []);
    if (!list.length) { box.style.display='none'; return; }
    box.style.display = 'block';
    box.innerHTML = list.map((p,i) => {
      const nome = p.name.length > 45 ? p.name.substring(0,45)+'â€¦' : p.name;
      return `<div class="suggestion-item" onclick="addEditProduct(${i})" style="display:flex;justify-content:space-between;align-items:center">
        <span><strong>${nome}</strong></span>
        <span style="color:#f97316;font-weight:700;margin-left:8px">R$ ${parseFloat(p.price||0).toFixed(2)}</span>
      </div>`;
    }).join('');
    box._data = list;
  }, 300);
}

function addEditProduct(i) {
  const p = document.getElementById('edit-prod-suggestions')._data[i];
  document.getElementById('edit-prod-search').value = '';
  document.getElementById('edit-prod-suggestions').style.display = 'none';
  const existing = editItems.find(x => String(x.id) === String(p.id));
  if (existing) existing.qty++;
  else editItems.push({ id: String(p.id), name: p.name, qty: 1, price: parseFloat(p.price)||0 });
  renderEditItems();
}

async function saveEditOrder(confirmBling = false) {
  const name  = document.getElementById('edit-name').value.trim();
  const _editRua = document.getElementById('edit-addr').value.trim();
  const _editNum = document.getElementById('edit-num') ? document.getElementById('edit-num').value.trim() : '';
  const addr  = _editNum ? _editRua + ', ' + _editNum : _editRua;
  if (!name) { toast('Nome obrigatÃ³rio', 'error'); return; }
  const isConsumidorFinal = name.toUpperCase().includes('CONSUMIDOR FINAL');
  if (!isConsumidorFinal && !addr) { toast('EndereÃ§o obrigatÃ³rio', 'error'); return; }
  if (!editItems.length) { toast('Adicione pelo menos 1 item', 'error'); return; }

  const total = editItems.reduce((s,i) => s + (i.price||0)*(i.qty||1), 0);
  const editDriverVal = document.getElementById('edit-driver').value;
  const body = {
    customer_name: name,
    phone_digits: document.getElementById('edit-phone').value.replace(/\D/g,''),
    address_line: addr,
    bairro: document.getElementById('edit-bairro').value,
    complemento: document.getElementById('edit-comp').value,
    referencia: document.getElementById('edit-ref').value,
    items: editItems,
    total_value: total,
    notes: document.getElementById('edit-notes').value,
    tipo_pagamento: document.getElementById('edit-tipo-pgto').value,
    driver_id: editDriverVal ? parseInt(editDriverVal) : undefined,
  };
  if (confirmBling) body.confirm_bling_change = true;

  showLoading('Salvando pedido...');
  try {
    const resp = await api(`/api/order/${editOrderId}/update`, { method: 'POST', body: JSON.stringify(body) });
    
    // Backend pediu confirmaÃ§Ã£o de impacto no Bling
    if (resp.requires_confirmation) {
      hideLoading();
      const actionEmoji = resp.bling_action === 'create' ? 'ğŸ“¤' : 'ğŸ—‘ï¸';
      const actionColor = resp.bling_action === 'create' ? '#16a34a' : '#dc2626';
      const actionLabel = resp.bling_action === 'create' ? 'CRIAR VENDA' : 'EXCLUIR VENDA';
      
      // Mostrar modal de confirmaÃ§Ã£o Bling
      const modalHtml = `
        <div class="modal-overlay" id="modal-bling-confirm" style="display:flex;z-index:9999;">
          <div class="modal-box" style="max-width:460px;text-align:center;padding:30px;">
            <div style="font-size:48px;margin-bottom:10px;">${actionEmoji}</div>
            <h2 style="color:${actionColor};margin:0 0 15px;">${actionLabel} no Bling</h2>
            <p style="font-size:14px;color:#475569;line-height:1.5;">${resp.message}</p>
            <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
              <button onclick="document.getElementById('modal-bling-confirm').remove();" 
                style="padding:10px 24px;border:2px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer;font-size:14px;font-weight:600;">
                âœ– Cancelar
              </button>
              <button onclick="document.getElementById('modal-bling-confirm').remove(); saveEditOrder(true);"
                style="padding:10px 24px;border:none;border-radius:8px;background:${actionColor};color:#fff;cursor:pointer;font-size:14px;font-weight:700;">
                âœ… Sim, ${resp.bling_action === 'create' ? 'Criar' : 'Excluir'}
              </button>
            </div>
          </div>
        </div>`;
      document.body.insertAdjacentHTML('beforeend', modalHtml);
      return;
    }

    // Sucesso - mostrar resultado Bling se houver
    hideLoading();
    if (resp.bling_result) {
      const br = resp.bling_result;
      if (br.action === 'created') {
        toast(`âœ… Pedido atualizado + Venda Bling nÂº ${br.bling_pedido_num || br.bling_pedido_id} criada!`, 'success');
      } else if (br.action === 'deleted') {
        toast(`âœ… Pedido atualizado + Venda Bling excluÃ­da`, 'success');
      } else if (br.action === 'create_error') {
        toast(`âš ï¸ Pedido salvo, mas ERRO ao criar venda Bling: ${br.error}`, 'error');
      } else if (br.action === 'delete_error') {
        toast(`âš ï¸ Pedido salvo, mas ERRO ao excluir venda Bling: ${br.error}. Exclua manualmente no painel Bling.`, 'error');
      } else {
        toast('âœ… Pedido atualizado!');
      }
    } else {
      toast('âœ… Pedido atualizado!');
    }
    closeEditModal();
    load();
  } catch(e) { hideLoading(); toast(e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ PIX QR Code (GestÃ£o) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function abrirPixGestao(orderId) {
  const overlay = document.getElementById('pix-overlay');
  const body = document.getElementById('pix-body');
  overlay.style.display = 'flex';
  body.innerHTML = '<div style="text-align:center;padding:30px"><div style="width:32px;height:32px;border:3px solid #e2e8f0;border-top-color:#0891b2;border-radius:50%;animation:spin .8s linear infinite;margin:0 auto"></div><p style="margin-top:12px;color:#64748b">Carregando PIX...</p></div>';

  try {
    // 1) Tentar pegar QR existente
    const check = await api('/api/pagamentos/' + orderId + '/qrcode');
    if (check.ok && check.paid) {
      body.innerHTML = '<div style="text-align:center;padding:30px"><p style="font-size:48px">âœ…</p><p style="font-weight:700;color:#16a34a;font-size:18px">PIX jÃ¡ confirmado!</p></div><button class="pix-btn-close" onclick="fecharPixGestao()">Fechar</button>';
      return;
    }
    if (check.ok && check.qrcode) {
      renderPixGestao(orderId, check);
      return;
    }
    // 2) Gerar novo QR
    const data = await api('/api/pagamentos/' + orderId + '/gerar-pix', { method: 'POST' });
    if (data.ok && data.qrcode) {
      renderPixGestao(orderId, data);
    } else {
      body.innerHTML = '<div style="text-align:center;padding:30px"><p style="font-size:40px">âš ï¸</p><p style="color:#dc2626;font-weight:600">' + (data.error || 'Erro ao gerar QR') + '</p></div><button class="pix-btn-close" onclick="fecharPixGestao()">Fechar</button>';
    }
  } catch(e) {
    body.innerHTML = '<div style="text-align:center;padding:30px"><p style="font-size:40px">âŒ</p><p style="color:#dc2626">' + e.message + '</p></div><button class="pix-btn-close" onclick="fecharPixGestao()">Fechar</button>';
  }
}

function renderPixGestao(orderId, data) {
  const order = window._gestaoRows.find(o => o.id === orderId) || {};
  const nome = order.customer_name || 'Cliente';
  const valor = parseFloat(order.total_value || data.total_value || 0).toFixed(2);
  const qrCode = data.qrcode || data.qr_code || '';
  const body = document.getElementById('pix-body');

  let qrHtml = '';
  try {
    const qr = qrcode(0, 'L');
    qr.addData(qrCode);
    qr.make();
    qrHtml = '<div style="display:inline-block;border:3px solid #0891b2;border-radius:12px;overflow:hidden;line-height:0">' + qr.createImgTag(5, 8) + '</div>';
  } catch(e) {
    qrHtml = '<img src="https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=' + encodeURIComponent(qrCode) + '" style="width:200px;height:200px;border-radius:8px;border:3px solid #0891b2">';
  }

  body.innerHTML = `
    <div style="font-weight:700;font-size:15px;margin-bottom:4px">${nome}</div>
    <div style="font-size:28px;font-weight:900;color:#0891b2;margin:4px 0 12px">R$ ${valor}</div>
    ${qrHtml}
    <p style="font-size:12px;color:#64748b;margin:10px 0 4px">PIX Copia e Cola:</p>
    <div id="pix-code-text" style="background:#f0fdfa;border:2px solid #0891b2;border-radius:8px;padding:8px;font-size:10px;word-break:break-all;color:#334155;max-height:80px;overflow-y:auto">${qrCode}</div>
    <div style="display:flex;gap:8px;margin-top:12px;justify-content:center;flex-wrap:wrap">
      <button onclick="copiarPixGestao()" style="background:#0891b2;color:#fff;border:none;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer;font-size:13px">ğŸ“‹ Copiar</button>
      ${order.phone_digits ? '<button onclick="enviarPixWhatsGestao(' + orderId + ')" style="background:#25d366;color:#fff;border:none;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer;font-size:13px">ğŸ“² WhatsApp</button>' : ''}
      <button class="pix-btn-close" onclick="fecharPixGestao()">Fechar</button>
    </div>
  `;
}

function fecharPixGestao() { document.getElementById('pix-overlay').style.display = 'none'; }

function copiarPixGestao() {
  const el = document.getElementById('pix-code-text');
  if (!el) return;
  navigator.clipboard.writeText(el.textContent).then(() => toast('ğŸ“‹ CÃ³digo PIX copiado!')).catch(() => {
    const ta = document.createElement('textarea');
    ta.value = el.textContent; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
    toast('ğŸ“‹ CÃ³digo PIX copiado!');
  });
}

async function enviarPixWhatsGestao(orderId) {
  if (!confirm('Enviar PIX por WhatsApp para o cliente?')) return;
  showLoading('Enviando PIX WhatsApp...');
  try {
    const d = await api('/api/lembretes/enviar/' + orderId, { method: 'POST', body: JSON.stringify({ force: true }) });
    hideLoading();
    if (d.ok) { toast('ğŸ“² PIX enviado por WhatsApp!'); fecharPixGestao(); }
    else toast('âŒ ' + (d.error || 'Falha'), 'error');
  } catch(e) { hideLoading(); toast(e.message, 'error'); }
}

init();

// â•â•â• PIX AUTO-CHECK (gestÃ£o) â€” verifica PIX pendentes a cada 20s â•â•â•
let pixCheckBusy = false;
async function autoCheckPixGestao(){
  if(pixCheckBusy) return;
  const pendentes = (window._gestaoRows||[]).filter(o => o.tipo_pagamento==='pix_receber' && !o.pago && o.pix_tx_id);
  if(!pendentes.length) return;
  pixCheckBusy = true;
  for(const o of pendentes){
    try {
      const d = await api('/api/pix/check/'+o.id, {method:'POST'});
      if(d.action==='marked_paid'){
        toast('âœ… PIX CONFIRMADO! Pedido #'+o.id+' pago!','success');
        load(); break;
      }
    } catch(e) {}
  }
  pixCheckBusy = false;
}
setInterval(autoCheckPixGestao, 20000);
</script>

<!-- MODAL EDITAR PEDIDO -->
<div class="modal-overlay" id="modal-edit" style="display:none">
  <div class="modal" style="max-width:620px;width:95%;max-height:90vh;overflow-y:auto">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <h2 style="margin:0">âœï¸ Editar Pedido <span id="edit-order-id" style="color:#f97316"></span></h2>
      <button onclick="closeEditModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8;padding:4px 8px;border-radius:6px" title="Fechar">&times;</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">CLIENTE *</label>
        <input id="edit-name" type="text" style="width:100%">
      </div>
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">TELEFONE</label>
        <input id="edit-phone" type="text" style="width:100%">
      </div>
      <div style="grid-column:1/-1">
        <label style="font-size:12px;color:#64748b;font-weight:600">ENDEREÃ‡O (RUA) *</label>
        <div class="street-wrap" style="position:relative">
          <input id="edit-addr" type="text" autocomplete="off" style="width:100%"
            oninput="streetAC(this,'edit-bairro','edit-addr-ac')">
          <div id="edit-addr-ac" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #6366f1;border-top:none;border-radius:0 0 8px 8px;z-index:1000;max-height:200px;overflow-y:auto;box-shadow:0 8px 20px rgba(0,0,0,.15)"></div>
        </div>
      </div>
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">NÃšMERO</label>
        <input id="edit-num" type="text" style="width:100%" placeholder="123">
      </div>
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">BAIRRO</label>
        <input id="edit-bairro" type="text" style="width:100%">
      </div>
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">COMPLEMENTO</label>
        <input id="edit-comp" type="text" style="width:100%">
      </div>
      <div style="grid-column:1/-1">
        <label style="font-size:12px;color:#64748b;font-weight:600">REFERÃŠNCIA</label>
        <input id="edit-ref" type="text" style="width:100%">
      </div>
    </div>

    <label style="font-size:12px;color:#64748b;font-weight:600">ITENS</label>
    <div style="display:flex;gap:8px;margin-bottom:8px;position:relative">
      <input id="edit-prod-search" type="text" placeholder="ğŸ” Adicionar produto..." style="flex:1" oninput="searchEditProduct(this.value)">
      <div id="edit-prod-suggestions" style="display:none;position:absolute;top:38px;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:200px;overflow-y:auto"></div>
    </div>
    <div id="edit-items-list" style="margin-bottom:12px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-top:2px solid #f97316;margin-bottom:12px">
      <span style="font-weight:700">TOTAL</span>
      <span id="edit-total" style="font-size:20px;font-weight:900;color:#f97316">R$ 0,00</span>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">OBSERVAÃ‡ÃƒO</label>
        <textarea id="edit-notes" rows="2" style="width:100%;resize:vertical"></textarea>
      </div>
      <div>
        <label style="font-size:12px;color:#64748b;font-weight:600">TIPO DE PAGAMENTO</label>
        <select id="edit-tipo-pgto" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">
          <option value="dinheiro">ğŸ’µ Dinheiro</option>
          <option value="pix_vista">âš¡ PIX Ã  vista</option>
          <option value="pix_receber">â³ PIX a receber</option>
          <option value="debito">ğŸ’³ DÃ©bito</option>
          <option value="credito">ğŸ’³ CrÃ©dito</option>
          <option value="mensalista">ğŸ“… Mensalista</option>
          <option value="boleto">ğŸ§¾ Boleto</option>
          <option value="nfe">ğŸ“„ NFe</option>
        </select>
      </div>
      <div style="grid-column:1/-1">
        <label style="font-size:12px;color:#64748b;font-weight:600">ENTREGADOR</label>
        <select id="edit-driver" style="width:100%;padding:10px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px">
          <option value="">â€” Sem entregador â€”</option>
        </select>
      </div>
    </div>

    <div style="display:flex;gap:8px;margin-top:16px;justify-content:space-between;flex-wrap:wrap">
      <div style="display:flex;gap:6px">
        <button id="edit-btn-revert" class="btn" style="background:#f59e0b;color:#fff;font-size:12px;padding:8px 12px;display:none" onclick="closeEditModal();openRevertModal(editOrderId, window._editOrderStatus)" title="Reabrir pedido">â†©ï¸ Reabrir</button>
        <button id="edit-btn-cancel" class="btn" style="background:#ef4444;color:#fff;font-size:12px;padding:8px 12px;display:none" onclick="closeEditModal();openCancelModal(editOrderId, window._editOrderStatus)" title="Cancelar pedido">âœ• Cancelar</button>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-gray" onclick="closeEditModal()" title="Fechar">Fechar</button>
        <button class="btn btn-orange" onclick="saveEditOrder()" title="Salvar alteraÃ§Ãµes do pedido">ğŸ’¾ Salvar</button>
      </div>
    </div>
  </div>
</div>

<!-- PIX QR Modal -->
<div id="pix-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:9999;justify-content:center;align-items:center">
  <div style="background:#fff;border-radius:16px;padding:24px;max-width:380px;width:92%;text-align:center;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3)">
    <h3 style="color:#0891b2;margin-bottom:12px">ğŸ’  PIX â€” QR Code</h3>
    <div id="pix-body"></div>
  </div>
</div>
<style>
  .pix-btn-close { background:#e2e8f0;color:#475569;border:none;border-radius:8px;padding:10px 16px;font-weight:700;cursor:pointer;font-size:13px;margin-top:8px; }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>
</body>
</html>
