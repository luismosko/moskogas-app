<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Novo Pedido â€” MoskoGÃ¡s v2.10.4</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 680px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 16px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, textarea, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border 0.2s; }
  input:focus, textarea:focus { outline: none; border-color: #f97316; }
  .row { display: grid; gap: 12px; margin-bottom: 12px; }
  .row-2 { grid-template-columns: 1fr 1fr; }
  .autocomplete-box { position: relative; }
  #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #f97316; border-top: none; border-radius: 0 0 8px 8px; z-index: 100; max-height: 250px; overflow-y: auto; }
  .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  .suggestion-item:hover { background: #fff7ed; }
  .suggestion-item strong { color: #1e293b; }
  .suggestion-item small { color: #64748b; }
  .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
  .item-btn { padding: 12px 6px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; text-align: center; transition: all 0.15s; }
  .item-btn:hover { border-color: #f97316; background: #fff7ed; }
  .item-btn.selected { border-color: #f97316; background: #f97316; color: #fff; }
  .item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; padding: 8px 12px; }
  .item-row span { flex: 1; font-weight: 600; font-size: 14px; }
  .qty-btn { width: 32px; height: 32px; border: 2px solid #e2e8f0; border-radius: 6px; background: #fff; font-size: 18px; cursor: pointer; font-weight: 700; }
  .qty-val { width: 36px; text-align: center; font-weight: 700; font-size: 16px; }
  .btn-remove { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px; }
  .btn-primary { background: #f97316; color: #fff; border: none; border-radius: 10px; padding: 16px 24px; font-size: 18px; font-weight: 800; width: 100%; cursor: pointer; transition: background 0.2s; }
  .btn-primary:hover { background: #ea6d0a; }
  .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
  .status-bar { text-align: center; padding: 8px; font-size: 13px; color: #64748b; }
  .total-bar { background: #1e293b; color: #fff; border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .total-bar .val { font-size: 22px; font-weight: 900; color: #f97316; }
  .search-tab { padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; color: #64748b; transition: all 0.15s; }
  .search-tab.active { border-color: #f97316; background: #f97316; color: #fff; }
  textarea { resize: vertical; height: 70px; }
  .fav-btn { padding: 7px 14px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 12px; font-weight: 700; color: #334155; transition: all 0.15s; white-space: nowrap; display: flex; align-items: center; gap: 5px; }
  .fav-btn:hover { border-color: #f97316; background: #fff7ed; color: #f97316; transform: translateY(-1px); }
  .fav-btn:active { transform: scale(0.97); }
  .fav-btn .fav-price { color: #f97316; font-size: 11px; font-weight: 800; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v2.10.4 â€” pedido</div>
<div class="container">
  <h1>â• Novo Pedido <span id="bling-indicator" title="Verificando Bling..." style="font-size:11px;padding:2px 8px;border-radius:10px;background:#94a3b8;color:#fff;cursor:pointer;vertical-align:middle" onclick="checkBlingStatus(true)">â³ Bling</span> <span style="font-size:12px;color:#94a3b8;font-weight:400">v2.10.4</span></h1>

  <!-- BUSCA CLIENTE -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <label style="margin:0">ğŸ” Buscar Cliente</label>
      <div style="display:flex;gap:6px">
        <button onclick="setConsumidorFinal()" style="background:#f0f9ff;border:1px solid #7dd3fc;border-radius:6px;padding:3px 10px;font-size:11px;color:#0284c7;cursor:pointer;font-weight:600" title="Pedido sem cadastro â€” Consumidor Final Bling">ğŸ‘¤ Consumidor Final</button>
        <button onclick="openCadastroModal()" style="background:#f0fdf4;border:1px solid #86efac;border-radius:6px;padding:3px 10px;font-size:11px;color:#16a34a;cursor:pointer;font-weight:600" title="Cadastrar novo cliente no Bling (PF/PJ)">â• Cadastrar Cliente</button>
        <button onclick="syncBling(this)" style="background:none;border:1px solid #e2e8f0;border-radius:6px;padding:3px 10px;font-size:11px;color:#94a3b8;cursor:pointer" title="Sincronizar contatos do Bling para busca por endereÃ§o">ğŸ”„ Sync Bling</button>
      </div>
    </div>
    <div class="search-fields" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
      <div style="position:relative">
        <input id="searchPhone" type="tel" placeholder="ğŸ“ Telefone" autocomplete="off" oninput="doSearch(this.value,'phone')" style="width:100%;padding-right:28px">
        <span onclick="clearSearch('searchPhone')" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;color:#94a3b8;font-size:14px;display:none" id="clr-phone">âœ•</span>
      </div>
      <div style="position:relative">
        <input id="searchName" type="text" placeholder="ğŸ‘¤ Nome" autocomplete="off" oninput="doSearch(this.value,'name')" style="width:100%;padding-right:28px">
        <span onclick="clearSearch('searchName')" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;color:#94a3b8;font-size:14px;display:none" id="clr-name">âœ•</span>
      </div>
      <div style="position:relative">
        <input id="searchAddr" type="text" placeholder="ğŸ“ EndereÃ§o" autocomplete="off" oninput="doSearch(this.value,'address')" style="width:100%;padding-right:28px">
        <span onclick="clearSearch('searchAddr')" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;color:#94a3b8;font-size:14px;display:none" id="clr-addr">âœ•</span>
      </div>
    </div>
    <div style="font-size:11px;color:#94a3b8;margin-top:4px">ğŸ’¡ VocÃª pode combinar campos â€” ex: nome <strong>"luis"</strong> + endereÃ§o <strong>"afonso"</strong></div>
    <div id="suggestions" style="display:none;position:relative;"></div>
  </div>

  <!-- DADOS DO CLIENTE -->
  <div class="card">
    <div class="row row-2">
      <div>
        <label>Nome do Cliente *</label>
        <input id="cName" type="text" placeholder="Nome completo">
      </div>
      <div>
        <label>Telefone</label>
        <input id="cPhone" type="tel" placeholder="67 9...">
      </div>
    </div>
    <div class="row" style="margin-bottom:12px">
      <div style="display:grid;grid-template-columns:1fr 100px;gap:8px">
        <div>
          <label>Rua *</label>
          <div class="street-wrap">
            <input id="cAddr" type="text" placeholder="Ex: Rua das OrquÃ­deas" autocomplete="off" oninput="streetAC(this,'cBairro','cAddr-ac')">
            <div id="cAddr-ac" class="street-ac" style="display:none"></div>
          </div>
        </div>
        <div>
          <label>NÃºmero *</label>
          <input id="cNum" type="text" placeholder="123" autocomplete="off">
        </div>
      </div>
    </div>
    <div class="row row-2">
      <div>
        <label>Bairro</label>
        <input id="cBairro" type="text" placeholder="Ex: Jardim Noroeste">
      </div>
      <div>
        <label>Complemento</label>
        <input id="cComp" type="text" placeholder="Apto, Bloco...">
      </div>
    </div>
    <div>
      <label>Ponto de ReferÃªncia</label>
      <input id="cRef" type="text" placeholder="Ex: prÃ³ximo ao mercado X">
    </div>

    <!-- BotÃ£o endereÃ§os adicionais (aparece ao selecionar cliente) -->
    <div id="multi-addr-bar" style="display:none;margin-top:10px;padding-top:10px;border-top:2px dashed #e2e8f0;display:flex;align-items:center;gap:10px">
      <button type="button" onclick="openAddrModal()" title="Ver endereÃ§os salvos deste cliente" style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer">
        ğŸ“ Outros endereÃ§os <span id="addr-count-badge" style="background:rgba(255,255,255,0.3);border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px">0</span>
      </button>
      <span id="addr-selected-label" style="font-size:12px;color:#6366f1;font-weight:600"></span>
    </div>
  </div>

  <!-- ÃšLTIMO PEDIDO DO CLIENTE -->
  <div class="card" id="last-order-card" style="display:none;padding:10px 14px;background:#f0f9ff;border:1px solid #bae6fd">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <span style="font-size:12px;font-weight:700;color:#0369a1">ğŸ• Ãšltimo Pedido</span>
      <span id="last-order-date" style="font-size:11px;color:#94a3b8"></span>
    </div>
    <div id="last-order-items" style="font-size:12px;color:#334155;margin-bottom:6px"></div>
    <div style="display:flex;justify-content:space-between;align-items:center">
      <span id="last-order-total" style="font-size:13px;font-weight:800;color:#0369a1"></span>
      <button onclick="repeatLastOrder()" style="background:#0ea5e9;color:#fff;border:none;border-radius:6px;padding:5px 12px;font-size:12px;font-weight:700;cursor:pointer" title="Adicionar mesmos itens ao pedido atual">ğŸ”„ Repetir</button>
    </div>
  </div>

  <!-- ITENS -->
  <div class="card">
    <label style="margin-bottom:10px">ğŸ“¦ Itens do Pedido</label>
    <div id="fav-products" style="display:none;margin-bottom:10px">
      <div style="font-size:11px;font-weight:700;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px">â­ Produtos RÃ¡pidos</div>
      <div id="fav-buttons" style="display:flex;flex-wrap:wrap;gap:6px"></div>
    </div>
    <div style="position:relative;margin-bottom:10px">
      <input id="product-search" type="text" placeholder="ğŸ” Buscar produto pelo nome..." autocomplete="off" oninput="searchProducts(this.value)">
      <div id="product-suggestions" style="display:none;position:absolute;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:220px;overflow-y:auto"></div>
    </div>
    <div id="items-list"></div>
    <div class="total-bar" id="total-bar" style="display:none">
      <span>TOTAL</span>
      <span class="val" id="total-val">R$ 0,00</span>
    </div>
  </div>

  <!-- OBSERVAÃ‡ÃƒO -->
  <div class="card">
    <label>ğŸ“ ObservaÃ§Ã£o (opcional)</label>
    <textarea id="notes" placeholder="Urgente, horÃ¡rio preferido, troco para..."></textarea>
  </div>

  <!-- TIPO DE PAGAMENTO -->
  <div class="card" style="border:3px solid #6366f1">
    <label style="font-size:14px;font-weight:800;color:#4f46e5;letter-spacing:.5px">ğŸ’³ TIPO DE PAGAMENTO <span style="color:#dc2626">*</span></label>
    <div style="font-size:12px;color:#64748b;margin:6px 0 12px;line-height:1.4">
      <strong>Pagos agora:</strong> cria venda no Bling imediatamente<br>
      <strong>PIX a receber:</strong> cria venda no Bling, aguarda confirmaÃ§Ã£o<br>
      <strong>Mensalista/Boleto:</strong> NÃƒO cria venda agora, aparece em Pagamentos
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="pgto-grid">
      <button type="button" class="tipo-pgto-btn" data-tipo="dinheiro"     data-key="dinheiro" onclick="selTipoPgto(this)" title="Pago na hora â€” cria venda no Bling">ğŸ’µ Dinheiro</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="pix_vista"    data-key="pix" onclick="selTipoPgto(this)" title="Pago na hora â€” cria venda no Bling">âš¡ PIX Ã  vista</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="pix_receber"  data-key="pix_aguardando" onclick="selTipoPgto(this)" title="Cria venda no Bling â€” aguarda confirmaÃ§Ã£o de PIX">â³ PIX a receber</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="debito"       data-key="debito" onclick="selTipoPgto(this)" title="Pago na hora â€” cria venda no Bling">ğŸ’³ DÃ©bito</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="credito"      data-key="credito" onclick="selTipoPgto(this)" title="Pago na hora â€” cria venda no Bling">ğŸ’³ CrÃ©dito</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="mensalista"   data-key="fiado" onclick="selTipoPgto(this)" title="NÃ£o cria venda â€” aparece em Pagamentos">ğŸ“… Mensalista</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="boleto"       data-key="fiado" onclick="selTipoPgto(this)" title="NÃ£o cria venda â€” aparece em Pagamentos">ğŸ§¾ Boleto</button>
      <button type="button" class="tipo-pgto-btn" data-tipo="nfe"          data-key="fiado" onclick="selTipoPgto(this)" title="NÃ£o cria venda â€” aparece em Pagamentos">ğŸ“„ NFe</button>
    </div>
    <input type="hidden" id="tipo_pagamento" value="">
    <input type="hidden" id="forma_pagamento_key" value="">
  </div>

  <style>
  .tipo-pgto-btn {
    padding:14px 8px;border-radius:10px;border:2.5px solid #e2e8f0;background:#f8fafc;
    font-size:13px;font-weight:700;cursor:pointer;transition:all .15s;color:#374151;
  }
  .tipo-pgto-btn.sel {
    border-color:#6366f1;background:#ede9fe;color:#4f46e5;
    box-shadow:0 0 0 3px rgba(99,102,241,.2);
  }
  .tipo-pgto-btn:hover:not(.sel) {
    border-color:#c7d2fe;background:#f5f3ff;
  }
  </style>

  <div class="status-bar" id="status-bar"></div>
  <button class="btn-primary" id="btn-save" onclick="saveOrder()" title="Salvar pedido e ir para gestÃ£o">âœ… SALVAR PEDIDO</button>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

// â”€â”€ Bling Status Monitor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function checkBlingStatus(manual = false) {
  const ind = document.getElementById('bling-indicator');
  if (!ind) return;
  try {
    const r = await api('/api/bling/keep-alive');
    if (r.connected) {
      ind.style.background = '#16a34a';
      ind.textContent = 'ğŸŸ¢ Bling OK';
      ind.title = `Token vÃ¡lido (${r.minutesLeft}min) â€” clique para verificar`;
      hideBlingBanner();
    } else {
      ind.style.background = '#dc2626';
      ind.textContent = 'ğŸ”´ Bling OFF';
      ind.title = 'Reautorize em Config â†’ Conectar Bling';
      showBlingBanner();
    }
  } catch(e) {
    ind.style.background = '#dc2626';
    ind.textContent = 'ğŸ”´ Bling OFF';
    ind.title = 'Erro ao verificar â€” clique para tentar';
    showBlingBanner();
  }
}

function showBlingBanner() {
  if (document.getElementById('bling-banner')) return;
  const b = document.createElement('div');
  b.id = 'bling-banner';
  b.style.cssText = 'position:fixed;top:0;left:0;right:0;z-index:99999;background:#dc2626;color:#fff;padding:12px 16px;display:flex;align-items:center;justify-content:space-between;font-size:14px;font-weight:600;box-shadow:0 2px 8px rgba(0,0,0,0.3)';
  b.innerHTML = '<span>âš ï¸ Bling desconectado â€” pedidos serÃ£o salvos mas SEM venda no Bling!</span>'
    + '<a href="config.html" style="background:#fff;color:#dc2626;padding:6px 16px;border-radius:8px;font-weight:700;text-decoration:none;margin-left:12px;white-space:nowrap">ğŸ”‘ Reconectar</a>';
  document.body.prepend(b);
  document.body.style.paddingTop = '52px';
}

function hideBlingBanner() {
  const b = document.getElementById('bling-banner');
  if (b) { b.remove(); document.body.style.paddingTop = ''; }
  // Limpar tambÃ©m banner legado (reauth-banner)
  const old = document.getElementById('reauth-banner');
  if (old) { old.remove(); }
}

// Check on load + every 3 min (backup) + imediato ao voltar pra aba
checkBlingStatus(true);
setInterval(() => checkBlingStatus(false), 60000);
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) checkBlingStatus(true);
});

let items = [];
let searchTimer;

// â”€â”€ Produtos Favoritos (quick-add) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(async function loadFavorites() {
  try {
    const favs = await api('/api/app-products?favorites=1');
    if (favs && favs.length) {
      const container = document.getElementById('fav-products');
      const btns = document.getElementById('fav-buttons');
      container.style.display = 'block';
      btns.innerHTML = favs.map(f => {
        const preco = parseFloat(f.price || 0).toFixed(2);
        const iconHtml = f.icon_url ? `<img src="${API_BASE}${f.icon_url}" style="width:22px;height:22px;border-radius:4px;object-fit:cover">` : '';
        return `<button class="fav-btn" onclick="addItem('${f.bling_id}','${(f.name||'').replace(/'/g,"\\'")}',${parseFloat(f.price)||0},'${(f.code||'').replace(/'/g,"\\'")}')" title="Adicionar ${f.name} â€” R$ ${preco}">
          ${iconHtml}${f.name} <span class="fav-price">R$${preco}</span>
        </button>`;
      }).join('');
    }
  } catch(e) { console.log('Favoritos nÃ£o carregados:', e.message); }
})();

async function syncBling(btn) {
  btn.disabled = true;
  btn.textContent = 'â³ Sincronizando...';
  try {
    const r = await api('/api/customer/sync-bling', { method: 'POST' });
    btn.textContent = `âœ… ${r.synced} contatos sincronizados`;
    setTimeout(() => { btn.textContent = 'ğŸ”„ Sincronizar contatos Bling'; btn.disabled = false; }, 4000);
  } catch(e) {
    btn.textContent = 'âŒ Erro â€” tente novamente';
    btn.disabled = false;
  }
}

function doSearch(val, type) {
  clearTimeout(searchTimer);
  // Coleta todos os campos ativos simultaneamente
  const phone = document.getElementById('searchPhone').value.trim();
  const name  = document.getElementById('searchName').value.trim();
  const addr  = document.getElementById('searchAddr').value.trim();

  // Precisa de pelo menos um campo com 2+ chars
  if (Math.max(phone.length, name.length, addr.length) < 2) { hideSuggestions(); return; }

  searchTimer = setTimeout(async () => {
    try {
      // Busca combinada: envia todos os filtros preenchidos ao mesmo tempo
      const params = new URLSearchParams();
      if (phone.length >= 2) params.set('phone', phone);
      if (name.length  >= 2) params.set('name',  name);
      if (addr.length  >= 2) params.set('addr',  addr);

      const results = await api(`/api/customer/search-multi?${params.toString()}`);
      showSuggestions(results);
    } catch(e) { console.error(e); }
  }, 280);
}

document.addEventListener('click', e => {
  if (!e.target.closest('.search-fields') && !e.target.closest('#suggestions')) hideSuggestions();
});

function showSuggestions(list) {
  const box = document.getElementById('suggestions');
  if (!list.length) { hideSuggestions(); return; }
  box.style.display = 'block';
  box.innerHTML = list.map((c, i) => {
    const addrLabel = c._extra_obs ? `<span style="background:#ede9fe;color:#6366f1;font-size:10px;font-weight:700;padding:1px 6px;border-radius:8px;margin-right:4px">${c._extra_obs}</span>` : '';
    return `
    <div class="suggestion-item" onclick="selectCustomer(${i})">
      <strong>${c.name || c.customer_name}</strong>
      <span style="margin-left:8px;color:#f97316">${c.phone_digits || ''}</span><br>
      <small>${addrLabel}${c.address_line || ''} ${c.bairro ? 'â€” ' + c.bairro : ''}</small>
    </div>`;
  }).join('');
  box._data = list;
}

function hideSuggestions() {
  const box = document.getElementById('suggestions');
  box.style.display = 'none';
}

function clearSearch(inputId) {
  const inp = document.getElementById(inputId);
  if (inp) { inp.value = ''; inp.focus(); }
  const clrMap = { searchPhone: 'clr-phone', searchName: 'clr-name', searchAddr: 'clr-addr' };
  const clrEl = document.getElementById(clrMap[inputId]);
  if (clrEl) clrEl.style.display = 'none';
  doSearch('', inputId.replace('search','').toLowerCase());
}

// Mostra/oculta botÃ£o X ao digitar
['searchPhone','searchName','searchAddr'].forEach(id => {
  const clrMap = { searchPhone: 'clr-phone', searchName: 'clr-name', searchAddr: 'clr-addr' };
  const inp = document.getElementById(id);
  if (inp) inp.addEventListener('input', () => {
    const clr = document.getElementById(clrMap[id]);
    if (clr) clr.style.display = inp.value ? 'block' : 'none';
  });
});

async function selectCustomer(i) {
  const c = document.getElementById('suggestions')._data[i];
  document.getElementById('cName').value   = c.name || c.customer_name || '';
  document.getElementById('cPhone').value  = c.phone_digits || '';
  // Preenche rua e numero separados
  const _al = c.address_line || '';
  const _numMatch = _al.match(/,\s*(\d+\S*)$/);
  document.getElementById('cAddr').value = _numMatch ? _al.slice(0, _numMatch.index) : _al;
  const _numEl = document.getElementById('cNum');
  if (_numEl) _numEl.value = _numMatch ? _numMatch[1] : '';
  document.getElementById('cBairro').value = c.bairro || '';
  document.getElementById('cComp').value   = c.complemento || '';
  document.getElementById('cRef').value    = c.referencia || '';
  hideSuggestions();
  ['searchPhone','searchName','searchAddr'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  // Busca detalhes Bling
  if (c.bling_contact_id) {
    try {
      const det = await api(`/api/customer/bling-detail/${c.bling_contact_id}`);
      if (det && !det.error) {
        if (det.phone_digits) document.getElementById('cPhone').value  = det.phone_digits;
        if (det.address_line) {
          const _bl = det.address_line;
          const _bm = _bl.match(/,\s*(\d+\S*)$/);
          document.getElementById('cAddr').value = _bm ? _bl.slice(0, _bm.index) : _bl;
          const _ne = document.getElementById('cNum');
          if (_ne) _ne.value = _bm ? _bm[1] : '';
        }
        if (det.bairro)       document.getElementById('cBairro').value = det.bairro;
        if (det.complemento)  document.getElementById('cComp').value   = det.complemento;
      }
    } catch(e) {}
  }
  // Carrega endereÃ§os mÃºltiplos
  if (c.phone_digits) loadSavedAddresses(c.phone_digits);
  // Carrega Ãºltimo pedido (exceto Consumidor Final)
  const nome = (c.name || c.customer_name || '').toUpperCase();
  if (c.phone_digits && !nome.includes('CONSUMIDOR FINAL')) {
    loadLastOrder(c.phone_digits);
  } else {
    document.getElementById('last-order-card').style.display = 'none';
  }
}

let currentPhone = '';
let allAddresses = [];
let _lastOrderData = null;

// â”€â”€ Ãšltimo pedido do cliente â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadLastOrder(phone) {
  const card = document.getElementById('last-order-card');
  _lastOrderData = null;
  try {
    const res = await api(`/api/customer/last-order?phone=${phone}`);
    if (!res.found || !res.order) { card.style.display = 'none'; return; }
    const o = res.order;
    _lastOrderData = o.items || [];
    // Data formatada
    let dateStr = '';
    if (o.created_at) {
      const d = typeof o.created_at === 'number' ? new Date(o.created_at * 1000) : new Date(o.created_at);
      dateStr = d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour:'2-digit',minute:'2-digit'});
    }
    document.getElementById('last-order-date').textContent = `#${o.id} â€” ${dateStr}`;
    document.getElementById('last-order-items').innerHTML = (o.items || []).map(it =>
      `<span style="display:inline-block;background:#e0f2fe;padding:2px 8px;border-radius:4px;margin:2px 4px 2px 0;font-size:11px">${it.name} x${it.qty} <strong>R$${parseFloat(it.price||0).toFixed(2)}</strong></span>`
    ).join('');
    document.getElementById('last-order-total').textContent = `Total: R$ ${parseFloat(o.total_value||0).toFixed(2)}`;
    card.style.display = 'block';
  } catch(e) { card.style.display = 'none'; }
}

function repeatLastOrder() {
  if (!_lastOrderData || !_lastOrderData.length) return;
  for (const it of _lastOrderData) {
    const existing = items.find(i => i.id === String(it.bling_id || it.id || it.name));
    if (existing) {
      existing.qty += (it.qty || 1);
    } else {
      items.push({
        id: String(it.bling_id || it.id || it.name),
        name: it.name || 'Produto',
        qty: it.qty || 1,
        price: parseFloat(it.price) || 0,
        code: it.code || ''
      });
    }
  }
  renderItems();
  renderTotal();
  toast('ğŸ”„ Itens do pedido anterior adicionados!', 'success');
  document.getElementById('last-order-card').style.display = 'none';
}

// â”€â”€ Banner de reautorizaÃ§Ã£o Bling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function checkBlingReauth(err) {
  const msg = (err?.message || String(err) || '').toLowerCase();
  if (msg.includes('reauth') || msg.includes('invalid_token') || msg.includes('bling 401') || msg.includes('bling_reauth') || msg.includes('token') && msg.includes('expir')) {
    // Atualizar indicador para VERMELHO imediatamente
    const ind = document.getElementById('bling-indicator');
    if (ind) {
      ind.style.background = '#dc2626';
      ind.textContent = 'ğŸ”´ Bling OFF';
      ind.title = 'Token expirado â€” clique para tentar reconectar';
    }
    // Usar o banner unificado
    showBlingBanner();
    // Tentar auto-recovery em background (keep-alive tenta refresh)
    setTimeout(() => checkBlingStatus(true), 2000);
    return true;
  }
  return false;
}

// â”€â”€ Carrega endereÃ§os e atualiza badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSavedAddresses(phone) {
  currentPhone = phone;
  document.getElementById('modal-client-name').textContent = document.getElementById('cName').value;
  try {
    allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(phone)}`);
  } catch(e) { allAddresses = []; }
  // Mostra botÃ£o
  const bar = document.getElementById('multi-addr-bar');
  bar.style.display = 'flex';
  document.getElementById('addr-count-badge').textContent = allAddresses.length;
}

// â”€â”€ Abre modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddrModal() {
  document.getElementById('addr-search-input').value = '';
  renderAddrList(allAddresses);
  document.getElementById('addr-modal').style.display = 'flex';
  // Sempre abre na aba Buscar
  setTimeout(() => switchAddrTab('buscar'), 50);
}
function closeAddrModal() {
  document.getElementById('addr-modal').style.display = 'none';
}
// addr-modal: fecha apenas pelo botÃ£o X

// â”€â”€ Renderiza lista no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAddrList(list) {
  const el = document.getElementById('addr-modal-list');
  if (!list.length) {
    el.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px">Nenhum endereÃ§o cadastrado</div>';
    return;
  }
  el.innerHTML = list.map(a => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;margin-bottom:8px;cursor:pointer;transition:border .15s"
      onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#e2e8f0'"
      onclick="applyAddress(${JSON.stringify(a).replace(/"/g,'&quot;')})">
      <div style="flex:1">
        <div style="font-size:14px;font-weight:700;color:#6366f1">${a.obs || 'â€”'}</div>
        <div style="font-size:13px;color:#334155;margin-top:2px">${a.address_line}${a.bairro ? ' â€” ' + a.bairro : ''}</div>
        ${a.complemento ? `<div style="font-size:11px;color:#94a3b8">${a.complemento}</div>` : ''}
        ${a.referencia  ? `<div style="font-size:11px;color:#94a3b8">Ref: ${a.referencia}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button type="button" onclick="event.stopPropagation();deleteAddr(${a.id})"
          style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:14px;padding:2px" title="Excluir">ğŸ—‘ï¸</button>
        <div style="background:#6366f1;color:#fff;border-radius:6px;padding:5px 10px;font-size:12px;font-weight:700">Usar â†’</div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ Filtro de busca no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterAddresses(q) {
  if (!q) { renderAddrList(allAddresses); return; }
  const ql = q.toLowerCase();
  renderAddrList(allAddresses.filter(a =>
    (a.obs || '').toLowerCase().includes(ql) ||
    (a.address_line || '').toLowerCase().includes(ql) ||
    (a.bairro || '').toLowerCase().includes(ql)
  ));
}

// â”€â”€ Aplicar endereÃ§o selecionado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyAddress(a) {
  const _aa = a.address_line || '';
  const _am = _aa.match(/,\s*(\d+\S*)$/);
  document.getElementById('cAddr').value = _am ? _aa.slice(0, _am.index) : _aa;
  const _an = document.getElementById('cNum'); if (_an) _an.value = _am ? _am[1] : '';
  document.getElementById('cBairro').value = a.bairro || '';
  document.getElementById('cComp').value   = a.complemento || '';
  document.getElementById('cRef').value    = a.referencia || '';
  document.getElementById('addr-selected-label').textContent = 'âœ… ' + (a.obs || a.address_line);
  closeAddrModal();
  toast('ğŸ“ ' + (a.obs || a.address_line));
}

// â”€â”€ Form de novo endereÃ§o no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ Autocomplete de ruas (Campo Grande/MS via Nominatim OSM) â”€
let _acTimer = null;
let _acActiveIdx = -1;

async function streetAC(input, bairroId, dropId) {
  const q = input.value.trim();
  const drop = document.getElementById(dropId);
  clearTimeout(_acTimer);
  _acActiveIdx = -1;
  
  if (q.length < 3) { drop.style.display='none'; return; }

  // NavegaÃ§Ã£o por teclado
  input.onkeydown = (e) => {
    const items = drop.querySelectorAll('.street-ac-item');
    if (!items.length) return;
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      _acActiveIdx = Math.min(_acActiveIdx+1, items.length-1);
      items.forEach((el,i) => el.classList.toggle('active', i===_acActiveIdx));
      items[_acActiveIdx]?.scrollIntoView({block:'nearest'});
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      _acActiveIdx = Math.max(_acActiveIdx-1, 0);
      items.forEach((el,i) => el.classList.toggle('active', i===_acActiveIdx));
      items[_acActiveIdx]?.scrollIntoView({block:'nearest'});
    } else if (e.key === 'Enter' && _acActiveIdx >= 0) {
      e.preventDefault();
      items[_acActiveIdx].click();
    } else if (e.key === 'Escape') {
      drop.style.display='none';
    }
  };

  _acTimer = setTimeout(async () => {
    drop.innerHTML = '<div style="padding:8px 12px;color:#94a3b8;font-size:12px">ğŸ” Buscando...</div>';
    drop.style.display = 'block';
    try {
      // Busca no D1 local (banco de ruas de Campo Grande importado do OpenStreetMap)
      const results = await api(`/api/streets/search?q=${encodeURIComponent(q)}`);

      if (!results || !results.length) {
        drop.innerHTML = '<div style="padding:8px 12px;color:#94a3b8;font-size:12px">Nenhuma rua encontrada â€” tente o nome completo</div>';
        return;
      }

      drop.innerHTML = results.map((r, idx) => {
        const road   = r.name || '';
        const bairro = r.bairro || '';
        const safe   = road.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        const safeb  = bairro.replace(/\\/g,'\\\\').replace(/'/g,"\\'");
        return `<div
          style="cursor:pointer;display:flex;justify-content:space-between;align-items:center;padding:9px 12px;border-bottom:1px solid #e2e8f0;font-size:13px"
          onmouseenter="this.style.background='#ede9fe';this.style.cursor='pointer'"
          onmouseleave="this.style.background=''"
          onclick="selectStreet('${safe}','${safeb}','${input.id}','${bairroId}','${dropId}')">
          <div style="font-weight:700;color:#1e293b">${road}</div>
          <div style="color:#94a3b8;font-size:11px;flex-shrink:0;margin-left:8px">â†µ</div>
        </div>`;
      }).join('');
    } catch(e) {
      // Fallback: banco de ruas nÃ£o importado ainda
      drop.innerHTML = '<div style="padding:10px 12px;color:#f97316;font-size:12px">âš ï¸ Banco de ruas nÃ£o importado. Acesse âš™ï¸ Config â†’ Importar Ruas de Campo Grande</div>';
    }
  }, 250);
}

function selectStreet(road, bairro, inputId, bairroId, dropId) {
  const inp = document.getElementById(inputId);
  if (inp) inp.value = road;
  const bairroEl = document.getElementById(bairroId);
  if (bairroEl && !bairroEl.value) bairroEl.value = bairro;
  document.getElementById(dropId).style.display = 'none';
  _acActiveIdx = -1;

  // Sempre busca bairros â€” rua pode passar por vÃ¡rios bairros (ex: Afonso Pena)
  if (bairroEl) fetchBairrosParaRua(road, bairroEl);

  // Foca no campo NÃºmero
  const numMap = { 'cAddr': 'cNum', 'm-addr': 'm-num' };
  const numId = numMap[inputId];
  const numEl = numId ? document.getElementById(numId) : null;
  if (numEl && !bairroEl) { setTimeout(() => numEl.focus(), 50); }
}

// Busca bairros da rua no Nominatim via Worker e mostra seletor se houver mais de um
async function fetchBairrosParaRua(road, bairroEl) {
  // Mostra indicador de carregamento no campo bairro
  const prev = bairroEl.placeholder;
  bairroEl.placeholder = 'â³ Buscando bairros...';
  bairroEl.readOnly = true;

  // Remove seletor anterior se existir
  const oldSel = document.getElementById('bairro-picker');
  if (oldSel) oldSel.remove();

  try {
    const r = await api(`/api/streets/bairros?name=${encodeURIComponent(road)}`);
    const bairros = r.bairros || [];

    bairroEl.readOnly = false;
    bairroEl.placeholder = prev;

    if (bairros.length === 0) {
      // Nenhum bairro encontrado â€” deixa livre para digitar
      return;
    }

    if (bairros.length === 1) {
      // SÃ³ um bairro â€” preenche automaticamente
      bairroEl.value = bairros[0];
      // Foca no nÃºmero
      const numMap = { 'cBairro': 'cNum', 'm-bairro': 'm-num' };
      const numId = numMap[bairroEl.id];
      const numEl = numId ? document.getElementById(numId) : null;
      if (numEl) setTimeout(() => numEl.focus(), 50);
      return;
    }

    // MÃºltiplos bairros â€” mostra dropdown para escolher
    const picker = document.createElement('div');
    picker.id = 'bairro-picker';
    picker.style.cssText = `
      position:absolute; z-index:9999; background:#fff;
      border:2px solid #6366f1; border-radius:10px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      min-width:260px; max-width:360px; overflow:hidden;
      font-family:system-ui,sans-serif;
    `;

    picker.innerHTML = `
      <div style="background:#6366f1;color:#fff;padding:8px 12px;font-size:12px;font-weight:700;">
        ğŸ“ ${road} â€” qual bairro?
      </div>
      ${bairros.map(b => `
        <div onclick="chooseBairro('${b.replace(/'/g,"\'")}','${bairroEl.id}')"
          style="padding:10px 14px;cursor:pointer;font-size:13px;border-bottom:1px solid #f1f5f9;color:#1e293b;"
          onmouseenter="this.style.background='#ede9fe'"
          onmouseleave="this.style.background=''">
          ${b}
        </div>`).join('')}
      <div onclick="document.getElementById('bairro-picker').remove();document.getElementById('${bairroEl.id}').readOnly=false;document.getElementById('${bairroEl.id}').focus();"
        style="padding:8px 14px;cursor:pointer;font-size:12px;color:#94a3b8;text-align:center;"
        onmouseenter="this.style.background='#f8fafc'"
        onmouseleave="this.style.background=''">
        âœï¸ Digitar manualmente
      </div>
    `;

    // Posiciona abaixo do campo bairro
    const rect = bairroEl.getBoundingClientRect();
    picker.style.top  = (rect.bottom + window.scrollY + 4) + 'px';
    picker.style.left = rect.left + 'px';
    document.body.appendChild(picker);

    // Fecha ao clicar fora
    setTimeout(() => {
      document.addEventListener('click', function closePicker(e) {
        if (!picker.contains(e.target) && e.target !== bairroEl) {
          picker.remove();
          bairroEl.readOnly = false;
          document.removeEventListener('click', closePicker);
        }
      });
    }, 100);

  } catch(_) {
    bairroEl.readOnly = false;
    bairroEl.placeholder = prev;
  }
}

function chooseBairro(bairro, bairroElId) {
  const bairroEl = document.getElementById(bairroElId);
  if (bairroEl) { bairroEl.value = bairro; bairroEl.readOnly = false; }
  const picker = document.getElementById('bairro-picker');
  if (picker) picker.remove();
  // Foca no nÃºmero
  const numMap = { 'cBairro': 'cNum', 'm-bairro': 'm-num' };
  const numId = numMap[bairroElId];
  const numEl = numId ? document.getElementById(numId) : null;
  if (numEl) setTimeout(() => numEl.focus(), 50);
}

// Fecha dropdown ao clicar fora
document.addEventListener('click', e => {
  if (!e.target.closest('.street-wrap')) {
    document.querySelectorAll('.street-ac').forEach(d => d.style.display='none');
  }
});

function switchAddrTab(tab) {
  const isBuscar = tab === 'buscar';
  document.getElementById('panel-buscar').style.display = isBuscar ? 'flex' : 'none';
  document.getElementById('panel-novo').style.display   = isBuscar ? 'none' : 'block';
  const tabB = document.getElementById('tab-buscar');
  const tabN = document.getElementById('tab-novo');
  tabB.style.background = isBuscar ? '#6366f1' : '#f1f5f9';
  tabB.style.color      = isBuscar ? '#fff' : '#64748b';
  tabN.style.background = isBuscar ? '#f1f5f9' : '#6366f1';
  tabN.style.color      = isBuscar ? '#64748b' : '#fff';
  if (isBuscar) {
    document.getElementById('addr-search-input').focus();
  } else {
    document.getElementById('m-obs').focus();
  }
}
function showAddInModal() { switchAddrTab('novo'); }
function hideAddInModal() {
  switchAddrTab('buscar');
  ['m-obs','m-addr','m-num','m-bairro','m-comp','m-ref'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
}

async function saveAddrInModal() {
  const obs  = document.getElementById('m-obs').value.trim();
  const line = document.getElementById('m-addr').value.trim();
  document.getElementById('m-obs').style.borderColor  = '';
  document.getElementById('m-addr').style.borderColor = '';
  if (!obs)  { document.getElementById('m-obs').style.borderColor  = '#dc2626'; document.getElementById('m-obs').focus(); return; }
  if (!line)  { document.getElementById('m-addr').style.borderColor = '#dc2626'; document.getElementById('m-addr').focus(); return; }
  if (!currentPhone) { toast('âŒ Selecione um cliente primeiro'); return; }

  const btn = document.querySelector('button[onclick="saveAddrInModal()"]');
  if (btn && btn.disabled) return; // jÃ¡ estÃ¡ salvando - ignora cliques extras
  const origText = btn ? btn.textContent : '';
  if (btn) { btn.textContent = 'â³ Salvando...'; btn.disabled = true; }

  try {
    const payload = {
      phone_digits: currentPhone, obs, address_line: line,
      bairro:      document.getElementById('m-bairro').value || '',
      complemento: document.getElementById('m-comp').value  || '',
      referencia:  document.getElementById('m-ref').value   || '',
    };
    console.log('Salvando endereÃ§o:', payload);

    const result = await api('/api/address/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });
    console.log('Resultado:', result);

    toast('âœ… EndereÃ§o salvo!');

    // Recarrega lista imediatamente
    try {
      allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(currentPhone)}`);
    } catch(le) { console.error('Erro ao recarregar lista:', le); allAddresses = []; }

    document.getElementById('addr-count-badge').textContent = allAddresses.length;
    document.getElementById('addr-search-input').value = '';
    renderAddrList(allAddresses);
    hideAddInModal(); // volta para aba Buscar e limpa campos
  } catch(e) {
    console.error('Erro saveAddrInModal:', e);
    toast('âŒ Erro: ' + (e.message || 'falha ao salvar'));
    if (btn) { btn.textContent = origText || 'ğŸ’¾ Salvar endereÃ§o'; btn.disabled = false; }
  }
}

async function deleteAddr(id) {
  if (!confirm('Excluir este endereÃ§o?')) return;
  await api(`/api/address/${id}`, { method: 'DELETE' });
  allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(currentPhone)}`);
  document.getElementById('addr-count-badge').textContent = allAddresses.length;
  renderAddrList(allAddresses);
}

// â”€â”€ Produtos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let productTimer;
async function searchProducts(q) {
  clearTimeout(productTimer);
  const box = document.getElementById('product-suggestions');
  if (q.length < 2) { box.style.display='none'; box._data = []; return; }

  // Mostra loading
  box.style.display = 'block';
  box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">ğŸ” Buscando...</div>';
  box._data = [];

  productTimer = setTimeout(async () => {
    try {
      const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`);
      if (!list || !list.length) {
        box.innerHTML = '<div style="padding:10px 14px;color:#94a3b8;font-size:12px">Nenhum produto encontrado para "' + q + '"</div>';
        box._data = [];
        return;
      }
      box._data = list;
      box.style.display = 'block';
      box.innerHTML = list.map((p, idx) => {
        const nome = (p.name||'').length > 55 ? (p.name||'').substring(0,55)+'â€¦' : (p.name||'Produto');
        const preco = parseFloat(p.price||0).toFixed(2);
        return `<div class="suggestion-item" onclick="addProductFromSearch(${idx})"
          style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <span>
            <strong>${nome}</strong>
            ${p.code ? `<small style="color:#94a3b8;margin-left:6px">(${p.code})</small>` : ''}
          </span>
          <span style="color:#f97316;font-weight:700;white-space:nowrap">R$ ${preco}</span>
        </div>`;
      }).join('');
    } catch(e) {
      console.error('Erro busca produto:', e);
      if (checkBlingReauth(e)) {
        box.innerHTML = `<div style="padding:10px 14px;color:#dc2626;font-size:12px">âš ï¸ Token Bling expirado â€” tentando reconectar... <a href="config.html" style="color:#dc2626;font-weight:700">ou reautorize aqui</a></div>`;
        // checkBlingReauth jÃ¡ dispara auto-recovery, quando reconectar o user pode buscar de novo
      } else {
        box.innerHTML = `<div style="padding:10px 14px;color:#dc2626;font-size:12px">âŒ Erro: ${e.message}</div>`;
      }
      box._data = [];
    }
  }, 300);
}

function addProductFromSearch(idx) {
  const box = document.getElementById('product-suggestions');
  const list = box._data || [];
  const p = list[idx];
  if (!p) { toast('âŒ Produto nÃ£o encontrado', 'error'); return; }
  box.style.display = 'none';
  box._data = [];
  document.getElementById('product-search').value = '';
  addItem(String(p.id), p.name || 'Produto', parseFloat(p.price) || 0, p.code || '');
}

document.addEventListener('click', e => {
  if (!e.target.closest('#product-search') && !e.target.closest('#product-suggestions'))
    document.getElementById('product-suggestions').style.display='none';
});

// â”€â”€ Consumidor Final â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let isConsumidorFinal = false;
const CONSUMIDOR_FINAL_BLING_ID = 726746364;

function setConsumidorFinal() {
  isConsumidorFinal = true;
  document.getElementById('cName').value = 'CONSUMIDOR FINAL';
  document.getElementById('cPhone').value = '';
  document.getElementById('cAddr').value = '';
  if (document.getElementById('cNum')) document.getElementById('cNum').value = '';
  if (document.getElementById('cBairro')) document.getElementById('cBairro').value = '';
  if (document.getElementById('cComp')) document.getElementById('cComp').value = '';
  if (document.getElementById('cRef')) document.getElementById('cRef').value = '';
  // Destacar visualmente
  document.getElementById('cName').style.background = '#f0f9ff';
  document.getElementById('cName').style.borderColor = '#7dd3fc';
  toast('ğŸ‘¤ Consumidor Final â€” endereÃ§o nÃ£o obrigatÃ³rio', 'ok');
}

// Reset flag quando muda nome manualmente
document.getElementById('cName')?.addEventListener('input', () => {
  if (isConsumidorFinal) {
    isConsumidorFinal = false;
    document.getElementById('cName').style.background = '';
    document.getElementById('cName').style.borderColor = '';
  }
});

// â”€â”€ Itens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addItem(id, name, price, code) {
  const existing = items.find(i => i.id === id);
  if (existing) { existing.qty++; }
  else { items.push({ id, name, qty: 1, price, code: code || '' }); }
  renderItems();
}

function changeQty(id, delta) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) items = items.filter(i => i.id !== id);
  renderItems();
}

function setQty(id, val) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  const qty = parseInt(val) || 0;
  if (qty <= 0) { items = items.filter(i => i.id !== id); }
  else { item.qty = qty; }
  renderItems();
}

// Converte input de preÃ§o: "120" â†’ 120.00, "120,50" â†’ 120.50, "25.00" â†’ 25.00
function parsePrice(val) {
  if (typeof val !== 'string') val = String(val || '0');
  val = val.trim().replace(/\s/g, '');
  // Se tem vÃ­rgula, trata como decimal BR
  if (val.includes(',')) val = val.replace('.', '').replace(',', '.');
  return parseFloat(val) || 0;
}

function changePrice(id, val) {
  const item = items.find(i => i.id === id);
  if (item) { item.price = parsePrice(val); renderItems(); renderTotal(); }
}

function renderTotal() {
  let total = 0;
  items.forEach(it => total += it.price * it.qty);
  document.getElementById('total-bar').style.display = items.length ? 'flex' : 'none';
  document.getElementById('total-val').textContent = `R$ ${total.toFixed(2)}`;
}

function renderItems() {
  const list = document.getElementById('items-list');
  if (!items.length) {
    list.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:12px">Nenhum item adicionado</div>';
    document.getElementById('total-bar').style.display = 'none';
    return;
  }
  list.innerHTML = items.map(it => `
    <div class="item-row">
      <span style="flex:1;font-size:14px">${it.name}</span>
      <button class="qty-btn" onclick="changeQty('${it.id}',-1)">âˆ’</button>
      <input type="text" inputmode="numeric" value="${it.qty}" 
        style="width:40px;text-align:center;font-weight:800;font-size:15px;border:1px solid #e2e8f0;border-radius:6px;padding:3px 2px;-moz-appearance:textfield"
        onblur="setQty('${it.id}',this.value)" onkeydown="if(event.key==='Enter')this.blur()">
      <button class="qty-btn" onclick="changeQty('${it.id}',1)">+</button>
      <span style="display:flex;align-items:center;gap:4px">
        <small style="color:#94a3b8">R$</small>
        <input type="text" inputmode="decimal" value="${it.price.toFixed(2)}" 
          style="width:65px;padding:4px;border:1px solid #e2e8f0;border-radius:6px;font-weight:700;text-align:right;font-size:13px;-moz-appearance:textfield"
          onblur="changePrice('${it.id}',this.value);this.value=parsePrice(this.value).toFixed(2)"
          onkeydown="if(event.key==='Enter'){this.blur()}">
      </span>
      <span style="min-width:75px;text-align:right;font-weight:800;color:#1e293b;font-size:14px">=&nbsp;R$&nbsp;${(it.price*it.qty).toFixed(2)}</span>
      <button class="btn-remove" onclick="changeQty('${it.id}',-99)">âœ•</button>
    </div>`).join('');
  renderTotal();
}

// â”€â”€ Tipo de Pagamento â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selTipoPgto(btn) {
  document.querySelectorAll('.tipo-pgto-btn').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
  document.getElementById('tipo_pagamento').value = btn.dataset.tipo;
  document.getElementById('forma_pagamento_key').value = btn.dataset.key;
}

// â”€â”€ Salvar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveOrder() {
  const name  = document.getElementById('cName').value.trim();
  const addrRua = document.getElementById('cAddr').value.trim();
  const addrNum = document.getElementById('cNum') ? document.getElementById('cNum').value.trim() : '';
  const addr    = addrNum ? addrRua + ', ' + addrNum : addrRua;
  if (!name) { toast('Nome do cliente obrigatÃ³rio', 'error'); return; }
  if (!isConsumidorFinal && !addr) { toast('EndereÃ§o obrigatÃ³rio', 'error'); return; }

  const tipoPgto = document.getElementById('tipo_pagamento').value;
  if (!tipoPgto) { toast('âš ï¸ Selecione o tipo de pagamento', 'error'); return; }

  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = 'â³ Salvando...';
  showLoading('Salvando pedido...');

  try {
    const total = items.reduce((s, i) => s + i.price * i.qty, 0);
    const result = await api('/api/order/create', {
      method: 'POST',
      body: JSON.stringify({
        phone:            document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line:     addr,
        bairro:           document.getElementById('cBairro').value,
        complemento:      document.getElementById('cComp').value,
        referencia:       document.getElementById('cRef').value,
        items:            items.map(i => ({ name: i.name, qty: i.qty, price: i.price, bling_id: i.id, code: i.code || '' })),
        total_value:      total || null,
        notes:            document.getElementById('notes').value,
        tipo_pagamento:   tipoPgto,
        forma_pagamento_key: document.getElementById('forma_pagamento_key').value,
        bling_contact_id: isConsumidorFinal ? CONSUMIDOR_FINAL_BLING_ID : (window._lastBlingContactId || null),
      }),
    });

    // Salvar cliente no cache
    await api('/api/customer/upsert', {
      method: 'POST',
      body: JSON.stringify({
        phone: document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line: addr,
        bairro:      document.getElementById('cBairro').value,
        complemento: document.getElementById('cComp').value,
        referencia:  document.getElementById('cRef').value,
      }),
    }).catch(() => {});

    // Mensagens de sucesso
    const msgs = {
      dinheiro: 'pago e no Bling âœ…',
      pix_vista: 'PIX Ã  vista',
      pix_receber: 'PIX a receber â³',
      debito: 'DÃ©bito',
      credito: 'CrÃ©dito',
      mensalista: 'Mensalista ğŸ“‹',
      boleto: 'Boleto/Ã“rgÃ£o ğŸ§¾',
      nfe: 'NFe ğŸ“„'
    };
    const statusMsg = msgs[tipoPgto] || '';
    
    hideLoading();
    toast(`âœ… Pedido #${result.id} salvo â€” ${statusMsg}. Bling ao entregar.`);
    setTimeout(() => { window.location.href = 'gestao.html'; }, 1200);

  } catch(e) {
    hideLoading();
    checkBlingReauth(e); // Atualiza indicador se for erro de token
    toast(e.message, 'error');
    btn.disabled = false;
    btn.textContent = 'âœ… SALVAR PEDIDO';
  }
}

renderItems();
</script>

<!-- â”€â”€ MODAL ENDEREÃ‡OS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="addr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:16px;width:min(94vw,560px);max-height:90vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3)" onclick="event.stopPropagation()">

    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 20px;border-bottom:2px solid #e2e8f0;flex-shrink:0">
      <div>
        <div style="font-size:15px;font-weight:800;color:#1e293b">ğŸ“ EndereÃ§os de Entrega</div>
        <div id="modal-client-name" style="font-size:12px;color:#6366f1;margin-top:1px"></div>
      </div>
      <button onclick="closeAddrModal()" style="background:#f1f5f9;border:none;border-radius:8px;width:34px;height:34px;font-size:20px;cursor:pointer;line-height:1">Ã—</button>
    </div>

    <!-- Tabs -->
    <div style="display:flex;border-bottom:2px solid #e2e8f0;flex-shrink:0">
      <button id="tab-buscar" onclick="switchAddrTab('buscar')"
        style="flex:1;padding:10px;border:none;background:#6366f1;color:#fff;font-size:13px;font-weight:700;cursor:pointer;border-radius:0">
        ğŸ” Buscar endereÃ§o
      </button>
      <button id="tab-novo" onclick="switchAddrTab('novo')"
        style="flex:1;padding:10px;border:none;background:#f1f5f9;color:#64748b;font-size:13px;font-weight:700;cursor:pointer;border-radius:0 0 0 0">
        + Novo endereÃ§o
      </button>
    </div>

    <!-- Painel BUSCAR -->
    <div id="panel-buscar" style="display:flex;flex-direction:column;flex:1;min-height:0">
      <div style="padding:12px 20px;flex-shrink:0">
        <input id="addr-search-input" type="text" placeholder="ğŸ” Digite nome da unidade ou rua..."
          oninput="filterAddresses(this.value)" autocomplete="off"
          style="width:100%;padding:9px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;outline:none"
          onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e2e8f0'">
      </div>
      <div id="addr-modal-list" style="flex:1;overflow-y:auto;padding:0 20px 12px"></div>
    </div>

    <!-- Painel NOVO -->
    <div id="panel-novo" style="display:none;overflow-y:auto;padding:16px 20px;flex:1">
      <div style="margin-bottom:10px">
        <label style="font-size:11px;font-weight:700;color:#64748b">NOME / UNIDADE *</label>
        <input id="m-obs" type="text" placeholder="Ex: Escola Municipal X, ClÃ­nica SaÃºde Plena"
          style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
      </div>
      <div style="margin-bottom:10px;display:grid;grid-template-columns:1fr 90px;gap:8px">
        <div>
          <label style="font-size:11px;font-weight:700;color:#64748b">RUA *</label>
          <div class="street-wrap">
            <input id="m-addr" type="text" placeholder="Rua das Flores" autocomplete="off"
              oninput="streetAC(this,'m-bairro','m-addr-ac')"
              style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
            <div id="m-addr-ac" class="street-ac" style="display:none"></div>
          </div>
        </div>
        <div>
          <label style="font-size:11px;font-weight:700;color:#64748b">NÃšMERO *</label>
          <input id="m-num" type="text" placeholder="100"
            style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px">
        <div>
          <label style="font-size:11px;font-weight:700;color:#64748b">BAIRRO</label>
          <input id="m-bairro" type="text" placeholder="Jardim Noroeste"
            style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
        <div>
          <label style="font-size:11px;font-weight:700;color:#64748b">COMPLEMENTO</label>
          <input id="m-comp" type="text" placeholder="Sala 2, Bloco A"
            style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
      </div>
      <div style="margin-bottom:14px">
        <label style="font-size:11px;font-weight:700;color:#64748b">PONTO DE REFERÃŠNCIA</label>
        <input id="m-ref" type="text" placeholder="PrÃ³ximo ao semÃ¡foro"
          style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
      </div>
      <div style="display:flex;gap:8px">
        <button type="button" onclick="saveAddrInModal()"
          style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:11px 20px;font-size:14px;font-weight:700;cursor:pointer;flex:1">
          ğŸ’¾ Salvar endereÃ§o
        </button>
        <button type="button" onclick="switchAddrTab('buscar')"
          style="background:#f1f5f9;color:#64748b;border:none;border-radius:8px;padding:11px 16px;font-size:13px;cursor:pointer">
          Cancelar
        </button>
      </div>
    </div>

  </div>
</div>

<!-- â”€â”€ MODAL CADASTRO CLIENTE (PF/PJ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="cadastro-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);z-index:10000;overflow-y:auto">
  <div style="background:#fff;max-width:560px;margin:30px auto;border-radius:14px;box-shadow:0 8px 32px rgba(0,0,0,0.2)">
    <div style="padding:16px 20px;border-bottom:2px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0;font-size:17px;color:#1e293b">ğŸ‘¤ Cadastrar Cliente no Bling</h2>
      <button onclick="closeCadastroModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8">âœ•</button>
    </div>

    <!-- Tabs PF / PJ -->
    <div style="display:flex;border-bottom:2px solid #e2e8f0">
      <button id="tab-pf" onclick="switchCadTab('pf')" style="flex:1;padding:12px;font-size:14px;font-weight:700;border:none;cursor:pointer;background:#f97316;color:#fff;border-radius:0">
        ğŸ§‘ Pessoa FÃ­sica
      </button>
      <button id="tab-pj" onclick="switchCadTab('pj')" style="flex:1;padding:12px;font-size:14px;font-weight:700;border:none;cursor:pointer;background:#f1f5f9;color:#64748b;border-radius:0">
        ğŸ¢ Pessoa JurÃ­dica
      </button>
    </div>

    <div style="padding:20px">
      <!-- === PF Fields === -->
      <div id="cad-pf">
        <div style="display:grid;gap:10px;margin-bottom:12px">
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">NOME COMPLETO *</label>
            <input id="cad-pf-nome" type="text" placeholder="Nome do cliente" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">CPF</label>
              <input id="cad-pf-cpf" type="text" placeholder="000.000.000-00" maxlength="14" oninput="maskCPF(this)" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">TELEFONE / CELULAR</label>
              <input id="cad-pf-tel" type="tel" placeholder="67 99999-9999" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">E-MAIL</label>
              <input id="cad-pf-email" type="email" placeholder="cliente@email.com" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">E-MAIL P/ ENVIO NFe</label>
              <input id="cad-pf-email-nfe" type="email" placeholder="nfe@email.com" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
          </div>
        </div>
      </div>

      <!-- === PJ Fields === -->
      <div id="cad-pj" style="display:none">
        <div style="display:grid;gap:10px;margin-bottom:12px">
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">RAZÃƒO SOCIAL *</label>
            <input id="cad-pj-razao" type="text" placeholder="Empresa LTDA" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">NOME FANTASIA</label>
              <input id="cad-pj-fantasia" type="text" placeholder="Nome popular" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">CNPJ *</label>
              <input id="cad-pj-cnpj" type="text" placeholder="00.000.000/0000-00" maxlength="18" oninput="maskCNPJ(this)" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:end">
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">INSCRIÃ‡ÃƒO ESTADUAL</label>
              <input id="cad-pj-ie" type="text" placeholder="IE" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
            <div style="padding-bottom:4px">
              <label style="font-size:11px;cursor:pointer;display:flex;align-items:center;gap:4px;color:#64748b;font-weight:600">
                <input type="checkbox" id="cad-pj-ie-isento" onchange="document.getElementById('cad-pj-ie').disabled = this.checked; if(this.checked) document.getElementById('cad-pj-ie').value = ''"> ISENTO
              </label>
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">TELEFONE</label>
              <input id="cad-pj-tel" type="tel" placeholder="67 3333-4444" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">E-MAIL</label>
              <input id="cad-pj-email" type="email" placeholder="contato@empresa.com" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
            <div>
              <label style="font-size:11px;font-weight:700;color:#64748b">E-MAIL P/ ENVIO NFe *</label>
              <input id="cad-pj-email-nfe" type="email" placeholder="nfe@empresa.com" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
            </div>
          </div>
        </div>
      </div>

      <!-- === EndereÃ§o (compartilhado PF/PJ) === -->
      <div style="border-top:2px solid #e2e8f0;padding-top:14px;margin-top:8px">
        <p style="font-size:12px;font-weight:700;color:#475569;margin-bottom:10px">ğŸ“ ENDEREÃ‡O</p>
        <div style="display:grid;grid-template-columns:3fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">RUA</label>
            <input id="cad-rua" type="text" placeholder="Rua das OrquÃ­deas" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">NÃšMERO</label>
            <input id="cad-num" type="text" placeholder="123" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:10px">
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">BAIRRO</label>
            <input id="cad-bairro" type="text" placeholder="Jardim Noroeste" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">COMPLEMENTO</label>
            <input id="cad-comp" type="text" placeholder="Sala 2" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">CEP</label>
            <input id="cad-cep" type="text" placeholder="79000-000" maxlength="9" oninput="maskCEP(this)" style="width:100%;padding:9px;border:2px solid #e2e8f0;border-radius:6px;font-size:14px;margin-top:3px">
          </div>
        </div>
      </div>

      <!-- BotÃµes -->
      <div style="display:flex;gap:8px;margin-top:16px">
        <button id="cad-btn-save" onclick="saveCadastro()" style="flex:1;background:#16a34a;color:#fff;border:none;border-radius:8px;padding:12px;font-size:15px;font-weight:700;cursor:pointer">
          âœ… Cadastrar no Bling
        </button>
        <button onclick="closeCadastroModal()" style="background:#f1f5f9;color:#64748b;border:none;border-radius:8px;padding:12px 20px;font-size:14px;cursor:pointer">
          Cancelar
        </button>
      </div>
      <p id="cad-status" style="margin-top:10px;font-size:12px;color:#94a3b8;text-align:center"></p>
    </div>
  </div>
</div>

<script>
// â”€â”€ Cadastro Cliente Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cadTab = 'pf';

function openCadastroModal() {
  document.getElementById('cadastro-modal').style.display = 'block';
  // Preencher campos com dados jÃ¡ digitados no form principal
  const name = document.getElementById('cName').value;
  const phone = document.getElementById('cPhone').value;
  if (name) document.getElementById('cad-pf-nome').value = name;
  if (phone) document.getElementById('cad-pf-tel').value = phone;
}

function closeCadastroModal() {
  document.getElementById('cadastro-modal').style.display = 'none';
  document.getElementById('cad-status').textContent = '';
}

function switchCadTab(tab) {
  cadTab = tab;
  document.getElementById('cad-pf').style.display = tab === 'pf' ? 'block' : 'none';
  document.getElementById('cad-pj').style.display = tab === 'pj' ? 'block' : 'none';
  document.getElementById('tab-pf').style.background = tab === 'pf' ? '#f97316' : '#f1f5f9';
  document.getElementById('tab-pf').style.color = tab === 'pf' ? '#fff' : '#64748b';
  document.getElementById('tab-pj').style.background = tab === 'pj' ? '#f97316' : '#f1f5f9';
  document.getElementById('tab-pj').style.color = tab === 'pj' ? '#fff' : '#64748b';
}

// Masks
function maskCPF(el) {
  let v = el.value.replace(/\D/g, '').substring(0, 11);
  v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
  el.value = v;
}
function maskCNPJ(el) {
  let v = el.value.replace(/\D/g, '').substring(0, 14);
  v = v.replace(/^(\d{2})(\d)/, '$1.$2').replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3').replace(/\.(\d{3})(\d)/, '.$1/$2').replace(/(\d{4})(\d)/, '$1-$2');
  el.value = v;
}
function maskCEP(el) {
  let v = el.value.replace(/\D/g, '').substring(0, 8);
  v = v.replace(/(\d{5})(\d)/, '$1-$2');
  el.value = v;
}

async function saveCadastro() {
  const btn = document.getElementById('cad-btn-save');
  const status = document.getElementById('cad-status');
  btn.disabled = true;
  btn.textContent = 'â³ Cadastrando...';
  status.textContent = '';
  showLoading('Cadastrando no Bling...');

  try {
    let payload = {};

    if (cadTab === 'pf') {
      const nome = document.getElementById('cad-pf-nome').value.trim();
      if (!nome) { throw new Error('Nome obrigatÃ³rio'); }
      const cpfRaw = document.getElementById('cad-pf-cpf').value.replace(/\D/g, '');
      // Validar CPF se preenchido
      if (cpfRaw && (cpfRaw.length !== 11 || /^(\d)\1{10}$/.test(cpfRaw))) {
        throw new Error('CPF invÃ¡lido â€” verifique os dÃ­gitos');
      }
      payload = {
        tipoPessoa: 'F',
        nome,
        numeroDocumento: document.getElementById('cad-pf-cpf').value,
        celular: document.getElementById('cad-pf-tel').value,
        email: document.getElementById('cad-pf-email').value,
        emailNfe: document.getElementById('cad-pf-email-nfe').value,
        contribuinte: 9, // NÃ£o contribuinte
      };
    } else {
      const nome = document.getElementById('cad-pj-razao').value.trim();
      const cnpj = document.getElementById('cad-pj-cnpj').value.trim();
      if (!nome) { throw new Error('RazÃ£o Social obrigatÃ³ria'); }
      if (!cnpj) { throw new Error('CNPJ obrigatÃ³rio'); }
      const cnpjRaw = cnpj.replace(/\D/g, '');
      if (cnpjRaw.length !== 14 || /^(\d)\1{13}$/.test(cnpjRaw)) {
        throw new Error('CNPJ invÃ¡lido â€” verifique os dÃ­gitos');
      }
      const ieIsento = document.getElementById('cad-pj-ie-isento').checked;
      payload = {
        tipoPessoa: 'J',
        nome,
        fantasia: document.getElementById('cad-pj-fantasia').value,
        numeroDocumento: cnpj,
        ie: ieIsento ? '' : document.getElementById('cad-pj-ie').value,
        contribuinte: ieIsento ? 2 : (document.getElementById('cad-pj-ie').value ? 1 : 9),
        celular: document.getElementById('cad-pj-tel').value,
        email: document.getElementById('cad-pj-email').value,
        emailNfe: document.getElementById('cad-pj-email-nfe').value,
      };
    }

    // EndereÃ§o compartilhado
    payload.endereco = document.getElementById('cad-rua').value;
    payload.numero = document.getElementById('cad-num').value;
    payload.bairro = document.getElementById('cad-bairro').value;
    payload.complemento = document.getElementById('cad-comp').value;
    payload.cep = document.getElementById('cad-cep').value;

    const result = await api('/api/customer/create-bling', {
      method: 'POST',
      body: JSON.stringify(payload),
    });

    if (!result.ok) throw new Error(result.error || 'Erro ao cadastrar');

    status.style.color = '#16a34a';
    status.textContent = `âœ… Cliente cadastrado no Bling! ID: ${result.bling_contact_id}`;
    toast(`âœ… ${payload.nome} cadastrado no Bling!`);

    // Preencher dados no form principal
    document.getElementById('cName').value = payload.nome;
    if (payload.celular) document.getElementById('cPhone').value = payload.celular;
    if (payload.endereco) {
      document.getElementById('cAddr').value = payload.endereco;
      if (document.getElementById('cNum')) document.getElementById('cNum').value = payload.numero || '';
    }
    if (payload.bairro) document.getElementById('cBairro').value = payload.bairro;
    if (payload.complemento) document.getElementById('cComp').value = payload.complemento;

    // Salvar bling_contact_id em variÃ¡vel para uso no pedido
    window._lastBlingContactId = result.bling_contact_id;

    setTimeout(() => closeCadastroModal(), 1500);

  } catch(e) {
    status.style.color = '#dc2626';
    status.textContent = 'âŒ ' + e.message;
    toast('âŒ ' + e.message, 'error');
  } finally {
    hideLoading();
    btn.disabled = false;
    btn.textContent = 'âœ… Cadastrar no Bling';
  }
}
</script>

</body>
</html>
