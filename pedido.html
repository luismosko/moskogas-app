
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Novo Pedido â€” MoskoGÃ¡s v1.7</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 680px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 16px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, textarea, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border 0.2s; }
  input:focus, textarea:focus { outline: none; border-color: #f97316; }
  .row { display: grid; gap: 12px; margin-bottom: 12px; }
  .row-2 { grid-template-columns: 1fr 1fr; }
  .autocomplete-box { position: relative; }
  #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #f97316; border-top: none; border-radius: 0 0 8px 8px; z-index: 100; max-height: 250px; overflow-y: auto; }
  .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  .suggestion-item:hover { background: #fff7ed; }
  .suggestion-item strong { color: #1e293b; }
  .suggestion-item small { color: #64748b; }
  .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
  .item-btn { padding: 12px 6px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; text-align: center; transition: all 0.15s; }
  .item-btn:hover { border-color: #f97316; background: #fff7ed; }
  .item-btn.selected { border-color: #f97316; background: #f97316; color: #fff; }
  .item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; padding: 8px 12px; }
  .item-row span { flex: 1; font-weight: 600; font-size: 14px; }
  .qty-btn { width: 32px; height: 32px; border: 2px solid #e2e8f0; border-radius: 6px; background: #fff; font-size: 18px; cursor: pointer; font-weight: 700; }
  .qty-val { width: 36px; text-align: center; font-weight: 700; font-size: 16px; }
  .btn-remove { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px; }
  .btn-primary { background: #f97316; color: #fff; border: none; border-radius: 10px; padding: 16px 24px; font-size: 18px; font-weight: 800; width: 100%; cursor: pointer; transition: background 0.2s; }
  .btn-primary:hover { background: #ea6d0a; }
  .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
  .status-bar { text-align: center; padding: 8px; font-size: 13px; color: #64748b; }
  .total-bar { background: #1e293b; color: #fff; border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .total-bar .val { font-size: 22px; font-weight: 900; color: #f97316; }
  .search-tab { padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; color: #64748b; transition: all 0.15s; }
  .search-tab.active { border-color: #f97316; background: #f97316; color: #fff; }
  textarea { resize: vertical; height: 70px; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <h1>â• Novo Pedido <span style="font-size:12px;color:#94a3b8;font-weight:400">v1.7</span></h1>

  <!-- BUSCA CLIENTE -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <label style="margin:0">ğŸ” Buscar Cliente</label>
      <button onclick="syncBling(this)" style="background:none;border:1px solid #e2e8f0;border-radius:6px;padding:3px 10px;font-size:11px;color:#94a3b8;cursor:pointer" title="Sincronizar contatos do Bling para busca por endereÃ§o">ğŸ”„ Sync Bling</button>
    </div>
    <div class="search-fields" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
      <input id="searchPhone" type="tel" placeholder="ğŸ“ Telefone" autocomplete="off" oninput="doSearch(this.value,'phone')">
      <input id="searchName" type="text" placeholder="ğŸ‘¤ Nome" autocomplete="off" oninput="doSearch(this.value,'name')">
      <input id="searchAddr" type="text" placeholder="ğŸ“ EndereÃ§o" autocomplete="off" oninput="doSearch(this.value,'address')">
    </div>
    <div id="suggestions" style="display:none;position:relative;"></div>
  </div>

  <!-- DADOS DO CLIENTE -->
  <div class="card">
    <div class="row row-2">
      <div>
        <label>Nome do Cliente *</label>
        <input id="cName" type="text" placeholder="Nome completo">
      </div>
      <div>
        <label>Telefone</label>
        <input id="cPhone" type="tel" placeholder="67 9...">
      </div>
    </div>
    <div class="row" style="margin-bottom:12px">
      <label>EndereÃ§o (Rua + NÃºmero) *</label>
      <input id="cAddr" type="text" placeholder="Ex: Rua das OrquÃ­deas, 123">
    </div>
    <div class="row row-2">
      <div>
        <label>Bairro</label>
        <input id="cBairro" type="text" placeholder="Ex: Jardim Noroeste">
      </div>
      <div>
        <label>Complemento</label>
        <input id="cComp" type="text" placeholder="Apto, Bloco...">
      </div>
    </div>
    <div>
      <label>Ponto de ReferÃªncia</label>
      <input id="cRef" type="text" placeholder="Ex: prÃ³ximo ao mercado X">
    </div>

    <!-- BotÃ£o endereÃ§os adicionais (aparece ao selecionar cliente) -->
    <div id="multi-addr-bar" style="display:none;margin-top:10px;padding-top:10px;border-top:2px dashed #e2e8f0;display:flex;align-items:center;gap:10px">
      <button type="button" onclick="openAddrModal()" style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:700;cursor:pointer">
        ğŸ“ Outros endereÃ§os <span id="addr-count-badge" style="background:rgba(255,255,255,0.3);border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px">0</span>
      </button>
      <span id="addr-selected-label" style="font-size:12px;color:#6366f1;font-weight:600"></span>
    </div>
  </div>

  <!-- ITENS -->
  <div class="card">
    <label style="margin-bottom:10px">ğŸ“¦ Itens do Pedido</label>
    <div style="position:relative;margin-bottom:10px">
      <input id="product-search" type="text" placeholder="ğŸ” Buscar produto pelo nome..." autocomplete="off" oninput="searchProducts(this.value)">
      <div id="product-suggestions" style="display:none;position:absolute;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:220px;overflow-y:auto"></div>
    </div>
    <div id="items-list"></div>
    <div class="total-bar" id="total-bar" style="display:none">
      <span>TOTAL</span>
      <span class="val" id="total-val">R$ 0,00</span>
    </div>
  </div>

  <!-- OBSERVAÃ‡ÃƒO -->
  <div class="card">
    <label>ğŸ“ ObservaÃ§Ã£o (opcional)</label>
    <textarea id="notes" placeholder="Urgente, horÃ¡rio preferido, troco para..."></textarea>
  </div>

  <div class="status-bar" id="status-bar"></div>
  <button class="btn-primary" id="btn-save" onclick="saveOrder()">âœ… SALVAR PEDIDO</button>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let items = [];
let searchTimer;

async function syncBling(btn) {
  btn.disabled = true;
  btn.textContent = 'â³ Sincronizando...';
  try {
    const r = await api('/api/customer/sync-bling', { method: 'POST' });
    btn.textContent = `âœ… ${r.synced} contatos sincronizados`;
    setTimeout(() => { btn.textContent = 'ğŸ”„ Sincronizar contatos Bling'; btn.disabled = false; }, 4000);
  } catch(e) {
    btn.textContent = 'âŒ Erro â€” tente novamente';
    btn.disabled = false;
  }
}

function doSearch(val, type) {
  // limpa os outros campos
  const map = {phone:'searchPhone', name:'searchName', address:'searchAddr'};
  Object.entries(map).forEach(([t, id]) => { if (t !== type) document.getElementById(id).value = ''; });
  clearTimeout(searchTimer);
  const q = val.trim();
  if (q.length < 2) { hideSuggestions(); return; }
  searchTimer = setTimeout(async () => {
    try {
      const results = await api(`/api/customer/search?q=${encodeURIComponent(q)}&type=${type}`);
      showSuggestions(results);
    } catch(e) { console.error(e); }
  }, 280);
}

document.addEventListener('click', e => {
  if (!e.target.closest('.search-fields') && !e.target.closest('#suggestions')) hideSuggestions();
});

function showSuggestions(list) {
  const box = document.getElementById('suggestions');
  if (!list.length) { hideSuggestions(); return; }
  box.style.display = 'block';
  box.innerHTML = list.map((c, i) => `
    <div class="suggestion-item" onclick="selectCustomer(${i})">
      <strong>${c.name || c.customer_name}</strong>
      <span style="margin-left:8px;color:#f97316">${c.phone_digits || ''}</span><br>
      <small>${c.address_line || ''} ${c.bairro ? 'â€” ' + c.bairro : ''}</small>
    </div>
  `).join('');
  box._data = list;
}

function hideSuggestions() {
  const box = document.getElementById('suggestions');
  box.style.display = 'none';
}

async function selectCustomer(i) {
  const c = document.getElementById('suggestions')._data[i];
  document.getElementById('cName').value   = c.name || c.customer_name || '';
  document.getElementById('cPhone').value  = c.phone_digits || '';
  document.getElementById('cAddr').value   = c.address_line || '';
  document.getElementById('cBairro').value = c.bairro || '';
  document.getElementById('cComp').value   = c.complemento || '';
  document.getElementById('cRef').value    = c.referencia || '';
  hideSuggestions();
  ['searchPhone','searchName','searchAddr'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  // Busca detalhes Bling
  if (c.bling_contact_id) {
    try {
      const det = await api(`/api/customer/bling-detail/${c.bling_contact_id}`);
      if (det && !det.error) {
        if (det.phone_digits) document.getElementById('cPhone').value  = det.phone_digits;
        if (det.address_line) document.getElementById('cAddr').value   = det.address_line;
        if (det.bairro)       document.getElementById('cBairro').value = det.bairro;
        if (det.complemento)  document.getElementById('cComp').value   = det.complemento;
      }
    } catch(e) {}
  }
  // Carrega endereÃ§os mÃºltiplos
  if (c.phone_digits) loadSavedAddresses(c.phone_digits);
}

let currentPhone = '';
let allAddresses = [];

// â”€â”€ Carrega endereÃ§os e atualiza badge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSavedAddresses(phone) {
  currentPhone = phone;
  document.getElementById('modal-client-name').textContent = document.getElementById('cName').value;
  try {
    allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(phone)}`);
  } catch(e) { allAddresses = []; }
  // Mostra botÃ£o
  const bar = document.getElementById('multi-addr-bar');
  bar.style.display = 'flex';
  document.getElementById('addr-count-badge').textContent = allAddresses.length;
}

// â”€â”€ Abre modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openAddrModal() {
  document.getElementById('addr-search-input').value = '';
  renderAddrList(allAddresses);
  hideAddInModal();
  document.getElementById('addr-modal').style.display = 'flex';
  setTimeout(() => document.getElementById('addr-search-input').focus(), 100);
}
function closeAddrModal() {
  document.getElementById('addr-modal').style.display = 'none';
}
document.addEventListener('click', e => {
  const m = document.getElementById('addr-modal');
  if (m && m.style.display === 'flex' && e.target === m) closeAddrModal();
});

// â”€â”€ Renderiza lista no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAddrList(list) {
  const el = document.getElementById('addr-modal-list');
  if (!list.length) {
    el.innerHTML = '<div style="text-align:center;color:#94a3b8;padding:20px;font-size:13px">Nenhum endereÃ§o cadastrado</div>';
    return;
  }
  el.innerHTML = list.map(a => `
    <div style="display:flex;align-items:center;gap:10px;padding:10px 12px;background:#f8fafc;border:2px solid #e2e8f0;border-radius:10px;margin-bottom:8px;cursor:pointer;transition:border .15s"
      onmouseover="this.style.borderColor='#6366f1'" onmouseout="this.style.borderColor='#e2e8f0'"
      onclick="applyAddress(${JSON.stringify(a).replace(/"/g,'&quot;')})">
      <div style="flex:1">
        <div style="font-size:14px;font-weight:700;color:#6366f1">${a.obs || 'â€”'}</div>
        <div style="font-size:13px;color:#334155;margin-top:2px">${a.address_line}${a.bairro ? ' â€” ' + a.bairro : ''}</div>
        ${a.complemento ? `<div style="font-size:11px;color:#94a3b8">${a.complemento}</div>` : ''}
        ${a.referencia  ? `<div style="font-size:11px;color:#94a3b8">Ref: ${a.referencia}</div>` : ''}
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button type="button" onclick="event.stopPropagation();deleteAddr(${a.id})"
          style="background:none;border:none;color:#dc2626;cursor:pointer;font-size:14px;padding:2px" title="Excluir">ğŸ—‘ï¸</button>
        <div style="background:#6366f1;color:#fff;border-radius:6px;padding:5px 10px;font-size:12px;font-weight:700">Usar â†’</div>
      </div>
    </div>
  `).join('');
}

// â”€â”€ Filtro de busca no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterAddresses(q) {
  if (!q) { renderAddrList(allAddresses); return; }
  const ql = q.toLowerCase();
  renderAddrList(allAddresses.filter(a =>
    (a.obs || '').toLowerCase().includes(ql) ||
    (a.address_line || '').toLowerCase().includes(ql) ||
    (a.bairro || '').toLowerCase().includes(ql)
  ));
}

// â”€â”€ Aplicar endereÃ§o selecionado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyAddress(a) {
  document.getElementById('cAddr').value   = a.address_line || '';
  document.getElementById('cBairro').value = a.bairro || '';
  document.getElementById('cComp').value   = a.complemento || '';
  document.getElementById('cRef').value    = a.referencia || '';
  document.getElementById('addr-selected-label').textContent = 'âœ… ' + (a.obs || a.address_line);
  closeAddrModal();
  showToast('ğŸ“ ' + (a.obs || a.address_line));
}

// â”€â”€ Form de novo endereÃ§o no modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showAddInModal() {
  document.getElementById('add-addr-section').style.display = 'none';
  document.getElementById('add-addr-form-modal').style.display = 'block';
  document.getElementById('m-obs').focus();
}
function hideAddInModal() {
  document.getElementById('add-addr-section').style.display = 'block';
  document.getElementById('add-addr-form-modal').style.display = 'none';
  ['m-obs','m-addr','m-bairro','m-comp','m-ref'].forEach(id => document.getElementById(id).value = '');
}

async function saveAddrInModal() {
  const obs  = document.getElementById('m-obs').value.trim();
  const line = document.getElementById('m-addr').value.trim();
  if (!obs)  { document.getElementById('m-obs').style.borderColor  = '#dc2626'; document.getElementById('m-obs').focus(); return; }
  if (!line) { document.getElementById('m-addr').style.borderColor = '#dc2626'; document.getElementById('m-addr').focus(); return; }
  const btn = document.querySelector('#add-addr-form-modal button');
  btn.textContent = 'â³ Salvando...'; btn.disabled = true;
  try {
    await api('/api/address/save', { method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        phone_digits: currentPhone, obs, address_line: line,
        bairro:      document.getElementById('m-bairro').value,
        complemento: document.getElementById('m-comp').value,
        referencia:  document.getElementById('m-ref').value,
      })
    });
    showToast('âœ… EndereÃ§o salvo!');
    // Recarrega lista imediatamente
    allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(currentPhone)}`);
    document.getElementById('addr-count-badge').textContent = allAddresses.length;
    document.getElementById('addr-search-input').value = '';
    renderAddrList(allAddresses);
    hideAddInModal();
  } catch(e) {
    showToast('Erro ao salvar', 'error');
    btn.textContent = 'ğŸ’¾ Salvar endereÃ§o'; btn.disabled = false;
  }
}

async function deleteAddr(id) {
  if (!confirm('Excluir este endereÃ§o?')) return;
  await api(`/api/address/${id}`, { method: 'DELETE' });
  allAddresses = await api(`/api/address/list?phone=${encodeURIComponent(currentPhone)}`);
  document.getElementById('addr-count-badge').textContent = allAddresses.length;
  renderAddrList(allAddresses);
}

// â”€â”€ Produtos â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let productTimer;
async function searchProducts(q) {
  clearTimeout(productTimer);
  const box = document.getElementById('product-suggestions');
  if (q.length < 2) { box.style.display='none'; return; }
  productTimer = setTimeout(async () => {
    try {
      const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`);
      if (!list.length) { box.style.display='none'; return; }
      box.style.display = 'block';
      box.innerHTML = list.map((p,i) => {
        const nome = p.name.length > 50 ? p.name.substring(0,50)+'â€¦' : p.name;
        return `
        <div class="suggestion-item" onclick="addProductFromSearch(${i})" style="display:flex;justify-content:space-between;align-items:center">
          <span><strong>${nome}</strong>${p.code ? ' <small style=color:#94a3b8;margin-left:4px>('+p.code+')</small>' : ''}</span>
          <span style="color:#f97316;font-weight:700;margin-left:8px;white-space:nowrap">R$ ${parseFloat(p.price||0).toFixed(2)}</span>
        </div>`;}).join('');
      box._data = list;
    } catch(e) { console.error(e); }
  }, 300);
}

function addProductFromSearch(i) {
  const p = document.getElementById('product-suggestions')._data[i];
  document.getElementById('product-search').value = '';
  document.getElementById('product-suggestions').style.display = 'none';
  addItem(String(p.id), p.name, parseFloat(p.price)||0);
}

document.addEventListener('click', e => {
  if (!e.target.closest('#product-search') && !e.target.closest('#product-suggestions'))
    document.getElementById('product-suggestions').style.display='none';
});

// â”€â”€ Itens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addItem(id, name, price) {
  const existing = items.find(i => i.id === id);
  if (existing) { existing.qty++; }
  else { items.push({ id, name, qty: 1, price }); }
  renderItems();
}

function changeQty(id, delta) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) items = items.filter(i => i.id !== id);
  renderItems();
}

function changePrice(id, val) {
  const item = items.find(i => i.id === id);
  if (item) { item.price = parseFloat(val)||0; renderTotal(); }
}

function renderTotal() {
  let total = 0;
  items.forEach(it => total += it.price * it.qty);
  document.getElementById('total-bar').style.display = items.length ? 'flex' : 'none';
  document.getElementById('total-val').textContent = `R$ ${total.toFixed(2)}`;
}

function renderItems() {
  const list = document.getElementById('items-list');
  if (!items.length) {
    list.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:12px">Nenhum item adicionado</div>';
    document.getElementById('total-bar').style.display = 'none';
    return;
  }
  list.innerHTML = items.map(it => `
    <div class="item-row">
      <span style="flex:1;font-size:14px">${it.name}</span>
      <button class="qty-btn" onclick="changeQty('${it.id}',-1)">âˆ’</button>
      <span class="qty-val">${it.qty}</span>
      <button class="qty-btn" onclick="changeQty('${it.id}',1)">+</button>
      <span style="display:flex;align-items:center;gap:4px">
        <small style="color:#94a3b8">R$</small>
        <input type="number" step="0.01" value="${it.price.toFixed(2)}" 
          style="width:65px;padding:4px;border:1px solid #e2e8f0;border-radius:6px;font-weight:700;text-align:right;font-size:13px"
          onchange="changePrice('${it.id}',this.value)">
      </span>
      <span style="min-width:75px;text-align:right;font-weight:800;color:#1e293b;font-size:14px">=&nbsp;R$&nbsp;${(it.price*it.qty).toFixed(2)}</span>
      <button class="btn-remove" onclick="changeQty('${it.id}',-99)">âœ•</button>
    </div>`).join('');
  renderTotal();
}

// â”€â”€ Salvar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveOrder() {
  const name  = document.getElementById('cName').value.trim();
  const addr  = document.getElementById('cAddr').value.trim();
  if (!name) { toast('Nome do cliente obrigatÃ³rio', 'error'); return; }
  if (!addr) { toast('EndereÃ§o obrigatÃ³rio', 'error'); return; }

  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = 'â³ Salvando...';

  try {
    const total = items.reduce((s, i) => s + i.price * i.qty, 0);
    const result = await api('/api/order/create', {
      method: 'POST',
      body: JSON.stringify({
        phone:       document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line: addr,
        bairro:      document.getElementById('cBairro').value,
        complemento: document.getElementById('cComp').value,
        referencia:  document.getElementById('cRef').value,
        items:       items.map(i => ({ name: i.name, qty: i.qty, price: i.price })),
        total_value: total || null,
        notes:       document.getElementById('notes').value,
      }),
    });

    // Salvar cliente no cache
    await api('/api/customer/upsert', {
      method: 'POST',
      body: JSON.stringify({
        phone: document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line: addr,
        bairro:      document.getElementById('cBairro').value,
        complemento: document.getElementById('cComp').value,
        referencia:  document.getElementById('cRef').value,
      }),
    }).catch(() => {});

    toast(`âœ… Pedido #${result.id} criado!`);

    // Limpar form
    setTimeout(() => {
      document.getElementById('multi-addr-bar').style.display = 'none';
      document.getElementById('addr-selected-label').textContent = '';
      document.getElementById('addr-count-badge').textContent = '0';
      allAddresses = []; currentPhone = '';
      ['cName','cPhone','cAddr','cBairro','cComp','cRef','notes','search'].forEach(id => {
        document.getElementById(id).value = '';
      });
      items = [];
      renderItems();
      btn.disabled = false;
      btn.textContent = 'âœ… SALVAR PEDIDO';
    }, 800);

  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false;
    btn.textContent = 'âœ… SALVAR PEDIDO';
  }
}

renderItems();
</script>

<!-- â”€â”€ MODAL ENDEREÃ‡OS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="addr-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.5);z-index:9999;align-items:center;justify-content:center">
  <div style="background:#fff;border-radius:16px;width:min(94vw,560px);max-height:88vh;display:flex;flex-direction:column;box-shadow:0 20px 60px rgba(0,0,0,0.3)">
    
    <!-- Header -->
    <div style="display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:2px solid #e2e8f0">
      <div>
        <div style="font-size:16px;font-weight:800;color:#1e293b">ğŸ“ EndereÃ§os de Entrega</div>
        <div id="modal-client-name" style="font-size:12px;color:#6366f1;margin-top:2px"></div>
      </div>
      <button onclick="closeAddrModal()" style="background:#f1f5f9;border:none;border-radius:8px;width:32px;height:32px;font-size:18px;cursor:pointer">Ã—</button>
    </div>

    <!-- Busca -->
    <div style="padding:12px 20px;border-bottom:1px solid #f1f5f9">
      <input id="addr-search-input" type="text" placeholder="ğŸ” Buscar por nome da unidade ou rua..."
        oninput="filterAddresses(this.value)"
        style="width:100%;padding:9px 12px;border:2px solid #e2e8f0;border-radius:8px;font-size:14px;outline:none"
        onfocus="this.style.borderColor='#6366f1'" onblur="this.style.borderColor='#e2e8f0'">
    </div>

    <!-- Lista de endereÃ§os -->
    <div id="addr-modal-list" style="flex:1;overflow-y:auto;padding:12px 20px"></div>

    <!-- Footer: adicionar novo -->
    <div style="padding:12px 20px;border-top:2px solid #e2e8f0">
      <div id="add-addr-section">
        <button type="button" onclick="showAddInModal()" style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:9px 16px;font-size:13px;font-weight:700;cursor:pointer;width:100%">
          + Cadastrar novo endereÃ§o para este cliente
        </button>
      </div>
      <div id="add-addr-form-modal" style="display:none">
        <div style="font-size:13px;font-weight:700;color:#6366f1;margin-bottom:10px">Novo EndereÃ§o</div>
        <div style="margin-bottom:8px">
          <label style="font-size:11px;font-weight:700;color:#64748b">NOME / UNIDADE *</label>
          <input id="m-obs" type="text" placeholder="Ex: Escola Municipal X, ClÃ­nica SaÃºde Plena" 
            style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
        <div style="margin-bottom:8px">
          <label style="font-size:11px;font-weight:700;color:#64748b">RUA + NÃšMERO *</label>
          <input id="m-addr" type="text" placeholder="Rua das Flores, 100" 
            style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">BAIRRO</label>
            <input id="m-bairro" type="text" placeholder="Jardim Noroeste" 
              style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
          </div>
          <div>
            <label style="font-size:11px;font-weight:700;color:#64748b">COMPLEMENTO</label>
            <input id="m-comp" type="text" placeholder="Sala 2, Bloco A" 
              style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
          </div>
        </div>
        <div style="margin-bottom:10px">
          <label style="font-size:11px;font-weight:700;color:#64748b">PONTO DE REFERÃŠNCIA</label>
          <input id="m-ref" type="text" placeholder="PrÃ³ximo ao semÃ¡foro" 
            style="width:100%;padding:8px;border:2px solid #e2e8f0;border-radius:6px;font-size:13px;margin-top:3px">
        </div>
        <div style="display:flex;gap:8px">
          <button type="button" onclick="saveAddrInModal()" 
            style="background:#6366f1;color:#fff;border:none;border-radius:8px;padding:9px 20px;font-size:13px;font-weight:700;cursor:pointer;flex:1">
            ğŸ’¾ Salvar endereÃ§o
          </button>
          <button type="button" onclick="hideAddInModal()" 
            style="background:#f1f5f9;color:#64748b;border:none;border-radius:8px;padding:9px 16px;font-size:13px;cursor:pointer">
            Cancelar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
