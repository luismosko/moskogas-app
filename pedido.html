<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Novo Pedido ‚Äî MoskoG√°s v1.7</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 680px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 16px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  input, textarea, select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 16px; transition: border 0.2s; }
  input:focus, textarea:focus { outline: none; border-color: #f97316; }
  .row { display: grid; gap: 12px; margin-bottom: 12px; }
  .row-2 { grid-template-columns: 1fr 1fr; }
  .autocomplete-box { position: relative; }
  #suggestions { position: absolute; top: 100%; left: 0; right: 0; background: #fff; border: 2px solid #f97316; border-top: none; border-radius: 0 0 8px 8px; z-index: 100; max-height: 250px; overflow-y: auto; }
  .suggestion-item { padding: 10px 12px; cursor: pointer; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  .suggestion-item:hover { background: #fff7ed; }
  .suggestion-item strong { color: #1e293b; }
  .suggestion-item small { color: #64748b; }
  .items-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 12px; }
  .item-btn { padding: 12px 6px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; text-align: center; transition: all 0.15s; }
  .item-btn:hover { border-color: #f97316; background: #fff7ed; }
  .item-btn.selected { border-color: #f97316; background: #f97316; color: #fff; }
  .item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; background: #f8fafc; border-radius: 8px; padding: 8px 12px; }
  .item-row span { flex: 1; font-weight: 600; font-size: 14px; }
  .qty-btn { width: 32px; height: 32px; border: 2px solid #e2e8f0; border-radius: 6px; background: #fff; font-size: 18px; cursor: pointer; font-weight: 700; }
  .qty-val { width: 36px; text-align: center; font-weight: 700; font-size: 16px; }
  .btn-remove { background: none; border: none; color: #dc2626; cursor: pointer; font-size: 18px; }
  .btn-primary { background: #f97316; color: #fff; border: none; border-radius: 10px; padding: 16px 24px; font-size: 18px; font-weight: 800; width: 100%; cursor: pointer; transition: background 0.2s; }
  .btn-primary:hover { background: #ea6d0a; }
  .btn-primary:disabled { background: #94a3b8; cursor: not-allowed; }
  .status-bar { text-align: center; padding: 8px; font-size: 13px; color: #64748b; }
  .total-bar { background: #1e293b; color: #fff; border-radius: 8px; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
  .total-bar .val { font-size: 22px; font-weight: 900; color: #f97316; }
  .search-tab { padding: 8px; border: 2px solid #e2e8f0; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; font-weight: 700; color: #64748b; transition: all 0.15s; }
  .search-tab.active { border-color: #f97316; background: #f97316; color: #fff; }
  textarea { resize: vertical; height: 70px; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div class="container">
  <h1>‚ûï Novo Pedido <span style="font-size:12px;color:#94a3b8;font-weight:400">v1.7</span></h1>

  <!-- BUSCA CLIENTE -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <label style="margin:0">üîç Buscar Cliente</label>
      <button onclick="syncBling(this)" style="background:none;border:1px solid #e2e8f0;border-radius:6px;padding:3px 10px;font-size:11px;color:#94a3b8;cursor:pointer" title="Sincronizar contatos do Bling para busca por endere√ßo">üîÑ Sync Bling</button>
    </div>
    <div class="search-fields" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
      <input id="searchPhone" type="tel" placeholder="üìû Telefone" autocomplete="off" oninput="doSearch(this.value,'phone')">
      <input id="searchName" type="text" placeholder="üë§ Nome" autocomplete="off" oninput="doSearch(this.value,'name')">
      <input id="searchAddr" type="text" placeholder="üìç Endere√ßo" autocomplete="off" oninput="doSearch(this.value,'address')">
    </div>
    <div id="suggestions" style="display:none;position:relative;"></div>
  </div>

  <!-- DADOS DO CLIENTE -->
  <div class="card">
    <div class="row row-2">
      <div>
        <label>Nome do Cliente *</label>
        <input id="cName" type="text" placeholder="Nome completo">
      </div>
      <div>
        <label>Telefone</label>
        <input id="cPhone" type="tel" placeholder="67 9...">
      </div>
    </div>
    <div class="row" style="margin-bottom:12px">
      <label>Endere√ßo (Rua + N√∫mero) *</label>
      <input id="cAddr" type="text" placeholder="Ex: Rua das Orqu√≠deas, 123">
    </div>
    <div class="row row-2">
      <div>
        <label>Bairro</label>
        <input id="cBairro" type="text" placeholder="Ex: Jardim Noroeste">
      </div>
      <div>
        <label>Complemento</label>
        <input id="cComp" type="text" placeholder="Apto, Bloco...">
      </div>
    </div>
    <div>
      <label>Ponto de Refer√™ncia</label>
      <input id="cRef" type="text" placeholder="Ex: pr√≥ximo ao mercado X">
    </div>
  </div>

  <!-- ITENS -->
  <div class="card">
    <label style="margin-bottom:10px">üì¶ Itens do Pedido</label>
    <div style="position:relative;margin-bottom:10px">
      <input id="product-search" type="text" placeholder="üîç Buscar produto pelo nome..." autocomplete="off" oninput="searchProducts(this.value)">
      <div id="product-suggestions" style="display:none;position:absolute;left:0;right:0;z-index:50;border:2px solid #f97316;border-top:none;border-radius:0 0 8px 8px;background:#fff;max-height:220px;overflow-y:auto"></div>
    </div>
    <div id="items-list"></div>
    <div class="total-bar" id="total-bar" style="display:none">
      <span>TOTAL</span>
      <span class="val" id="total-val">R$ 0,00</span>
    </div>
  </div>

  <!-- OBSERVA√á√ÉO -->
  <div class="card">
    <label>üìù Observa√ß√£o (opcional)</label>
    <textarea id="notes" placeholder="Urgente, hor√°rio preferido, troco para..."></textarea>
  </div>

  <div class="status-bar" id="status-bar"></div>
  <button class="btn-primary" id="btn-save" onclick="saveOrder()">‚úÖ SALVAR PEDIDO</button>
</div>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let items = [];
let searchTimer;

async function syncBling(btn) {
  btn.disabled = true;
  btn.textContent = '‚è≥ Sincronizando...';
  try {
    const r = await api('/api/customer/sync-bling', { method: 'POST' });
    btn.textContent = `‚úÖ ${r.synced} contatos sincronizados`;
    setTimeout(() => { btn.textContent = 'üîÑ Sincronizar contatos Bling'; btn.disabled = false; }, 4000);
  } catch(e) {
    btn.textContent = '‚ùå Erro ‚Äî tente novamente';
    btn.disabled = false;
  }
}

function doSearch(val, type) {
  // limpa os outros campos
  const map = {phone:'searchPhone', name:'searchName', address:'searchAddr'};
  Object.entries(map).forEach(([t, id]) => { if (t !== type) document.getElementById(id).value = ''; });
  clearTimeout(searchTimer);
  const q = val.trim();
  if (q.length < 2) { hideSuggestions(); return; }
  searchTimer = setTimeout(async () => {
    try {
      const results = await api(`/api/customer/search?q=${encodeURIComponent(q)}&type=${type}`);
      showSuggestions(results);
    } catch(e) { console.error(e); }
  }, 280);
}

document.addEventListener('click', e => {
  if (!e.target.closest('.search-fields') && !e.target.closest('#suggestions')) hideSuggestions();
});

function showSuggestions(list) {
  const box = document.getElementById('suggestions');
  if (!list.length) { hideSuggestions(); return; }
  box.style.display = 'block';
  box.innerHTML = list.map((c, i) => `
    <div class="suggestion-item" onclick="selectCustomer(${i})">
      <strong>${c.name || c.customer_name}</strong>
      <span style="margin-left:8px;color:#f97316">${c.phone_digits || ''}</span><br>
      <small>${c.address_line || ''} ${c.bairro ? '‚Äî ' + c.bairro : ''}</small>
    </div>
  `).join('');
  box._data = list;
}

function hideSuggestions() {
  const box = document.getElementById('suggestions');
  box.style.display = 'none';
}

async function selectCustomer(i) {
  const c = document.getElementById('suggestions')._data[i];
  // Preenche o que j√° temos
  document.getElementById('cName').value   = c.name || c.customer_name || '';
  document.getElementById('cPhone').value  = c.phone_digits || '';
  document.getElementById('cAddr').value   = c.address_line || '';
  document.getElementById('cBairro').value = c.bairro || '';
  document.getElementById('cComp').value   = c.complemento || '';
  document.getElementById('cRef').value    = c.referencia || '';
  hideSuggestions();
  // Limpa campos de busca
  ['searchPhone','searchName','searchAddr'].forEach(id => {
    const el = document.getElementById(id); if (el) el.value = '';
  });
  // Busca detalhes completos do Bling sempre que tiver bling_contact_id
  if (c.bling_contact_id) {
    try {
      const det = await api(`/api/customer/bling-detail/${c.bling_contact_id}`);
      if (det && !det.error) {
        if (det.phone_digits) document.getElementById('cPhone').value  = det.phone_digits;
        if (det.address_line) document.getElementById('cAddr').value   = det.address_line;
        if (det.bairro)       document.getElementById('cBairro').value = det.bairro;
        if (det.complemento)  document.getElementById('cComp').value   = det.complemento;
      }
    } catch(e) { console.error('Detalhe Bling:', e); }
  }
}

// ‚îÄ‚îÄ Produtos ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let productTimer;
async function searchProducts(q) {
  clearTimeout(productTimer);
  const box = document.getElementById('product-suggestions');
  if (q.length < 2) { box.style.display='none'; return; }
  productTimer = setTimeout(async () => {
    try {
      const list = await api(`/api/products/search?q=${encodeURIComponent(q)}`);
      if (!list.length) { box.style.display='none'; return; }
      box.style.display = 'block';
      box.innerHTML = list.map((p,i) => {
        const nome = p.name.length > 50 ? p.name.substring(0,50)+'‚Ä¶' : p.name;
        return `
        <div class="suggestion-item" onclick="addProductFromSearch(${i})" style="display:flex;justify-content:space-between;align-items:center">
          <span><strong>${nome}</strong>${p.code ? ' <small style=color:#94a3b8;margin-left:4px>('+p.code+')</small>' : ''}</span>
          <span style="color:#f97316;font-weight:700;margin-left:8px;white-space:nowrap">R$ ${parseFloat(p.price||0).toFixed(2)}</span>
        </div>`;}).join('');
      box._data = list;
    } catch(e) { console.error(e); }
  }, 300);
}

function addProductFromSearch(i) {
  const p = document.getElementById('product-suggestions')._data[i];
  document.getElementById('product-search').value = '';
  document.getElementById('product-suggestions').style.display = 'none';
  addItem(String(p.id), p.name, parseFloat(p.price)||0);
}

document.addEventListener('click', e => {
  if (!e.target.closest('#product-search') && !e.target.closest('#product-suggestions'))
    document.getElementById('product-suggestions').style.display='none';
});

// ‚îÄ‚îÄ Itens ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addItem(id, name, price) {
  const existing = items.find(i => i.id === id);
  if (existing) { existing.qty++; }
  else { items.push({ id, name, qty: 1, price }); }
  renderItems();
}

function changeQty(id, delta) {
  const item = items.find(i => i.id === id);
  if (!item) return;
  item.qty += delta;
  if (item.qty <= 0) items = items.filter(i => i.id !== id);
  renderItems();
}

function changePrice(id, val) {
  const item = items.find(i => i.id === id);
  if (item) { item.price = parseFloat(val)||0; renderTotal(); }
}

function renderTotal() {
  let total = 0;
  items.forEach(it => total += it.price * it.qty);
  document.getElementById('total-bar').style.display = items.length ? 'flex' : 'none';
  document.getElementById('total-val').textContent = `R$ ${total.toFixed(2)}`;
}

function renderItems() {
  const list = document.getElementById('items-list');
  if (!items.length) {
    list.innerHTML = '<div style="color:#94a3b8;text-align:center;padding:12px">Nenhum item adicionado</div>';
    document.getElementById('total-bar').style.display = 'none';
    return;
  }
  list.innerHTML = items.map(it => `
    <div class="item-row">
      <span style="flex:1;font-size:14px">${it.name}</span>
      <button class="qty-btn" onclick="changeQty('${it.id}',-1)">‚àí</button>
      <span class="qty-val">${it.qty}</span>
      <button class="qty-btn" onclick="changeQty('${it.id}',1)">+</button>
      <span style="display:flex;align-items:center;gap:4px">
        <small style="color:#94a3b8">R$</small>
        <input type="number" step="0.01" value="${it.price.toFixed(2)}" 
          style="width:65px;padding:4px;border:1px solid #e2e8f0;border-radius:6px;font-weight:700;text-align:right;font-size:13px"
          onchange="changePrice('${it.id}',this.value)">
      </span>
      <span style="min-width:75px;text-align:right;font-weight:800;color:#1e293b;font-size:14px">=&nbsp;R$&nbsp;${(it.price*it.qty).toFixed(2)}</span>
      <button class="btn-remove" onclick="changeQty('${it.id}',-99)">‚úï</button>
    </div>`).join('');
  renderTotal();
}

// ‚îÄ‚îÄ Salvar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveOrder() {
  const name  = document.getElementById('cName').value.trim();
  const addr  = document.getElementById('cAddr').value.trim();
  if (!name) { toast('Nome do cliente obrigat√≥rio', 'error'); return; }
  if (!addr) { toast('Endere√ßo obrigat√≥rio', 'error'); return; }

  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = '‚è≥ Salvando...';

  try {
    const total = items.reduce((s, i) => s + i.price * i.qty, 0);
    const result = await api('/api/order/create', {
      method: 'POST',
      body: JSON.stringify({
        phone:       document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line: addr,
        bairro:      document.getElementById('cBairro').value,
        complemento: document.getElementById('cComp').value,
        referencia:  document.getElementById('cRef').value,
        items:       items.map(i => ({ name: i.name, qty: i.qty, price: i.price })),
        total_value: total || null,
        notes:       document.getElementById('notes').value,
      }),
    });

    // Salvar cliente no cache
    await api('/api/customer/upsert', {
      method: 'POST',
      body: JSON.stringify({
        phone: document.getElementById('cPhone').value.replace(/\D/g, ''),
        name,
        address_line: addr,
        bairro:      document.getElementById('cBairro').value,
        complemento: document.getElementById('cComp').value,
        referencia:  document.getElementById('cRef').value,
      }),
    }).catch(() => {});

    toast(`‚úÖ Pedido #${result.id} criado!`);

    // Limpar form
    setTimeout(() => {
      ['cName','cPhone','cAddr','cBairro','cComp','cRef','notes','search'].forEach(id => {
        document.getElementById(id).value = '';
      });
      items = [];
      renderItems();
      btn.disabled = false;
      btn.textContent = '‚úÖ SALVAR PEDIDO';
    }, 800);

  } catch(e) {
    toast(e.message, 'error');
    btn.disabled = false;
    btn.textContent = '‚úÖ SALVAR PEDIDO';
  }
}

renderItems();
</script>
</body>
</html>
