<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos ‚Äî MoskoG√°s v1.4.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar input, .toolbar select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn:hover { opacity: 0.85; }

  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; padding: 16px; }
  .s-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .s-card .label { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
  .s-card .value { font-size: 24px; font-weight: 900; }
  .s-card .value.red { color: #dc2626; }
  .s-card .value.orange { color: #f97316; }
  .s-card .value.gray { color: #64748b; }
  .s-card .value.green { color: #16a34a; }
  .s-card .value.blue { color: #2563eb; }

  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #475569; color: #fff; padding: 8px 10px; text-align: left; font-size: 12px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: #fffbeb; }

  .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #fff; }
  .btn-pago { background: #16a34a; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-pago:hover { background: #15803d; }
  .btn-pago:disabled { background: #94a3b8; cursor: not-allowed; }
  .btn-lembrete { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-lembrete:hover { background: #1d4ed8; }
  .btn-lembrete:disabled { background: #94a3b8; cursor: not-allowed; }
  .btn-lembrete .rb { background: #fbbf24; color: #92400e; border-radius: 8px; padding: 1px 5px; font-size: 10px; margin-left: 3px; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 15px; }

  .bulk-bar { display: none; background: #fef3c7; padding: 10px 16px; align-items: center; gap: 12px; border-bottom: 2px solid #fbbf24; flex-wrap: wrap; }
  .bulk-bar.show { display: flex; }
  .bulk-bar .count { font-weight: 800; color: #92400e; font-size: 14px; }

  .actions-cell { display: flex; gap: 4px; align-items: center; }
  .ri { font-size: 10px; color: #94a3b8; margin-top: 2px; }
  .ri.w { color: #f97316; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v1.4.0 ‚Äî pagamentos</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div style="display:flex;align-items:center;gap:4px">
    <input type="date" id="fDateFrom" onchange="loadPagamentos()" style="width:135px">
    <span style="color:#94a3b8;font-size:12px">at√©</span>
    <input type="date" id="fDateTo" onchange="loadPagamentos()" style="width:135px">
    <button class="btn" onclick="setDateFilter('hoje')" id="btnHoje" title="Filtrar pagamentos de hoje" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Hoje</button>
    <button class="btn" onclick="setDateFilter('ontem')" id="btnOntem" title="Filtrar pagamentos de ontem" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Ontem</button>
    <button class="btn" onclick="setDateFilter('semana')" id="btnSemana" title="√öltimos 7 dias" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">7 dias</button>
    <button class="btn" onclick="setDateFilter('limpar')" title="Limpar filtro de data" style="background:#e2e8f0;color:#64748b;padding:6px 8px;font-size:12px">‚úï</button>
  </div>
  <select id="fTipo" onchange="loadPagamentos()" title="Filtrar por tipo de pagamento">
    <option value="">Todos os tipos</option>
    <option value="pix_receber">‚è≥ PIX a receber</option>
    <option value="mensalista">üìÖ Mensalista</option>
    <option value="boleto">üßæ Boleto</option>
    <option value="nfe">üìÑ NFe</option>
  </select>
  <input type="text" id="fQ" placeholder="üîç Busca cliente..." oninput="loadPagamentos()" style="width:160px">
  <button class="btn btn-orange" onclick="loadPagamentos()" title="Recarregar lista">üîÑ Atualizar</button>
  <span id="count-badge" style="font-size:12px;color:#64748b;margin-left:4px"></span>
  <span title="Vers√£o" style="background:#6366f1;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:.5px">v1.4.0</span>
</div>

<!-- BULK BAR -->
<div class="bulk-bar" id="bulk-bar">
  <input type="checkbox" id="bulk-all" onchange="toggleBulkAll(this.checked)" title="Selecionar/desmarcar todos">
  <span class="count"><span id="bulk-count">0</span> selecionados</span>
  <button class="btn" style="background:#16a34a;color:#fff;font-size:12px;padding:6px 14px" onclick="bulkMarcarPago()" title="Marcar pagos em lote">‚úÖ Marcar Pagos</button>
  <button class="btn" style="background:#2563eb;color:#fff;font-size:12px;padding:6px 14px;display:none" onclick="bulkEnviarLembrete()" id="btn-bulk-lembrete" title="Enviar lembrete WhatsApp (s√≥ PIX)">üì± Enviar Lembretes</button>
</div>

<!-- SUMMARY CARDS -->
<div class="summary-cards">
  <div class="s-card">
    <div class="label">üí∞ Total Pendente</div>
    <div class="value red" id="total-pendente">R$ 0,00</div>
  </div>
  <div class="s-card">
    <div class="label">üìä Qtd Pendentes</div>
    <div class="value orange" id="count-total">0</div>
  </div>
  <div class="s-card">
    <div class="label">‚è≥ PIX Pendente</div>
    <div class="value blue" id="count-pix">0</div>
  </div>
  <div class="s-card">
    <div class="label">‚úÖ No Bling</div>
    <div class="value green" id="count-bling">0</div>
  </div>
  <div class="s-card">
    <div class="label">üì± Lembretes Enviados</div>
    <div class="value gray" id="count-lembretes">0</div>
  </div>
</div>

<!-- TABELA -->
<table>
  <thead>
    <tr>
      <th style="width:30px"><input type="checkbox" id="th-check" onchange="toggleBulkAll(this.checked)" title="Selecionar todos"></th>
      <th>#</th>
      <th>Data</th>
      <th>Cliente</th>
      <th>Endere√ßo</th>
      <th>Itens</th>
      <th>Valor</th>
      <th>Tipo</th>
      <th>Bling</th>
      <th>A√ß√£o</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<div id="empty-msg" class="empty" style="display:none">‚úÖ Nenhum pagamento pendente!</div>

<script src="shared.js"></script>
<script>
// v1.4.0
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let allData = [];
let selectedIds = new Set();

function todayCG() { return new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' }); }
function daysCG(n) {
  const d = new Date(); d.setDate(d.getDate() + n);
  return d.toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
}

function setDateFilter(mode) {
  const from = document.getElementById('fDateFrom');
  const to   = document.getElementById('fDateTo');
  const btns = { hoje: document.getElementById('btnHoje'), ontem: document.getElementById('btnOntem'), semana: document.getElementById('btnSemana') };
  Object.values(btns).forEach(b => b.style.background = '#64748b');
  if (mode === 'hoje') {
    const t = todayCG(); from.value = t; to.value = t;
    btns.hoje.style.background = '#f97316';
  } else if (mode === 'ontem') {
    const y = daysCG(-1); from.value = y; to.value = y;
    btns.ontem.style.background = '#f97316';
  } else if (mode === 'semana') {
    from.value = daysCG(-7); to.value = todayCG();
    btns.semana.style.background = '#f97316';
  } else { from.value = ''; to.value = ''; }
  loadPagamentos();
}

let loadTimer;
async function loadPagamentos() {
  clearTimeout(loadTimer);
  loadTimer = setTimeout(_loadPagamentos, 150);
}

async function _loadPagamentos() {
  try {
    const data = await api('/api/pagamentos');
    allData = Array.isArray(data) ? data : [];

    const dateFrom = document.getElementById('fDateFrom').value;
    const dateTo   = document.getElementById('fDateTo').value;
    const tipo     = document.getElementById('fTipo').value;
    const q        = document.getElementById('fQ').value.toLowerCase().trim();

    let rows = allData;
    if (dateFrom || dateTo) {
      rows = rows.filter(r => {
        if (!r.created_at) return true;
        const d = new Date(r.created_at * 1000).toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
        if (dateFrom && d < dateFrom) return false;
        if (dateTo   && d > dateTo)   return false;
        return true;
      });
    }
    if (tipo) rows = rows.filter(r => r.tipo_pagamento === tipo);
    if (q) rows = rows.filter(r =>
      (r.customer_name || '').toLowerCase().includes(q) ||
      (r.address_line || '').toLowerCase().includes(q) ||
      String(r.id).includes(q)
    );

    renderTable(rows);
    renderSummary(rows);
    document.getElementById('count-badge').textContent = `${rows.length} pendentes`;
    selectedIds.clear();
    updateBulkBar();
  } catch(e) { toast('Erro ao carregar: ' + e.message, 'error'); }
}

function timeAgo(epoch) {
  if (!epoch) return '';
  const diff = Math.floor(Date.now() / 1000) - epoch;
  if (diff < 3600) return Math.floor(diff / 60) + 'min';
  if (diff < 86400) return Math.floor(diff / 3600) + 'h';
  return Math.floor(diff / 86400) + 'd';
}

function renderTable(rows) {
  const tbody = document.getElementById('tbody');
  const emptyMsg = document.getElementById('empty-msg');
  if (!rows.length) { tbody.innerHTML = ''; emptyMsg.style.display = 'block'; return; }
  emptyMsg.style.display = 'none';

  const tipoLabels = {
    pix_receber: '‚è≥ PIX', mensalista: 'üìÖ Mensal', boleto: 'üßæ Boleto', nfe: 'üìÑ NFe',
    dinheiro: 'üíµ Dinh', pix_vista: '‚ö° PIX', debito: 'üí≥ D√©b', credito: 'üí≥ Cr√©d'
  };

  tbody.innerHTML = rows.map(p => {
    const items = (() => { try { return JSON.parse(p.items_json || '[]'); } catch(e) { return []; } })();
    const itemsStr = items.map(i => `${i.qty}x ${i.name}`).join(', ') || '‚Äî';
    const dt = p.created_at ? new Date(p.created_at * 1000).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', timeZone:'America/Campo_Grande' }) : '‚Äî';
    const hr = p.created_at ? new Date(p.created_at * 1000).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit', timeZone:'America/Campo_Grande' }) : '';

    const blingBadge = p.bling_pedido_id
      ? `<span class="badge" style="background:#16a34a">‚úÖ #${p.bling_pedido_num || p.bling_pedido_id}</span>`
      : `<span class="badge" style="background:#94a3b8">‚è≥</span>`;

    const ck = selectedIds.has(p.id) ? 'checked' : '';

    // Bot√£o lembrete ‚Äî s√≥ PIX a receber
    let lb = '';
    let ri = '';
    if (p.tipo_pagamento === 'pix_receber') {
      const cnt = p.reminder_count || 0;
      const badge = cnt > 0 ? `<span class="rb">${cnt}</span>` : '';
      const hasPhone = p.phone_digits && p.phone_digits.replace(/\D/g, '').length >= 10;
      lb = hasPhone
        ? `<button class="btn-lembrete" onclick="enviarLembrete(${p.id})" title="Enviar lembrete PIX via WhatsApp${cnt ? ' ('+cnt+' enviado'+(cnt>1?'s':'')+')':''}">üì±${badge}</button>`
        : `<button class="btn-lembrete" disabled title="Sem telefone">üì±</button>`;
      if (cnt > 0 && p.last_reminder_at) {
        ri = `<div class="ri${cnt >= 3 ? ' w' : ''}">üì±${cnt}x ¬∑ ${timeAgo(p.last_reminder_at)} atr√°s</div>`;
      }
    }

    return `<tr>
      <td><input type="checkbox" value="${p.id}" ${ck} onchange="toggleSelect(${p.id}, this.checked)"></td>
      <td><strong>#${p.id}</strong>${ri}</td>
      <td style="white-space:nowrap;font-size:12px">${dt}<br><span style="color:#94a3b8">${hr}</span></td>
      <td style="font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.customer_name||''}">${p.customer_name||'‚Äî'}</td>
      <td style="color:#64748b;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.address_line||''}">${p.address_line||'‚Äî'}<br><span style="font-size:11px">${p.bairro||''}</span></td>
      <td style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${itemsStr}">${itemsStr}</td>
      <td style="font-weight:800;color:#1e293b;white-space:nowrap">R$ ${parseFloat(p.total_value||0).toFixed(2)}</td>
      <td style="white-space:nowrap">${tipoLabels[p.tipo_pagamento]||p.tipo_pagamento||'‚Äî'}</td>
      <td>${blingBadge}</td>
      <td><div class="actions-cell">${lb}<button class="btn-pago" onclick="marcarPago(${p.id})" title="Confirmar recebimento">‚úÖ Pago</button></div></td>
    </tr>`;
  }).join('');
}

function renderSummary(rows) {
  let total = 0, countBling = 0, countPix = 0, totalLemb = 0;
  rows.forEach(p => {
    total += parseFloat(p.total_value) || 0;
    if (p.bling_pedido_id) countBling++;
    if (p.tipo_pagamento === 'pix_receber') countPix++;
    totalLemb += (p.reminder_count || 0);
  });
  document.getElementById('total-pendente').textContent = 'R$ ' + total.toFixed(2);
  document.getElementById('count-total').textContent = rows.length;
  document.getElementById('count-pix').textContent = countPix;
  document.getElementById('count-bling').textContent = countBling;
  document.getElementById('count-lembretes').textContent = totalLemb;
}

// ‚îÄ‚îÄ Lembrete Individual ‚îÄ‚îÄ
async function enviarLembrete(orderId) {
  if (!confirm(`Enviar lembrete PIX via WhatsApp para pedido #${orderId}?`)) return;
  showLoading('Enviando lembrete...');
  try {
    const d = await api(`/api/lembretes/enviar/${orderId}`, { method: 'POST' });
    hideLoading();
    if (d.ok) {
      toast(`üì± Lembrete #${d.envio_num} enviado para pedido #${orderId}!`);
      loadPagamentos();
    } else {
      toast('‚ùå ' + (d.error || 'Falha ao enviar'), 'error');
    }
  } catch(e) { hideLoading(); toast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Lembrete Bulk ‚îÄ‚îÄ
async function bulkEnviarLembrete() {
  const ids = [...selectedIds];
  const pixIds = ids.filter(id => {
    const p = allData.find(r => r.id === id);
    return p && p.tipo_pagamento === 'pix_receber' && p.phone_digits;
  });
  if (!pixIds.length) { toast('‚ö†Ô∏è Nenhum PIX com telefone selecionado', 'error'); return; }
  if (!confirm(`Enviar lembrete PIX para ${pixIds.length} pedido(s)?`)) return;
  showLoading(`Enviando ${pixIds.length} lembrete(s)...`);
  try {
    const d = await api('/api/lembretes/enviar-bulk', {
      method: 'POST',
      body: JSON.stringify({ order_ids: pixIds })
    });
    hideLoading();
    toast(d.message || 'Lembretes processados', d.ok ? 'success' : 'error');
    loadPagamentos();
  } catch(e) { hideLoading(); toast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Pagamento ‚îÄ‚îÄ
async function marcarPago(orderId) {
  if (!confirm(`Confirmar pagamento do pedido #${orderId}?`)) return;
  showLoading('Processando...');
  try {
    const d = await api(`/api/pagamentos/${orderId}`, { method: 'PATCH' });
    hideLoading();
    if (d.ok) { toast(`‚úÖ Pedido #${orderId} pago!`); loadPagamentos(); }
    else { toast('‚ùå ' + (d.error || 'Falha'), 'error'); }
  } catch(e) { hideLoading(); toast(e.message, 'error'); }
}

// ‚îÄ‚îÄ Sele√ß√£o ‚îÄ‚îÄ
function toggleSelect(id, checked) {
  if (checked) selectedIds.add(id); else selectedIds.delete(id);
  updateBulkBar();
}
function toggleBulkAll(checked) {
  document.querySelectorAll('#tbody input[type=checkbox]').forEach(b => {
    b.checked = checked;
    const id = parseInt(b.value);
    if (checked) selectedIds.add(id); else selectedIds.delete(id);
  });
  document.getElementById('th-check').checked = checked;
  document.getElementById('bulk-all').checked = checked;
  updateBulkBar();
}
function updateBulkBar() {
  const count = selectedIds.size;
  document.getElementById('bulk-count').textContent = count;
  document.getElementById('bulk-bar').classList.toggle('show', count > 0);
  const pixCount = [...selectedIds].filter(id => {
    const p = allData.find(r => r.id === id);
    return p && p.tipo_pagamento === 'pix_receber';
  }).length;
  const bl = document.getElementById('btn-bulk-lembrete');
  if (bl) bl.style.display = pixCount > 0 ? '' : 'none';
}

async function bulkMarcarPago() {
  const ids = [...selectedIds];
  if (!ids.length) return;
  if (!confirm(`Marcar ${ids.length} pedido(s) como pago(s)?`)) return;
  showLoading(`Processando ${ids.length} pagamento(s)...`);
  let ok = 0, fail = 0;
  for (const id of ids) {
    try { const d = await api(`/api/pagamentos/${id}`, { method: 'PATCH' }); if (d.ok) ok++; else fail++; }
    catch(e) { fail++; }
  }
  hideLoading();
  toast(`‚úÖ ${ok} pago(s)${fail ? `, ${fail} erro(s)` : ''}`, fail ? 'error' : 'success');
  loadPagamentos();
}

setDateFilter('semana');
setInterval(loadPagamentos, 30000);
</script>
</body>
</html>
