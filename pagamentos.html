<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos ‚Äî MoskoG√°s v1.0.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 16px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  table { width: 100%; border-collapse: collapse; }
  th { background: #f8fafc; color: #64748b; text-align: left; padding: 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
  td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  tr:hover { background: #fef3c7; }
  .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; }
  .badge-green { background: #dcfce7; color: #15803d; }
  .badge-yellow { background: #fef3c7; color: #a16207; }
  .badge-gray { background: #f1f5f9; color: #64748b; }
  .btn-pago { background: #16a34a; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; }
  .btn-pago:hover { background: #15803d; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v1.0.0 ‚Äî pagamentos</div>
<div class="container">
  <h1>üí∞ Gest√£o de Pagamentos <span style="font-size:12px;color:#94a3b8;font-weight:400">v1.0.0</span></h1>

  <div class="card">
    <div id="summary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #f1f5f9">
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">TOTAL PENDENTE</div>
        <div id="total-pendente" style="font-size:22px;font-weight:900;color:#dc2626">R$ 0,00</div>
      </div>
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">NO BLING</div>
        <div id="count-bling" style="font-size:22px;font-weight:900;color:#f97316">0</div>
      </div>
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">PENDENTE EMISS√ÉO</div>
        <div id="count-pendente" style="font-size:22px;font-weight:900;color:#64748b">0</div>
      </div>
    </div>

    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Cliente</th>
            <th>Endere√ßo</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Status Bling</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="empty-msg" class="empty" style="display:none">
      ‚úÖ Nenhum pagamento pendente!
    </div>
  </div>
</div>

<script>
const API_BASE = 'https://api.moskogas.com.br';

async function loadPagamentos() {
  try {
    const resp = await fetch(\`\${API_BASE}/api/pagamentos\`);
    const data = await resp.json();
    
    if (!data || data.length === 0) {
      document.getElementById('tbody').innerHTML = '';
      document.getElementById('empty-msg').style.display = 'block';
      document.getElementById('total-pendente').textContent = 'R$ 0,00';
      document.getElementById('count-bling').textContent = '0';
      document.getElementById('count-pendente').textContent = '0';
      return;
    }

    document.getElementById('empty-msg').style.display = 'none';
    
    let totalPendente = 0;
    let countBling = 0;
    let countPendente = 0;

    const html = data.map(p => {
      totalPendente += p.total_value || 0;
      if (p.bling_pedido_id) countBling++; else countPendente++;

      const tipoLabels = {
        dinheiro: 'üíµ Dinheiro',
        pix_vista: '‚ö° PIX √† vista',
        pix_receber: '‚è≥ PIX a receber',
        mensalista: 'üìÖ Mensalista',
        boleto: 'üßæ Boleto/√ìrg√£o'
      };

      const statusBadge = p.bling_pedido_id 
        ? \`<span class="badge badge-green">‚úÖ Venda #\${p.bling_pedido_num || p.bling_pedido_id}</span>\`
        : \`<span class="badge badge-gray">‚è≥ Aguardando emiss√£o</span>\`;

      return \`<tr>
        <td><strong>#\${p.id}</strong></td>
        <td>\${p.customer_name || '-'}</td>
        <td style="font-size:12px;color:#64748b">\${p.address_line || '-'}</td>
        <td><strong>R$ \${(p.total_value || 0).toFixed(2)}</strong></td>
        <td>\${tipoLabels[p.tipo_pagamento] || p.tipo_pagamento}</td>
        <td>\${statusBadge}</td>
        <td><button class="btn-pago" onclick="marcarPago(\${p.id})" title="Marcar pagamento como recebido">‚úÖ Marcar Pago</button></td>
      </tr>\`;
    }).join('');

    document.getElementById('tbody').innerHTML = html;
    document.getElementById('total-pendente').textContent = 'R$ ' + totalPendente.toFixed(2);
    document.getElementById('count-bling').textContent = countBling;
    document.getElementById('count-pendente').textContent = countPendente;

  } catch(e) {
    alert('Erro ao carregar pagamentos: ' + e.message);
  }
}

async function marcarPago(orderId) {
  if (!confirm('Confirmar que este pedido foi pago?')) return;
  
  try {
    const resp = await fetch(\`\${API_BASE}/api/pagamentos/\${orderId}\`, { method: 'PATCH' });
    const data = await resp.json();
    
    if (data.ok) {
      alert('‚úÖ Pedido marcado como pago!');
      loadPagamentos();
    } else {
      alert('‚ùå Erro: ' + (data.error || 'Falha ao marcar como pago'));
    }
  } catch(e) {
    alert('Erro: ' + e.message);
  }
}

// Carregar ao abrir a p√°gina
loadPagamentos();

// Atualizar a cada 30 segundos
setInterval(loadPagamentos, 30000);

// ‚îÄ‚îÄ Nav compartilhada ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
fetch('https://moskogas.github.io/app/nav.html')
  .then(r => r.text())
  .then(html => { document.getElementById('nav-placeholder').innerHTML = html; })
  .catch(() => {});
</script>
</body>
</html>
