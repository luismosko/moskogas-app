<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos ‚Äî MoskoG√°s v1.1.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
  h1 { color: #1e293b; font-size: 22px; margin-bottom: 16px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }

  /* Toolbar de filtros */
  .filters { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 2px solid #f1f5f9; }
  .filters input, .filters select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 13px; background: #f8fafc; }
  .filters input:focus, .filters select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn-gray { background: #94a3b8; color: #fff; }
  .btn:hover { opacity: 0.85; }

  table { width: 100%; border-collapse: collapse; }
  th { background: #f8fafc; color: #64748b; text-align: left; padding: 10px; font-size: 12px; font-weight: 700; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; }
  td { padding: 12px 10px; border-bottom: 1px solid #f1f5f9; font-size: 14px; }
  tr:hover { background: #fef3c7; }
  .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; display: inline-block; }
  .badge-green { background: #dcfce7; color: #15803d; }
  .badge-yellow { background: #fef3c7; color: #a16207; }
  .badge-gray { background: #f1f5f9; color: #64748b; }
  .btn-pago { background: #16a34a; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; }
  .btn-pago:hover { background: #15803d; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; }
  .tipo-badge { padding: 3px 8px; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap; }
  .count-badge { font-size: 12px; color: #64748b; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v1.1.0 ‚Äî pagamentos</div>
<div class="container">
  <h1>üí∞ Gest√£o de Pagamentos <span style="font-size:12px;color:#94a3b8;font-weight:400">v1.1.0</span></h1>

  <!-- Resumo -->
  <div class="card">
    <div id="summary" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px;padding-bottom:16px;border-bottom:2px solid #f1f5f9">
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">TOTAL PENDENTE</div>
        <div id="total-pendente" style="font-size:22px;font-weight:900;color:#dc2626">R$ 0,00</div>
      </div>
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">NO BLING</div>
        <div id="count-bling" style="font-size:22px;font-weight:900;color:#f97316">0</div>
      </div>
      <div>
        <div style="font-size:12px;color:#64748b;margin-bottom:4px">PENDENTE EMISS√ÉO</div>
        <div id="count-pendente" style="font-size:22px;font-weight:900;color:#64748b">0</div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters">
      <input type="text" id="fCliente" placeholder="üîç Buscar cliente..." oninput="applyFilters()" style="width:200px">
      <div style="display:flex;align-items:center;gap:4px">
        <input type="date" id="fDateFrom" onchange="applyFilters()" style="width:135px">
        <span style="color:#94a3b8;font-size:12px">at√©</span>
        <input type="date" id="fDateTo" onchange="applyFilters()" style="width:135px">
      </div>
      <select id="fTipo" onchange="applyFilters()">
        <option value="">Todos os tipos</option>
        <option value="pix_receber">‚è≥ PIX a receber</option>
        <option value="mensalista">üìÖ Mensalista</option>
        <option value="boleto">üßæ Boleto/√ìrg√£o</option>
      </select>
      <button class="btn btn-orange" onclick="loadPagamentos()">üîÑ Atualizar</button>
      <button class="btn btn-gray" onclick="clearFilters()">‚úï Limpar</button>
      <span id="filter-count" class="count-badge"></span>
    </div>

    <div style="overflow-x:auto">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Cliente</th>
            <th>Endere√ßo</th>
            <th>Valor</th>
            <th>Tipo</th>
            <th>Status Bling</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div id="empty-msg" class="empty" style="display:none">
      ‚úÖ Nenhum pagamento pendente!
    </div>
  </div>
</div>

<script src="shared.js"></script>
<script>
// ‚îÄ‚îÄ Nav ‚îÄ‚îÄ
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
let allData = [];

// ‚îÄ‚îÄ Tipos ‚îÄ‚îÄ
const tipoLabels = {
  dinheiro:     'üíµ Dinheiro',
  pix_vista:    '‚ö° PIX √† vista',
  pix_receber:  '‚è≥ PIX a receber',
  mensalista:   'üìÖ Mensalista',
  boleto:       'üßæ Boleto/√ìrg√£o'
};

const tipoColors = {
  pix_receber: 'background:#fef3c7;color:#92400e',
  mensalista:  'background:#dbeafe;color:#1e40af',
  boleto:      'background:#f1f5f9;color:#475569',
  dinheiro:    'background:#dcfce7;color:#15803d',
  pix_vista:   'background:#ecfdf5;color:#065f46'
};

// ‚îÄ‚îÄ Load da API ‚îÄ‚îÄ
async function loadPagamentos() {
  try {
    const data = await api('/api/pagamentos');
    allData = data || [];
    applyFilters();
  } catch(e) {
    toast('‚ùå Erro ao carregar: ' + e.message, 'error');
  }
}

// ‚îÄ‚îÄ Filtragem local ‚îÄ‚îÄ
function applyFilters() {
  const qCliente = document.getElementById('fCliente').value.trim().toLowerCase();
  const dateFrom = document.getElementById('fDateFrom').value;
  const dateTo   = document.getElementById('fDateTo').value;
  const tipo     = document.getElementById('fTipo').value;

  let filtered = allData.filter(p => {
    // Filtro por cliente (nome, telefone ou endere√ßo)
    if (qCliente && !(p.customer_name || '').toLowerCase().includes(qCliente)
                  && !(p.phone_digits || '').includes(qCliente)
                  && !(p.address_line || '').toLowerCase().includes(qCliente)) return false;

    // Filtro por data
    if (dateFrom || dateTo) {
      const orderDate = p.created_at
        ? new Date(p.created_at * 1000).toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' })
        : null;
      if (!orderDate) return false;
      if (dateFrom && orderDate < dateFrom) return false;
      if (dateTo && orderDate > dateTo) return false;
    }

    // Filtro por tipo
    if (tipo && p.tipo_pagamento !== tipo) return false;

    return true;
  });

  renderTable(filtered);
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderTable(data) {
  const tbody = document.getElementById('tbody');
  const emptyEl = document.getElementById('empty-msg');

  if (!data || data.length === 0) {
    tbody.innerHTML = '';
    emptyEl.style.display = 'block';
    document.getElementById('total-pendente').textContent = 'R$ 0,00';
    document.getElementById('count-bling').textContent = '0';
    document.getElementById('count-pendente').textContent = '0';
    document.getElementById('filter-count').textContent = allData.length > 0 ? '0 de ' + allData.length : '';
    return;
  }

  emptyEl.style.display = 'none';

  let totalPendente = 0;
  let countBling = 0;
  let countPendente = 0;

  const html = data.map(p => {
    totalPendente += p.total_value || 0;
    if (p.bling_pedido_id) countBling++; else countPendente++;

    const blingBadge = p.bling_pedido_id
      ? `<span class="badge badge-green">‚úÖ Venda #${p.bling_pedido_num || p.bling_pedido_id}</span>`
      : `<span class="badge badge-gray">‚è≥ Aguardando emiss√£o</span>`;

    const tipoStyle = tipoColors[p.tipo_pagamento] || 'background:#f1f5f9;color:#64748b';
    const dateStr = fmtDate(p.created_at);

    return `<tr>
      <td><strong>#${p.id}</strong></td>
      <td style="font-size:12px;color:#64748b;white-space:nowrap">${dateStr}</td>
      <td>${p.customer_name || '‚Äî'}<br><small style="color:#94a3b8">${p.phone_digits || ''}</small></td>
      <td style="font-size:12px;color:#64748b">${p.address_line || '‚Äî'}</td>
      <td><strong>R$ ${(p.total_value || 0).toFixed(2)}</strong></td>
      <td><span class="tipo-badge" style="${tipoStyle}">${tipoLabels[p.tipo_pagamento] || p.tipo_pagamento}</span></td>
      <td>${blingBadge}</td>
      <td><button class="btn-pago" onclick="marcarPago(${p.id})">‚úÖ Pago</button></td>
    </tr>`;
  }).join('');

  tbody.innerHTML = html;
  document.getElementById('total-pendente').textContent = 'R$ ' + totalPendente.toFixed(2);
  document.getElementById('count-bling').textContent = countBling;
  document.getElementById('count-pendente').textContent = countPendente;

  const fc = document.getElementById('filter-count');
  fc.textContent = data.length < allData.length
    ? data.length + ' de ' + allData.length + ' registros'
    : data.length + ' registros';
}

// ‚îÄ‚îÄ A√ß√µes ‚îÄ‚îÄ
async function marcarPago(orderId) {
  if (!confirm('Confirmar que o pedido #' + orderId + ' foi pago?')) return;
  try {
    const data = await api('/api/pagamentos/' + orderId, { method: 'PATCH' });
    if (data.ok) {
      toast('‚úÖ Pedido #' + orderId + ' marcado como pago!');
      loadPagamentos();
    } else {
      toast('‚ùå ' + (data.error || 'Falha'), 'error');
    }
  } catch(e) {
    toast('‚ùå Erro: ' + e.message, 'error');
  }
}

function clearFilters() {
  document.getElementById('fCliente').value = '';
  document.getElementById('fDateFrom').value = '';
  document.getElementById('fDateTo').value = '';
  document.getElementById('fTipo').value = '';
  applyFilters();
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadPagamentos();
setInterval(loadPagamentos, 30000);
</script>
</body>
</html>
