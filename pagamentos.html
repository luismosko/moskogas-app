<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos â€” MoskoGÃ¡s v1.2.0</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar input, .toolbar select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn:hover { opacity: 0.85; }

  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; padding: 16px; }
  .s-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .s-card .label { font-size: 11px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
  .s-card .value { font-size: 24px; font-weight: 900; }
  .s-card .value.red { color: #dc2626; }
  .s-card .value.orange { color: #f97316; }
  .s-card .value.gray { color: #64748b; }
  .s-card .value.green { color: #16a34a; }

  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #1e293b; color: #fff; padding: 8px 10px; text-align: left; font-size: 11px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; vertical-align: middle; }
  tr:hover td { background: #fffbeb; }

  .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 10px; font-weight: 700; color: #fff; }
  .btn-pago { background: #16a34a; color: #fff; border: none; border-radius: 6px; padding: 5px 10px; font-size: 11px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-pago:hover { background: #15803d; }
  .btn-pago:disabled { background: #94a3b8; cursor: not-allowed; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 15px; }

  /* Bulk select */
  .bulk-bar { display: none; background: #fef3c7; padding: 10px 16px; align-items: center; gap: 12px; border-bottom: 2px solid #fbbf24; }
  .bulk-bar.show { display: flex; }
  .bulk-bar .count { font-weight: 800; color: #92400e; font-size: 14px; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v1.2.0 â€” pagamentos</div>

<!-- TOOLBAR -->
<div class="toolbar">
  <div style="display:flex;align-items:center;gap:4px">
    <input type="date" id="fDateFrom" onchange="loadPagamentos()" style="width:135px">
    <span style="color:#94a3b8;font-size:12px">atÃ©</span>
    <input type="date" id="fDateTo" onchange="loadPagamentos()" style="width:135px">
    <button class="btn" onclick="setDateFilter('hoje')" id="btnHoje" title="Filtrar pagamentos de hoje" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Hoje</button>
    <button class="btn" onclick="setDateFilter('ontem')" id="btnOntem" title="Filtrar pagamentos de ontem" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Ontem</button>
    <button class="btn" onclick="setDateFilter('semana')" id="btnSemana" title="Ãšltimos 7 dias" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">7 dias</button>
    <button class="btn" onclick="setDateFilter('limpar')" title="Limpar filtro de data" style="background:#e2e8f0;color:#64748b;padding:6px 8px;font-size:12px">âœ•</button>
  </div>
  <select id="fTipo" onchange="loadPagamentos()" title="Filtrar por tipo de pagamento">
    <option value="">Todos os tipos</option>
    <option value="pix_receber">â³ PIX a receber</option>
    <option value="mensalista">ğŸ“… Mensalista</option>
    <option value="boleto">ğŸ§¾ Boleto/Ã“rgÃ£o</option>
  </select>
  <input type="text" id="fQ" placeholder="ğŸ” Busca cliente..." oninput="loadPagamentos()" style="width:160px">
  <button class="btn btn-orange" onclick="loadPagamentos()" title="Recarregar lista de pagamentos">ğŸ”„ Atualizar</button>
  <span id="count-badge" style="font-size:12px;color:#64748b;margin-left:4px"></span>
  <span title="VersÃ£o do sistema" style="background:#6366f1;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700;letter-spacing:.5px">v1.2.0</span>
</div>

<!-- BULK BAR -->
<div class="bulk-bar" id="bulk-bar">
  <input type="checkbox" id="bulk-all" onchange="toggleBulkAll(this.checked)" title="Selecionar/desmarcar todos">
  <span class="count"><span id="bulk-count">0</span> selecionados</span>
  <button class="btn" style="background:#16a34a;color:#fff;font-size:12px;padding:6px 14px" onclick="bulkMarcarPago()" title="Marcar todos selecionados como pagos">âœ… Marcar Pagos em Lote</button>
</div>

<!-- SUMMARY CARDS -->
<div class="summary-cards">
  <div class="s-card">
    <div class="label">ğŸ’° Total Pendente</div>
    <div class="value red" id="total-pendente">R$ 0,00</div>
  </div>
  <div class="s-card">
    <div class="label">ğŸ“Š Qtd Pendentes</div>
    <div class="value orange" id="count-total">0</div>
  </div>
  <div class="s-card">
    <div class="label">âœ… No Bling</div>
    <div class="value green" id="count-bling">0</div>
  </div>
  <div class="s-card">
    <div class="label">â³ Aguardando EmissÃ£o</div>
    <div class="value gray" id="count-pendente">0</div>
  </div>
</div>

<!-- TABELA -->
<table>
  <thead>
    <tr>
      <th style="width:30px"><input type="checkbox" id="th-check" onchange="toggleBulkAll(this.checked)" title="Selecionar todos"></th>
      <th>#</th>
      <th>Data</th>
      <th>Cliente</th>
      <th>EndereÃ§o</th>
      <th>Itens</th>
      <th>Valor</th>
      <th>Tipo</th>
      <th>Status Bling</th>
      <th>AÃ§Ã£o</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<div id="empty-msg" class="empty" style="display:none">âœ… Nenhum pagamento pendente!</div>

<script src="shared.js"></script>
<script>
// v1.2.0
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let allData = [];
let selectedIds = new Set();

// â”€â”€ Date filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function todayCG() { return new Date().toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' }); }
function daysCG(n) {
  const d = new Date(); d.setDate(d.getDate() + n);
  return d.toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
}

function setDateFilter(mode) {
  const from = document.getElementById('fDateFrom');
  const to   = document.getElementById('fDateTo');
  const btns = { hoje: document.getElementById('btnHoje'), ontem: document.getElementById('btnOntem'), semana: document.getElementById('btnSemana') };
  Object.values(btns).forEach(b => b.style.background = '#64748b');

  if (mode === 'hoje') {
    const t = todayCG(); from.value = t; to.value = t;
    btns.hoje.style.background = '#f97316';
  } else if (mode === 'ontem') {
    const y = daysCG(-1); from.value = y; to.value = y;
    btns.ontem.style.background = '#f97316';
  } else if (mode === 'semana') {
    from.value = daysCG(-7); to.value = todayCG();
    btns.semana.style.background = '#f97316';
  } else {
    from.value = ''; to.value = '';
  }
  loadPagamentos();
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let loadTimer;
async function loadPagamentos() {
  clearTimeout(loadTimer);
  loadTimer = setTimeout(_loadPagamentos, 150);
}

async function _loadPagamentos() {
  try {
    const data = await api('/api/pagamentos');
    if (!Array.isArray(data)) { allData = []; } else { allData = data; }

    // Client-side filters
    const dateFrom = document.getElementById('fDateFrom').value;
    const dateTo   = document.getElementById('fDateTo').value;
    const tipo     = document.getElementById('fTipo').value;
    const q        = document.getElementById('fQ').value.toLowerCase().trim();

    let rows = allData;

    if (dateFrom || dateTo) {
      rows = rows.filter(r => {
        if (!r.created_at) return true;
        const d = new Date(r.created_at * 1000).toLocaleDateString('sv-SE', { timeZone: 'America/Campo_Grande' });
        if (dateFrom && d < dateFrom) return false;
        if (dateTo   && d > dateTo)   return false;
        return true;
      });
    }
    if (tipo) rows = rows.filter(r => r.tipo_pagamento === tipo);
    if (q) rows = rows.filter(r =>
      (r.customer_name || '').toLowerCase().includes(q) ||
      (r.address_line || '').toLowerCase().includes(q) ||
      String(r.id).includes(q)
    );

    renderTable(rows);
    renderSummary(rows);
    document.getElementById('count-badge').textContent = `${rows.length} pendentes`;
    selectedIds.clear();
    updateBulkBar();

  } catch(e) {
    toast('Erro ao carregar: ' + e.message, 'error');
  }
}

function renderTable(rows) {
  const tbody = document.getElementById('tbody');
  const emptyMsg = document.getElementById('empty-msg');

  if (!rows.length) {
    tbody.innerHTML = '';
    emptyMsg.style.display = 'block';
    return;
  }
  emptyMsg.style.display = 'none';

  const tipoLabels = {
    dinheiro: 'ğŸ’µ Dinheiro', pix_vista: 'âš¡ PIX Ã  vista',
    pix_receber: 'â³ PIX a receber', mensalista: 'ğŸ“… Mensalista', boleto: 'ğŸ§¾ Boleto/Ã“rgÃ£o'
  };

  tbody.innerHTML = rows.map(p => {
    const items = (() => { try { return JSON.parse(p.items_json || '[]'); } catch(e) { return []; } })();
    const itemsStr = items.map(i => `${i.qty}x ${i.name}`).join(', ') || 'â€”';
    const data = p.created_at ? new Date(p.created_at * 1000).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit', timeZone:'America/Campo_Grande' }) : 'â€”';
    const hora = p.created_at ? new Date(p.created_at * 1000).toLocaleTimeString('pt-BR', { hour:'2-digit', minute:'2-digit', timeZone:'America/Campo_Grande' }) : '';

    const blingBadge = p.bling_pedido_id
      ? `<span class="badge" style="background:#16a34a">âœ… #${p.bling_pedido_num || p.bling_pedido_id}</span>`
      : `<span class="badge" style="background:#94a3b8">â³ Sem venda</span>`;

    const checked = selectedIds.has(p.id) ? 'checked' : '';

    return `<tr>
      <td><input type="checkbox" value="${p.id}" ${checked} onchange="toggleSelect(${p.id}, this.checked)" title="Selecionar para aÃ§Ã£o em lote"></td>
      <td><strong>#${p.id}</strong></td>
      <td style="white-space:nowrap;font-size:11px">${data}<br><span style="color:#94a3b8">${hora}</span></td>
      <td style="font-weight:600;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.customer_name || ''}">${p.customer_name || 'â€”'}</td>
      <td style="font-size:11px;color:#64748b;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.address_line || ''}">${p.address_line || 'â€”'}<br><span style="font-size:10px">${p.bairro || ''}</span></td>
      <td style="font-size:11px;max-width:140px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${itemsStr}">${itemsStr}</td>
      <td style="font-weight:800;color:#1e293b;white-space:nowrap">R$ ${parseFloat(p.total_value || 0).toFixed(2)}</td>
      <td style="white-space:nowrap;font-size:11px">${tipoLabels[p.tipo_pagamento] || p.tipo_pagamento || 'â€”'}</td>
      <td>${blingBadge}</td>
      <td><button class="btn-pago" onclick="marcarPago(${p.id})" title="Confirmar recebimento deste pagamento">âœ… Pago</button></td>
    </tr>`;
  }).join('');
}

function renderSummary(rows) {
  let totalPendente = 0, countBling = 0, countPendente = 0;
  rows.forEach(p => {
    totalPendente += parseFloat(p.total_value) || 0;
    if (p.bling_pedido_id) countBling++; else countPendente++;
  });
  document.getElementById('total-pendente').textContent = 'R$ ' + totalPendente.toFixed(2);
  document.getElementById('count-total').textContent = rows.length;
  document.getElementById('count-bling').textContent = countBling;
  document.getElementById('count-pendente').textContent = countPendente;
}

// â”€â”€ Marcar Pago â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function marcarPago(orderId) {
  if (!confirm(`Confirmar pagamento do pedido #${orderId}?`)) return;
  try {
    const data = await api(`/api/pagamentos/${orderId}`, { method: 'PATCH' });
    if (data.ok) {
      toast(`âœ… Pedido #${orderId} marcado como pago!`);
      loadPagamentos();
    } else {
      toast('âŒ ' + (data.error || 'Falha'), 'error');
    }
  } catch(e) { toast(e.message, 'error'); }
}

// â”€â”€ Bulk select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSelect(id, checked) {
  if (checked) selectedIds.add(id); else selectedIds.delete(id);
  updateBulkBar();
}

function toggleBulkAll(checked) {
  const boxes = document.querySelectorAll('#tbody input[type=checkbox]');
  boxes.forEach(b => {
    b.checked = checked;
    const id = parseInt(b.value);
    if (checked) selectedIds.add(id); else selectedIds.delete(id);
  });
  document.getElementById('th-check').checked = checked;
  document.getElementById('bulk-all').checked = checked;
  updateBulkBar();
}

function updateBulkBar() {
  const bar = document.getElementById('bulk-bar');
  const count = selectedIds.size;
  document.getElementById('bulk-count').textContent = count;
  bar.classList.toggle('show', count > 0);
}

async function bulkMarcarPago() {
  const ids = [...selectedIds];
  if (!ids.length) return;
  if (!confirm(`Marcar ${ids.length} pedido(s) como pago(s)?`)) return;

  let ok = 0, fail = 0;
  for (const id of ids) {
    try {
      const data = await api(`/api/pagamentos/${id}`, { method: 'PATCH' });
      if (data.ok) ok++; else fail++;
    } catch(e) { fail++; }
  }
  toast(`âœ… ${ok} pago(s)${fail ? `, ${fail} erro(s)` : ''}`, fail ? 'error' : 'success');
  loadPagamentos();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
setDateFilter('semana');

// Auto refresh 30s
setInterval(loadPagamentos, 30000);
</script>
</body>
</html>
