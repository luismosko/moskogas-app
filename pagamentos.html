<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos â€” MoskoGÃ¡s v1.9.9</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar input, .toolbar select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn:hover { opacity: 0.85; }
  .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; padding: 16px; }
  .s-card { background: #fff; border-radius: 12px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .s-card .label { font-size: 12px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-bottom: 4px; }
  .s-card .value { font-size: 24px; font-weight: 900; }
  .s-card .value.red { color: #dc2626; }
  .s-card .value.orange { color: #f97316; }
  .s-card .value.gray { color: #64748b; }
  .s-card .value.green { color: #16a34a; }
  .s-card .value.blue { color: #2563eb; }
  .s-card .value.purple { color: #7c3aed; }
  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #475569; color: #fff; padding: 8px 10px; text-align: left; font-size: 12px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: #fffbeb; }
  .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #fff; }
  .btn-pago { background: #16a34a; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-pago:hover { background: #15803d; }
  .btn-nfe { background: #7c3aed; color: #fff; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-nfe:hover { background: #6d28d9; }
  .btn-lembrete { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-lembrete:hover { background: #1d4ed8; }
  .btn-lembrete:disabled, .btn-pago:disabled, .btn-nfe:disabled { background: #94a3b8; cursor: not-allowed; }
  .btn-lembrete .rb { background: #fbbf24; color: #92400e; border-radius: 8px; padding: 1px 5px; font-size: 10px; margin-left: 3px; }
  .empty { text-align: center; padding: 40px; color: #94a3b8; font-size: 15px; }
  .bulk-bar { display: none; background: #fef3c7; padding: 10px 16px; align-items: center; gap: 12px; border-bottom: 2px solid #fbbf24; flex-wrap: wrap; }
  .bulk-bar.show { display: flex; }
  .bulk-bar .count { font-weight: 800; color: #92400e; font-size: 14px; }
  .actions-cell { display: flex; gap: 4px; align-items: center; }
  .ri { font-size: 10px; color: #94a3b8; margin-top: 2px; }
  .ri.w { color: #f97316; }
  .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:200; justify-content:center; align-items:center; }
  .modal-overlay.show { display:flex; }
  .modal-box { background:#fff; border-radius:16px; padding:24px; max-width:600px; width:95%; max-height:80vh; overflow-y:auto; box-shadow:0 16px 48px rgba(0,0,0,0.2); }
  .modal-box h3 { margin-bottom:16px; font-size:18px; }
  .modal-box table { font-size:13px; margin:12px 0; }
  .modal-box table th { background:#7c3aed; position:static; }
  .modal-box .total-line { font-size:18px; font-weight:900; color:#7c3aed; text-align:right; margin:12px 0; }
  .modal-box .btn-row { display:flex; gap:8px; justify-content:flex-end; margin-top:16px; }
  .btn-qr { background: #0891b2; color: #fff; border: none; border-radius: 6px; padding: 6px 10px; font-size: 12px; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .btn-qr:hover { background: #0e7490; }
  .btn-qr:disabled { background: #94a3b8; cursor: not-allowed; }
  .qr-modal-body { text-align: center; }
  .qr-modal-body img { max-width: 280px; margin: 12px auto; border-radius: 8px; border: 2px solid #e2e8f0; }
  .qr-code-text { background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; padding: 12px; font-size: 11px; word-break: break-all; max-height: 80px; overflow-y: auto; margin: 8px 0; text-align: left; font-family: monospace; }
  .btn-copy { background: #0891b2; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer; }
  .btn-copy:hover { background: #0e7490; }
  .btn-whats { background: #16a34a; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-size: 14px; font-weight: 700; cursor: pointer; }
  .btn-whats:hover { background: #15803d; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>
<div style="font-size:10px;color:#94a3b8;text-align:right;padding:2px 12px 0">v1.9.9 â€” pagamentos</div>
<div class="toolbar">
  <div style="display:flex;align-items:center;gap:4px">
    <input type="date" id="fDateFrom" onchange="loadPagamentos()" style="width:135px">
    <span style="color:#94a3b8;font-size:12px">atÃ©</span>
    <input type="date" id="fDateTo" onchange="loadPagamentos()" style="width:135px">
    <button class="btn" onclick="setDateFilter('hoje')" id="btnHoje" title="Filtrar hoje" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Hoje</button>
    <button class="btn" onclick="setDateFilter('ontem')" id="btnOntem" title="Filtrar ontem" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">Ontem</button>
    <button class="btn" onclick="setDateFilter('semana')" id="btnSemana" title="Ãšltimos 7 dias" style="background:#64748b;color:#fff;padding:6px 10px;font-size:12px">7 dias</button>
    <button class="btn" onclick="setDateFilter('limpar')" title="Limpar filtro" style="background:#e2e8f0;color:#64748b;padding:6px 8px;font-size:12px">âœ•</button>
  </div>
  <select id="fTipo" onchange="loadPagamentos()" title="Filtrar por tipo">
    <option value="">Todos os tipos</option>
    <option value="pix_receber">â³ PIX Aberto</option>
    <option value="mensalista">ğŸ“… Mensalista</option>
    <option value="boleto">ğŸ§¾ Boleto</option>
  </select>
  <input type="text" id="fQ" placeholder="ğŸ” Busca cliente..." oninput="loadPagamentos()" style="width:160px">
  <button class="btn btn-orange" onclick="loadPagamentos()" title="Recarregar">ğŸ”„ Atualizar</button>
  <button class="btn" id="btn-ver-pagos" onclick="toggleVerPagos()" title="Mostrar/ocultar pedidos jÃ¡ pagos" style="background:#64748b;color:#fff;padding:6px 12px;font-size:12px">ğŸ‘ Ver Pagos</button>
  <span id="count-badge" style="font-size:12px;color:#64748b;margin-left:4px"></span>
  <span title="VersÃ£o" style="background:#6366f1;color:#fff;border-radius:10px;padding:2px 8px;font-size:10px;font-weight:700">v1.9.9</span>
</div>

<div class="bulk-bar" id="bulk-bar">
  <input type="checkbox" id="bulk-all" onchange="toggleBulkAll(this.checked)" title="Selecionar/desmarcar todos">
  <span class="count"><span id="bulk-count">0</span> selecionados</span>
  <button class="btn" style="background:#16a34a;color:#fff;font-size:12px;padding:6px 14px;display:none" onclick="bulkMarcarPago()" id="btn-bulk-pago" title="Marcar pagos (PIX Aberto)">âœ… Marcar Pagos (<span id="bulk-pix-count">0</span>)</button>
  <button class="btn" style="background:#7c3aed;color:#fff;font-size:12px;padding:6px 14px;display:none" onclick="bulkGerarNfe()" id="btn-bulk-nfe" title="Gerar Venda Agrupada no Bling (Mensalista/Boleto)">ğŸ“„ Gerar Venda Agrupada (<span id="bulk-nfe-count">0</span>)</button>
  <button class="btn" style="background:#2563eb;color:#fff;font-size:12px;padding:6px 14px;display:none" onclick="bulkEnviarLembrete()" id="btn-bulk-lembrete" title="Enviar lembrete WhatsApp (PIX)">ğŸ“± Enviar Lembretes</button>
</div>

<div class="summary-cards">
  <div class="s-card"><div class="label">ğŸ’° Total Pendente</div><div class="value red" id="total-pendente">R$ 0,00</div></div>
  <div class="s-card"><div class="label">ğŸ“Š Qtd Pendentes</div><div class="value orange" id="count-total">0</div></div>
  <div class="s-card"><div class="label">â³ PIX a Receber</div><div class="value blue" id="count-pix">0</div></div>
  <div class="s-card"><div class="label">ğŸ“… Mensal/Boleto</div><div class="value purple" id="count-mensal">0</div></div>
  <div class="s-card"><div class="label">âœ… Com Bling</div><div class="value green" id="count-bling">0</div></div>
  <div class="s-card"><div class="label">ğŸ“± Lembretes</div><div class="value gray" id="count-lembretes">0</div></div>
</div>

<table>
  <thead><tr>
    <th style="width:30px"><input type="checkbox" id="th-check" onchange="toggleBulkAll(this.checked)" title="Selecionar todos"></th>
    <th>#</th><th>Data</th><th>Cliente</th><th>EndereÃ§o</th><th>Itens</th><th>Valor</th><th>Tipo</th><th>Bling</th><th>AÃ§Ã£o</th>
  </tr></thead>
  <tbody id="tbody"></tbody>
</table>
<div id="empty-msg" class="empty" style="display:none">âœ… Nenhum pagamento pendente!</div>

<!-- Modal NFe Preview -->
<div class="modal-overlay" id="nfe-modal">
  <div class="modal-box">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>ğŸ“„ Preview Venda Agrupada</h3>
      <button onclick="closeNfeModal()" style="background:none;border:none;font-size:20px;cursor:pointer" title="Fechar">âœ•</button>
    </div>
    <div id="nfe-modal-body"></div>
    <div class="btn-row">
      <button class="btn" style="background:#e2e8f0;color:#475569" onclick="closeNfeModal()">Cancelar</button>
      <button class="btn" style="background:#7c3aed;color:#fff" onclick="confirmarNfe()">ğŸ“„ Confirmar e Gerar Venda</button>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
<script src="shared.js"></script>

<!-- Modal QR Code PIX -->
<div class="modal-overlay" id="qr-modal">
  <div class="modal-box" style="max-width:420px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3 id="qr-modal-title">ğŸ“± PIX â€” QR Code</h3>
      <button onclick="closeQrModal()" style="background:none;border:none;font-size:20px;cursor:pointer" title="Fechar">âœ•</button>
    </div>
    <div id="qr-modal-body" class="qr-modal-body"></div>
  </div>
</div>

<script>
// v1.9.9 â€” Pagamentos: QR Code PIX PushInPay + Venda agrupada + Marcar Pago
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let allData = [];
let selectedIds = new Set();
let pendingNfeIds = [];

const TIPO_LABELS = { pix_receber:'â³ PIX Aberto', mensalista:'ğŸ“… Mensal', boleto:'ğŸ§¾ Boleto', dinheiro:'ğŸ’µ Dinh', pix_vista:'âš¡ PIX', debito:'ğŸ’³ DÃ©b', credito:'ğŸ’³ CrÃ©d' };
const TIPOS_NFE = ['mensalista','boleto'];
let mostrarPagos = false;

function toggleVerPagos() {
  mostrarPagos = !mostrarPagos;
  const btn = document.getElementById('btn-ver-pagos');
  btn.style.background = mostrarPagos ? '#16a34a' : '#64748b';
  btn.textContent = mostrarPagos ? 'ğŸ‘ Pagos: ON' : 'ğŸ‘ Ver Pagos';
  loadPagamentos();
}

function todayCG() { return new Date().toLocaleDateString('sv-SE',{timeZone:'America/Campo_Grande'}); }
function daysCG(n) { const d=new Date(); d.setDate(d.getDate()+n); return d.toLocaleDateString('sv-SE',{timeZone:'America/Campo_Grande'}); }

function setDateFilter(mode) {
  const from=document.getElementById('fDateFrom'), to=document.getElementById('fDateTo');
  const btns={hoje:document.getElementById('btnHoje'),ontem:document.getElementById('btnOntem'),semana:document.getElementById('btnSemana')};
  Object.values(btns).forEach(b=>b.style.background='#64748b');
  if(mode==='hoje'){const t=todayCG();from.value=t;to.value=t;btns.hoje.style.background='#f97316';}
  else if(mode==='ontem'){const y=daysCG(-1);from.value=y;to.value=y;btns.ontem.style.background='#f97316';}
  else if(mode==='semana'){from.value=daysCG(-7);to.value=todayCG();btns.semana.style.background='#f97316';}
  else{from.value='';to.value='';}
  loadPagamentos();
}

let loadTimer;
function loadPagamentos(){clearTimeout(loadTimer);loadTimer=setTimeout(_load,150);}

async function _load() {
  try {
    const qs = mostrarPagos ? '?incluir_pagos=1' : '';
    const data = await api('/api/pagamentos' + qs);
    allData = Array.isArray(data) ? data : [];
    const dateFrom=document.getElementById('fDateFrom').value, dateTo=document.getElementById('fDateTo').value;
    const tipo=document.getElementById('fTipo').value, q=document.getElementById('fQ').value.toLowerCase().trim();
    let rows = allData;
    if(dateFrom||dateTo) rows=rows.filter(r=>{if(!r.created_at)return true;const d=new Date(r.created_at*1000).toLocaleDateString('sv-SE',{timeZone:'America/Campo_Grande'});return(!dateFrom||d>=dateFrom)&&(!dateTo||d<=dateTo);});
    if(tipo) rows=rows.filter(r=>r.tipo_pagamento===tipo);
    if(q) rows=rows.filter(r=>(r.customer_name||'').toLowerCase().includes(q)||(r.address_line||'').toLowerCase().includes(q)||String(r.id).includes(q));
    renderTable(rows); renderSummary(rows);
    document.getElementById('count-badge').textContent = mostrarPagos
      ? rows.length + ' registros (' + rows.filter(r=>r.pago).length + ' pagos)'
      : rows.length + ' pendentes';
    selectedIds.clear(); updateBulkBar();
    hideLoading();
  } catch(e){hideLoading();toast('Erro: '+e.message,'error');}
}

function printRec(id) {
  const o = allData.find(r => r.id == id);
  if (o) {
    try {
      sessionStorage.setItem('mg_print_order', JSON.stringify(o));
      window.open('print.html?id=' + id + '&src=session', '_blank');
    } catch(e) {
      // fallback: URL param (pode falhar se muito grande)
      window.open('print.html?data=' + encodeURIComponent(JSON.stringify(o)), '_blank');
    }
  } else {
    window.open('print.html?id=' + id, '_blank');
  }
}

function timeAgo(epoch){if(!epoch)return'';const d=Math.floor(Date.now()/1000)-epoch;if(d<3600)return Math.floor(d/60)+'min';if(d<86400)return Math.floor(d/3600)+'h';return Math.floor(d/86400)+'d';}

function renderTable(rows) {
  const tbody=document.getElementById('tbody'), emptyMsg=document.getElementById('empty-msg');
  if(!rows.length){tbody.innerHTML='';emptyMsg.style.display='block';return;}
  emptyMsg.style.display='none';
  tbody.innerHTML=rows.map(p=>{
    const items=(()=>{try{return JSON.parse(p.items_json||'[]');}catch(e){return[];}})();
    const itemsStr=items.map(i=>i.qty+'x '+i.name).join(', ')||'â€”';
    const dt=p.created_at?new Date(p.created_at*1000).toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit',timeZone:'America/Campo_Grande'}):'â€”';
    const hr=p.created_at?new Date(p.created_at*1000).toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',timeZone:'America/Campo_Grande'}):'';
    const blingBadge=p.bling_pedido_id?`<span class="badge" style="background:#16a34a">âœ… #${p.bling_pedido_num||p.bling_pedido_id}</span>`:`<span class="badge" style="background:#94a3b8">â³</span>`;
    const ck=selectedIds.has(p.id)?'checked':'';
    const isNfe=TIPOS_NFE.includes(p.tipo_pagamento);
    let actionBtns='';
    if(p.pago){
      // â”€â”€ PAGO: sÃ³ imprimir + Bling se ainda nÃ£o enviado â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if(!p.bling_pedido_id){
        if(isNfe){
          actionBtns+=`<button class="btn-nfe" onclick="gerarNfeUnico(${p.id})" title="Gerar Venda no Bling">ğŸ“„ Bling</button>`;
        } else {
          actionBtns+=`<button class="btn-nfe" onclick="gerarVendaBling(${p.id})" title="Enviar ao Bling" style="background:#0891b2">ğŸ“¤ Bling</button>`;
        }
      }
      actionBtns += `<button onclick="printRec(${p.id})" title="Imprimir recibo" style="background:#1F4E79;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700">ğŸ–¨ï¸</button>`;
    } else {
      // â”€â”€ NÃƒO PAGO: todos os botÃµes normais â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      if(p.tipo_pagamento==='pix_receber'){
        // BotÃ£o QR Code PIX â€” PushInPay mÃ­nimo R$1,00
        const hasQr = p.pix_tx_id || p.cora_invoice_id;
        const valorNum = parseFloat(p.total_value||0);
        if(valorNum < 1){
          actionBtns+=`<button class="btn-qr" disabled title="PIX exige mÃ­nimo R$1,00 (pedido: R$${valorNum.toFixed(2)})" style="opacity:.4;cursor:not-allowed">â• PIX</button>`;
        } else {
          actionBtns+=`<button class="btn-qr" onclick="showQrCode(${p.id})" title="${hasQr?'Ver QR Code PIX':'Gerar QR Code PIX'}">${hasQr?'ğŸ“± QR':'â• PIX'}</button>`;
          if(hasQr) actionBtns+=`<button class="btn-check-pix" onclick="checkPixStatus(${p.id})" title="Verificar pagamento na PushInPay" style="background:#8b5cf6;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700">âœ” Check</button>`;
        }
        const cnt=p.reminder_count||0;const badge=cnt>0?`<span class="rb">${cnt}</span>`:'';
        const hasPhone=p.phone_digits&&p.phone_digits.replace(/\D/g,'').length>=10;
        actionBtns+=hasPhone?`<button class="btn-lembrete" onclick="enviarLembrete(${p.id})" title="Lembrete PIX WhatsApp${cnt?' ('+cnt+'x)':''}">ğŸ“±${badge}</button>`:`<button class="btn-lembrete" disabled title="Sem telefone">ğŸ“±</button>`;
      }
      // BotÃ£o principal
      if(isNfe){
        actionBtns+=`<button class="btn-nfe" onclick="gerarNfeUnico(${p.id})" title="Gerar Venda no Bling + marcar pago">ğŸ“„ Venda</button>`;
      } else {
        actionBtns+=`<button class="btn-pago" onclick="marcarPago(${p.id})" title="Confirmar recebimento PIX">âœ… Pago</button>`;
      }
      // BotÃ£o imprimir
      actionBtns += `<button onclick="printRec(${p.id})" title="Imprimir recibo" style="background:#1F4E79;color:#fff;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;font-size:12px;font-weight:700">ğŸ–¨ï¸</button>`;
    }
    let ri='';
    if(p.tipo_pagamento==="pix_receber"){const cnt=p.reminder_count||0;if(cnt>0&&p.last_reminder_at)ri=`<div class="ri${cnt>=3?" w":""}">ğŸ“±${cnt}x Â· ${timeAgo(p.last_reminder_at)} atrÃ¡s</div>`;}
    const trStyle = p.pago ? 'background:#f0fdf4;opacity:0.75' : '';
    const pagoTag = p.pago ? `<span style="font-size:10px;background:#16a34a;color:#fff;border-radius:10px;padding:1px 6px;margin-left:4px">âœ… pago</span>` : '';
    return `<tr style="${trStyle}">
      <td><input type="checkbox" value="${p.id}" data-tipo="${p.tipo_pagamento||''}" ${ck} onchange="toggleSelect(this)" ${p.pago?'disabled':''}></td>
      <td><strong>#${p.id}</strong>${pagoTag}${ri}</td>
      <td style="white-space:nowrap;font-size:12px">${dt}<br><span style="color:#94a3b8">${hr}</span></td>
      <td style="font-weight:600;max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.customer_name||''}">${p.customer_name||'â€”'}</td>
      <td style="color:#64748b;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${p.address_line||''}">${p.address_line||'â€”'}<br><span style="font-size:11px">${p.bairro||''}</span></td>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${itemsStr}">${itemsStr}</td>
      <td style="font-weight:800;color:#1e293b;white-space:nowrap">R$ ${parseFloat(p.total_value||0).toFixed(2)}</td>
      <td style="white-space:nowrap">${TIPO_LABELS[p.tipo_pagamento]||p.tipo_pagamento||'â€”'}</td>
      <td>${blingBadge}</td>
      <td><div class="actions-cell">${actionBtns}</div></td>
    </tr>`;
  }).join('');
}

function renderSummary(rows) {
  let total=0,countBling=0,countPix=0,countMensal=0,totalLemb=0;
  rows.forEach(p=>{total+=parseFloat(p.total_value)||0;if(p.bling_pedido_id)countBling++;if(p.tipo_pagamento==='pix_receber')countPix++;if(TIPOS_NFE.includes(p.tipo_pagamento))countMensal++;totalLemb+=(p.reminder_count||0);});
  document.getElementById('total-pendente').textContent='R$ '+total.toFixed(2);
  document.getElementById('count-total').textContent=rows.length;
  document.getElementById('count-pix').textContent=countPix;
  document.getElementById('count-mensal').textContent=countMensal;
  document.getElementById('count-bling').textContent=countBling;
  document.getElementById('count-lembretes').textContent=totalLemb;
}

// â•â•â• SELEÃ‡ÃƒO â•â•â•
function toggleSelect(el){
  const id=parseInt(el.value);
  if(el.checked)selectedIds.add(id);else selectedIds.delete(id);
  updateBulkBar();
}
function toggleBulkAll(checked){
  document.querySelectorAll('#tbody input[type=checkbox]').forEach(b=>{
    b.checked=checked;
    const id=parseInt(b.value);
    if(checked)selectedIds.add(id);else selectedIds.delete(id);
  });
  document.getElementById('th-check').checked=checked;
  document.getElementById('bulk-all').checked=checked;
  updateBulkBar();
}
function updateBulkBar(){
  // Ler tipos diretamente dos checkboxes marcados (sem depender de allData.find)
  const checkedBoxes=[...document.querySelectorAll('#tbody input[type=checkbox]:checked')];
  const count=checkedBoxes.length;
  // Sincronizar selectedIds com o DOM
  selectedIds.clear();
  checkedBoxes.forEach(b=>selectedIds.add(parseInt(b.value)));
  document.getElementById('bulk-count').textContent=count;
  document.getElementById('bulk-bar').classList.toggle('show',count>0);
  let pixCount=0, nfeCount=0;
  checkedBoxes.forEach(b=>{
    const tipo=b.dataset.tipo||'';
    if(tipo==='pix_receber')pixCount++;
    if(TIPOS_NFE.includes(tipo))nfeCount++;
  });
  document.getElementById('btn-bulk-pago').style.display=pixCount>0?'inline-block':'none';
  document.getElementById('bulk-pix-count').textContent=pixCount;
  document.getElementById('btn-bulk-nfe').style.display=nfeCount>0?'inline-block':'none';
  document.getElementById('bulk-nfe-count').textContent=nfeCount;
  document.getElementById('btn-bulk-lembrete').style.display=pixCount>0?'inline-block':'none';
}

// â•â•â• MARCAR PAGO (PIX Aberto) â•â•â•
async function marcarPago(orderId){
  if(!confirm('Confirmar recebimento do PIX #'+orderId+'?'))return;
  showLoading('Verificando Bling...');
  const result = await apiBling('Marcando PIX #'+orderId+' como pago', async () => {
    return await api('/api/pagamentos/'+orderId,{method:'PATCH'});
  });
  hideLoading();
  if(result.ok){
    if(result.data.ok){toast('âœ… Pedido #'+orderId+' pago!');loadPagamentos();}
    else toast('âŒ '+(result.data.error||'Falha'),'error');
  } else if(!result.canceled) {
    toast('âŒ '+result.error,'error');
  }
}
async function bulkMarcarPago(){
  const ids=[...selectedIds].filter(id=>{const p=allData.find(r=>r.id==id);return p&&p.tipo_pagamento==='pix_receber';});
  if(!ids.length){toast('âš ï¸ Nenhum PIX selecionado','error');return;}
  if(!confirm('Marcar '+ids.length+' PIX como pago(s)?'))return;
  // Verifica Bling antes do loop
  const blingOk = await checkBlingBeforeAction();
  if(!blingOk){toast('âš ï¸ Bling nÃ£o conectado â€” operaÃ§Ã£o cancelada','error');return;}
  showLoading('Processando '+ids.length+' pagamento(s)...');
  let ok=0,fail=0;
  for(const id of ids){try{const d=await api('/api/pagamentos/'+id,{method:'PATCH'});if(d.ok)ok++;else fail++;}catch(e){fail++;}}
  hideLoading();
  toast('âœ… '+ok+' pago(s)'+(fail?', '+fail+' erro(s)':''),fail?'error':'success');
  loadPagamentos();
}

// â•â•â• NFE AGRUPADA (Mensalista/Boleto) â•â•â•
function gerarNfeUnico(orderId){showNfePreview([orderId]);}

async function gerarVendaBling(orderId){
  if(!confirm('Criar venda no Bling para o pedido #'+orderId+'?\n\nO pedido jÃ¡ estÃ¡ marcado como pago.'))return;
  showLoading('Criando no Bling...');
  const result = await apiBling('Criando venda Bling #'+orderId, async () => {
    return await api('/api/pagamentos/criar-vendas-bling',{method:'POST',body:JSON.stringify({order_ids:[orderId]})});
  });
  hideLoading();
  if(result.ok){
    if(result.data.ok||result.data.results){toast('âœ… Venda criada no Bling!','success');loadPagamentos();}
    else toast('âŒ '+(result.data.error||'Falha'),'error');
  } else if(!result.canceled){
    toast('âŒ '+result.error,'error');
  }
}
function bulkGerarNfe(){
  const ids=[...selectedIds].filter(id=>{const p=allData.find(r=>r.id==id);return p&&TIPOS_NFE.includes(p.tipo_pagamento);});
  if(!ids.length){toast('âš ï¸ Nenhum Mensalista/Boleto selecionado','error');return;}
  showNfePreview(ids);
}

function showNfePreview(ids){
  const orders=ids.map(id=>allData.find(r=>r.id==id)).filter(Boolean);
  pendingNfeIds=ids;
  // Agrupar por cliente
  const grupos={};
  for(const o of orders){
    const key=o.phone_digits||o.customer_name||'sem_'+o.id;
    if(!grupos[key])grupos[key]={cliente:o.customer_name,pedidos:[],produtos:{},total:0};
    grupos[key].pedidos.push(o);
    grupos[key].total+=parseFloat(o.total_value)||0;
    try{const items=JSON.parse(o.items_json||'[]');for(const item of items){const pk=item.name||'?';if(!grupos[key].produtos[pk])grupos[key].produtos[pk]={name:item.name,qty:0,price:parseFloat(item.price)||0};grupos[key].produtos[pk].qty+=parseInt(item.qty)||1;}}catch(_){}
  }
  let html='';
  const gKeys=Object.keys(grupos);
  for(const key of gKeys){
    const g=grupos[key]; const prods=Object.values(g.produtos);
    html+=`<div style="background:#f8fafc;border-radius:8px;padding:12px;margin-bottom:12px">`;
    html+=`<div style="font-weight:700;font-size:15px;margin-bottom:4px">ğŸ‘¤ ${g.cliente}</div>`;
    html+=`<div style="font-size:12px;color:#64748b;margin-bottom:8px">Pedidos: ${g.pedidos.map(p=>'#'+p.id).join(', ')}</div>`;
    html+=`<table style="width:100%"><thead><tr><th>Produto</th><th style="text-align:center">Qtd Total</th><th style="text-align:right">Unit.</th><th style="text-align:right">Subtotal</th></tr></thead><tbody>`;
    for(const p of prods){
      const sub=p.qty*p.price;
      html+=`<tr><td>${p.name}</td><td style="text-align:center;font-weight:700">${p.qty}</td><td style="text-align:right">R$ ${p.price.toFixed(2)}</td><td style="text-align:right;font-weight:700">R$ ${sub.toFixed(2)}</td></tr>`;
    }
    html+=`</tbody></table>`;
    html+=`<div class="total-line">Total: R$ ${g.total.toFixed(2)}</div></div>`;
  }
  if(gKeys.length>1) html+=`<div style="font-size:13px;color:#64748b;text-align:right;margin-top:8px">${gKeys.length} cliente(s) â†’ ${gKeys.length} Venda(s) no Bling</div>`;
  html+=`<div style="margin-top:12px;padding:10px;background:#fef3c7;border-radius:8px;font-size:12px;color:#92400e">âš ï¸ SerÃ¡ criada uma Venda no Bling para cada cliente, agrupando os itens dos pedidos selecionados. Os pedidos serÃ£o marcados como pagos.</div>`;
  document.getElementById('nfe-modal-body').innerHTML=html;
  document.getElementById('nfe-modal').classList.add('show');
}

function closeNfeModal(){document.getElementById('nfe-modal').classList.remove('show');pendingNfeIds=[];}

async function confirmarNfe(){
  if(!pendingNfeIds.length)return;
  const ids=[...pendingNfeIds];
  closeNfeModal();
  showLoading('Gerando Venda no Bling... Aguarde');
  
  const result = await apiBling('Gerando Venda para '+ids.length+' pedido(s)', async () => {
    return await api('/api/pagamentos/criar-vendas-bling',{method:'POST',body:JSON.stringify({order_ids:ids})});
  });
  hideLoading();
  
  if(result.ok){
    const d=result.data;
    if(d.ok!==undefined){
      const res=d.resultados||[];
      const ok=res.filter(r=>r.ok).length, fail=res.filter(r=>!r.ok).length;
      let msg='ğŸ“„ '+ok+' Venda(s) criada(s) no Bling!';
      if(fail>0)msg+=' âš ï¸ '+fail+' erro(s)';
      if(result.recovered)msg+=' (reconectado)';
      toast(msg,fail?'error':'success');
      for(const r of res){if(!r.ok)toast('âŒ '+r.cliente+': '+r.error,'error');}
    } else {
      toast('âŒ '+(d.error||'Falha ao gerar Venda'),'error');
    }
    loadPagamentos();
  } else if(!result.canceled) {
    toast('âŒ '+result.error,'error');
  }
}

// â•â•â• QR CODE PIX (PushInPay) â•â•â•
async function showQrCode(orderId) {
  showLoading('Carregando QR Code...');
  try {
    const data = await api('/api/pagamentos/'+orderId+'/qrcode');
    hideLoading();
    if(!data.ok){toast('âŒ '+(data.error||'Erro'),'error');return;}
    if(data.paid){toast('âœ… PIX jÃ¡ confirmado!');loadPagamentos();return;}
    if(data.qrcode){
      renderQrModal(orderId, data);
    } else {
      // Sem QR ainda â€” gerar
      await gerarPixQr(orderId);
    }
  } catch(e){hideLoading();toast('âŒ '+e.message,'error');}
}

async function gerarPixQr(orderId) {
  showLoading('Gerando QR Code PIX...');
  try {
    const data = await api('/api/pagamentos/'+orderId+'/gerar-pix',{method:'POST'});
    hideLoading();
    if(!data.ok){toast('âŒ '+(data.error||'Falha ao gerar PIX'),'error');return;}
    if(!data.pix_disponivel){toast('âš ï¸ PIX nÃ£o disponÃ­vel â€” verifique configuraÃ§Ã£o','error');return;}
    renderQrModal(orderId, data);
    loadPagamentos();
  } catch(e){hideLoading();toast('âŒ '+e.message,'error');}
}

function renderQrModal(orderId, data) {
  const order = allData.find(r=>r.id===orderId);
  const nome = order?.customer_name || 'Cliente';
  const valor = parseFloat(order?.total_value||data.total_value||0).toFixed(2);
  const qrCode = data.qrcode || data.qr_code || '';

  // Gerar QR Code localmente via qrcode-generator
  let qrImgHtml = '';
  if (qrCode) {
    try {
      const qr = qrcode(0, 'L');
      qr.addData(qrCode);
      qr.make();
      qrImgHtml = '<div style="display:inline-block;border:3px solid #0891b2;border-radius:8px;overflow:hidden;line-height:0;margin:8px auto">' + qr.createImgTag(5, 8) + '</div>';
    } catch(e) {
      qrImgHtml = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(qrCode)}" alt="QR Code PIX" style="width:220px;height:220px;border-radius:8px;border:3px solid #0891b2;margin:8px auto;display:block" />`;
    }
  }

  document.getElementById('qr-modal-title').textContent = `ğŸ“± PIX â€” Pedido #${orderId}`;
  
  let html = `<div style="font-weight:700;font-size:16px;margin:8px 0">${nome}</div>`;
  html += `<div style="font-size:28px;font-weight:900;color:#0891b2;margin:8px 0">R$ ${valor}</div>`;
  
  if(qrImgHtml){
    html += qrImgHtml;
  }
  
  if(qrCode){
    html += `<div style="font-size:12px;color:#64748b;margin-top:8px;font-weight:700">PIX Copia e Cola:</div>`;
    html += `<div class="qr-code-text" id="qr-code-text">${qrCode}</div>`;
    html += `<div style="display:flex;gap:8px;justify-content:center;margin-top:12px;flex-wrap:wrap">`;
    html += `<button class="btn-copy" onclick="copiarPix()">ğŸ“‹ Copiar CÃ³digo</button>`;
    if(order?.phone_digits) {
      html += `<button class="btn-whats" onclick="enviarPixWhats(${orderId})" title="Enviar QR Code por WhatsApp">ğŸ“² WhatsApp</button>`;
    }
    html += `</div>`;
  }
  
  html += `<div style="display:flex;gap:8px;justify-content:center;margin-top:16px">`;
  html += `<button class="btn" style="background:#e2e8f0;color:#475569" onclick="closeQrModal()">Fechar</button>`;
  html += `<button class="btn" style="background:#0891b2;color:#fff" onclick="gerarPixQr(${orderId})" title="Gerar novo QR Code">ğŸ”„ Regerar</button>`;
  html += `</div>`;
  
  document.getElementById('qr-modal-body').innerHTML = html;
  document.getElementById('qr-modal').classList.add('show');
}

function closeQrModal(){ document.getElementById('qr-modal').classList.remove('show'); }

function copiarPix(){
  const text=document.getElementById('qr-code-text')?.textContent;
  if(!text){toast('âš ï¸ CÃ³digo nÃ£o disponÃ­vel','error');return;}
  navigator.clipboard.writeText(text).then(()=>{toast('ğŸ“‹ CÃ³digo PIX copiado!');}).catch(()=>{
    // Fallback
    const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    toast('ğŸ“‹ CÃ³digo PIX copiado!');
  });
}

async function enviarPixWhats(orderId){
  if(!confirm('Enviar QR Code PIX por WhatsApp para o cliente do pedido #'+orderId+'?'))return;
  showLoading('Enviando PIX por WhatsApp...');
  try{
    const data=await api('/api/lembretes/enviar/'+orderId,{method:'POST'});
    hideLoading();
    if(data.ok){toast('ğŸ“² PIX enviado por WhatsApp!');}
    else{toast('âŒ '+(data.error||'Falha'),'error');}
  }catch(e){hideLoading();toast('âŒ '+e.message,'error');}
}

// â•â•â• CHECK PIX STATUS (PushInPay) â•â•â•
async function checkPixStatus(orderId){
  showLoading('Verificando pagamento PIX...');
  try{
    const d=await api('/api/pix/check/'+orderId,{method:'POST'});
    hideLoading();
    if(d.action==='marked_paid'){
      toast('âœ… PIX CONFIRMADO! Pedido #'+orderId+' marcado como pago!','success');
      loadPagamentos();
    } else if(d.action==='still_pending'){
      toast('â³ PIX ainda pendente (status: '+d.tx_status+')','warning');
    } else if(d.message==='JÃ¡ estÃ¡ pago'){
      toast('âœ… Pedido jÃ¡ estÃ¡ pago','success');
      loadPagamentos();
    } else {
      toast('â„¹ï¸ '+(d.error||d.message||JSON.stringify(d)));
    }
  }catch(e){hideLoading();toast('âŒ '+e.message,'error');}
}

// â•â•â• LEMBRETES PIX â•â•â•
async function enviarLembrete(orderId, force){
  if(!force && !confirm('Enviar lembrete PIX WhatsApp para pedido #'+orderId+'?'))return;
  showLoading('Enviando lembrete...');
  try{
    const opts = {method:'POST'};
    if(force) opts.body = JSON.stringify({force:true});
    const d=await api('/api/lembretes/enviar/'+orderId, opts);
    hideLoading();
    if(d.ok){toast('ğŸ“± Lembrete enviado!');loadPagamentos();}
    else if(d.limite_atingido){
      if(confirm('âš ï¸ Limite de '+d.count+' lembretes atingido.\n\nEnviar mesmo assim?')){
        enviarLembrete(orderId, true);
      }
    }
    else{toast('âŒ '+(d.error||'Falha'),'error');}
  }catch(e){hideLoading();toast(e.message,'error');}
}
async function bulkEnviarLembrete(){
  const ids=[...selectedIds].filter(id=>{const p=allData.find(r=>r.id==id);return p&&p.tipo_pagamento==='pix_receber'&&p.phone_digits;});
  if(!ids.length){toast('âš ï¸ Nenhum PIX com telefone','error');return;}
  if(!confirm('Enviar lembrete PIX para '+ids.length+' pedido(s)?'))return;
  showLoading('Enviando '+ids.length+' lembrete(s)...');
  try{const d=await api('/api/lembretes/enviar-bulk',{method:'POST',body:JSON.stringify({order_ids:ids})});hideLoading();toast(d.message||'Processado',d.ok?'success':'error');loadPagamentos();}catch(e){hideLoading();toast(e.message,'error');}
}

setDateFilter('semana');
setInterval(loadPagamentos,30000);

// â•â•â• PIX AUTO-CHECK POLLING â•â•â•
// Verifica automaticamente PIX pendentes a cada 30s
let pixCheckRunning = false;
async function autoCheckPix(){
  if(pixCheckRunning) return;
  const pixPendentes = allData.filter(p => p.tipo_pagamento==='pix_receber' && p.pix_tx_id && !p.pago);
  if(!pixPendentes.length) return;
  pixCheckRunning = true;
  for(const p of pixPendentes){
    try {
      const d = await api('/api/pix/check/'+p.id, {method:'POST'});
      if(d.action==='marked_paid'){
        toast('âœ… PIX CONFIRMADO automaticamente! Pedido #'+p.id,'success');
        loadPagamentos();
        break; // reload vai atualizar tudo
      }
    } catch(e) { /* silencioso */ }
  }
  pixCheckRunning = false;
}
setInterval(autoCheckPix, 20000); // a cada 30s
</script>
</body>
</html>
