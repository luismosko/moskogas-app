<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pagamentos ‚Äî MoskoG√°s</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; }
  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; }
  select, input[type=date] { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; }
  .btn { padding: 9px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #1e293b; color: #fff; padding: 10px 12px; text-align: left; font-size: 12px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 10px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: #fafafa; }
  .pay-btn { padding: 4px 10px; border: none; border-radius: 6px; cursor: pointer; font-weight: 700; font-size: 12px; }
  .pay-recv { background: #dcfce7; color: #16a34a; border: 1px solid #86efac; }
  .pay-pend { background: #fee2e2; color: #dc2626; border: 1px solid #fca5a5; }
  .pay-rev  { background: #f1f5f9; color: #6b7280; border: 1px solid #d1d5db; }
  .pay-method { padding: 4px 8px; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 12px; }
  .summary { background: #1e293b; color: #fff; padding: 10px 16px; display: flex; gap: 20px; flex-wrap: wrap; font-size: 13px; }
  .summary strong { color: #f97316; }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<div class="toolbar">
  <input type="date" id="fDate" onchange="load()">
  <select id="fStatus" onchange="load()">
    <option value="">Todos</option>
    <option value="pendente">üí∏ Pendente</option>
    <option value="recebido">‚úÖ Recebido</option>
    <option value="estornado">‚Ü©Ô∏è Estornado</option>
  </select>
  <button class="btn btn-orange" onclick="load()">üîÑ Atualizar</button>
  <span id="count-lbl" style="font-size:12px;color:#64748b"></span>
</div>

<div class="summary" id="summary"></div>

<table>
  <thead>
    <tr>
      <th>#Pedido</th>
      <th>Data</th>
      <th>Cliente</th>
      <th>Endere√ßo</th>
      <th>Itens</th>
      <th>Total</th>
      <th>Entregador</th>
      <th>Pagamento</th>
      <th>Forma</th>
      <th>Obs</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>

<script src="shared.js"></script>
<script>
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();
document.getElementById('fDate').value = today();

async function load() {
  const date   = document.getElementById('fDate').value;
  const status = document.getElementById('fStatus').value;

  let url = '/api/payments/list?';
  if (date)   url += `&date=${date}`;
  if (status) url += `&status=${status}`;

  const rows = await api(url).catch(() => []);
  document.getElementById('count-lbl').textContent = `${rows.length} registros`;
  renderSummary(rows);
  render(rows);
}

function renderSummary(rows) {
  let recebido = 0, pendente = 0, estornado = 0;
  rows.forEach(r => {
    const v = r.total_value || 0;
    if (r.status === 'recebido')  recebido  += v;
    if (r.status === 'pendente')  pendente  += v;
    if (r.status === 'estornado') estornado += v;
  });
  document.getElementById('summary').innerHTML = `
    <span>‚úÖ Recebido: <strong>R$ ${recebido.toFixed(2)}</strong></span>
    <span>üí∏ Pendente: <strong>R$ ${pendente.toFixed(2)}</strong></span>
    <span>‚Ü©Ô∏è Estornado: <strong>R$ ${estornado.toFixed(2)}</strong></span>
    <span style="margin-left:auto">üí∞ Total: <strong>R$ ${(recebido+pendente).toFixed(2)}</strong></span>`;
}

function render(rows) {
  const tbody = document.getElementById('tbody');
  if (!rows.length) {
    tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:32px;color:#94a3b8">Nenhum registro</td></tr>';
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const items = JSON.parse(r.items_json || '[]');
    const itemsStr = items.map(i => `${i.qty}√ó ${i.name}`).join(', ') || '‚Äî';
    const data = fmtDate(r.order_created_at);
    const total = r.total_value ? `R$ ${r.total_value.toFixed(2)}` : '‚Äî';

    const methods = ['Dinheiro','Pix','Cart√£o D√©bito','Cart√£o Cr√©dito','Outro'];
    const methodSel = `<select class="pay-method" onchange="setPayment(${r.order_id}, '${r.status}', this.value, null)">
      <option value="">Forma...</option>
      ${methods.map(m => `<option value="${m}" ${r.payment_method === m ? 'selected' : ''}>${m}</option>`).join('')}
    </select>`;

    return `
    <tr>
      <td><strong>#${r.order_id}</strong></td>
      <td style="white-space:nowrap">${data}</td>
      <td>
        <div style="font-weight:700">${r.customer_name}</div>
        <div style="font-size:11px;color:#64748b">${r.phone_digits || ''}</div>
      </td>
      <td style="font-size:12px">${r.address_line || '‚Äî'}</td>
      <td style="font-size:12px;max-width:140px">${itemsStr}</td>
      <td style="font-weight:700">${total}</td>
      <td style="font-size:12px">${r.driver_name_cache || '‚Äî'}</td>
      <td>
        <div style="display:flex;gap:4px">
          <button class="pay-btn pay-recv" onclick="setPayment(${r.order_id}, 'recebido', null, null)" ${r.status==='recebido'?'style="opacity:0.5"':''}>‚úÖ Recebido</button>
          <button class="pay-btn pay-pend" onclick="setPayment(${r.order_id}, 'pendente', null, null)" ${r.status==='pendente'?'style="opacity:0.5"':''}>üí∏ Pendente</button>
          <button class="pay-btn pay-rev"  onclick="setPayment(${r.order_id}, 'estornado', null, null)">‚Ü©Ô∏è</button>
        </div>
        <div style="margin-top:4px">${payBadge(r.status)}</div>
      </td>
      <td>${methodSel}</td>
      <td>
        <input type="text" placeholder="Obs..." value="${r.notes || ''}" onblur="setPayment(${r.order_id}, null, null, this.value)"
          style="width:100px;padding:4px 8px;border:1px solid #e2e8f0;border-radius:6px;font-size:12px">
      </td>
    </tr>`;
  }).join('');
}

async function setPayment(orderId, status, method, notes) {
  try {
    const body = { order_id: orderId };
    if (status !== null) body.status = status;
    if (method !== null) body.method = method;
    if (notes  !== null) body.notes  = notes;

    await api('/api/payment/set', { method: 'POST', body: JSON.stringify(body) });
    if (status) { toast(`Pagamento: ${status}`); load(); }
  } catch(e) { toast(e.message, 'error'); }
}

load();
</script>
</body>
</html>
