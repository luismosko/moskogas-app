<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UsuÃ¡rios â€” MoskoApp v1.4.1</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; min-height: 100vh; }
  .container { max-width: 900px; margin: 0 auto; padding: 16px; }
  h1 { font-size: 20px; color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
  .card { background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
  .btn { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-gray   { background: #e2e8f0; color: #1e293b; }
  .btn:hover  { opacity: 0.9; }
  table { width: 100%; border-collapse: collapse; font-size: 13px; }
  th { background: #f1f5f9; font-weight: 700; font-size: 11px; text-transform: uppercase; color: #64748b; padding: 10px 8px; text-align: left; }
  td { padding: 10px 8px; border-bottom: 1px solid #f1f5f9; }
  .role-badge { padding: 2px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #fff; }
  .role-admin { background: #7c3aed; }
  .role-atendente { background: #2563eb; }
  .role-entregador { background: #16a34a; }
  .status-on  { color: #16a34a; }
  .status-off { color: #dc2626; }

  /* Modal */
  .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
  .modal-overlay.active { display: flex; }
  .modal { background: #fff; border-radius: 16px; padding: 24px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
  .modal h2 { font-size: 18px; color: #1e293b; }
  .modal label { display: block; font-size: 12px; font-weight: 700; color: #64748b; margin-bottom: 4px; text-transform: uppercase; }
  .modal input, .modal select { width: 100%; padding: 10px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 15px; margin-bottom: 12px; }
  .modal input:focus, .modal select:focus { outline: none; border-color: #f97316; }
  .modal .btn-row { display: flex; gap: 8px; margin-top: 8px; }
  .modal .btn-row .btn { flex: 1; padding: 12px; font-size: 14px; }
  .version-badge { font-size: 10px; color: #94a3b8; text-align: right; padding: 4px 0 10px; }
</style>
</head>
<body>
<div id="nav-container"></div>

<div class="container">
  <h1>ğŸ‘¥ GestÃ£o de UsuÃ¡rios v1.4.1</h1>

  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px;">
      <span style="font-size:14px;font-weight:700;color:#1e293b;">UsuÃ¡rios do Sistema</span>
      <div style="display:flex;gap:8px;align-items:center;">
        <button class="btn btn-gray" id="btn-toggle-inativos" onclick="toggleInativos()" style="font-size:12px;padding:6px 12px;">ğŸ‘ Ver inativos</button>
        <button class="btn btn-orange" onclick="openModal()">â• Novo UsuÃ¡rio</button>
      </div>
    </div>

    <div id="loading" style="text-align:center;padding:20px;color:#64748b;">â³ Carregando...</div>
    <table id="users-table" style="display:none;">
      <thead>
        <tr><th>Nome</th><th>Login</th><th>FunÃ§Ã£o</th><th>Vendedor Bling</th><th>AÃ§Ãµes</th></tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>
    <div id="empty-msg" style="display:none;text-align:center;padding:20px;color:#94a3b8;">Nenhum usuÃ¡rio cadastrado</div>
  </div>

  <div class="version-badge">v1.4.1 â€” usuÃ¡rios</div>
</div>

<!-- Modal Criar/Editar -->
<div id="modal-overlay" class="modal-overlay">
  <div class="modal">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2 id="modal-title" style="margin:0;">Novo UsuÃ¡rio</h2>
      <button onclick="closeModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:#94a3b8;padding:4px 8px;border-radius:6px;" title="Fechar">&times;</button>
    </div>

    <label>Nome completo</label>
    <input type="text" id="m-nome" required>

    <label>Login (usuÃ¡rio)</label>
    <input type="text" id="m-login" autocapitalize="off">

    <label id="lbl-senha">Senha</label>
    <input type="password" id="m-senha">

    <label>FunÃ§Ã£o</label>
    <select id="m-role">
      <option value="entregador">ğŸšš Entregador</option>
      <option value="atendente">ğŸ“ Atendente</option>
      <option value="admin">ğŸ‘‘ Administrador</option>
    </select>

    <label>Vendedor Bling (vincular)</label>
    <select id="m-vendedor">
      <option value="">â€” Selecionar â€”</option>
    </select>

    <label>Telefone</label>
    <input type="tel" id="m-telefone" placeholder="67999999999">

    <div style="display:flex;gap:20px;margin:8px 0 12px;">
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;text-transform:none;font-size:14px;">
        <input type="checkbox" id="m-pode-entregar" style="width:18px;height:18px;margin:0;" onchange="onPodeEntregarChange()">
        ğŸšš Pode entregar
      </label>
      <label style="display:flex;align-items:center;gap:6px;cursor:pointer;text-transform:none;font-size:14px;">
        <input type="checkbox" id="m-recebe-whatsapp" style="width:18px;height:18px;margin:0;">
        ğŸ“± Recebe WhatsApp
      </label>
    </div>

    <label>Status</label>
    <select id="m-ativo">
      <option value="1">âœ… Ativo</option>
      <option value="0">âŒ Inativo</option>
    </select>

    <input type="hidden" id="m-id">

    <div class="btn-row">
      <button class="btn btn-gray" onclick="closeModal()">Cancelar</button>
      <button class="btn btn-green" id="btn-save" onclick="saveUser()">ğŸ’¾ Salvar</button>
    </div>
  </div>
</div>

<script src="shared.js"></script>
<script>
// Auth check â€” admin e atendente
checkAuth(['admin', 'atendente']);

document.getElementById('nav-container').innerHTML = buildNav();

// Atendente nÃ£o vÃª opÃ§Ã£o "Admin" no dropdown de role
const currentUser = getCurrentUser();
if (currentUser && currentUser.role !== 'admin') {
  const adminOpt = document.querySelector('#m-role option[value="admin"]');
  if (adminOpt) adminOpt.remove();
}

let vendedoresBling = [];
let allUsers = [];
let showInativos = false;

// === Toggle exibiÃ§Ã£o de inativos ===
function toggleInativos() {
  showInativos = !showInativos;
  const btn = document.getElementById('btn-toggle-inativos');
  btn.textContent = showInativos ? 'ğŸ‘ Ocultar inativos' : 'ğŸ‘ Ver inativos';
  btn.style.background = showInativos ? '#475569' : '#e2e8f0';
  btn.style.color = showInativos ? '#fff' : '#1e293b';
  renderUsers();
}

// === Toggle: desmarcar "Recebe WhatsApp" se desmarcou "Pode Entregar" ===
function onPodeEntregarChange() {
  if (!document.getElementById('m-pode-entregar').checked) {
    document.getElementById('m-recebe-whatsapp').checked = false;
  }
}

// === Renderizar tabela ===
function renderUsers() {
  const filtered = showInativos ? allUsers : allUsers.filter(u => u.ativo);
  const tbody = document.getElementById('users-body');
  const table = document.getElementById('users-table');
  const empty = document.getElementById('empty-msg');

  if (!filtered.length) {
    empty.style.display = 'block';
    empty.textContent = showInativos ? 'Nenhum usuÃ¡rio cadastrado' : 'Nenhum usuÃ¡rio ativo';
    table.style.display = 'none';
    return;
  }

  empty.style.display = 'none';
  table.style.display = 'table';

  tbody.innerHTML = filtered.map(u => {
    const roleClass = `role-${u.role}`;
    const roleLabel = { admin: 'ğŸ‘‘ Admin', atendente: 'ğŸ“ Atendente', entregador: 'ğŸšš Entregador' }[u.role] || u.role;
    const vendedorInfo = u.bling_vendedor_nome ? u.bling_vendedor_nome : '<span style="color:#94a3b8">â€”</span>';
    const inativoTag = !u.ativo ? ' <span style="background:#dc2626;color:#fff;padding:1px 6px;border-radius:4px;font-size:9px;font-weight:700;">INATIVO</span>' : '';
    const flagsHtml = (u.pode_entregar ? '<span title="Pode entregar" style="font-size:13px;">ğŸšš</span>' : '') +
                      (u.recebe_whatsapp ? '<span title="Recebe WhatsApp" style="font-size:13px;">ğŸ“±</span>' : '');
    const rowStyle = !u.ativo ? 'opacity:0.5;' : '';
    const nome_escaped = u.nome.replace(/'/g, "\\'");
    return `<tr style="${rowStyle}">
      <td style="font-weight:600;">${u.nome}${inativoTag} ${flagsHtml}</td>
      <td style="color:#64748b;">${u.login}</td>
      <td><span class="role-badge ${roleClass}">${roleLabel}</span></td>
      <td>${vendedorInfo}</td>
      <td style="white-space:nowrap;">
        <button class="btn btn-gray" style="padding:4px 10px;font-size:11px;" onclick="editUser(${u.id})">âœï¸ Editar</button>
        ${u.ativo
          ? `<button class="btn btn-red" style="padding:4px 10px;font-size:11px;" onclick="toggleAtivo(${u.id},'${nome_escaped}',false)">â¸ Desativar</button>`
          : `<button class="btn btn-green" style="padding:4px 10px;font-size:11px;" onclick="toggleAtivo(${u.id},'${nome_escaped}',true)">â–¶ Reativar</button>`
        }
      </td>
    </tr>`;
  }).join('');

  // Mostra contador de inativos no botÃ£o
  const inativos = allUsers.filter(u => !u.ativo).length;
  const btn = document.getElementById('btn-toggle-inativos');
  if (inativos > 0 && !showInativos) {
    btn.textContent = `ğŸ‘ Ver inativos (${inativos})`;
    btn.style.display = '';
  } else if (inativos > 0 && showInativos) {
    btn.textContent = 'ğŸ‘ Ocultar inativos';
    btn.style.display = '';
  } else {
    btn.style.display = 'none';
  }
}

// === Carregar dados ===
async function loadUsers() {
  try {
    allUsers = await api('/api/auth/users');
    document.getElementById('loading').style.display = 'none';
    renderUsers();
  } catch(e) {
    document.getElementById('loading').textContent = 'âŒ Erro: ' + e.message;
  }
}

async function loadVendedores() {
  try {
    vendedoresBling = await api('/api/vendedores');
    const sel = document.getElementById('m-vendedor');
    sel.innerHTML = '<option value="">â€” Sem vÃ­nculo â€”</option>';
    for (const v of vendedoresBling) {
      const label = v.name || ('Vendedor #' + v.id);
      sel.innerHTML += `<option value="${v.id}" data-nome="${label}">${label}</option>`;
    }
  } catch(e) {
    console.warn('Erro ao carregar vendedores Bling:', e.message);
  }
}

// === Ativar/Desativar usuÃ¡rio ===
async function toggleAtivo(id, nome, ativar) {
  if (!confirm(`${ativar ? 'Reativar' : 'Desativar'} usuÃ¡rio "${nome}"?`)) return;
  showLoading(ativar ? 'Reativando...' : 'Desativando...');
  try {
    const user = allUsers.find(u => u.id === id);
    if (!user) return;
    await api('/api/auth/users', {
      method: 'POST',
      body: JSON.stringify({ id, nome: user.nome, login: user.login, role: user.role, pode_entregar: user.pode_entregar, recebe_whatsapp: user.recebe_whatsapp, ativo: ativar ? 1 : 0 })
    });
    toast(ativar ? `âœ… "${nome}" reativado!` : `âœ… "${nome}" desativado`);
    loadUsers();
  } catch(e) { toast('Erro: ' + e.message, 'error'); }
  finally { hideLoading(); }
}

// === Modal ===
function openModal(user = null) {
  document.getElementById('modal-title').textContent = user ? 'Editar UsuÃ¡rio' : 'Novo UsuÃ¡rio';
  document.getElementById('m-id').value = user?.id || '';
  document.getElementById('m-nome').value = user?.nome || '';
  document.getElementById('m-login').value = user?.login || '';
  document.getElementById('m-senha').value = '';
  document.getElementById('m-role').value = user?.role || 'entregador';
  document.getElementById('m-vendedor').value = user?.bling_vendedor_id || '';
  document.getElementById('m-telefone').value = user?.telefone || '';
  document.getElementById('m-ativo').value = user ? (user.ativo ? '1' : '0') : '1';

  // Flags entrega/whatsapp â€” default: entregador=ambos ligados, outros=desligados
  const isEntregador = (user?.role || 'entregador') === 'entregador';
  document.getElementById('m-pode-entregar').checked = user ? !!user.pode_entregar : isEntregador;
  document.getElementById('m-recebe-whatsapp').checked = user ? !!user.recebe_whatsapp : isEntregador;

  document.getElementById('lbl-senha').textContent = user ? 'Nova senha (deixe vazio para manter)' : 'Senha';
  document.getElementById('m-senha').required = !user;

  document.getElementById('modal-overlay').classList.add('active');
  document.getElementById('m-nome').focus();
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('active');
}

async function editUser(id) {
  const user = allUsers.find(u => u.id === id);
  if (user) openModal(user);
}

async function saveUser() {
  const btn = document.getElementById('btn-save');
  btn.disabled = true;
  btn.textContent = 'â³ Salvando...';
  showLoading('Salvando usuÃ¡rio...');

  try {
    const id = document.getElementById('m-id').value || null;
    const nome = document.getElementById('m-nome').value.trim();
    const login = document.getElementById('m-login').value.trim().toLowerCase();
    const senha = document.getElementById('m-senha').value;
    const role = document.getElementById('m-role').value;
    const vendedorSel = document.getElementById('m-vendedor');
    const bling_vendedor_id = vendedorSel.value ? parseInt(vendedorSel.value) : null;
    const selectedOpt = vendedorSel.options[vendedorSel.selectedIndex];
    const bling_vendedor_nome = vendedorSel.value ? (selectedOpt.dataset.nome || selectedOpt.textContent.trim()) : null;
    const telefone = document.getElementById('m-telefone').value.trim();
    const ativo = parseInt(document.getElementById('m-ativo').value);

    if (!nome || !login) { toast('Nome e login obrigatÃ³rios', 'error'); return; }
    if (!id && !senha) { toast('Senha obrigatÃ³ria para novo usuÃ¡rio', 'error'); return; }

    const payload = { nome, login, role, bling_vendedor_id, bling_vendedor_nome, telefone, ativo,
      pode_entregar: document.getElementById('m-pode-entregar').checked ? 1 : 0,
      recebe_whatsapp: document.getElementById('m-recebe-whatsapp').checked ? 1 : 0
    };
    if (id) payload.id = parseInt(id);
    if (senha) payload.senha = senha;

    await api('/api/auth/users', { method: 'POST', body: JSON.stringify(payload) });
    btn.textContent = 'âœ… Salvo!';
    btn.style.background = '#16a34a';
    toast(id ? 'UsuÃ¡rio atualizado!' : 'UsuÃ¡rio criado com sucesso!');
    setTimeout(() => { closeModal(); loadUsers(); }, 800);
  } catch(e) {
    toast('Erro: ' + e.message, 'error');
  } finally {
    hideLoading();
    btn.disabled = false;
    btn.textContent = 'ğŸ’¾ Salvar';
    btn.style.background = '#16a34a';
  }
}

// Init
loadVendedores();
loadUsers();
</script>
</body>
</html>
