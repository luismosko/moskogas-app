<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Contratos v1.1.0 â€” MoskoGÃ¡s</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: system-ui, sans-serif; background: #f1f5f9; }
  h1 { font-size: 20px; color: #1e293b; display: flex; align-items: center; gap: 8px; }
  h1 .v-badge { background: #f97316; color: #fff; font-size: 11px; padding: 2px 8px; border-radius: 10px; font-weight: 700; }

  .toolbar { background: #fff; padding: 12px 16px; display: flex; gap: 8px; flex-wrap: wrap; align-items: center; border-bottom: 2px solid #e2e8f0; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
  .toolbar input, .toolbar select { padding: 8px 12px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 14px; background: #f8fafc; }
  .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #f97316; }
  .btn { padding: 8px 14px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 13px; display: inline-flex; align-items: center; gap: 4px; }
  .btn-orange { background: #f97316; color: #fff; }
  .btn-blue   { background: #2563eb; color: #fff; }
  .btn-green  { background: #16a34a; color: #fff; }
  .btn-gray   { background: #94a3b8; color: #fff; }
  .btn-red    { background: #dc2626; color: #fff; }
  .btn-purple { background: #7c3aed; color: #fff; }
  .btn:hover { opacity: 0.85; }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; }
  .btn-sm { padding: 5px 10px; font-size: 12px; }

  table { width: 100%; border-collapse: collapse; background: #fff; }
  th { background: #475569; color: #fff; padding: 8px 10px; text-align: left; font-size: 12px; font-weight: 700; white-space: nowrap; position: sticky; top: 58px; z-index: 40; }
  td { padding: 8px 10px; border-bottom: 1px solid #f1f5f9; font-size: 13px; vertical-align: middle; }
  tr:hover td { background: #fafafa; }
  tr.clickable { cursor: pointer; }

  .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 700; color: #fff; }
  .badge-draft { background: #94a3b8; }
  .badge-ready { background: #0ea5e9; }
  .badge-waiting { background: #eab308; color: #000; }
  .badge-partially_signed { background: #f97316; }
  .badge-signed { background: #16a34a; }
  .badge-canceled { background: #6b7280; }
  .badge-error { background: #dc2626; }

  .action-btns { display: flex; gap: 4px; flex-wrap: nowrap; }

  /* Summary */
  .summary-bar { background: #475569; color: #fff; padding: 10px 16px; font-size: 13px; display: flex; gap: 16px; flex-wrap: wrap; }
  .summary-bar span strong { color: #fb923c; }

  /* Modal */
  .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:200; align-items:center; justify-content:center; }
  .modal-overlay.open { display:flex; }
  .modal { background:#fff; border-radius:14px; padding:24px; width:min(700px,95vw); max-height:90vh; overflow-y:auto; }
  .modal h2 { font-size:18px; margin-bottom:16px; color:#1e293b; }
  .modal label { display:block; font-size:12px; font-weight:700; color:#64748b; margin-bottom:4px; text-transform:uppercase; }
  .modal input, .modal select, .modal textarea { width:100%; padding:10px; border:2px solid #e2e8f0; border-radius:8px; font-size:14px; margin-bottom:12px; }
  .modal input:focus, .modal select:focus, .modal textarea:focus { outline:none; border-color:#f97316; }
  .modal-footer { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; flex-wrap:wrap; }
  .row { display: flex; gap: 12px; }
  .row > * { flex: 1; }
  .section-title { font-size: 14px; font-weight: 700; color: #475569; border-bottom: 2px solid #e2e8f0; padding-bottom: 4px; margin: 16px 0 12px 0; }

  /* Detail panel */
  .detail-panel { background:#fff; margin: 16px; border-radius:14px; padding:24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
  .detail-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; margin-bottom: 16px; }
  .detail-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 12px; margin-bottom: 20px; }
  .detail-field { }
  .detail-field label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
  .detail-field p { font-size: 14px; color: #1e293b; margin-top: 2px; }

  .signer-card { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 10px; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
  .signer-card.signed { border-color: #16a34a; background: #f0fdf4; }
  .signer-card.rejected { border-color: #dc2626; background: #fef2f2; }

  .timeline { border-left: 3px solid #e2e8f0; margin-left: 8px; padding-left: 16px; }
  .timeline-item { margin-bottom: 12px; position: relative; }
  .timeline-item::before { content: ''; position: absolute; left: -22px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background: #94a3b8; }
  .timeline-item .time { font-size: 11px; color: #94a3b8; }
  .timeline-item .event { font-size: 13px; color: #334155; }

  .empty-state { text-align: center; padding: 60px 20px; color: #94a3b8; }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .loading { text-align: center; padding: 40px; color: #94a3b8; }

  @media (max-width: 640px) {
    .row { flex-direction: column; gap: 0; }
    .detail-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div id="nav-placeholder"></div>

<!-- TOOLBAR -->
<div class="toolbar">
  <h1>ğŸ“„ Contratos <span class="v-badge">v1.1.0</span></h1>
  <div style="flex:1"></div>
  <select id="fStatus" onchange="loadContratos()" style="width:140px">
    <option value="">Todos Status</option>
    <option value="draft">Rascunho</option>
    <option value="ready">Pronto</option>
    <option value="waiting">Aguardando</option>
    <option value="partially_signed">Parcial</option>
    <option value="signed">Assinado</option>
    <option value="canceled">Cancelado</option>
    <option value="error">Erro</option>
  </select>
  <input id="fSearch" placeholder="Buscar..." onkeyup="if(event.key==='Enter')loadContratos()" style="width:180px">
  <button class="btn btn-purple btn-sm" onclick="openConfig()" title="Configurar dados do comodante e testemunhas">âš™ï¸ Config</button>
  <button class="btn btn-orange" onclick="openNovoContrato()">â• Novo Contrato</button>
</div>

<!-- SUMMARY -->
<div class="summary-bar" id="summaryBar"></div>

<!-- LIST VIEW -->
<div id="listView">
  <table>
    <thead>
      <tr>
        <th>NÂº</th>
        <th>Cliente</th>
        <th>CNPJ/CPF</th>
        <th>Status</th>
        <th>Assinaturas</th>
        <th>Criado</th>
        <th>AÃ§Ãµes</th>
      </tr>
    </thead>
    <tbody id="tblBody">
      <tr><td colspan="7" class="loading">Carregando...</td></tr>
    </tbody>
  </table>
</div>

<!-- DETAIL VIEW -->
<div id="detailView" style="display:none"></div>

<!-- â•â• MODAL: Novo/Editar Contrato â•â• -->
<div class="modal-overlay" id="modalContrato">
  <div class="modal">
    <h2 id="modalTitle">Novo Contrato de Comodato</h2>

    <div class="section-title">Dados do ComodatÃ¡rio</div>
    <div class="row">
      <div>
        <label>Tipo</label>
        <select id="mTipoPessoa" onchange="togglePJPF()">
          <option value="pj">Pessoa JurÃ­dica</option>
          <option value="pf">Pessoa FÃ­sica</option>
        </select>
      </div>
      <div>
        <label id="lblDoc">CNPJ</label>
        <input id="mCnpjCpf" placeholder="00.000.000/0001-00">
      </div>
    </div>
    <label id="lblNome">RazÃ£o Social</label>
    <input id="mRazaoSocial" placeholder="Nome da empresa">
    <label>EndereÃ§o</label>
    <input id="mEndereco" placeholder="Rua, nÂº, bairro">
    <div class="row">
      <div><label>CEP</label><input id="mCep" placeholder="79000-000"></div>
      <div><label>Email</label><input id="mEmail" type="email" placeholder="email@empresa.com"></div>
    </div>

    <div class="section-title">ResponsÃ¡vel / Representante</div>
    <div class="row">
      <div><label>Nome</label><input id="mRespNome" placeholder="Nome completo"></div>
      <div><label>CPF</label><input id="mRespCpf" placeholder="000.000.000-00"></div>
    </div>
    <div class="row">
      <div><label>Email</label><input id="mRespEmail" type="email" placeholder="email@responsavel.com"></div>
      <div><label>Telefone (WhatsApp)</label><input id="mRespTel" placeholder="(67) 99999-0000"></div>
    </div>

    <div class="section-title">Itens do Comodato</div>
    <div id="mItensContainer"></div>
    <button class="btn btn-gray btn-sm" onclick="addItem()" style="margin-bottom:12px">â• Adicionar Item</button>

    <div class="section-title">SignatÃ¡rios</div>
    <div id="mSignatariosContainer"></div>
    <button class="btn btn-gray btn-sm" onclick="addSignatario()">â• Adicionar SignatÃ¡rio</button>

    <div class="modal-footer">
      <button class="btn btn-gray" onclick="closeModal('modalContrato')">Cancelar</button>
      <button class="btn btn-blue" onclick="salvarContrato()" id="btnSalvar">ğŸ’¾ Salvar Rascunho</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Config Comodante/Testemunhas â•â• -->
<div class="modal-overlay" id="modalConfig">
  <div class="modal">
    <h2>âš™ï¸ ConfiguraÃ§Ã£o de Contratos</h2>

    <div class="section-title">Dados do Comodante (sua empresa)</div>
    <label>RazÃ£o Social</label>
    <input id="cfEmpresa" placeholder="Mosko Ltda">
    <div class="row">
      <div><label>CNPJ</label><input id="cfCnpj" placeholder="00.000.000/0001-00"></div>
      <div><label>IE</label><input id="cfIe" placeholder="InscriÃ§Ã£o estadual"></div>
    </div>
    <label>EndereÃ§o</label>
    <input id="cfEndereco" placeholder="EndereÃ§o completo">
    <div class="row">
      <div><label>Representante</label><input id="cfRepresentante" placeholder="Nome do representante"></div>
      <div><label>CPF Representante</label><input id="cfRepCpf" placeholder="000.000.000-00"></div>
    </div>

    <div class="section-title">Testemunha 1 (padrÃ£o)</div>
    <div class="row">
      <div><label>Nome</label><input id="cfTest1Nome" placeholder="Nome"></div>
      <div><label>CPF</label><input id="cfTest1Cpf" placeholder="CPF"></div>
    </div>
    <div class="row">
      <div><label>Telefone</label><input id="cfTest1Tel" placeholder="Telefone"></div>
      <div><label>Email</label><input id="cfTest1Email" placeholder="Email"></div>
    </div>

    <div class="section-title">Testemunha 2 (padrÃ£o)</div>
    <div class="row">
      <div><label>Nome</label><input id="cfTest2Nome" placeholder="Nome"></div>
      <div><label>CPF</label><input id="cfTest2Cpf" placeholder="CPF"></div>
    </div>
    <div class="row">
      <div><label>Telefone</label><input id="cfTest2Tel" placeholder="Telefone"></div>
      <div><label>Email</label><input id="cfTest2Email" placeholder="Email"></div>
    </div>

    <div class="section-title">ğŸ“ Modelo do Contrato (ClÃ¡usulas)</div>
    <p style="font-size:12px;color:#94a3b8;margin-bottom:8px">Use as variÃ¡veis: <code>{COMODANTE}</code>, <code>{COMODATARIA}</code>, <code>{ITENS_TABELA}</code>, <code>{DATA}</code>, <code>{ASSINATURAS}</code></p>
    <textarea id="cfTemplate" rows="20" style="font-family:monospace;font-size:12px;line-height:1.5"></textarea>
    <button class="btn btn-gray btn-sm" onclick="carregarModeloPadrao()" style="margin-bottom:12px">ğŸ”„ Restaurar Modelo PadrÃ£o</button>

    <div class="modal-footer">
      <button class="btn btn-gray" onclick="closeModal('modalConfig')">Cancelar</button>
      <button class="btn btn-blue" onclick="salvarConfig()" id="btnSalvarConfig">ğŸ’¾ Salvar ConfiguraÃ§Ã£o</button>
    </div>
  </div>
</div>

<script src="shared.js"></script>
<script>
// v1.1.0 â€” modelo editÃ¡vel + fix auth PDF auto-sync responsÃ¡vel + loading feedback em Config e Salvar showToast â†’ toast
document.getElementById('nav-placeholder').innerHTML = NAV_HTML;
checkApiKey();

let currentContratos = [];
let editingId = null;
let configData = {};

const STATUS_LABELS = {
  draft: 'Rascunho', ready: 'Pronto', waiting: 'Aguardando',
  partially_signed: 'Parcial', signed: 'Assinado âœ…',
  canceled: 'Cancelado', error: 'Erro'
};

const PRODUTOS_DEFAULT = [
  { nome: 'P45 (45kg)', valor: 0 },
  { nome: 'P20 (20kg)', valor: 0 },
  { nome: 'P13 (13kg)', valor: 0 },
  { nome: 'GalÃ£o 20L', valor: 0 },
];

const TEMPLATE_PADRAO = `INSTRUMENTO PARTICULAR CONTRATO DE COMODATO

{COMODANTE}

{COMODATARIA}

ClÃ¡usula Primeira - Tem por objeto este contrato a cessÃ£o gratuita de uso dos bens, de propriedade da COMODANTE Ã  COMODATÃRIA, nas condiÃ§Ãµes estabelecidas neste instrumento e nas quantidades e especificaÃ§Ãµes constantes abaixo.

{ITENS_TABELA}

ClÃ¡usula Segunda - A presente cessÃ£o restringe-se apenas ao uso do(s) bem(ns) identificado(s) na clÃ¡usula anterior pela COMODATÃRIA, nos termos do CÃ³digo Civil, art. 579 e seguintes.

ClÃ¡usula Terceira â€“ O(s) bem(ns), objeto deste contrato referido(s) nos item acima Ã© no valor unitÃ¡rio em reais na data da assinatura deste Termo.

DO PRAZO

ClÃ¡usula Quarta - O presente comodato terÃ¡ duraÃ§Ã£o de 12 meses a partir da data da assinatura deste, sendo que a COMODATÃRIA compromete-se a restituir o(s) bem(ns) descrito(s) na ClÃ¡usula Primeira, nas mesmas condiÃ§Ãµes de uso e conservaÃ§Ã£o em que se encontra nesta data.

ClÃ¡usula Quinta - Expirado o prazo aqui ajustado, caso nÃ£o haja manifestaÃ§Ã£o de nenhuma das partes, este instrumento se renova por igual perÃ­odo.

ClÃ¡usula Sexta - Extrapolando o prazo mÃ¡ximo fixado na clÃ¡usula quarta e nÃ£o havendo a prorrogaÃ§Ã£o, o(s) bem(ns) deverÃ¡(Ã£o) ser entregue(s) no prazo de 5 (cinco) dias Ã  COMODANTE. Quando do vencimento desse Ãºltimo na falta de entrega, fica a COMODATÃRIA sujeita ao pagamento de multa fixa 10% (dez por cento) do valor dos bem, mais 2% (dois por cento) do valor do bem por dia em que o mesmo permanecer em seu poder.

DO USO

ClÃ¡usula SÃ©tima â€“ O(s) bem(ns) objeto da cessÃ£o destina-se exclusivamente ao uso da COMODATÃRIA, vedada a sua utilizaÃ§Ã£o em outras operaÃ§Ãµes estranhas Ã  que se propÃµe.

DA MANUTENÃ‡ÃƒO DO(S) BEM(NS)

ClÃ¡usula Oitava - Todas as despesas de manutenÃ§Ã£o e conservaÃ§Ã£o do(s) bem(ns) comodatado(s), de qualquer natureza serÃ£o de responsabilidade da COMODATÃRIA.

ClÃ¡usula Nona - A COMODATÃRIA obriga-se a manter os bens objeto deste contrato, em perfeitas condiÃ§Ãµes de uso e funcionamento.

ClÃ¡usula DÃ©cima - Durante a vigÃªncia do presente contrato fica assegurado Ã  COMODANTE o direito de inspecionar os bens objeto do contrato no local onde se encontram para verificaÃ§Ã£o do bom cumprimento deste contrato.

DA RESCISÃƒO

ClÃ¡usula DÃ©cima Primeira - O presente contrato poderÃ¡ ser rescindido a qualquer tempo, a critÃ©rio das partes, mediante notificaÃ§Ã£o com antecedÃªncia mÃ­nima de 10 (dez) dias.

ClÃ¡usula DÃ©cima Segunda - Infringida pela COMODATÃRIA qualquer ClÃ¡usula deste Instrumento, a rescisÃ£o serÃ¡ automÃ¡tica, independente de notificaÃ§Ã£o judicial ou extrajudicial, devendo o bem ser restituÃ­do imediatamente Ã  COMODANTE sob pena da aplicaÃ§Ã£o do disposto na ClÃ¡usula Sexta deste instrumento.

DISPOSIÃ‡Ã•ES GERAIS

ClÃ¡usula DÃ©cima Terceira - O presente Termo de comodato nÃ£o cria nenhuma obrigaÃ§Ã£o de compra e venda dos bens constantes na ClÃ¡usula Primeira.

ELEIÃ‡ÃƒO DO FORO

ClÃ¡usula DÃ©cima Quarta - Fica eleito o Foro da Cidade de Campo Grande-MS, para dirimir quaisquer questÃµes decorrentes da execuÃ§Ã£o do presente contrato, com exclusÃ£o de qualquer outro, por mais privilegiado que seja.

ClÃ¡usula DÃ©cima Quinta - Os casos omissos serÃ£o resolvidos pelas partes contratantes, de comum acordo, ou pelas disposiÃ§Ãµes legais aplicÃ¡veis Ã  espÃ©cie. E, por estarem de comum acordo, assinam o presente instrumento em 2 (duas) vias de igual teor, para que produzam um sÃ³ efeito, o qual fazem na presenÃ§a de duas testemunhas que a tudo assistiram e tambÃ©m assinam.

{DATA}

{ASSINATURAS}`;

function carregarModeloPadrao() {
  document.getElementById('cfTemplate').value = TEMPLATE_PADRAO;
  toast('Modelo padrÃ£o carregado', 'info');
}

// â”€â”€ Load â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadContratos() {
  const status = document.getElementById('fStatus').value;
  const search = document.getElementById('fSearch').value.trim();
  const params = new URLSearchParams();
  if (status) params.set('status', status);
  if (search) params.set('search', search);

  try {
    const r = await api(`/api/contratos?${params}`);
    currentContratos = r.data || [];
    renderList();
    renderSummary(r);
  } catch (e) {
    toast('Erro ao carregar contratos: ' + e.message, 'error');
  }
}

function renderList() {
  const tbody = document.getElementById('tblBody');
  if (!currentContratos.length) {
    tbody.innerHTML = '<tr><td colspan="7" class="empty-state"><div class="icon">ğŸ“„</div>Nenhum contrato encontrado</td></tr>';
    return;
  }
  tbody.innerHTML = currentContratos.map(c => {
    const dt = c.created_at ? new Date(c.created_at * 1000).toLocaleDateString('pt-BR') : '-';
    const assinLabel = `${c.assinaturas_ok || 0}/${c.assinaturas_total || 0}`;
    return `<tr class="clickable" onclick="openDetail(${c.id})">
      <td><strong>${c.numero}</strong></td>
      <td>${c.razao_social || c.responsavel_nome || '-'}</td>
      <td style="font-size:12px">${c.cnpj_cpf || '-'}</td>
      <td><span class="badge badge-${c.status}">${STATUS_LABELS[c.status] || c.status}</span></td>
      <td>${assinLabel}</td>
      <td>${dt}</td>
      <td onclick="event.stopPropagation()">
        <div class="action-btns">
          ${c.status === 'draft' || c.status === 'error' ? `<button class="btn btn-blue btn-sm" onclick="editContrato(${c.id})" title="Editar">âœï¸</button>` : ''}
          ${c.status === 'ready' ? `<button class="btn btn-green btn-sm" onclick="enviarAssinatura(${c.id})" title="Enviar para assinatura">âœï¸</button>` : ''}
          ${['waiting','partially_signed'].includes(c.status) ? `<button class="btn btn-purple btn-sm" onclick="reenviarLinks(${c.id})" title="Reenviar WhatsApp">ğŸ“²</button>` : ''}
        </div>
      </td>
    </tr>`;
  }).join('');
}

function renderSummary(r) {
  const bar = document.getElementById('summaryBar');
  const total = r.total || currentContratos.length;
  const signed = currentContratos.filter(c => c.status === 'signed').length;
  const waiting = currentContratos.filter(c => ['waiting', 'partially_signed'].includes(c.status)).length;
  const draft = currentContratos.filter(c => c.status === 'draft').length;
  bar.innerHTML = `<span>Total: <strong>${total}</strong></span>
    <span>Assinados: <strong>${signed}</strong></span>
    <span>Aguardando: <strong>${waiting}</strong></span>
    <span>Rascunhos: <strong>${draft}</strong></span>`;
}

// â”€â”€ Detail View â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function openDetail(id) {
  try {
    const r = await api(`/api/contratos/${id}`);
    const c = r.contract;
    const signers = r.signers || [];
    const events = r.events || [];
    const attachments = r.attachments || [];
    let itens = [];
    try { itens = JSON.parse(c.itens_json || '[]'); } catch {}

    const dt = c.created_at ? new Date(c.created_at * 1000).toLocaleString('pt-BR') : '-';
    const signedDt = c.signed_at ? new Date(c.signed_at * 1000).toLocaleString('pt-BR') : '';

    document.getElementById('listView').style.display = 'none';
    const dv = document.getElementById('detailView');
    dv.style.display = 'block';

    dv.innerHTML = `
      <div class="detail-panel">
        <div class="detail-header">
          <div>
            <h2 style="font-size:20px;color:#1e293b">ğŸ“„ ${c.numero}</h2>
            <span class="badge badge-${c.status}" style="font-size:13px;margin-top:4px">${STATUS_LABELS[c.status] || c.status}</span>
            ${signedDt ? `<span style="font-size:12px;color:#16a34a;margin-left:8px">âœ… Assinado em ${signedDt}</span>` : ''}
            ${c.assinafy_error ? `<div style="color:#dc2626;font-size:12px;margin-top:4px">âš ï¸ ${c.assinafy_error}</div>` : ''}
          </div>
          <div class="action-btns" style="flex-wrap:wrap">
            <button class="btn btn-gray btn-sm" onclick="voltarLista()">â† Voltar</button>
            ${['draft','ready','error'].includes(c.status) ? `<button class="btn btn-blue btn-sm" onclick="editContrato(${c.id})">âœï¸ Editar</button>` : ''}
            ${c.status === 'ready' ? `<button class="btn btn-green btn-sm" onclick="enviarAssinatura(${c.id})">âœï¸ Enviar p/ Assinatura</button>` : ''}
            ${['draft','ready'].includes(c.status) ? `<button class="btn btn-purple btn-sm" onclick="gerarPDF(${c.id})">ğŸ“ƒ Gerar PDF</button>` : ''}
            ${['waiting','partially_signed'].includes(c.status) ? `<button class="btn btn-purple btn-sm" onclick="reenviarLinks(${c.id})">ğŸ“² Reenviar WhatsApp</button>` : ''}
            ${c.generated_pdf_key ? `<a class="btn btn-gray btn-sm" href="${API_BASE}/api/contratos/${c.id}/pdf?type=generated&api_key=${getApiKeyFallback()}" target="_blank">ğŸ“¥ PDF Gerado</a>` : ''}
            ${c.signed_pdf_key ? `<a class="btn btn-green btn-sm" href="${API_BASE}/api/contratos/${c.id}/pdf?type=signed&api_key=${getApiKeyFallback()}" target="_blank">ğŸ“¥ PDF Assinado</a>` : ''}
            ${c.status !== 'canceled' && c.status !== 'signed' ? `<button class="btn btn-red btn-sm" onclick="cancelarContrato(${c.id})">âŒ Cancelar</button>` : ''}
          </div>
        </div>

        <div class="detail-grid">
          <div class="detail-field"><label>Tipo</label><p>${c.tipo_pessoa === 'pf' ? 'Pessoa FÃ­sica' : 'Pessoa JurÃ­dica'}</p></div>
          <div class="detail-field"><label>${c.tipo_pessoa === 'pf' ? 'Nome' : 'RazÃ£o Social'}</label><p>${c.razao_social || '-'}</p></div>
          <div class="detail-field"><label>${c.tipo_pessoa === 'pf' ? 'CPF' : 'CNPJ'}</label><p>${c.cnpj_cpf || '-'}</p></div>
          <div class="detail-field"><label>EndereÃ§o</label><p>${c.endereco || '-'}</p></div>
          <div class="detail-field"><label>CEP</label><p>${c.cep || '-'}</p></div>
          <div class="detail-field"><label>Criado em</label><p>${dt}</p></div>
        </div>

        ${c.responsavel_nome ? `
        <div class="section-title">ResponsÃ¡vel</div>
        <div class="detail-grid">
          <div class="detail-field"><label>Nome</label><p>${c.responsavel_nome}</p></div>
          <div class="detail-field"><label>CPF</label><p>${c.responsavel_cpf || '-'}</p></div>
          <div class="detail-field"><label>Email</label><p>${c.responsavel_email || '-'}</p></div>
          <div class="detail-field"><label>Telefone</label><p>${c.responsavel_telefone || '-'}</p></div>
        </div>` : ''}

        ${itens.length ? `
        <div class="section-title">Itens do Comodato</div>
        <table style="margin-bottom:20px">
          <thead><tr><th>Produto</th><th>Qtd</th><th>Valor Unit.</th><th>Obs</th></tr></thead>
          <tbody>${itens.map(i => `<tr><td>${i.produto || i.nome}</td><td>${i.quantidade || 1}</td><td>${i.valor_unit ? 'R$ ' + parseFloat(i.valor_unit).toFixed(2) : '-'}</td><td>${i.obs || '-'}</td></tr>`).join('')}</tbody>
        </table>` : ''}

        <div class="section-title">SignatÃ¡rios (${signers.filter(s=>s.status==='signed').length}/${signers.length} assinaram)</div>
        ${signers.map(s => {
          const cls = s.status === 'signed' ? 'signed' : s.status === 'rejected' ? 'rejected' : '';
          const statusIcon = s.status === 'signed' ? 'âœ…' : s.status === 'rejected' ? 'âŒ' : 'â³';
          const signedAt = s.signed_at ? new Date(s.signed_at * 1000).toLocaleString('pt-BR') : '';
          return `<div class="signer-card ${cls}">
            <div>
              <strong>${statusIcon} ${s.nome}</strong> <span style="color:#94a3b8;font-size:12px">(${s.role})</span>
              <div style="font-size:12px;color:#64748b">${s.email || ''} ${s.telefone ? 'â€¢ ' + s.telefone : ''}</div>
              ${signedAt ? `<div style="font-size:11px;color:#16a34a">Assinado em ${signedAt}</div>` : ''}
              ${s.reject_reason ? `<div style="font-size:11px;color:#dc2626">Motivo: ${s.reject_reason}</div>` : ''}
            </div>
            <div>
              ${s.signing_url && s.status === 'pending' ? `<a href="${s.signing_url}" target="_blank" class="btn btn-blue btn-sm">ğŸ”— Link</a>` : ''}
              ${s.status === 'pending' && s.telefone && c.status !== 'draft' ? `<button class="btn btn-purple btn-sm" onclick="reenviarLinks(${c.id}, ${s.id})">ğŸ“²</button>` : ''}
            </div>
          </div>`;
        }).join('') || '<p style="color:#94a3b8;padding:12px">Nenhum signatÃ¡rio adicionado</p>'}

        ${events.length ? `
        <div class="section-title">Timeline</div>
        <div class="timeline">
          ${events.slice(0, 20).map(e => {
            const t = e.created_at ? new Date(e.created_at * 1000).toLocaleString('pt-BR') : '';
            return `<div class="timeline-item">
              <div class="time">${t} ${e.usuario_nome ? 'â€¢ ' + e.usuario_nome : ''}</div>
              <div class="event"><strong>${e.evento}</strong>: ${e.detalhes || ''}</div>
            </div>`;
          }).join('')}
        </div>` : ''}
      </div>`;
  } catch (e) {
    toast('Erro ao carregar contrato: ' + e.message, 'error');
  }
}

function voltarLista() {
  document.getElementById('detailView').style.display = 'none';
  document.getElementById('listView').style.display = 'block';
}

function getApiKeyFallback() {
  return getSessionToken() || localStorage.getItem('mg_api_key') || '';
}

// â”€â”€ Create / Edit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function openNovoContrato() {
  editingId = null;
  document.getElementById('modalTitle').textContent = 'Novo Contrato de Comodato';
  clearForm();
  // Pre-populate signers from config
  loadDefaultSignatarios();
  openModal('modalContrato');
}

async function editContrato(id) {
  try {
    const r = await api(`/api/contratos/${id}`);
    const c = r.contract;
    editingId = c.id;
    document.getElementById('modalTitle').textContent = `Editar ${c.numero}`;

    document.getElementById('mTipoPessoa').value = c.tipo_pessoa || 'pj';
    document.getElementById('mCnpjCpf').value = c.cnpj_cpf || '';
    document.getElementById('mRazaoSocial').value = c.razao_social || '';
    document.getElementById('mEndereco').value = c.endereco || '';
    document.getElementById('mCep').value = c.cep || '';
    document.getElementById('mEmail').value = c.responsavel_email || '';
    document.getElementById('mRespNome').value = c.responsavel_nome || '';
    document.getElementById('mRespCpf').value = c.responsavel_cpf || '';
    document.getElementById('mRespEmail').value = c.responsavel_email || '';
    document.getElementById('mRespTel').value = c.responsavel_telefone || '';
    togglePJPF();

    // Items
    let itens = [];
    try { itens = JSON.parse(c.itens_json || '[]'); } catch {}
    document.getElementById('mItensContainer').innerHTML = '';
    if (itens.length) {
      itens.forEach(i => addItem(i));
    } else {
      addItem();
    }

    // Signers
    const signers = r.signers || [];
    document.getElementById('mSignatariosContainer').innerHTML = '';
    signers.forEach(s => addSignatario(s));

    openModal('modalContrato');
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  }
}

async function salvarContrato() {
  const body = {
    tipo_pessoa: document.getElementById('mTipoPessoa').value,
    cnpj_cpf: document.getElementById('mCnpjCpf').value.trim(),
    razao_social: document.getElementById('mRazaoSocial').value.trim(),
    endereco: document.getElementById('mEndereco').value.trim(),
    cep: document.getElementById('mCep').value.trim(),
    responsavel_nome: document.getElementById('mRespNome').value.trim(),
    responsavel_cpf: document.getElementById('mRespCpf').value.trim(),
    responsavel_email: document.getElementById('mRespEmail').value.trim() || document.getElementById('mEmail').value.trim(),
    responsavel_telefone: document.getElementById('mRespTel').value.trim(),
    itens: collectItems(),
    signatarios: collectSignatarios(),
  };

  if (!body.razao_social && !body.responsavel_nome) {
    toast('Informe o nome/razÃ£o social do cliente', 'warning');
    return;
  }

  const btn = document.getElementById('btnSalvar');
  btn.disabled = true; btn.textContent = 'â³ Salvando...';

  try {
    if (editingId) {
      await api(`/api/contratos/${editingId}`, { method: 'PATCH', body: JSON.stringify(body) });
      toast('âœ… Contrato atualizado!', 'success');
    } else {
      const r = await api('/api/contratos', { method: 'POST', body: JSON.stringify(body) });
      toast(`âœ… Contrato ${r.numero} criado!`, 'success');
    }
    closeModal('modalContrato');
    loadContratos();
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ’¾ Salvar Rascunho';
  }
}

// â”€â”€ Items â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addItem(data) {
  const container = document.getElementById('mItensContainer');
  const div = document.createElement('div');
  div.className = 'row';
  div.style.alignItems = 'end';
  div.innerHTML = `
    <div style="flex:2"><label>Produto</label><input class="item-produto" value="${data?.produto || data?.nome || ''}" placeholder="Ex: P45 (45kg)"></div>
    <div style="flex:0.7"><label>Qtd</label><input type="number" class="item-qtd" value="${data?.quantidade || 1}" min="1"></div>
    <div style="flex:1"><label>Valor Unit.</label><input type="number" step="0.01" class="item-valor" value="${data?.valor_unit || ''}" placeholder="0.00"></div>
    <div style="flex:0.3"><button class="btn btn-red btn-sm" onclick="this.closest('.row').remove()" style="margin-bottom:12px">âœ•</button></div>
  `;
  container.appendChild(div);
}

function collectItems() {
  const items = [];
  document.querySelectorAll('#mItensContainer .row').forEach(row => {
    const produto = row.querySelector('.item-produto').value.trim();
    const quantidade = parseInt(row.querySelector('.item-qtd').value) || 1;
    const valor_unit = parseFloat(row.querySelector('.item-valor').value) || 0;
    if (produto) items.push({ produto, quantidade, valor_unit });
  });
  return items;
}

// â”€â”€ SignatÃ¡rios â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addSignatario(data) {
  const container = document.getElementById('mSignatariosContainer');
  const div = document.createElement('div');
  div.className = 'row';
  div.style.alignItems = 'end';
  div.style.background = '#f8fafc';
  div.style.padding = '8px';
  div.style.borderRadius = '8px';
  div.style.marginBottom = '8px';
  div.innerHTML = `
    <div style="flex:0.8"><label>Papel</label>
      <select class="sig-role">
        <option value="comodatario" ${data?.role==='comodatario'?'selected':''}>ComodatÃ¡rio</option>
        <option value="comodante" ${data?.role==='comodante'?'selected':''}>Comodante</option>
        <option value="testemunha1" ${data?.role==='testemunha1'?'selected':''}>Testemunha 1</option>
        <option value="testemunha2" ${data?.role==='testemunha2'?'selected':''}>Testemunha 2</option>
      </select>
    </div>
    <div style="flex:1.3"><label>Nome</label><input class="sig-nome" value="${data?.nome||''}" placeholder="Nome completo"></div>
    <div style="flex:0.8"><label>CPF</label><input class="sig-cpf" value="${data?.cpf||''}" placeholder="CPF"></div>
    <div style="flex:1"><label>Telefone (WhatsApp)</label><input class="sig-tel" value="${data?.telefone||''}" placeholder="(67) 99999-0000"></div>
    <div style="flex:1"><label>Email</label><input class="sig-email" value="${data?.email||''}" placeholder="email@mail.com"></div>
    <div style="flex:0.2"><button class="btn btn-red btn-sm" onclick="this.closest('.row').remove()" style="margin-bottom:12px">âœ•</button></div>
  `;
  container.appendChild(div);
}

function collectSignatarios() {
  const signers = [];
  document.querySelectorAll('#mSignatariosContainer .row').forEach(row => {
    const nome = row.querySelector('.sig-nome').value.trim();
    if (!nome) return;
    signers.push({
      role: row.querySelector('.sig-role').value,
      nome,
      cpf: row.querySelector('.sig-cpf').value.trim(),
      telefone: row.querySelector('.sig-tel').value.trim(),
      email: row.querySelector('.sig-email').value.trim(),
    });
  });
  return signers;
}

async function loadDefaultSignatarios() {
  if (!configData.contrato_comodante && !configData.contrato_testemunhas) {
    await loadConfig();
  }
  const container = document.getElementById('mSignatariosContainer');
  container.innerHTML = '';
  document.getElementById('mItensContainer').innerHTML = '';
  addItem(); // blank item

  // ComodatÃ¡rio auto-preenche com dados do responsÃ¡vel
  const respNome = document.getElementById('mRespNome').value.trim();
  const respCpf = document.getElementById('mRespCpf').value.trim();
  const respTel = document.getElementById('mRespTel').value.trim();
  const respEmail = document.getElementById('mRespEmail').value.trim() || document.getElementById('mEmail').value.trim();
  addSignatario({ role: 'comodatario', nome: respNome, cpf: respCpf, telefone: respTel, email: respEmail });

  // Add comodante from config
  const com = configData.contrato_comodante || {};
  if (com.representante) {
    addSignatario({ role: 'comodante', nome: com.representante, cpf: com.rep_cpf || '', telefone: '', email: '' });
  }

  // Add witnesses from config
  const test = configData.contrato_testemunhas || [];
  if (test[0]) addSignatario({ role: 'testemunha1', nome: test[0].nome || '', cpf: test[0].cpf || '', telefone: test[0].telefone || '', email: test[0].email || '' });
  if (test[1]) addSignatario({ role: 'testemunha2', nome: test[1].nome || '', cpf: test[1].cpf || '', telefone: test[1].telefone || '', email: test[1].email || '' });
}

// Sync responsÃ¡vel â†’ comodatÃ¡rio ao digitar
['mRespNome', 'mRespCpf', 'mRespTel', 'mRespEmail', 'mEmail'].forEach(id => {
  const el = document.getElementById(id);
  if (el) el.addEventListener('input', syncComodatario);
});

function syncComodatario() {
  const firstSigner = document.querySelector('#mSignatariosContainer .row');
  if (!firstSigner) return;
  const role = firstSigner.querySelector('.sig-role');
  if (!role || role.value !== 'comodatario') return;
  firstSigner.querySelector('.sig-nome').value = document.getElementById('mRespNome').value;
  firstSigner.querySelector('.sig-cpf').value = document.getElementById('mRespCpf').value;
  firstSigner.querySelector('.sig-tel').value = document.getElementById('mRespTel').value;
  firstSigner.querySelector('.sig-email').value = document.getElementById('mRespEmail').value || document.getElementById('mEmail').value;
}

// â”€â”€ Actions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function enviarAssinatura(id) {
  if (!confirm('Enviar contrato para assinatura digital via Assinafy + WhatsApp?')) return;
  try {
    toast('Enviando para Assinafy... aguarde', 'info');
    const r = await api(`/api/contratos/${id}/enviar-assinatura`, { method: 'POST', body: '{}' });
    toast('Contrato enviado para assinatura! Links enviados via WhatsApp.', 'success');
    loadContratos();
    openDetail(id);
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  }
}

async function reenviarLinks(contractId, signerId) {
  if (!confirm('Reenviar links de assinatura via WhatsApp?')) return;
  try {
    const body = signerId ? { signer_id: signerId } : {};
    await api(`/api/contratos/${contractId}/reenviar-links`, { method: 'POST', body: JSON.stringify(body) });
    toast('Links reenviados!', 'success');
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  }
}

async function cancelarContrato(id) {
  const motivo = prompt('Motivo do cancelamento:');
  if (!motivo) return;
  try {
    await api(`/api/contratos/${id}/cancelar`, { method: 'POST', body: JSON.stringify({ motivo }) });
    toast('Contrato cancelado', 'success');
    loadContratos();
    voltarLista();
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  }
}

async function gerarPDF(id) {
  toast('Gerando PDF... aguarde', 'info');
  try {
    const r = await api(`/api/contratos/${id}`);
    const c = r.contract;
    const signers = r.signers || [];
    let itens = [];
    try { itens = JSON.parse(c.itens_json || '[]'); } catch {}

    // Load config for comodante data
    if (!configData.contrato_comodante) await loadConfig();
    const com = configData.contrato_comodante || {};

    // Build HTML contract
    const html = buildContractHTML(c, signers, itens, com);

    // Generate PDF via html2pdf.js
    const element = document.createElement('div');
    element.innerHTML = html;
    element.style.position = 'absolute';
    element.style.left = '-9999px';
    document.body.appendChild(element);

    const opt = {
      margin: [15, 15, 15, 15],
      filename: `Comodato_${c.numero}.pdf`,
      image: { type: 'jpeg', quality: 0.95 },
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
    };

    const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
    document.body.removeChild(element);

    // Upload to worker
    const resp = await fetch(API_BASE + `/api/contratos/${id}/gerar-pdf`, {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + getSessionToken(),
        'Content-Type': 'application/pdf',
      },
      body: pdfBlob,
    });
    const result = await resp.json();
    if (!result.ok) throw new Error(result.error || 'Falha ao salvar PDF');

    toast(`PDF gerado! (${Math.round(result.size/1024)}KB)`, 'success');
    openDetail(id);
  } catch (e) {
    toast('Erro ao gerar PDF: ' + e.message, 'error');
  }
}

function buildContractHTML(contract, signers, itens, comodante) {
  const hoje = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: 'long', year: 'numeric' });
  const template = configData.contrato_template || TEMPLATE_PADRAO;

  // Build COMODANTE block
  const comodanteText = `COMODANTE: ${comodante.empresa || 'MOSKO LTDA'}, com sede Ã  ${comodante.endereco || 'Campo Grande/MS'}, inscrita no CNPJ sob o nÂº ${comodante.cnpj || ''}, ${comodante.ie ? 'IE ' + comodante.ie + ', ' : ''}representada por seu proprietÃ¡rio ${comodante.representante || ''}, inscrito no CPF/MF nÂº ${comodante.rep_cpf || ''}.`;

  // Build COMODATÃRIA block
  let comodatariaText = '';
  if (contract.tipo_pessoa === 'pf') {
    comodatariaText = `COMODATÃRIA: ${contract.razao_social}, pessoa fÃ­sica, inscrita no CPF sob o nÂº ${contract.cnpj_cpf || ''}, residente em ${contract.endereco || 'Campo Grande/MS'}.`;
  } else {
    comodatariaText = `COMODATÃRIA: ${contract.razao_social}, pessoa jurÃ­dica de direito privado, inscrita no CNPJ sob o nÂº ${contract.cnpj_cpf || ''}, com sede em ${contract.endereco || 'Campo Grande/MS'}${contract.responsavel_nome ? ', neste ato representada por ' + contract.responsavel_nome + (contract.responsavel_cpf ? ', inscrita no CPF nÂº ' + contract.responsavel_cpf : '') : ''}.`;
  }

  // Build ITENS table
  let totalGeral = 0;
  const itensRows = itens.map((i, idx) => {
    const valor = parseFloat(i.valor_unit) || 0;
    const qtd = parseInt(i.quantidade) || 1;
    totalGeral += valor * qtd;
    return `<tr>
      <td style="border:1px solid #999;padding:6px;text-align:center">${i.produto || i.nome}</td>
      <td style="border:1px solid #999;padding:6px;text-align:center">${qtd}</td>
      <td style="border:1px solid #999;padding:6px;text-align:center">R$ ${valor.toFixed(2)}</td>
    </tr>`;
  }).join('');

  const itensTabela = `<table style="width:100%;border-collapse:collapse;margin:10px 0">
    <thead><tr style="background:#e8e8e8">
      <th style="border:1px solid #999;padding:6px">Itens</th>
      <th style="border:1px solid #999;padding:6px">Quantidade</th>
      <th style="border:1px solid #999;padding:6px">Valor unitÃ¡rio</th>
    </tr></thead>
    <tbody>${itensRows}
      <tr><td colspan="2" style="border:1px solid #999;padding:6px;text-align:right;font-weight:bold">Total</td>
      <td style="border:1px solid #999;padding:6px;text-align:center;font-weight:bold">R$ ${totalGeral.toFixed(2)}</td></tr>
    </tbody></table>`;

  const dataText = `Campo Grande MS, ${hoje}`;

  // Build ASSINATURAS block
  const comodatarioSigner = signers.find(s => s.role === 'comodatario') || {};
  const comodanteSigner = signers.find(s => s.role === 'comodante') || {};
  const test1 = signers.find(s => s.role === 'testemunha1') || {};
  const test2 = signers.find(s => s.role === 'testemunha2') || {};

  const assinaturas = `
    <div style="margin-top:40px;display:flex;justify-content:space-between;gap:40px">
      <div style="text-align:center;flex:1;border-top:1px solid #000;padding-top:8px">
        <strong>Comodante</strong><br>${comodanteSigner.nome || comodante.representante || ''}<br>
        <span style="font-size:11px">CPF: ${comodanteSigner.cpf || comodante.rep_cpf || ''}</span>
      </div>
      <div style="text-align:center;flex:1;border-top:1px solid #000;padding-top:8px">
        <strong>ComodatÃ¡ria</strong><br>${comodatarioSigner.nome || contract.responsavel_nome || ''}<br>
        <span style="font-size:11px">CPF: ${comodatarioSigner.cpf || contract.responsavel_cpf || ''}</span>
      </div>
    </div>
    <div style="margin-top:40px;display:flex;justify-content:space-between;gap:40px">
      <div style="text-align:center;flex:1;border-top:1px solid #000;padding-top:8px">
        <strong>Testemunha 1</strong><br>${test1.nome || ''}<br>
        <span style="font-size:11px">${test1.cpf ? 'CPF: ' + test1.cpf : ''}</span>
      </div>
      <div style="text-align:center;flex:1;border-top:1px solid #000;padding-top:8px">
        <strong>Testemunha 2</strong><br>${test2.nome || ''}<br>
        <span style="font-size:11px">${test2.cpf ? 'CPF: ' + test2.cpf : ''}</span>
      </div>
    </div>`;

  // Replace variables in template
  let body = template
    .replace('{COMODANTE}', comodanteText)
    .replace('{COMODATARIA}', comodatariaText)
    .replace('{ITENS_TABELA}', '%%ITENS%%')
    .replace('{DATA}', dataText)
    .replace('{ASSINATURAS}', '%%ASSINATURAS%%');

  // Convert plain text paragraphs to HTML
  const paragraphs = body.split('\n\n').map(p => {
    p = p.trim();
    if (!p) return '';
    if (p === '%%ITENS%%') return itensTabela;
    if (p === '%%ASSINATURAS%%') return assinaturas;
    // Section headers (all caps or short lines)
    if (p === p.toUpperCase() && p.length < 60 && !p.includes('.')) {
      return `<p style="margin-top:16px;font-weight:bold;text-decoration:underline">${p}</p>`;
    }
    // Title
    if (p.startsWith('INSTRUMENTO')) {
      return `<h2 style="text-align:center;font-size:15px;margin-bottom:4px">${p}</h2>`;
    }
    return `<p style="text-align:justify;text-indent:2em;margin:6px 0">${p}</p>`;
  }).join('\n');

  return `<div style="font-family:'Times New Roman',serif;font-size:12.5px;color:#000;line-height:1.6;max-width:700px;margin:0 auto;padding:20px">
    <p style="text-align:center;font-size:11px;color:#888;margin-bottom:16px">NÂº ${contract.numero}</p>
    ${paragraphs}
  </div>`;
}

// â”€â”€ Config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function loadConfig() {
  try {
    const r = await api('/api/contratos/config');
    configData = r.config || {};
  } catch {
    configData = {};
  }
}

async function openConfig() {
  // Abre modal imediatamente â€” carrega dados depois
  openModal('modalConfig');
  const btn = document.getElementById('btnSalvarConfig');
  btn.disabled = true; btn.textContent = 'â³ Carregando...';

  try {
    await loadConfig();
  } catch {}

  const com = configData.contrato_comodante || {};
  const test = configData.contrato_testemunhas || [];

  document.getElementById('cfEmpresa').value = com.empresa || '';
  document.getElementById('cfCnpj').value = com.cnpj || '';
  document.getElementById('cfIe').value = com.ie || '';
  document.getElementById('cfEndereco').value = com.endereco || '';
  document.getElementById('cfRepresentante').value = com.representante || '';
  document.getElementById('cfRepCpf').value = com.rep_cpf || '';

  document.getElementById('cfTest1Nome').value = test[0]?.nome || '';
  document.getElementById('cfTest1Cpf').value = test[0]?.cpf || '';
  document.getElementById('cfTest1Tel').value = test[0]?.telefone || '';
  document.getElementById('cfTest1Email').value = test[0]?.email || '';

  document.getElementById('cfTest2Nome').value = test[1]?.nome || '';
  document.getElementById('cfTest2Cpf').value = test[1]?.cpf || '';
  document.getElementById('cfTest2Tel').value = test[1]?.telefone || '';
  document.getElementById('cfTest2Email').value = test[1]?.email || '';

  // Template
  document.getElementById('cfTemplate').value = configData.contrato_template || TEMPLATE_PADRAO;

  btn.disabled = false; btn.textContent = 'ğŸ’¾ Salvar ConfiguraÃ§Ã£o';
}

async function salvarConfig() {
  const btn = document.getElementById('btnSalvarConfig');
  btn.disabled = true; btn.textContent = 'â³ Salvando...';

  const body = {
    contrato_comodante: {
      empresa: document.getElementById('cfEmpresa').value.trim(),
      cnpj: document.getElementById('cfCnpj').value.trim(),
      ie: document.getElementById('cfIe').value.trim(),
      endereco: document.getElementById('cfEndereco').value.trim(),
      representante: document.getElementById('cfRepresentante').value.trim(),
      rep_cpf: document.getElementById('cfRepCpf').value.trim(),
    },
    contrato_testemunhas: [
      {
        nome: document.getElementById('cfTest1Nome').value.trim(),
        cpf: document.getElementById('cfTest1Cpf').value.trim(),
        telefone: document.getElementById('cfTest1Tel').value.trim(),
        email: document.getElementById('cfTest1Email').value.trim(),
      },
      {
        nome: document.getElementById('cfTest2Nome').value.trim(),
        cpf: document.getElementById('cfTest2Cpf').value.trim(),
        telefone: document.getElementById('cfTest2Tel').value.trim(),
        email: document.getElementById('cfTest2Email').value.trim(),
      },
    ],
    contrato_template: document.getElementById('cfTemplate').value,
  };

  try {
    await api('/api/contratos/config', { method: 'POST', body: JSON.stringify(body) });
    configData.contrato_comodante = body.contrato_comodante;
    configData.contrato_testemunhas = body.contrato_testemunhas;
    configData.contrato_template = body.contrato_template;
    toast('âœ… ConfiguraÃ§Ã£o salva!', 'success');
    closeModal('modalConfig');
  } catch (e) {
    toast('Erro: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'ğŸ’¾ Salvar ConfiguraÃ§Ã£o';
  }
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function togglePJPF() {
  const tipo = document.getElementById('mTipoPessoa').value;
  document.getElementById('lblDoc').textContent = tipo === 'pf' ? 'CPF' : 'CNPJ';
  document.getElementById('lblNome').textContent = tipo === 'pf' ? 'Nome Completo' : 'RazÃ£o Social';
  document.getElementById('mCnpjCpf').placeholder = tipo === 'pf' ? '000.000.000-00' : '00.000.000/0001-00';
}

function clearForm() {
  ['mTipoPessoa', 'mCnpjCpf', 'mRazaoSocial', 'mEndereco', 'mCep', 'mEmail',
   'mRespNome', 'mRespCpf', 'mRespEmail', 'mRespTel'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = el.tagName === 'SELECT' ? 'pj' : '';
  });
  document.getElementById('mItensContainer').innerHTML = '';
  document.getElementById('mSignatariosContainer').innerHTML = '';
  togglePJPF();
}

function openModal(id) {
  document.getElementById(id).classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

// Prevent modal close on overlay click (UX rule)
document.querySelectorAll('.modal-overlay').forEach(m => {
  m.addEventListener('click', (e) => { /* do nothing - UX rule */ });
});
document.querySelectorAll('.modal').forEach(m => {
  m.addEventListener('click', (e) => e.stopPropagation());
});

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadContratos();
loadConfig();
</script>
</body>
</html>
